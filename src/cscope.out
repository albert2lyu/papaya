cscope 15 $HOME/lab/yanqi/src -q 0000004768 0000335168
	@arch/x86/include/asm/bit.h

1 #iâdeà
X86_BIT_H


2 
	#X86_BIT_H


	)

4 
šlše
 
	$__bs
(
x
){

5 
lowe¡
;

6 
__asm__
 
	`__vŞ©e__
("bsf %1, %0\n\t"

10 :"ô"(
lowe¡
)

11 :"r"(
x
)

13  
lowe¡
;

15 
	}
}

17 
šlše
 
	$__b¤
(
x
){

18 
highe¡
;

19 
__asm__
 
	`__vŞ©e__
("bsr %1, %0\n\t"

23 :"ô"(
highe¡
)

24 :"r"(
x
)

26  
highe¡
;

28 
	}
}

30 
šlše
 
	$__bs0r
(
x
){

31  
	`__b¤
(~
x
);

33 
	}
}

35 
šlše
 
	$__bs0
(
x
){

36  
	`__bs
(~
x
);

37 
	}
}

39 
__bt
(*
ba£
, 
b™_id
);

40 
__bts
(*
ba£
, 
b™_id
);

41 
__bŒ
(*
ba£
, 
b™_id
);

51 
	#MASK_H
(
x
, 
m
) ({ \

52 
n
 = (
x
) * 8; \

53 
throw
 = 32 - 
n
 + (
m
); \

54 
u
 = 
x
; \

55 
u
 = u << 
throw
 >>hrow; \

56 
u
; \

57 })

	)

60 
	#MASK_L
(
x
, 
m
è((xè>> (mè<< (m))

	)

	@arch/x86/include/asm/errno.h

1 #iâdeà
X86_ERRNO_H


2 
	#X86_ERRNO_H


	)

3 
	~<asm-g’”ic/”ºo.h
>

	@arch/x86/include/asm/io.h

1 #iâdeà
X86_IO_H


2 
	#X86_IO_H


	)

5 *
iÜem­
(
phys_addr
, 
size
, 
æags
);

7 
šlše
 
	$wr™eb
(
addr
, 
u8
 
v®ue
){

8 
__asm__
 
	`__vŞ©e__
("mov %%al, (%%ebx)\n\t"

10 :"b"(
addr
), "a"(
v®ue
));

11 
	}
}

13 
šlše
 
	$wr™ew
(
addr
, 
u16
 
v®ue
){

14 
__asm__
 
	`__vŞ©e__
("mov %%ax, (%%ebx)\n\t"

16 :"b"(
addr
), "a"(
v®ue
));

17 
	}
}

19 
šlše
 
	$wr™–
(
addr
, 
v®ue
){

20 
__asm__
 
	`__vŞ©e__
("mov %%eax, (%%ebx)\n\t"

22 :"b"(
addr
), "a"(
v®ue
));

23 
	}
}

25 
šlše
 
	$»adb
(
addr
){

26 
v®ue
;

27 
__asm__
 
	`__vŞ©e__
("xor %0, %0 \n\t"

29 :"ô"(
v®ue
)

30 :"b"(
addr
)

32  
v®ue
;

33 
	}
}

36 
šlše
 
	$»adw
(
addr
){

37 
v®ue
;

38 
__asm__
 
	`__vŞ©e__
("xor %0, %0 \n\t"

40 :"ô"(
v®ue
)

41 :"b"(
addr
)

43  
v®ue
;

44 
	}
}

47 
šlše
 
	$»adl
(
addr
){

48 
v®ue
;

49 
__asm__
 
	`__vŞ©e__
("xor %0, %0 \n\t"

51 :"ô"(
v®ue
)

52 :"b"(
addr
)

54  
v®ue
;

55 
	}
}

57 
šlše
 
	$maskb
(
addr
, 
u8
 
mask
){

58 
v®ue
 = 
	`»adb
(
addr
);

59 
v®ue
 |ğ
mask
;

60 
	`wr™eb
(
addr
, 
v®ue
);

61 
	}
}

63 
šlše
 
	$unmaskb
(
addr
, 
u8
 
mask
){

64 
v®ue
 = 
	`»adb
(
addr
);

65 
v®ue
 &ğ~
mask
;

66 
	`wr™eb
(
addr
, 
v®ue
);

67 
	}
}

70 
šlše
 
	$maskw
(
addr
, 
u16
 
mask
){

71 
v®ue
 = 
	`»adw
(
addr
);

72 
v®ue
 |ğ
mask
;

73 
	`wr™ew
(
addr
, 
v®ue
);

74 
	}
}

76 
šlše
 
	$unmaskw
(
addr
, 
u16
 
mask
){

77 
v®ue
 = 
	`»adw
(
addr
);

78 
v®ue
 &ğ~
mask
;

79 
	`wr™ew
(
addr
, 
v®ue
);

80 
	}
}

82 
šlše
 
	$maskl
(
addr
, 
mask
){

83 
v®ue
 = 
	`»adl
(
addr
);

84 
v®ue
 |ğ
mask
;

85 
	`wr™–
(
addr
, 
v®ue
);

86 
	}
}

88 
šlše
 
	$unmaskl
(
addr
, 
mask
){

89 
v®ue
 = 
	`»adl
(
addr
);

90 
v®ue
 &ğ~
mask
;

91 
	`wr™–
(
addr
, 
v®ue
);

92 
	}
}

	@arch/x86/include/asm/page.h

1 #iâdeà
X86_PAGE_H


2 
	#X86_PAGE_H


	)

3 
	~<v®Ty³.h
>

4 
	~<lšux/as£¹.h
>

7 
	#PAGE_SHIFT
 12

	)

8 
	#PAGE_SIZE
 0x1000

	)

9 
	#PAGE_MASK
 (~0xfff)

	)

10 
	#·_idx
(
·ddr
è(Õaddr)>>
PAGE_SHIFT
)

	)

11 
	#·_pg
 
·_idx


	)

13 
	#PG_P
 1

	)

14 
	#PG_USU
 4

	)

15 
	#PG_RWW
 2

	)

17 
	#PG_H10
(
pg_id
èÕg_id>>10)

	)

18 
	#PG_L10
(
pg_id
èÕg_id&(0x400-1))

	)

20 
šlše
 
	$švÍg
(*
vaddr
){

21 
__asm__
 
	`__vŞ©e__
("švÍg (%0)"::"r"(
vaddr
));

22 
	}
}

24 
	#FLUSH_TLB
 
__asm__
 
	`__vŞ©e__
("mov %%cr3, %0\n\t" \

27 :"r"(0))

	)

32 
	#±e2·ge
(
±e
è((*)
	`__va
(Õ‹).
v®ue
 & 
PAGE_MASK
))

	)

33 
	#±e2·ge_t
(
±e
èĞ
mem_m­
 + (±e).
physiÿl
 )

	)

41 #´agm¨
·ck
(
push
)

42 #´agm¨
·ck
(1)

43 
	u±e
{

44 
	mv®ue
;

46 
	m´e£Á
: 1;

47 
	mwr™abË
: 1;

48 
	mu£r
: 1;

49 
	mPWT
: 1;

50 
	mPCD
: 1;

51 
	macûs£d
: 1;

52 
	mdœty
: 1;

54 
	mavl
: 3;

55 
	mphysiÿl
: 20;

58 
	mæags
: 12;

63 
	ulš—r_addr
{

64 
	mv®ue
;

66 
	moff£t
: 12;

67 
	mtbl_idx
: 10;

68 
	mdœ_idx
: 10;

72 
	uü3
{

73 
	mv®ue
;

76 
	mphysiÿl
: 20;

80 
	upg”r_code
{

81 
u32
 
	mv®ue
;

83 
	m´ÙeùiÚ
: 1;

84 
	mÚ_wr™e
: 1;

85 
	mäom_u£r
: 1;

86 
	mdœty_rsv
: 1;

87 
	mš¡ruùiÚ
: 1;

91 
	m$nİage
: 1;

92 
	m$Ú_»ad
: 1;

93 
	m$š_k”Ãl
: 1;

95 
	m$d©a
: 1;

99 #´agm¨
·ck
(
pİ
)

101 
	#PAGE_OFFSET
 0XC0000000

	)

102 
	#__·
(
vaddr
è(()(vaddrè- 
PAGE_OFFSET
)

	)

103 
	#__va
(
·ddr
è(()Õaddrè+ 
PAGE_OFFSET
)

	)

104 
	#KV
 
__va


	)

108 
šlše
 *
	$±e2·ge
(
±e
…te){

109 
	`as£¹
(
±e
.
v®ue
 &&…‹.
´e£Á
);

110  ((*)
	`__va
((
±e
).
v®ue
 & 
PAGE_MASK
));

111 
	}
}

113 
šlše
 
±e
 *
	$__va2±e
(*
vaddr
, 
±e
 *
pgdœ
){

114 if(!
pgdœ
)  0;

116 
lš—r_addr
 
Ïddr
 ;

117 
Ïddr
.
v®ue
 = ()
vaddr
;

118 
±e
 *
bË
 = 
	`±e2·ge
Ğ
pgdœ
[
Ïddr
.
dœ_idx
] );

119  
bË
 + 
Ïddr
.
tbl_idx
;

120 
	}
}

	@arch/x86/kernel/process.c

1 
	~<Şd/´oc.h
>

2 
	~<lšux/sched.h
>

3 
	~<asm/”ºo.h
>

4 
	~<lšux/NR_sysÿÎ.h
>

6 
k”Ãl_th»ad
((*
â
)(*), *
¬g
, 
æags
){

7 
__asm__
 
	`__vŞ©e__
(".intel_syntax‚oprefix\n\t"

17 :"a"(
NR_fÜk
), "r"(
â
), "r"(
¬g
)

20 
	}
}

23 
	$sys_execve
(
±_»gs
 
»gs
){

24 
”rÜ
;

25 *
f’ame
 = (*)
»gs
.
ebx
;

26 **
¬gv
 = (*)
»gs
.
ecx
;

27 if(!
¬gv
è -
EINVAL
;

28 
”rÜ
 = 
	`do_execve
(
f’ame
, 
¬gv
, (**)
»gs
.
edx
, &regs);

29  
”rÜ
;

30 
	}
}

32 
	$sys_´štf
(
±_»gs
 
»gs
){

33 
__asm__
 
	`__vŞ©e__
 ("push %0\n\t"

38 :"c"(
»gs
.
ecx
), "b"Ôegs.
ebx
)

41 
	}
}

	@arch/x86/kernel/sys_i386.c

17 
sys_mm­2
()

	@arch/x86/mm/fault.c

1 
	~<asm/·ge.h
>

2 
	~<lšux/mm.h
>

3 
	~<´oc.h
>

4 
	~<œq.h
>

6 
Ú_´ÙeùiÚ_”rÜ
(
”r_addr
,

7 
±_»gs
 *
´egs
, 
pg”r_code
);

8 
	gcouÁ_pg”r
;

24 
	$do_·ge_çuÉ
(
±_»gs
 *
´egs
, 
pg”r_code
 
”rcode
){

25 
IF
 = 
	`şi_ex
();

27 if(++
couÁ_pg”r
 >ğ2è
	`¥š
("double…age fault");

28 
u32
 
”r_addr
;

29 
__asm__
 
	`__vŞ©e__
(

31 :"ô" (
”r_addr
)

35 
	`İrštf
("·g”rÜ:ƒ¼_addr:%x,ƒ:%x,ƒ¥:%x\n", 
”r_addr
, 
´egs
->
e
,…»gs->
e¥
);

36 
	`İrštf
("error code:%s: %c %c\n",

37 
”rcode
.
´ÙeùiÚ
 ? "·g´ÙeùiÚƒ¼Ü":"·gnÙƒxi¡ƒ¼Ü",ƒ¼code.
äom_u£r
 ? 'U':'S',

38 
”rcode
.
Ú_wr™e
 ? 'W':'R'

41 if(
”r_addr
 =ğ0è
	`¥š
("attempto‡ccess‡ddress 0");

42 if(
	`š_š‹¼u±
(è|| !
cu¼’t
->
mm
è
	`¥š
("OOPs !");

44 if(
”rcode
.
$nİage
 == 0){

45 
vm_¬—
 *
vma
 = 
	`fšd_vma
(
cu¼’t
->
mm
, 
”r_addr
);

46 if(!
vma
){

47 
	`as£¹
(
”r_addr
 >ğ
__3G
);

48 
	`¥š
("kernel space…age fault");

50 if(
vma
->
¡¬t
 <ğ
”r_addr
){

51 if(
vma
->
İs
 && vma->İs->
nİage
){

52 
vma
->
İs
->
	`nİage
(vma, 
”r_addr
, 
”rcode
);

55 
	`commÚ_no_·ge
(
vma
, 
”r_addr
, 
”rcode
);

58 
	`¥š
("in vm_area gaps");

61 
	`Ú_´ÙeùiÚ_”rÜ
(
”r_addr
, 
´egs
, 
”rcode
);

64 
couÁ_pg”r
--;

65 if(
IF
è
	`¡i
();

67 
	}
}

69 
	$Ú_´ÙeùiÚ_”rÜ
(
”r_addr
,

70 
±_»gs
 *
´egs
, 
pg”r_code
 
”rcode
){

71 if(
”rcode
.
äom_u£r
 =ğ
çl£
è
	`¥š
("kernel fault !");

72 if(
”rcode
.
Ú_wr™e
 =ğ
çl£
è
	`¥š
("page fault on„ead!");

75 
vm_¬—
 *
”r_¬—
 = 
	`fšd_vma
Ğ
cu¼’t
->
mm
, 
”r_addr
 );

76 if(!
”r_¬—
è
	`¥š
(" yououched kernel space !");

77 if(
”r_¬—
->
¡¬t
 <ğ
”r_addr
){

78 
vm_æags
 vm_æag ğ
”r_¬—
->
æags
;

79 
boŞ
 
cow
 = 
vm_æags
.
sh¬ed
 =ğ
çl£
 && vm_æags.
maywr™e
;

80 if(
cow
){

81 
·ge
 *
th©_·ge_t
;

82 
±e
 *
th©_±e
;

83 *
th©_·ge
;

84 * 
Ãw_·ge
;

86 
th©_·ge
 = (*)(
”r_addr
 & 
PAGE_MASK
);

87 
th©_±e
 = 
	`__va2±e
((*)
”r_addr
, 
	`PGDIR_OF_MM
(
cu¼’t
->
mm
));

88 
th©_·ge_t
 = 
	`±e2·ge_t
(*
th©_±e
);

90 
th©_±e
->
wr™abË
 = 
Œue
;

91 if(
th©_·ge_t
->
_couÁ
 == 1){

92 
	`İrštf
("COW, single user, just unwp\n");

93 
dÚe
;

95 if(
th©_·ge_t
->
_couÁ
 <ğ0è
	`¥š
("that_page_t->count == 0!");

96 
	`İrštf
("%u, COW,‡ÎoøÃw…age. \n", 
th©_·ge_t
->
_couÁ
);

99 
Ãw_·ge
 = 
	`__®loc_·ge
(0);

100 
	`memıy
(
Ãw_·ge
, 
th©_·ge
, 
PAGE_SIZE
);

102 
	`put_·ge
(
th©_·ge_t
);

103 
th©_±e
->
physiÿl
 = 
	`__·
(
Ãw_·ge
) >> 12;

105 
dÚe
:

106 
	`švÍg
((*)
”r_addr
);

110 
	`¥š
("in gap !");

113 
	}
}

115 
	$do_b»akpošt_çuÉ
(
±_»gs
 *
»gs
){

116 
	`¥š
("breakpoint fault\n");

118 
	}
}

121 
	$do_g’”®_´Ùeù_çuÉ
(
±_»gs
 *
»gs
, 
”rcode
){

122 
	`İrštf
("general…rotectionƒrror!\n");

123 
	`İrštf
("”rÜ code:%x", 
”rcode
);

124 
	`İrštf
("äom %s,ƒ=%x\n", (
»gs
->
cs
 & 3è? "u£r" : "k”Ãl",„egs->
e
);

125 
	`¥š
("");

127 
	}
}

	@arch/x86/mm/ioremap.c

1 
	~<mm.h
>

2 
	~<asm/io.h
>

4 * 
	$iÜem­
(
phys_addr
, 
size
, 
æags
){

5 if(
phys_addr
 >> 30) {

6 
	`İrštf
(" %x ", 
phys_addr
);

7 
	`¥š
("too big IO…hysical‡ddress");

9  (*)(
phys_addr
 + 
PAGE_OFFSET
);

10 
	}
}

	@block/buffer.cn

31 
	~<lšux/bufãr_h—d.h
>

32 
	~<lšux/blkdev.h
>

33 
	~<scheduË.h
>

34 
	~<lšux/¦ab.h
>

36 
¦ab_h—d
 *
	gbufãrh—d_ÿche
;

38 
	gbufãr_h—d
 *

39 ç¼“å†²å—è¡¨
	g_
æŸ¥æ‰¾(
blk_un™
 *
	gun™
, 
ulÚg
 
	gblock_id
);

41 
	gli¡_h—d
 ç©ºé—²é“¾;

46 
	gli¡_h—d
 å¿™ç¢Œé“¾;

47 
	gulÚg
 å¿™ç¢Œå—æ•°é‡;

48 
	gulÚg
 ç©ºé—²å—æ•°é‡;

49 
	gulÚg
 ç›®å‰å—æ•°é‡;

50 
	gulÚg
 å—æ•°é‡é…é¢ = 256;

56 
šlše
 å¿™ç¢Œé“¾
	g_
æ·»åŠ Ğ
bufãr_h—d
 *
	g™
){

57 
li¡_add
Ğ&
™
->
Ìu
, &å¿™ç¢Œé“¾ );

61 
šlše
 å¿™ç¢Œé“¾
	g_
ç§»é™¤Ğ
bufãr_h—d
 *
	g™
){

62 
li¡_d–
(&
™
->
Ìu
);

69 
šlše
 ç©ºé—²é“¾
	g_
æ·»åŠ Ğ
bufãr_h—d
 *
	g™
){

70 
li¡_add_
Ğ&
™
->
Ìu
, &ç©ºé—²é“¾ );

74 
šlše
 ç©ºé—²é“¾
	g_
ç§»é™¤Ğ
bufãr_h—d
 *
	g™
){

75 
li¡_d–
(&
™
->
Ìu
);

79 
šlše
 å¼•ç”¨ç¼“å†²å—(
bufãr_h—d
 *
	gblock
){

80 
	gblock
->
	gcouÁ
++;

84 
šlše
 æ”¾å¼ƒç¼“å†²å—(
bufãr_h—d
 *
	gblock
){ 
a¤t
(
block
->
couÁ
 > 0);

85 
	gblock
->
	gcouÁ
--;

89 è§£æ˜ å°„å—(
bufãr_h—d
 *
	gblock
){ 
a¤t
(
block
->
couÁ
 > 0);

90 æ”¾å¼ƒç¼“å†²å—(
	gblock
);

91 if(
	gblock
->
	gcouÁ
 == 0){

93 å¿™ç¢Œé“¾
_
ç§»é™¤Ğ
block
 );

94 ç©ºé—²é“¾
	g_
æ·»åŠ Ğ
	gblock
 );

99 
šlše
 ç­‰å¾…å—è§£é”(
bufãr_h—d
 *
	gbh
){

100 
	gbh
->
	glock
){

101 
¦“p_Ú
(&
bh
->
wa™
);

107 
	gbufãr_h—d
 * ç¼“å†²å—å‘½ä¸­(
u32
 
	gdev
, 
	gblock
){

110 
blk_un™
 *
	gun™
;

111 
	gbufãr_h—d
 *å‘½ä¸­å—;

113 
	gun™
 = 
BLK_UNIT
(
dev
);

114 å‘½ä¸­å— = ç¼“å†²å—è¡¨
_
æŸ¥æ‰¾(
un™
, 
	gblock
);

119 
a¤t
(å‘½ä¸­å—->
block
 == block

120 && å‘½ä¸­å—->
dev_id
 =ğ
dev
);

123 if(å‘½ä¸­å—->
	gio
 =ğ
çl£
){

124 
Î_rw_block
Ğ
READ
, å‘½ä¸­å—);

127 if(å‘½ä¸­å—->
	gio
 =ğ
çl£
){

137 
	gbufãr_h—d
 * æ–°å»ºç©ºç™½å—(){

138 
bufãr_h—d
 *
	gbh
;

139 
	gbh
 = 
kmem_ÿche_®loc
(
bufãrh—d_ÿche
, 0); 
a¤t
(
bh
);

140 *
	gd©a
 = 
__®loc_·ge
(0);

141 
	gbh
->
	gd©a
 = 
d©a
;

142 
	gbh
->
	glock
 = 
çl£
;

143 
	gbh
->
	ghash
.
	g´ev
 = 
bh
->
hash
.
Ãxt
 = 0;

144 
	gbh
->
	gdœty
 = 
çl£
;

145 
INIT_LIST_HEAD
(&
bh
->
wa™
);

146  
	gbh
;

149 
boŞ
 
	$ex·nd_ä“li¡
(){ 
	`as£¹
Ğ
	`li¡_em±y
( &ç©ºé—²é“¾ ));

150 
u32
 
ÃwtÙ®
 = ç›®å‰å—æ•°é‡ + ç”Ÿé•¿ç²’åº¦;

151 if(
ÃwtÙ®
 > å—æ•°é‡é…é¢){

152  
çl£
;

154 
i
 = 0; i < ç”Ÿé•¿ç²’åº¦; i++){

155 
bufãr_h—d
 *
Ãw
 = æ–°å»ºç©ºç™½å—(); 
	`a¤t
(new);

157 
	`li¡_add
(&
Ãw
->
Ìu
, &ç©ºé—²é“¾);

159 ç›®å‰å—æ•°é‡ = 
ÃwtÙ®
;

161  
Œue
;

162 
	}
}

183 
	gbufãr_h—d
 *è¯·æ±‚ç©ºé—²å—(){

184 
bufãr_h—d
 *
	gÜphª
;

185 ifĞ
li¡_em±y
( &ç©ºé—²é“¾) ){

186 
boŞ
 
	gok
 = 
ex·nd_ä“li¡
(); if(!okè 
	gçl£
;

190 
	gÜphª
 = 
cÚš”_of
(ç©ºé—²é“¾.
Ãxt
,

191 
bufãr_h—d
, 
Ìu
);

193 ç©ºé—²é“¾
	g_
ç§»é™¤Ğ
	gÜphª
 );

196 if(
	gÜphª
->
	ghash
.
	g´ev
 == 0);

198 
li¡_d–
Ğ&
Üphª
->
hash
 );

199 if(
	gÜphª
->
	gdœty
){ 
as£¹
(0 && "write-back‚ot implemented yet");

200 if(!
	gÜphª
->
	glock
è
Î_rw_block
(
WRITE
, 
Üphª
);

207 
as£¹
Ğ
li¡_em±y
(&
Üphª
->
wa™
));

208 
	gÜphª
->
	gcouÁ
 = 1;

209  
	gÜphª
;

213 
	$š™_blkÏy”_bufãr
(){

214 
	`INIT_LIST_HEAD
(&ç©ºé—²é“¾);

215 
	`INIT_LIST_HEAD
(&å¿™ç¢Œé“¾);

216 
bufãrh—d_ÿche
 = 
	`kmem_ÿche_ü—‹
(

218 (
bufãr_h—d
), 0,

219 
SLAB_HWCACHE_ALIGN
, 0, 0 );

220 
	}
}

222 
	$š™_blkÏy”
(){

223 
	`š™_blkÏy”_basic
();

224 
	`š™_blkÏy”_bufãr
();

225 
	}
}

231 æ‰€éœ€çƒ­è¡¨é•¿(
blk_un™
 *
	gun™
){

232 
	gulÚg
 å•é“¾å®¹é‡ = 
__4K
 * ç¢°æ’é“¾å®¹é‡;

233 
	gulÚg
 åŒé¡µå®¹é‡ = å•é“¾å®¹é‡ * 
__1K
 ;

234 
ulÚg
 
	gdev_size
 = 512 * 
un™
->
tÙ®_£ùÜs
;

235  
û_div
Ğ
dev_size
, åŒé¡µå®¹é‡);

243 
	$»gi¡”_blkdev
(
majÜ
){ 
	`as£¹
(majÜ < 
MAX_BLKDEV
);

244 
blk_dev
 *
blkdev
;

245 
blkdev
 = &
blk_devs
[
majÜ
]; 
	`a¤t
(blkdev->
un™max
 > 0);

248 
i
 = 0; i < 
blkdev
->
un™max
; i++){

249 
blk_un™
 *
un™
;

252 ifĞ(
i
 % 
blkdev
->
un™cyşe
) == 0) ;

254 
un™
 = 
blkdev
->
un™s
[
i
];

255 if(!
un™
è; 
	`a¤t
(un™->
tÙ®_£ùÜs
 != 0);

256 
	`a¤t
(!
un™
->
hÙabË
 && "registered‡lready!");

257 
	`»gi¡”_blkun™
(
un™
, 
	`MKDEV
(
majÜ
, 
i
));

259 
	}
}

265 
	$»gi¡”_blkun™
(
blk_un™
 *
un™
, 
u32
 
dev
){ 
	`a¤t
(un™ && un™->
tÙ®_£ùÜs
 );

266 
li¡_h—d
 *ç¼“å†²å—è¡¨;

269 
·ges_Ãed
 = æ‰€éœ€çƒ­è¡¨é•¿(
un™
) * 2;

270 
Üd”_Ãed
 = 
	`pgÜd”_Ãeded
(
·ges_Ãed
);

271 
·ges_giveyou
 = 1 << 
Üd”_Ãed
;

272 ç¼“å†²å—è¡¨ = 
	`__®loc_·ges
(0, 
Üd”_Ãed
); 
	`a¤t
(ç¼“å†²å—è¡¨);

273 ç¼“å†²å—è¡¨é•¿ = 
·ges_giveyou
 * 
__4K
 /(
li¡_h—d
);

274 
i
 = 0 ; i < ç¼“å†²å—è¡¨é•¿; i++){

275 
	`INIT_LIST_HEAD
Ğ&ç¼“å†²å—è¡¨[
i
] );

278 
un™
->ç¼“å†²å—è¡¨ = ç¼“å†²å—è¡¨;

279 
un™
->ç¼“å†²å—è¡¨é•¿= ç¼“å†²å—è¡¨é•¿;

280 
un™
->
dev_id
 = 
dev
;

281 
	}
}

289 ç¼“å†²å—è¡¨
	g_
æ·»åŠ (
blk_un™
 *
	gun™
,

290 
bufãr_h—d
 *
	gÃw
)

291 { 
a¤t
(
Ãw
->
couÁ
 == 1);

292 
	gÃw
->
	gdev_id
 = 
un™
->
dev_id
;

293 
	gÃw
->
	gdœty
 = 
çl£
;

294 
	gÃw
->
	glock
 = 
çl£
;

297 
li¡_h—d
 *
	ghashtbl
 = 
un™
->ç¼“å†²å—è¡¨;

298 
	ghash
 = 
Ãw
->
block
 % 
un™
->ç¼“å†²å—è¡¨é•¿;

299 
li¡_add
(&
Ãw
->
hash
, &
hashtbl
[hash]);

304 
	gbufãr_h—d
 *

305 ç¼“å†²å—è¡¨
	g_
æŸ¥æ‰¾(
blk_un™
 *
	gun™
, 
ulÚg
 
	gblock_id
){

306 
	ghash
 = 
block_id
 % 
un™
->ç¼“å†²å—è¡¨é•¿;

307 
li¡_h—d
 *
	gcŞlisiÚ
 = 
un™
->ç¼“å†²å—è¡¨ + 
hash
;

308 
bufãr_h—d
 *
	gcu¼
;

309 
li¡_fÜ_—ch_§ã
(
cŞlisiÚ
, 
cu¼
, 
hash
){

310 if(
	gcu¼
->
	gblock
 =ğ
block_id
è 
cu¼
;

337 
	gbufãr_h—d
 *æ˜ å°„ç£ç›˜å—(
u32
 
	gdev
, 
ulÚg
 
	gblock
){

338 
bufãr_h—d
 *
	gbufãr
;

339 
bufãr_h—d
 *
	g¿w
;

342 
	gblk_devs
[
MAJOR
(
dev
)].
glob®2loÿl
(&dev, &
block
);

344 
	gbufãr
 = ç¼“å†²å—å‘½ä¸­(
dev
, 
	gblock
);

345 if(
	gbufãr
)  buffer;

347 
	g¿w
 = è¯·æ±‚ç©ºé—²å—(); 
a¤t
(
¿w
);

348 if(
	g¿w
->
	glock
){

350 
kp_¦“p
(0, 0);

352 ifĞ(
	gbufãr
 = ç¼“å†²å—å‘½ä¸­(
dev
, 
	gblock
) ) ){

353 ç©ºé—²é“¾
	g_
æ·»åŠ (
	g¿w
);

354  
	gbufãr
;

357 
	gbufãr
 = 
¿w
;

365 
	gbufãr
->
	gblock
 = 
block
;

366 ç¼“å†²å—è¡¨
	g_
æ·»åŠ Ğ
BLK_UNIT
(
dev
), 
	gbufãr
);

367 å¿™ç¢Œé“¾
	g_
æ·»åŠ (
	gbufãr
);

369 
Î_rw_block
(
READ
, 
bufãr
);

370 ç­‰å¾…å—è§£é”(
	gbufãr
);

377 if(
	gbufãr
->
	gio
 =ğ
çl£
){

378 æ”¾å¼ƒç¼“å†²å—(
bufãr
);

379 
	gbufãr
 = 0; 
¥š
("IO fault");

381  
	gbufãr
;

388 
	$Î_rw_blocks
(
u32
 
dev_id
, 
rw
,

389 
ulÚg
 
¡¬t
, ulÚg 
blocknum
, *
buf
)

391 *
äom
, *
to
;

392 
bufãr_h—d
 *
bh
;

394 
i
 = 0; i < 
blocknum
; i++){

395 
bh
 = 
	`mm­_disk
(
dev_id
, 
¡¬t
 + 
i
); 
	`a¤t
(bh);

396 if(
rw
 =ğ
READ
) {

397 
äom
 = 
bh
->
d©a
;

398 
to
 = 
buf
 + 
i
 * 
BLOCK_SIZE
;

401 
äom
 = 
buf
 + 
i
* 
BLOCK_SIZE
;

402 
to
 = 
bh
->
d©a
;

405 
	`memıy
(
to
, 
äom
, 
BLOCK_SIZE
);

406 
	`munm­_disk
(
bh
);

409 
	}
}

411 
	gbufãr_h—d
 *è¯·æ±‚å†™å…¥å—(
u32
 
	gdev
, 
ulÚg
 
	gblock
){

422 
	gbufãr_h—d
 *å›æ”¶æœ€å†·å—(){

423 if(
li¡_em±y
(&ç¼“å†²å—å…¨å±€é“¾))  0;

425 
bufãr_h—d
 *
	gcŞdblock
;

426 
	gcŞdblock
 = 
cÚš”_of
(ç¼“å†²å—å…¨å±€é“¾.
Ãxt
, 
bufãr_h—d
, 
Ìu
);

427 if(
	gcŞdblock
->
	gcouÁ
 > 0è
¥š
("unusual case");

429 ç¼“å†²å—è„±é“¾(
	gcŞdblock
);

430 if(
	gcŞdblock
->
	gdœty
){

432 
Î_rw_block
(
WRITE
, 
cŞdblock
);

434  
	gcŞdblock
;

443 
bufãr_h—d
 *
	gem±y
;

445 
	gem±y
 = æ–°å»ºç©ºç™½å—();

448 
	gem±y
 = å›æ”¶æœ€å†·å—();

450 
a¤t
(
em±y
 && 
li¡_em±y
Ğ&em±y->
wa™
 ));

451  
	gem±y
;

456 
	gli¡_h—d
 ç¼“å†²å—å…¨å±€é“¾;

464 
šlše
 å…¨å±€é“¾
	g_
æ·»åŠ (
bufãr_h—d
 *
	gÃw
){

465 
li¡_add_
(&
Ãw
->
Ìu
, &ç¼“å†²å—å…¨å±€é“¾);

466 å…¨å±€é“¾é•¿++; 
a¤t
(å…¨å±€é“¾é•¿ <= å…¨å±€é“¾å®¹é‡);

471 ç¼“å†²å—è„±é“¾(
bufãr_h—d
 *
	gbh
){

472 
li¡_d–
(&
bh
->
Ìu
);

473 
li¡_d–
(&
bh
->
hash
);

	@block/ll_rw_blk.c

3 
	~<lšux/blkdev.h
>

4 
	~<scheduË.h
>

5 
	~<uts.h
>

6 
	~<lšux/bufãr_h—d.h
>

8 
»que¡
 
	grq_¬r
[
MAX_REQUEST
];

9 
queue_g‘‹r
 
	gqueue_g‘‹rs
[
MAX_BLKDEV
];

11 
	$»gi¡”_queue_g‘‹r
(
majÜ
, 
g‘_queue_â
 *
g‘_queue
, *
d©a
){

12 
	`as£¹
(
majÜ
 < 
MAX_BLKDEV
 && major > 0);

13 
queue_g‘‹rs
[
majÜ
].
g‘_queue
 = get_queue;

14 
queue_g‘‹rs
[
majÜ
].
d©a
 = data;

15 
	}
}

21 
»que¡_queue
 * 
	$blk_g‘_queue
(
u16
 
dev_id
){

22 
queue_g‘‹r
 *
g‘‹r
 = &
queue_g‘‹rs
[
	`MAJOR
(
dev_id
)];

23 ià(
g‘‹r
->
g‘_queue
)

24  
g‘‹r
->
	`g‘_queue
(
dev_id
);

27  &
g‘‹r
->
»que¡_queue
;

28 
	}
};

32 
»que¡
 *
	$g‘_ä“_»que¡
(){

33 
i
 = 0; i < 
MAX_REQUEST
; i++){

34 if(
rq_¬r
[
i
].
dev_id
 == 0) „q_arr + i;

36 
	`as£¹
(0);

38 
	}
}

47 
	$g’”ic_mk_»que¡
(
rw
, 
bufãr_h—d
 *
bh
){

48 
	`şi_push
();

49 
majÜ
 = 
	`MAJOR
(
bh
->
dev_id
);

50 
»que¡
 * 
rq
 = 
	`g‘_ä“_»que¡
();

51 
rq
->
bh
 = bh;

52 
rq
->
dev_id
 = 
bh
->dev_id;

53 
rq
->
cmd
 = 
rw
;

54 
rq
->
¡¬t
 = 
bh
->
block
;

55 
rq
->
couÁ
 = 1;

56 
rq
->
buf
 = 
bh
->
d©a
;

57 
rq
->
ask”
 = 
cu¼’t
;

59 
blk_devs
[
majÜ
].
	`add_»que¡
(
rq
);

60 
	`æagi_pİ
();

61 
	}
}

64 
	$š™_blkÏy”_basic
(){

65 
i
 =0; i < 
MAX_BLKDEV
; i++){

68  
i
 = 0; i < 
MAX_REQUEST
; i++){

70 
	`INIT_LIST_HEAD
(&
rq_¬r
[
i
].
‹Áaşe
);

72 
	}
}

79 
	$Î_rw_block
(
rw
, 
bufãr_h—d
 *
bh
){

88 
u32
 
dev_id
 = 
bh
->dev_id;

89 
blk_un™
 *
un™
 = 
	`BLK_UNIT
(
dev_id
);

90 
u32
 
rw_¡¬t
 = 
	`block2lba
Ğ
bh
->
block
 );

91 
u32
 
rw_£ùÜs
 = 
	`block2£ùÜs
Ğ
bh
->
couÁ
 );

92 
u32
 
rw_’d
 = 
rw_¡¬t
 + 
rw_£ùÜs
;

93 if(
rw_’d
 <ğ
un™
->
tÙ®_£ùÜs
);

94 
	`¥š
("ll_rw out-of-boundray");

96 
bh
->
lock
 = 
Œue
;

97 
	`g’”ic_mk_»que¡
(
rw
, 
bh
);

99 
	}
}

	@boot.asm

1 ; 
The
 
memÜy
 
Ïyout
 
dŸg¿m
 
is
 
š
 
	gboÙšfo
.
	gasm


2 ;1 
sšgË
 
£gm’t
 
should
 
be
 
sm®Ër
 
	gthª
 64
	gKB


3 %
	gšşude
 "bootinfo.asm"

4 %
	gšşude
 "include/old/pm.inc"

5 %
	gšşude
 "include/old/utils.inc"

6 
	gÜg
 0x7c00

7 
addr_mbr_lßded
 
equ
 (
_ba£_k”Ãl_lßded
 - 512 * (
_boÙbš_occupy_£ùÜs
 + 
_fiximg_occupy_£ùÜs
))

8 [
b™s
 16]

9 
	gmbrH—d
:

10 
mov
 
ax
, 0xb800

11 
mov
 
	ggs
, 
ax


12 
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80,0,0,2,(
	g_boÙbš_occupy_£ùÜs
 + 
	g_fiximg_occupy_£ùÜs
 - 1),0,0x7e00 ;'-1' 
beÿu£
 
bios
 
has
 
®»ay
 
lßded
 
the
 
fœ¡
 
£ùÜ


13 
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80, 0,0,1,63,(
	gaddr_mbr_lßded
) >> 4, 0

14 
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80, 1,0,1,63,(
	gaddr_mbr_lßded
 + 512 * 63) >> 4, 0

15 
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80, 2,0,1,63,(
	gaddr_mbr_lßded
 + 512 * 63 * 2) >> 4, 0

16 
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80, 3,0,1,63,(
	gaddr_mbr_lßded
 + 512 * 63 * 3) >> 4, 0

17 
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80, 4,0,1,63,(
	gaddr_mbr_lßded
 + 512 * 63 * 4) >> 4, 0

18 ;
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80, 5,0,1,63,(
	gaddr_mbr_lßded
 + 512 * 63 * 5) >> 4, 0

19 ;
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80, 6,0,1,63,(
	gaddr_mbr_lßded
 + 512 * 63 * 6) >> 4, 0

20 ;
	g»ad_æİpy_side_o_£ùÜ_tÙ®_de¡§_de¡—
 0x80, 7,0,1,63,(
	gaddr_mbr_lßded
 + 512 * 63 * 7) >> 4, 0

21 ;å…±åº¦å–
	gk”Ãl
.
	g–f
 63 
	gx
 8 / 2 = 252
K
 ï¼Œè¿˜è¦å‡å»å‡ ä¸ªæ‰‡åŒºçš„
boÙ
.
bš
å’Œ
fix
.
img


22 ;
wh’
 
the
 
size
 
of
 
	gk”Ãl
.
–f
 
g‘s
 
şo£
 
	gto
 256
	gK
, 
we
 
	gÿn
't†oad it completely

23 
jmp
 
	g’Œªû


25 ;[
£ùiÚ
 .
gdt
]

26 ; 
GDT


27 
	ggdt
: 
DesütÜ
 0, 0, 0 ; 
nuÎ
 
	gdesütÜ


28 .
	gdesc_¶aš_c0
: 
DesütÜ
 0, 0fffff
	gh
, 
	gDA_32
 + 
	gDA_C
 + 
	gDA_LIMIT_4K


29 .
	gdesc_¶aš_d0
: 
DesütÜ
 0, 0fffff
	gh
, 
	gDA_DRW
 | 
	gDA_LIMIT_4K
 + 
	gDA_32


30 ; 
’d
 
of
 
	gGDT


32 ; 
the
 
£ËùÜ
 
cÜ»¥Úd
 
to
h
two
 
defšed
 
desütÜ
 
befÜe


33 
Ën_gdt
 
equ
 
	g$
 - 
	ggdt
 ; 
gdt
 
Ëngth


34 
£ËùÜ_¶aš_c0
 
equ
 
	ggdt
.
	gdesc_¶aš_c0
 - 
gdt


35 
£ËùÜ_¶aš_d0
 
equ
 
	ggdt
.
	gdesc_¶aš_d0
 - 
gdt


37 
	ggdtPŒ
:

38 
dw
 
Ën_gdt
 - 1 ; 
gdt
 
lim™s


39 
dd
 
	ggdt
 ; 
this
 
šdiÿ‹s
 
th©
 
gdt
 
mu¡
 
loÿ‹
 
©
 
mbr


42 
	g’Œªû
:

43 ;
lßd
 
	gdisk
 1

44 
jmp
 
»ad_ok


46 
	g»ad_”rÜ
:

47 
mov
 
bx
, 0xb800

48 
mov
 
	gds
,
bx


49 
mov
 
	g®
, '?'

50 
mov
 
	gah
, '?'

51 
mov
 
	gby‹
 [0], 
®


52 
mov
 
	gby‹
 [2], 
ah


53 
jmp
 
$


55 
	g»ad_ok
:

56 
mov
 
ax
, 
	g_ba£_k”Ãl_lßded
>>4

57 
mov
 
	ges
, 
ax


58 
mov
 
	gdi
, 0

59 
mov
 
	gcx
, 255

60 
mov
 
	gbx
, 0xb800

61 
mov
 
	gds
, 
bx


62 
mov
 
	gbx
, 0

63 
	gshow_–f
:

64 
mov
 
®
, [
es
:
di
]

65 
mov
 
by‹
 [
bx
], 
®


66 
add
 
	gbx
, 2

67 
šc
 
di


68 
loİ
 
	gshow_–f


70 ;
now
 
g‘
 
machše
 
physiÿl
 
memÜy
 
šfom©iÚ


71 
xÜ
 
	gax
, 
ax


72 
mov
 
	gds
, 
ax


73 
mov
 
	ges
, 
ax


74 
	gg‘_memÜy_šfÜm©iÚ
:

75 
mov
 
ebx
,0

76 
mov
 
	gdi
,
	gmem_£gšfo_¬r


77 .
	gloİ
:

78 
mov
 
—x
,0E820
h


79 
mov
 
	gecx
,20

80 
mov
 
	gedx
,0534D4150
h


81 15
h


82 
	gjc
 .
ç


83 
add
 
	gdi
,20

84 
šc
 
	gdwÜd
 [
mem_£gnum
]

85 
cmp
 
	gebx
,0

86 
	gjÃ
 .
loİ


87 
	gjmp
 .
	gdÚe


88 .
	gç
:

89 
mov
 
®
, 'X'

90 
mov
 
	gby‹
 [
gs
:0], 
®


91 
mov
 
	gby‹
 [
gs
:2], 
®


92 
jmp
 
	g$


93 .
	gdÚe
:

94 
jmp
 
mbr_ex‹nd


95 
times
 512-(
$
-
$$
è
db
 0

97 
mbr_ex‹nd
: ;
	g£ùÜ
 2,3,4 => 0x7d00,0x7e00,0x7f00

98 ; 
lßd
 
gdt


99 
mov
 
	gax
,0

100 
mov
 
	gds
,
ax


101 
	glgdt
 [
gdtPŒ
]

102 ;
ds
 
pošt
 
	gto
 [.
d©a
] 
š
 
	gk”Ãl
.
	gasm


104 ; 
şo£
 
the
 
	gš‹¼u±
, 
ªd
 
İ’
 
A20
 
to
 
g‘
h
add»ssšg
 
ab™y
 
	gbeyÚd
 1
	gM
.

105 
şi


106 
	gİ’A20
:

107 
š
 
®
, 92
h


108 
Ü
 
	g®
, 00000010b

109 
	gout
 92
	gh
, 
	g®


111 ; 
to
 
´ÙeùiÚ
 
mode


112 
	gsw™ch_´oMode
:

113 
mov
 
—x
, 
ü0


114 
Ü
 
	g—x
, 1 ; 
£t
 
	gCR0
's PE bit

115 
mov
 
	gü0
, 
—x


117 
mov
 
	gax
, 
£ËùÜ_¶aš_d0


118 
mov
 
	gds
,
ax


119 
mov
 
	ges
,
ax


120 
mov
 
	gss
,
ax


121 
jmp
 
dwÜd
 
	g£ËùÜ_¶aš_c0
:
fix_k”Ãl
 ;'jmp'-
İ”©iÚ
 
	gÃûs§ry
?

123 [
b™s
 32]

124 
	gfix_k”Ãl
:

125 ;
	gedi
æŒ‡å‘å†…æ ¸æ˜ åƒ, æ¯æ¬¡è·³512, æ€»æ˜¯æŒ‡åœ¨æ‰‡åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚

126 ;ä¹Ÿæ˜¯å–å®ƒçš„'de¡š©iÚ'ä¹‹æ„, 
	gfix
.
	gimg
é‡Œçš„
	gby‹
è¦ä¸€ä¸ªä¸ªè¡¥å›åˆ°
	gedi
æ‰€æŒ‡çš„åœ°æ–¹

127 
mov
 
	gedi
, 
	g_ba£_k”Ãl_lßded


128 ;
	gesi
æŒ‡å‘
	gfix
.
	gimg
, æ¯æ¬¡èµ°ä¸€ä¸ª
by‹


129 
mov
 
	gesi
, (
	g_fiximg_¡¬t_£ùÜ
 - 1) * 512 + 0x7c00

130 ;
	g—x
ç›¸å½“äº"æ‰‡åŒºåç§»", è¡¨ç¤ºä¿®æ­£åˆ°ç¬¬å‡ ä¸ªæ‰‡åŒº(ä»0è®¡æ•°)

131 
xÜ
 
	g—x
, 
—x


132 
mov
 
	gecx
, 0 ; !
	gboŞ—n
, 
šdiÿ‹s
 
the
 
Ï¡
 
£ùÜ
 
to
 
	gfix


133 .
	gcheck_Úe
:

134 ;æ³¨æ„, è¿™é‡Œæ¯”å¯¹çš„åªèƒ½æ˜¯
	g®
, ä½†ç¨å
	gšc
çš„ç¡®å®
	gax
, æˆ‘ä»¬æ˜¯æ•…æ„è®©å®ƒå›ç»•çš„.

135 
cmp
 
	gby‹
 [
edi
], 
	g®
 ;
check
 
magic
 
numb”


136 
	gje
 .
	gfix_™


137 ;é€’å¢åºç»ˆæ­¢, çœ‹çœ‹æ˜¯ä¸æ˜¯
	gk”Ãl
.
	g–f
çš„æœ€åä¸€ä¸ªæ‰‡åŒº

139 
cmp
 
	gby‹
 [
edi
], 0xcc

140 
	gjÃ
 .
	gbad
 ;å®Œäº†, 
	gk”Ãl
.
	gimg
çš„å†…å­˜æ˜ åƒåœ¨è¿™ä¸ªæ‰‡åŒºå‡ºé”™äº†

141 ;å¥½çš„, æ ¡éªŒé€šè¿‡, ç°åœ¨æ¥ä¿®æ­£
	gk”Ãl
.
	g–f
æœ€åä¸€ä¸ªæ‰‡åŒº

142 
mov
 
	gecx
, 1 ;æœ‰äº›æ—©ï¼Œä½†æ²¡äº‹ï¼Œå› ä¸ºå¦‚æœ
	gcouÁ
æ ¸å¯¹å¤±è´¥ï¼Œå°±æ­»å¾ªç¯äº†ã€‚

143 ;
šc
 
	gax
ä¹‹å,‡xçš„å€¼å°±ç›¸å½“äº
	gk”Ãl
.
	g–f
æ€»çš„æ‰‡åŒºæ•°é‡

144 
šc
 
ax


145 
cmp
 
	gwÜd
 [
esi
 + 1], 
	gax
 ;
	gesi
æ­¤æ—¶è¿˜æŒ‡å‘
	gfix
.
	gimg
çš„æœ€åä¸€ä¸ªç€è‰²
	gby‹
å¤‡ä»½

146 ;åœ¨å®ƒä¹‹å, ç´§è·Ÿçš„æ˜¯ä¸¤ä¸ª
	gby‹
çš„"æ€»æ‰‡åŒºæ•°"

147 ;æˆ‘ä»¬è¦è·Ÿ
	gax
æ¯”å¯¹ä¸€ä¸‹, è¿™æ˜¯ä¸€æ¬¡æ€»çš„æ ¡éªŒ

148 ;æ£€éªŒé€šè¿‡, è·³åˆ°
	gfix_™
, å°±ä¸å†å›æ¥äº†.å› ä¸º
	gecx
å·²ç»ç½®1

149 
	gje
 .
	gfix_™


150 .
	gbad
: 
jmp
 
$


151 .
fix_™
:

152 
mov
 
bl
, [
esi
]

153 
	gmov
 [
edi
], 
bl


154 
šc
 
esi


155 
šc
 
ax


156 
add
 
	gedi
, 512

157 
	gjcxz
 .
check_Úe


159 
	g»£t_k”Ãl
:

160 ;
ş—r
 
RAM
 .
bss


161 
mov
 
	gedi
,
ba£_k”Ãl_»£t


162 
mov
 
	g—x
,0

163 
mov
 
	gecx
,256*1024/4

164 
şd


165 
»p
 
	g¡osd


166 ; 
lßd
 
k”Ãl
 
	gäom
 0x8000
h


167 
mov
 
	gebx
, 
_ba£_k”Ãl_lßded


168 
mov
 
	gedx
,0

169 
mov
 
	gdx
, [
ebx
+42] ; 
e_ph’tsz


170 
mov
 
	gecx
,0

171 
mov
 
	gcx
, [
ebx
+44] ; 
e_phnum


172 
mov
 
	gebx
, [
ebx
+28]

173 
	g£¬ch_ph_ty³Lßded
:

174 
cmp
 
dwÜd
 [
_ba£_k”Ãl_lßded
 + 
ebx
], 1

175 
jÃ
 
doNÙhšg


176 
	gcySegm’t
:

177 
push
 
ecx


178 
mov
 
ecx
, [
_ba£_k”Ãl_lßded
 + 
ebx
 + 16]

179 
mov
 
	gesi
, [
_ba£_k”Ãl_lßded
 + 
ebx
 + 4]

180 
add
 
	gesi
, 
_ba£_k”Ãl_lßded


181 
mov
 
	gedi
, [
_ba£_k”Ãl_lßded
 + 
ebx
 + 8]

182 
ªd
 
	gedi
,0x0ffffffà;
	gmask
 '0xc003XXXX' 
	gto
 '0x0003XXXX'

183 
şd


184 
»p
 
movsb


185 
pİ
 
ecx


187 
	gdoNÙhšg
:

188 
add
 
ebx
,
edx


189 
loİ
 
£¬ch_ph_ty³Lßded


190 
	gk”Ãl_pg_m­
:

191 
şd


192 
mov
 
edi
,
	g_gpgdœ_ba£
+0xc00 ;
·ge
 
	gdœeùÜy
, å¯¹åº”äº†3
	gG
å¼€å§‹çš„å†…å­˜

193 
mov
 
	gecx
,224 ;åˆå§‹åŒ–224ä¸ª
	g’Œy
ï¼Œå¯¹åº”3
	gG
~3G+896
	gM
çš„å†…å­˜

194 
mov
 
	g—x
,0x101000|
	gPG_P
|
	gPG_USS
|
	gPG_RWW
 ;
’Œy
 
	gv®ue
ï¼Œå³é¡µè¡¨åœ°å€ï¼Œä»0x101000é€’å¢

195 .
	gfldœ
:

196 
¡osd


197 
add
 
—x
,0x1000

198 
	gloİ
 .
fldœ


199 
mov
 
	gecx
,0x400*224 ;224ä¸ª
·ge
 
	gbË
,æ¯ä¸ª·gbËæœ‰1024ä¸ª
’Œy


200 
mov
 
	g—x
,0|
	gPG_P
|
	gPG_USS
|
	gPG_RWW
 ;å¡«å……è¿™äº›
	g’Œy
,ä»0é€’å¢ã€‚è¡¨ç¤ºä»0åœ°å€å¼€å§‹
	gm­
.

201 
mov
 
	gedi
,0x101000

202 .
	gfÉbl
:

203 
¡osd


204 
add
 
—x
,0x1000

205 
	gloİ
 .
	gfÉbl


206 ;
	gm­
 0x7000~0x8ffà
	gnow


207 ;1~2
	gM
éƒ½æ˜¯
·ge
 
bË
(æœ€å¼€å§‹æ˜¯ä¸€ä¸ª
·gedœ
,æœ€æœ«å°¾æœ‰ä¸€æ®µæ²¡ç”¨)ï¼Œå®Œæˆäº†3
	gG
-3G,896M

208 ;å‘0~896
	gM
çš„æ˜ å°„ã€‚ æˆ‘ä»¬ä»æœ€æœ«å°¾åˆ†é…4
	gK
ï¼ˆè¿™ä¸ª
	g·ge
è‚¯å®šè¿˜æ²¡ç”¨ï¼Œå¾ˆå®‰å…¨)å½“ä½œé¡µè¡¨ï¼Œ

209 ;ç„¶åæŠŠè¿™ä¸ªé¡µè¡¨æ³¨å†Œåœ¨
·ge
 
	gdœeùÜy
çš„
	g’Œy
 0ï¼Œå®ƒå°±èƒ½æ˜ å°„è™šæ‹Ÿåœ°å€çš„0~4
	gM
äº†ï¼Œæˆ‘

210 ;ä»¬æƒ³æ˜ å°„çš„æ˜¯è™šå­˜åœ°å€çš„7c00~8fff,å› ä¸º
	gboÙ
.
	gbš
çš„ä»£ç åˆ†å¸ƒåœ¨(7c00+)ã€‚å› ä¸ºæ¥ä¸‹æ¥

211 ;
	gMMU
æ‰“å¼€ï¼Œæˆ‘ä»¬è¦èµ¶ç´§å®Œæˆè¿™ä¸ªå¯¹ç­‰æ˜ å°„ã€‚

212 
tmp_tbl_addr
 
	gequ
 0x200000-0x1000

213 
mov
 
	gdwÜd
 [
_gpgdœ_ba£
],
	gtmp_tbl_addr
|
	gPG_P
|
	gPG_USS
|
PG_RWW


214 
mov
 
	gdwÜd
 [
tmp_tbl_addr
+7*4],0x7000|
	gPG_P
|
	gPG_USS
|
PG_RWW


215 
mov
 
	gdwÜd
 [
tmp_tbl_addr
+8*4],0x8000|
	gPG_P
|
	gPG_USS
|
PG_RWW


217 
mov
 
	g—x
,
_gpgdœ_ba£


218 
mov
 
	gü3
,
	g—x
 ;
	g·ge
-
m­
 
aùive
 
now


219 
mov
 
	g—x
,
ü0


220 
Ü
 
	g—x
,0x80000000

221 
mov
 
	gü0
,
—x


222 
jmp
 
dwÜd
 
	g£ËùÜ_¶aš_c0
:
_ba£_’Œªû_k”Ãl


223 
times
 512-(
$
-
mbr_ex‹nd
è
db
 0

228 ; --13
h
 (
Ëaf
 8, 
‹¡
 
·¿m‘”
)

229 ; 
mov
 
	gah
, 8

230 ; 
mov
 
	gdl
, 0x80

231 ; 
mov
 
	gdi
, 0

232 ; 
mov
 
	ges
, 
	gdi


235 ; 
mov
 
	gbx
, 0xb800

236 ; 
mov
 
	gds
, 
	gbx


237 ; 
mov
 
	gbx
, 0

239 ; 
mov
 
	gby‹
 [
bx
], 'C'

241 ; 
mov
 
	gax
, 
	gcx


242 ; 
add
 
	gbx
, 2

243 ; 
mov
 
	gby‹
 [
bx
], 
	gah


244 ; 
shr
 
	g®
, 6

245 ; 
add
 
	gbx
, 2

246 ; 
mov
 
	gby‹
 [
bx
], 
	g®


247 ; 
add
 
	gbx
, 2

248 ; 
mov
 
	gby‹
 [
bx
], 'h'

249 ; 
add
 
	gbx
 , 2

250 ; 
add
 
	gdh
, '0'

251 ; 
mov
 
	gby‹
 [
bx
], 
	gdh


252 ; 
add
 
	gbx
, 2

253 ; 
mov
 
	gby‹
 [
bx
], 'd'

254 ; 
add
 
	gbx
, 2

255 ; 
add
 
	gdl
, '0'

256 ; 
mov
 
	gby‹
 [
bx
], 
	gdl


257 ; 
add
 
	gbx
, 2

258 ; 
mov
 
	gby‹
 [
bx
], 's'

259 ; 
mov
 
	gax
, 
	gcx


260 ; 
ªd
 
	g®
, 00111111b

261 ; 
add
 
	gbx
, 2

262 ; 
mov
 
	gby‹
 [
bx
], 
	g®


263 ; 
jmp
 
	g$


268 ;
mov
 
	gebx
, 0xb8000

269 ;
mov
 
	gax
, 
	gcx


270 ;
add
 
	g®
, '0'

271 ;
add
 
	gah
, '0'

272 ;
mov
 
	gby‹
 [
ebx
], 
	g®


273 ;
mov
 
	gby‹
 [
ebx
 + 2], 
	gah


274 ;
jmp
 
	g$


	@bootinfo.asm

1 ; 1, è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†å¯åŠ¨æ—¶çš„å…³é”®å‚æ•°ï¼šä¾‹å¦‚ä»å“ªä¸ªæ‰‡åŒºåŠ è½½
	gfix
.
	gimg
ï¼Œä»å“ªä¸ªæ‰‡åŒºå¼€å§‹

2 ; åŠ è½½
	gk”Ãl
.
	g–f
ã€‚

3 ; 2, è¿™äº›å‚æ•°æ˜¯ä»¥æ±‡ç¼–
equ
 
	gÏb–
çš„å½¢å¼å­˜åœ¨çš„ï¼Œå®ƒä»¬åˆ°äº†
	gC
è¯­è¨€é‡Œå°±æ˜¯å˜é‡ã€‚

4 ; 
	gboÙšfo
.
	gasm
åŒæ—¶å‚ä¸
	gboÙ
.
	gbš
å’Œ
	gk”Ãl
.
	g–f
çš„ç”Ÿæˆã€‚ ä»–ä½¿å¾—
	gC
è¯­è¨€èƒ½è®¿é—®åˆå§‹

7 ; [
Name
 
CÚv’tiÚ
]

8 ; 
	gÇsm
ä¸‹
	gequ
å½¢å¼çš„
	gÏb–
, åƒæ¯”
abc
ƒqu 0x7c00ï¼Œ æœ€ç»ˆè·Ÿ
	gC
è¯­è¨€é“¾æ¥æ—¶ï¼Œ
	gabc
ç›¸å½“äº
	gc
è¯­è¨€

9 ; é‡Œæ™®é€šçš„å˜é‡æ ‡ç­¾ã€‚ åœ¨
	gC
è¯­è¨€é‡Œï¼Œæˆ‘ä»¬å£°æ˜ 
abc
; 
´štf
("%d",‡bc);

10 ; æ‰“å°å‡ºæ¥çš„å°±æ˜¯0x7c00å¤„çš„ä¸€ä¸ª
	gdwÜd
ã€‚

11 ; æ‰€ä»¥æˆ‘ä»¬çº¦å®šï¼Œ ä»æ±‡ç¼–å¾€
	gC
é‡Œä¼ å˜é‡æ—¶ï¼Œå¦‚æœæƒ³ä¼ é€’çš„å°±æ˜¯ä¸€ä¸ªå˜é‡ï¼Œé‚£æ— æ‰€è°“ã€‚

12 ; ä½†å¦‚æœæƒ³ä¼ é€’çš„æ˜¯è¿™ä¸ªæ ‡ç­¾æœ¬èº«çš„
	gv®ue
ï¼Œå°±è¦å‘½åæˆ
	g_xxx
çš„å½¢å¼ã€‚å‰ä¸‹åˆ’çº¿ã€‚åˆ°äº†

13 é‡Œæˆ‘ä»¬è¿™æ ·ç”¨å®ƒ, #defšxxx ()&(_xxx)

14 ; 
S“
 
®so
 
	gboÙšfo
.
	gh


16 %
	gšşude
 "include/old/utils.inc"

19 ; | 256 
	gby‹s
 | 4b
	gy‹s
 |

20 ; |
	g_____________________________
|
	g________
|

22 ;| | 
	gmem_£gšfo
 | 
	g£gnum
 |

25 ;
	gÇsm
çš„ç»“æ„ä½“å¹¶ä¸å®ç”¨ï¼Œè¿™å„¿åªæ˜¯ç”¨å®ƒå¢åŠ å¯è¯»æ€§ã€‚

26 
¡ruc
 
	g»®mod_šfo_¡ru


27 .
	gmem_£gnum
: 
»sb
 4

28 .
mem_£gšfo_¬r
: 
»sb
 256

29 
’d¡ruc


31 
gequ
 
»®mod_šfo
, 0x6000

32 
mem_£gnum
 
equ
 
	g»®mod_šfo
 + 
	g»®mod_šfo_¡ru
.mem_segnum

33 
mem_£gšfo_¬r
 
equ
 
	g»®mod_šfo
 + 
	g»®mod_šfo_¡ru
.
	gmem_£gšfo_¬r


35 ;æ‰‡åŒºæ˜¯ä»1å¼€å§‹è®¡æ•°çš„ï¼Œåˆ°äº†
	gdimg
.
	gc
é‡Œè¦å‡1ï¼Œå› ä¸º
	gdd
æ˜¯ä»0å¼€å§‹è®¡æ•°çš„ã€‚

38 ; 
	g_______________________________________________________________________


39 ;
	g£ùÜ
| 1 | 2 | 3 | 4 | 5 | 6 | 7 | | | |

40 ; |
	g______boÙ
.
	gbš______
|
	g_fix__
|
	g_____k”Ãl
.
	g–f__________________________
|

43 
gequ
 
	g_boÙbš_¡¬t_£ùÜ
, 1

44 
gequ
 
	g_boÙbš_occupy_£ùÜs
,3

45 
gequ
 
	g_fiximg_¡¬t_£ùÜ
, 
	g_boÙbš_¡¬t_£ùÜ
 + 
_boÙbš_occupy_£ùÜs


46 
gequ
 
	g_fiximg_occupy_£ùÜs
, 1

47 
gequ
 
	g_k”Ãl_image_¡¬t_£ùÜ
, (
	g_fiximg_¡¬t_£ùÜ
 + 
	g_fiximg_occupy_£ùÜs
)

49 
gequ
 
	g_gpgdœ_ba£
,0x100000

51 
Ëqu
 
	g_ba£_k”Ãl_lßded
,0x60000

52 
ba£_k”Ãl_»£t
 
	gequ
 0x10400

53 
Ëqu
 
	g_ba£_’Œªû_k”Ãl
,
	gba£_k”Ãl_»£t
+0xc0000000

55 
gequ
 
	gRAMDISK_BASE
, 0x10000

	@drivers/ide/ide.c

7 
	~<lšux/ide.h
>

8 
	~<œq.h
>

9 
	~<scheduË.h
>

10 
	~<lšux/bufãr_h—d.h
>

12 
»que¡
 * 
ide_g‘_Ãxt_rq
(
ide_hwif
 *
hwif
);

13 
ide_do_»que¡
(
u32
 
dev_id
);

19 
	#DEVICE_NR
(
dev_id
è(
	`MINOR
(dev_idè/ 64)

	)

21 
	#CURR_HWIF
(
dev_id
è(
ide_hwifs
 + 
	`chªÃl_id
(dev_id))

	)

22 
	#MAX_HWIFS
 3

	)

26 
ide_hwif
 
	gide_hwifs
[
MAX_HWIFS
] = {

28 .
io_pÜts
={0x1f0, 0x1f1,0x1f2,0x1f3,0x1f4,0x1f5,0x1f6,0x1f7,0x3f6},

31 .
io_pÜts
={0x170, 0x171,0x172,0x173,0x174,0x175,0x176,0x177,0x3f6},

35 
add_»que¡
(
»que¡
 * 
rq
);

38 
	$chªÃl_id
(
dev_id
){

39  
	`MAJOR
(
dev_id
) / 22;

40 
	}
}

41 
»que¡
 *
	$‹Áaşe2»que¡
(
li¡_h—d
 *
h—d
){

42  
	`MB2STRU
(
»que¡
, 
h—d
, 
‹Áaşe
);

43 
	}
}

46 * 
	$ide_id’tify
(
u32
 
dev_id
){

47 
»que¡
 * 
rq
;

49 
IF
 = 
	`şi_ex
();

52 
rq
 = 
	`km®loc0
ĞĞ
»que¡
) );

53 
rq
->
dev_id
 = dev_id;

54 
rq
->
buf
 = 
	`__®loc_·ge
(
__GFP_ZERO
);

55 
rq
->
cmd
 = 
WIN_IDENTIFY
;

56 
rq
->
ask”
 = 
cu¼’t
;

57 
	`add_»que¡
(
rq
);

58 
	`kp_¦“p
(0, 0);

60 if(
IF
è
	`¡i
();

61  (*)
rq
->
buf
;

62 
	}
}

72 
	$glob®2loÿl
(
u32
 *
_dev
, 
ulÚg
 *
_block
){

73 
blk_dev
 *
blkdev
;

74 
blk_un™
 **
un™s
;

76 
u32
 
dev
 = *
_dev
;

77 
ulÚg
 
block
 = *
_block
;

78 
u32
 
majÜ
 = 
	`MAJOR
(
dev
);

79 
u32
 
mšÜ
 = 
	`MINOR
(
dev
);

80 
blkdev
 = 
blk_devs
 + 
majÜ
;

81 
un™s
 = 
blkdev
->un™s; 
	`a¤t
(un™s[
mšÜ
]);

82 if(!
un™s
[
mšÜ
]->
hªzi
) ;

86 
i
 = 
mšÜ
 % 
blkdev
->
un™cyşe
 + 1;

87 
i
 < 
blkdev
->
un™cyşe
; i++)

89 
blk_un™
 *
un™
 = 
blkdev
->
un™s
[ 
mšÜ
 + 
i
];

90 if(!
un™
) ;

92 
lba_off£t
 = 
	`block2lba
(
block
è- 
un™
->
¡¬t_£ùÜ
;

93 if(
lba_off£t
 >= 0 &&

94 
lba_off£t
 < 
	`block2£ùÜs
(
un™
->
tÙ®_£ùÜs
))

95 { 
u32
 
Ãwdev
 = 
	`MKDEV
(
majÜ
, 
mšÜ
 + 
i
);

96 
	`İrštf
(">>»dœeù %xØ%x:%x>>>", 
dev
,

97 
Ãwdev
, 
lba_off£t
 / 
BLOCK_SECTORS
);

98 *
_dev
 = 
	`MKDEV
(
majÜ
, 
mšÜ
 + 
i
);

99 *
_block
 = 
lba_off£t
 / 
BLOCK_SECTORS
;

100 if(
un™
->
hªzi
è
	`glob®2loÿl
(
_dev
, 
_block
);

103 
	}
}

105 
	$ide_’d_»que¡
(
ide_hwif
 *
hwif
){ 
	`as£¹
(hwif->
cur_rq
);

106 
bufãr_h—d
 *
bh
;

107 
»que¡
 *
to_d–
;

109 
to_d–
 = 
hwif
->
cur_rq
;

110 
bh
 = 
to_d–
->bh;

111 
hwif
->
cur_rq
 = 
	`ide_g‘_Ãxt_rq
(hwif);

112 
	`li¡_d–_š™
(&
to_d–
->
‹Áaşe
);

113 
to_d–
->
dev_id
 = 0;

114 
hwif
->
hªdËr
 = 0;

116 
bh
->
lock
 = 
çl£
;

117 
bh
->
dœty
 = 
çl£
;

118 
bh
->
io
 = 
Œue
;

120 
	`wake_up
(&
bh
->
wa™
);

121 
	}
}

123 
	$wš_»suÉ
(
ide_hwif
 *
hwif
){

124 
i
 = 
	`š_by‹
(
hwif
->
io_pÜts
[
SLOT_REG_STATUS
]);

125 ifĞ(
i
 & (
STATUS_BUSY
 | 
STATUS_READY
 | 
STATUS_WRERR
 | 
STATUS_SEEK
 | 
STATUS_ERR
)) == (STATUS_READY | STATUS_SEEK) ) \

127 if(
i
 & 
STATUS_ERR
è˜ğ
	`š_by‹
(
hwif
->
io_pÜts
[
SLOT_REG_ERROR
]);

128  
i
;

129 
	}
}

130 
	$id’tify_šŒ
(
ide_hwif
 *
hwif
){

131 
	`a¤t
Ğ
	`wš_»suÉ
Ğ
hwif
) == 0);

132 
»que¡
 *
cur_rq
 = 
hwif
->cur_rq;

133 
	`pÜt_»ad
(
hwif
->
io_pÜts
[
SLOT_REG_DATA
], 
cur_rq
->
buf
, 512);

135 
hwif
->
cur_rq
 = 
	`ide_g‘_Ãxt_rq
(hwif);

136 
	`li¡_d–_š™
(&
cur_rq
->
‹Áaşe
);

137 
hwif
->
hªdËr
 = 0;

139 
	`¦“p_aùive
(
cur_rq
->
ask”
);

140 
	`ide_do_»que¡
(
cur_rq
->
dev_id
);

141 
	}
}

144 
	$»ad_šŒ
(
ide_hwif
 *
hwif
){

145 if(
	`wš_»suÉ
(
hwif
)){

146 
	`as£¹
(0);

149 
»que¡
 *
cur_rq
 = 
hwif
->cur_rq;

151 
	`pÜt_»ad
(
hwif
->
io_pÜts
[
SLOT_REG_DATA
], 
cur_rq
->
buf
, 512);

152 if(--
cur_rq
->
couÁ
){

153 
cur_rq
->
buf
 += 512;

154 
	`İrštf
("%c", 0xfe);

157 
	`ide_’d_»que¡
(
hwif
);

158 
	`ide_do_»que¡
(
cur_rq
->
dev_id
);

159 
	}
}

161 
	$wr™e_šŒ
(
ide_hwif
 *
hwif
){

162 if(
	`wš_»suÉ
(
hwif
)){

163 
	`as£¹
(0);

165 
»que¡
 *
cur_rq
 = 
hwif
->cur_rq;

166 if(--
cur_rq
->
couÁ
){

167 
cur_rq
->
buf
 += 512;

169 
	`pÜt_wr™e
(
hwif
->
io_pÜts
[
SLOT_REG_DATA
], 
cur_rq
->
buf
, 512);

172 
	`ide_’d_»que¡
(
hwif
);

173 
	`ide_do_»que¡
(
cur_rq
->
dev_id
);

174 
	}
}

176 
	$ide_šŒ
(
œq
, *
_hwif
, 
±_»gs
 *
»g
){

177 
	`as£¹
(((
ide_hwif
 *)
_hwif
)->
hªdËr
);

179 ((
ide_hwif
*)
_hwif
)->
	`hªdËr
(_hwif);

180 
	}
}

184 
ide_drive
 *
	$g‘_šfo_±r
(
u16
 
dev_id
){

185 
un™
 = 
	`DEVICE_NR
(
dev_id
);

186 
chªÃl
 = 
	`chªÃl_id
(
dev_id
);

187  &
ide_hwifs
[
chªÃl
].
drive
[
un™
];

188 
	}
}

191 
	$hd_out
(*
io_pÜts
, 
cmd
, 
drv
, 
lba
, 
couÁ
, *
buf
){

192 
	`š_by‹
(
io_pÜts
[
SLOT_REG_STATUS
]è& 
STATUS_BUSY
è
	`İrštf
("@hd_out waiting on IDE controllor's BSY-bit\n");

193 
	`İrštf
("writing IDE„egisters\n");

196 
lba
 *
lba_¡ru
 = (lba *)(&lba);

197 
£Ëù
 * s–eù = &(
lba_¡ru
->select);

198 
£Ëù
->
drv
 = drv;

199 
£Ëù
->
lba
 = 1;

200 
£Ëù
->
b™5
 = s–eù->
b™7
 = 1;

202 
	`out_by‹
(
io_pÜts
[
SLOT_REG_CONTROL
],0);

204 
	`out_by‹
(
io_pÜts
[
SLOT_REG_FEATURES
], 0);

205 
	`out_by‹
(
io_pÜts
[
SLOT_REG_COUNT
],
couÁ
);

206 
	`out_by‹
(
io_pÜts
[
SLOT_REG_LBA_LOW
],
lba_¡ru
->
low
);

207 
	`out_by‹
(
io_pÜts
[
SLOT_REG_LBA_MID
],
lba_¡ru
->
middË
);

208 
	`out_by‹
(
io_pÜts
[
SLOT_REG_LBA_HIGH
],
lba_¡ru
->
high
);

209 
	`out_by‹
(
io_pÜts
[
SLOT_REG_DEVICE
], *(
u8
 *)
£Ëù
);

210 
	`out_by‹
(
io_pÜts
[
SLOT_REG_COMMAND
], 
cmd
);

211 
	}
}

214 
	$__¡¬t_»que¡
(
»que¡
 *
rq
){

215 
ù¾
;

216 
ide_hwif
 *
hwif
 = &
ide_hwifs
[
	`chªÃl_id
(
rq
->
dev_id
)];

217 if(
rq
->
cmd
 =ğ
READ
){

218 
ù¾
 = 
WIN_READ
;

219 
hwif
->
hªdËr
 = 
»ad_šŒ
;

221 if(
rq
->
cmd
 =ğ
WRITE
){

222 
ù¾
 = 
WIN_WRITE
;

223 
hwif
->
hªdËr
 = 
wr™e_šŒ
;

225 if(
rq
->
cmd
 =ğ
WIN_IDENTIFY
){

226 
hwif
->
hªdËr
 = 
id’tify_šŒ
;

227 
ù¾
 = 
WIN_IDENTIFY
;

229 
	`as£¹
(0);

232 if(
ù¾
 !ğ
WIN_IDENTIFY
){

233 
rq
->
¡¬t
 = 
	`BLK_UNIT
Ôq->
dev_id
)->
¡¬t_£ùÜ
 + 
	`block2£ùÜs
(rq->start);

234 
rq
->
couÁ
 *ğ
BLOCK_SECTORS
;

236 
	`hd_out
(
hwif
->
io_pÜts
, 
ù¾
, 
	`DEVICE_NR
(
rq
->
dev_id
),rq->
¡¬t
,„q->
couÁ
,„q->
buf
);

239 if(
rq
->
cmd
 =ğ
WRITE
){

240 
i
;

241 
wa™šg
 = 3000 * 100;

242 
i
 = 0; i < 
wa™šg
 && 
STATUS_DRQ
 == 0; i++);

243 
	`as£¹
(
i
 !ğ
wa™šg
 && "waiting DRQ changeso 1, overtime ");

244 
	`pÜt_wr™e
(
hwif
->
io_pÜts
[
SLOT_REG_DATA
], 
rq
->
buf
, 512);

248 
	}
}

252 
	$ide_do_»que¡
(
u32
 
dev_id
){

255 
ide_hwif
 *
hwif
 = 
ide_hwifs
 + 
	`chªÃl_id
(
dev_id
);

256 if(!
hwif
->
cur_rq
){

258 
em±y_couÁ
;

259 
	`İrštf
("[E %u] ", 
em±y_couÁ
++);

262 
	`__¡¬t_»que¡
(
hwif
->
cur_rq
);

263 
	}
}

265 
»que¡_queue
 * 
	$ide_g‘_queue
(
u16
 
dev_id
){

266 
ide_drive
 * 
drive
 = 
	`g‘_šfo_±r
(
dev_id
);

267 if(
drive
è &drive->
queue
;

269 
	}
}

271 
	$add_»que¡
(
»que¡
 * 
rq
){

272 
dev_id
 = 
rq
->dev_id;

273 
majÜ
 = 
	`MAJOR
(
dev_id
);

274 
»que¡_queue
 *
q
 = 
	`blk_g‘_queue
(
dev_id
);

275 
ide_hwif
 * 
hwif
 = 
ide_hwifs
 + 
	`chªÃl_id
(
dev_id
);

277 
	`şi_push
();

278 
	`li¡_add
(&
rq
->
‹Áaşe
, &
q
->
queue_h—d
);

279 
	`æagi_pİ
();

280 if(!
hwif
->
cur_rq
){

281 
hwif
->
cur_rq
 = 
rq
;

282 
blk_devs
[
majÜ
].
	`do_»que¡
(
dev_id
);

284 
	}
}

293 
	$ide_»ad_·¹©iÚ
(
majÜ
, 
drive
){

294 
bufãr_h—d
 *
ebr_block
 = 0,

295 *
mbr_block
 = 0;

296 
blk_dev
 *
blkdev
 = &
blk_devs
[
majÜ
];

297 
blk_un™
 **
un™s
 = 
blkdev
->units;

299 if(!
un™s
è{ 
	`as£¹
(
blkdev
->
un™max
 == 128);

300 
un™s
 = (*)
	`km®loc0
(4 * 
blkdev
->
un™max
);

301 
blkdev
->
un™s
 = units;

304 
i
 = 
drive
 * 
blkdev
->
un™cyşe
;

305 
disk_devid
 = 
	`MKDEV
(
majÜ
, 
i
);

306 
u16
 *
disk_šfo
 = 
	`ide_id’tify
(
disk_devid
);

307 
u32
 
disk_£ùÜs
 = *(u32 *)(
disk_šfo
+60);

310 if(!
un™s
[
i
])

311 
un™s
[
i
] = 
	`km®loc0
((
blk_un™
));

312 
un™s
[
i
]->
¡¬t_£ùÜ
 = 0;

313 
un™s
[
i
]->
tÙ®_£ùÜs
 = 
disk_£ùÜs
;

314 
un™s
[
i
]->
hªzi
 = 
Œue
;

315 
	`»gi¡”_blkun™
Ğ
un™s
[
i
], 
disk_devid
 );

317 
mbr_block
 = 
	`mm­_disk
(
disk_devid
, 0); 
	`a¤t
(mbr_block);

318 *
mbr
 = 
mbr_block
->
d©a
;

320 
·¹™iÚ
 *
dp
 = (*)(
mbr
 + 446);

321 
ebr_lba
 = 0;

323 
i
 = 0; i <=3; i++){

324 
uid
 = 
i
 + 64*
drive
 + 1;

325 if(
dp
[
i
].
¡¬t_£ùÜ
 == 0)

327 if(!
un™s
[
uid
])

328 
un™s
[
uid
] = 
	`km®loc
Ğ(
blk_un™
) );

329 
un™s
[
uid
]->
¡¬t_£ùÜ
 = 
dp
[
i
].start_sector;

330 
un™s
[
uid
]->
tÙ®_£ùÜs
 = 
dp
[
i
].total_sectors;

331 
un™s
[
uid
]->
hÙabË
 = 0;

333 if(
dp
[
i
].
sys_id
 =ğ
SYSID_EXTEND
) {

334 
ebr_lba
 = 
dp
[
i
].
¡¬t_£ùÜ
;

335 
un™s
[
uid
]->
hªzi
 = 
Œue
;

337 
un™s
[
uid
]->
hªzi
 = 
çl£
;

338 
	`»gi¡”_blkun™
(
un™s
[
uid
], 
	`MKDEV
(
majÜ
, uid));

343 
Ãxt_ebr
:

344 if(
ebr_lba
 =ğ0è
dÚe
; 
	`İrštf
("\nread‚extƒbr");

346 if(
ebr_block
è
	`munm­_disk
(ebr_block);

347 
ebr_block
 = 
	`mm­_disk
(
disk_devid
, 
	`lba2block
(
ebr_lba
) );

348 
dp
 = (*)(
ebr_block
->
d©a
 + 446);

349 
uid
 = 
i
 + 64 * 
drive
 + 1;

350 
	`as£¹
(
dp
[0].
¡¬t_£ùÜ
);

352 if(!
un™s
[
uid
])

353 
un™s
[
uid
] = 
	`km®loc
Ğ(
blk_un™
));

354 
un™s
[
uid
]->
¡¬t_£ùÜ
 = 
ebr_lba
 + 
dp
[0].start_sector;

355 
un™s
[
uid
]->
tÙ®_£ùÜs
 = 
dp
[0].total_sectors;

358 
	`»gi¡”_blkun™
Ğ
un™s
[
uid
], 
	`MKDEV
(
majÜ
, uid) );

359 if(
dp
[1].
¡¬t_£ùÜ
è
ebr_lba
 += dp[1].start_sector;

360 
ebr_lba
 = 0;

361 
i
++;

362 
Ãxt_ebr
;

363 
dÚe
:

364 if(
ebr_block
è
	`munm­_disk
(ebr_block);

365 if(
mbr_block
è
	`munm­_disk
(mbr_block);

367 
	}
}

369 
	$ide_š™
(){

370 
	`»gi¡”_queue_g‘‹r
(3, 
ide_g‘_queue
, 0);

371 
	`»gi¡”_queue_g‘‹r
(22, 
ide_g‘_queue
, 0);

372 
i
 = 0; i < 
MAX_HWIFS
; i++){

373 
j
 = 0; j <=1; j++){

374 
	`INIT_LIST_HEAD
(&
ide_hwifs
[
i
].
drive
[
j
].
queue
.
queue_h—d
);

378 
ide_hwifs
[0].
drive
[0].
´e£Á
 = 1;

379 
ide_hwifs
[0].
drive
[1].
´e£Á
 = 1;

380 
	`»que¡_œq
(0xe, 
ide_šŒ
, 
SA_INTERRUPT
, 
ide_hwifs
);

381 
œq_desc
[0xe].
¡©us
 &ğ~
IRQ_DISABLED
;

383 
blk_devs
[3].
do_»que¡
 = 
ide_do_»que¡
;

384 
blk_devs
[3].
add_»que¡
 =‡dd_request;

385 
blk_devs
[3].
glob®2loÿl
 = global2local;

387 
blk_devs
[22].
do_»que¡
 = 
ide_do_»que¡
;

388 
blk_devs
[22].
add_»que¡
 =‡dd_request;

389 
blk_devs
[22].
glob®2loÿl
 = global2local;

390 
blk_devs
[3].
un™max
 = 128;

391 
blk_devs
[3].
un™cyşe
 = 64;

392 
blk_devs
[22].
un™max
 = 128;

393 
blk_devs
[22].
un™cyşe
 = 64;

395 
	}
}

400 
»que¡
 * 
	$ide_g‘_Ãxt_rq
(
ide_hwif
 *
hwif
){

401 
»que¡
 *
cur_rq
 = 
hwif
->cur_rq;

402 if(
cur_rq
){

403 
»que¡_queue
 *
curq
 = 
	`ide_g‘_queue
(
cur_rq
->
dev_id
);

404 if(!
	`li¡_m“t_
(&
curq
->
queue_h—d
, &
cur_rq
->
‹Áaşe
))

405  
	`‹Áaşe2»que¡
(
cur_rq
->
‹Áaşe
.
Ãxt
);

410 
i
 = 0; i <=1; i++){

411 if(
hwif
->
drive
[
i
].
´e£Á
 =ğ
çl£
) ;

412 
»que¡_queue
 * 
q
 = &
hwif
->
drive
[
i
].
queue
;

413 if(
	`li¡_em±y
(&
q
->
queue_h—d
)) ;

414 
»que¡
 * 
rq
 = 
	`‹Áaşe2»que¡
(
q
->
queue_h—d
.
Ãxt
);

415 if(
rq
 !ğ
cur_rq
) „q;

418 
	}
}

	@drivers/net/8139.c

9 
	~<lšux/pci.h
>

10 
	~<asm/io.h
>

11 
	~<lšux/Ãtdeviû.h
>

12 
	~<œq.h
>

13 
	~<lšux/¦ab.h
>

14 
	~<mm.h
>

15 
	~<lšux/skbuff.h
>

16 
	~<lšux/bh.h
>

17 
	#PRIV
(
Ãtdev
è((
¹l8139_´iv©e
*)Ò‘dev->
´iv©e
))

	)

18 
	#__´iv
(
Ãtdev
è((
¹l8139_´iv©e
 *ê‘dev->
´iv©e
)

	)

19 
	#ETH_MIN_LEN
 60

	)

20 
	#NUM_TX_DESC
 4

	)

21 
	#TX_BUF_SIZE
 (1762 & ~3è

	)

24 
	s¹l8139_´iv©e
{

25 
pci_dev
 *
	mpcidev
;

26 *
	mmmio_addr
;

27 
	m»gs_Ën
;

28 
	mtx_æags
;

29 
	mtou£_desc
;

30 
	mbsy_desc
;

31 *
	mtx_bufs
[
NUM_TX_DESC
];

32 *
	mtx_buf
;

33 *
	mtx_buf_dma
;

34 
u16
 
	mtxbuf_size
;

37 
u8
 *
	mrx_ršg
;

38 *
	mrx_ršg_dma
;

39 
	mrx_ršg_Ën
;

40 
	mcursÜ_r
;

45 
šlše
 
	$RTL_maskb
(
Ãt_deviû
 *
Ãtdev
, 
off£t
, 
mask
){

46 
	`maskb
(
Ãtdev
->
ba£_addr
 + 
off£t
, 
mask
);

47 
	}
}

48 
šlše
 
	$RTL_maskw
(
Ãt_deviû
 *
Ãtdev
, 
off£t
, 
mask
){

49 
	`maskw
(
Ãtdev
->
ba£_addr
 + 
off£t
, 
mask
);

50 
	}
}

51 
šlše
 
	$RTL_maskl
(
Ãt_deviû
 *
Ãtdev
, 
off£t
, 
mask
){

52 
	`maskl
(
Ãtdev
->
ba£_addr
 + 
off£t
, 
mask
);

53 
	}
}

56 
šlše
 
	$RTL_»adb
(
Ãt_deviû
 *
Ãtdev
, 
off£t
){

57  
	`»adb
(
Ãtdev
->
ba£_addr
 + 
off£t
);

58 
	}
}

59 
šlše
 
	$RTL_»adw
(
Ãt_deviû
 *
Ãtdev
, 
off£t
){

60  
	`»adw
(
Ãtdev
->
ba£_addr
 + 
off£t
);

61 
	}
}

62 
šlše
 
	$RTL_»adl
(
Ãt_deviû
 *
Ãtdev
, 
off£t
){

63  
	`»adl
(
Ãtdev
->
ba£_addr
 + 
off£t
);

64 
	}
}

68 
šlše
 
	$RTL_wr™eb
(
Ãt_deviû
 *
Ãtdev
, 
off£t
, 
v®ue
){

69 
	`wr™eb
(
Ãtdev
->
ba£_addr
 + 
off£t
, 
v®ue
);

70 
	}
}

71 
šlše
 
	$RTL_wr™ew
(
Ãt_deviû
 *
Ãtdev
, 
off£t
, 
v®ue
){

72 
	`wr™ew
(
Ãtdev
->
ba£_addr
 + 
off£t
, 
v®ue
);

73 
	}
}

74 
šlše
 
	$RTL_wr™–
(
Ãt_deviû
 *
Ãtdev
, 
off£t
, 
v®ue
){

75 
	`wr™–
(
Ãtdev
->
ba£_addr
 + 
off£t
, 
v®ue
);

76 
	}
}

78 
	scÚfig
{

79 
u8
 
	mmac
[7];

80 
u32
 
	m
;

81 
u32
 
	mg©eway_
;

82 
u32
 
	mmask
;

83 } 
	gcÚfigs
[] ={

86 
MAKE_IP
(192, 168, 0, 9),

87 
MAKE_IP
(192, 168, 0, 1),

92 
MAKE_IP
(192, 168, 1, 9),

93 
MAKE_IP
(192, 168, 1, 1),

99 
pci_deviû_id
 
	g¹l8139_id_tbl
[] = {

124 
	eRTL8139_»gi¡”s
 {

125 
	mMAC0
 = 0,

126 
	mMAR0
 = 8,

127 
	mTxStus0
 = 0x10,

128 
	mTxAddr0
 = 0x20,

129 
	mRBSTART
 = 0x30,

130 
	mChCmd
 = 0x37,

131 
	mCursÜToR—d
 = 0x38,

132 
	mCursÜToRecv
 = 0x3A,

133 
	mIMR
 = 0x3C,

134 
	mISR
 = 0x3E,

135 
	mTxCÚfig
 = 0x40,

136 
	mRxCÚfig
 = 0x44,

137 
	mTim”
 = 0x48,

138 
	mRxMis£d
 = 0x4C,

139 
	mCfg9346
 = 0x50,

140 
	mCÚfig0
 = 0x51,

141 
	mCÚfig1
 = 0x52,

142 
	mTim”IÁ
 = 0x54,

143 
	mMedŸStus
 = 0x58,

144 
	mCÚfig3
 = 0x59,

145 
	mCÚfig4
 = 0x5A,

146 
	mHÉClk
 = 0x5B,

147 
	mMuÉiIÁr
 = 0x5C,

148 
	mTxSumm¬y
 = 0x60,

149 
	mBasicModeCŒl
 = 0x62,

150 
	mBasicModeStus
 = 0x64,

151 
	mNWayAdv”t
 = 0x66,

152 
	mNWayLPAR
 = 0x68,

153 
	mNWayEx·nsiÚ
 = 0x6A,

155 
	mFIFOTMS
 = 0x70,

156 
	mCSCR
 = 0x74,

157 
	mPARA78
 = 0x78,

158 
	mFÏshReg
 = 0xD4,

159 
	mPARA7c
 = 0x7c,

160 
	mCÚfig5
 = 0xD8,

163 
	eChCmdB™s
 {

164 
	mCmdRe£t
 = 0x10,

165 
	mCmdRxEnb
 = 0x08,

166 
	mCmdTxEnb
 = 0x04,

167 
	mRxBufEm±y
 = 0x01,

172 
	eIÁrStusB™s
 {

173 
	mPCIE¼
 = 0x8000,

174 
	mPCSTimeout
 = 0x4000,

175 
	mCabL’Chg
 = 0x2000,

176 
	mRxFIFOOv”
 = 0x40,

177 
	mRxUnd”run
 = 0x20,

178 
	mRxOv”æow
 = 0x10,

179 
	mTxE¼
 = 0x08,

180 
	mTxOK
 = 0x04,

181 
	mRxE¼
 = 0x02,

182 
	mRxOK
 = 0x01,

184 
	mRxAckB™s
 = 
RxFIFOOv”
 | 
RxOv”æow
 | 
RxOK
,

187 
	eTxStusB™s
 {

188 
	mTxHo¡Owns
 = 0x2000,

189 
	mTxUnd”run
 = 0x4000,

190 
	mTxStOK
 = 0x8000,

191 
	mTxOutOfWšdow
 = 0x20000000,

192 
	mTxAbÜ‹d
 = 0x40000000,

193 
	mTxC¬r›rLo¡
 = 0x80000000,

195 
	eRxStusB™s
 {

196 
	mRxMuÉiÿ¡
 = 0x8000,

197 
	mRxPhysiÿl
 = 0x4000,

198 
	mRxBrßdÿ¡
 = 0x2000,

199 
	mRxBadSymbŞ
 = 0x0020,

200 
	mRxRuÁ
 = 0x0010,

201 
	mRxTooLÚg
 = 0x0008,

202 
	mRxCRCE¼
 = 0x0004,

203 
	mRxBadAlign
 = 0x0002,

204 
	mRxStusOK
 = 0x0001,

208 
	erx_mode_b™s
 {

209 
	mAcû±E¼
 = 0x20,

210 
	mAcû±RuÁ
 = 0x10,

211 
	mAcû±Brßdÿ¡
 = 0x08,

212 
	mAcû±MuÉiÿ¡
 = 0x04,

213 
	mAcû±MyPhys
 = 0x02,

214 
	mAcû±AÎPhys
 = 0x01,

218 
	etx_cÚfig_b™s
 {

220 
	mTxIFGShiá
 = 24,

221 
	mTxIFG84
 = (0 << 
TxIFGShiá
),

222 
	mTxIFG88
 = (1 << 
TxIFGShiá
),

223 
	mTxIFG92
 = (2 << 
TxIFGShiá
),

224 
	mTxIFG96
 = (3 << 
TxIFGShiá
),

226 
	mTxLoİBack
 = (1 << 18) | (1 << 17),

227 
	mTxCRC
 = (1 << 16),

228 
	mTxCË¬Abt
 = (1 << 0),

229 
	mTxDMAShiá
 = 8,

230 
	mTxR‘ryShiá
 = 4,

232 
	mTxV”siÚMask
 = 0x7C800000,

235 
	eRxCÚfigB™s
 {

237 
	mRxCfgFIFOShiá
 = 13,

238 
	mRxCfgFIFONÚe
 = (7 << 
RxCfgFIFOShiá
),

241 
	mRxCfgDMAShiá
 = 8,

242 
	mRxCfgDMAUÆim™ed
 = (7 << 
RxCfgDMAShiá
),

245 
	mRxCfgRcv8K
 = 0,

246 
	mRxCfgRcv16K
 = (1 << 11),

247 
	mRxCfgRcv32K
 = (1 << 12),

248 
	mRxCfgRcv64K
 = (1 << 11) | (1 << 12),

251 
	mRxNoW¿p
 = (1 << 7),

253 
šlše
 
	$¹l8139_»£t
(
Ãt_deviû
 *
Ãtdev
){

254 
	`RTL_wr™eb
(
Ãtdev
, 
ChCmd
, 
CmdRe£t
);

255 
i
 = 0; i < 1000; i++){

256 if((
	`RTL_»adb
(
Ãtdev
, 
ChCmd
è& 
CmdRe£t
) == 0) ;

257 
	`ud–ay
(10);

259 
	`¥š
("8139„eset failed");

261 
	}
}

272 
	$¹l8139_¡İ
(
Ãt_deviû
 *
Ãtdev
){

274 
	}
}

276 #´agm¨
·ck
(
push
)

277 #´agm¨
·ck
(1)

278 
	sTxStusReg
{

280 
	mv®ue
;

282 
	msize
: 13;

283 
	mOWN
: 1;

284 
	mTUN
: 1;

285 
	mTOK
: 1;

286 
	mth»shŞd
: 6;

287 
	m»£rved
: 2;

288 
	mncc
: 4;

289 
	mCDH
: 1;

290 
	mOWC
: 1;

291 
	mTABT
: 1;

292 
	mCRS
: 1;

297 
	s¿w_·ckage
{

298 
u16
 
	mrx_¡©us
;

299 
u16
 
	msize
;

300 
	md©a
[0];

302 #´agm¨
·ck
(
pİ
)

304 
	$šfo_»gs
(
Ãt_deviû
 *
Ãtdev
){

305 
u16
 
šŒ_¡©us
 = 
	`RTL_»adw
(
Ãtdev
, 
ISR
);

306 
u32
 
tx_¡©us
 = 
	`RTL_»adl
(
Ãtdev
, 
TxStus0
);

307 
	`İrštf
("TxStus0: %x, ISR: %x, IMR: %x \n", 
tx_¡©us
, 
šŒ_¡©us
, \

308 
	`RTL_»adw
(
Ãtdev
, 
IMR
));

309 
	}
}

311 
	$tx_bÙtomh®f
Ğ*
_Ãtdev
){

312 
Ãt_deviû
 *
Ãtdev
 = 
_Ãtdev
;

313 
	`nic_wake_queue
(
Ãtdev
);

317 
	}
}

324 
	$Ú_tx
(
Ãt_deviû
 *
Ãtdev
){

325 
	`İrštf
(" ------!T!------ ");

326 
¹l8139_´iv©e
 *
´iv©e
 = 
Ãtdev
->private;

327 
äoz’_desc
 = 
´iv©e
->
tou£_desc
 + 4;

328 
	`as£¹
Ğ
´iv©e
->
bsy_desc
 < 
äoz’_desc
);

330 
TxStusReg
 
TSR
;

331 
vdesc
 = 
´iv©e
->
bsy_desc
;

332 
´iv©e
->
bsy_desc
 !ğ
äoz’_desc
){

333 
»®desc
 = 
´iv©e
->
bsy_desc
 % 
NUM_TX_DESC
;

334 
TSR
.
v®ue
 = 
	`RTL_»adl
(
Ãtdev
, 
TxStus0
 + 
»®desc
 * 4);

335 if(!
TSR
.
TOK
 && !TSR.
TUN
 && !TSR.
TABT
){

336 if(
vdesc
 =ğ
´iv©e
->
bsy_desc
){

337 
Ãtdev
->
debug
.
couÁ_drİ_tok
++;

338 
	`İrštf
(" T\\ ");

343 if(
TSR
.
TOK
){

347 
	`İrštf
(" TSR NOT TOK: %u, bsy_desc: %u,ou£_desc:%u\n", 
TSR
.
v®ue
, 
´iv©e
->
bsy_desc
,…riv©e->
tou£_desc
);

348 
	`¥š
("spin");

351 
´iv©e
->
bsy_desc
 ++;

355 if(
´iv©e
->
bsy_desc
 -…riv©e->
tou£_desc
 == 4){

358 
	`m¬k_bh
(
Ãtdev
->
Ú_tx_bh
);

360 
	}
}

363 
´oûss_rx_queue
Ğ
Ãt_deviû
 *
Ãtdev
);

364 
	$rx_bÙtomh®f
Ğ*
_Ãtdev
){

365 
	`´oûss_rx_queue
(
_Ãtdev
);

367 
	}
}

368 
	$Ú_rx
(
Ãt_deviû
 *
Ãtdev
){

371 
	`İrštf
(" !R! ");

373 
¹l8139_´iv©e
 *
´iv©e
 = 
Ãtdev
->private;

374 !Ğ
	`RTL_»adb
(
Ãtdev
, 
ChCmd
è& 
RxBufEm±y
 )){

375 
¿w_·ckage
 *
¿w
 = (*)(
´iv©e
->
rx_ršg
 +…riv©e->
cursÜ_r
);

378 
d©a_size
 = 
¿w
->
size
 - 4;

379 
sk_buff
 *
skb
 = 
	`dev_®loc_skb
(
d©a_size
 );

380 
skb
->
dev
 = 
Ãtdev
;

381 
	`memıy
(
skb
->
‘hhdr
, 
¿w
->
d©a
, 
d©a_size
);

382 
	`LL2_A
(&
Ãtdev
->
rx_queue
, 
skb
);

383 
	`m¬k_bh
(
Ãtdev
->
Ú_rx_bh
);

387 
´iv©e
->
cursÜ_r
 = (´iv©e->cursÜ_¸+ 
¿w
->
size
 + 4 + 3) & ~3;

388 if(
´iv©e
->
cursÜ_r
 >…riv©e->
rx_ršg_Ën
)

389 
´iv©e
->
cursÜ_r
 %ğ´iv©e->
rx_ršg_Ën
;

390 
	`RTL_wr™ew
(
Ãtdev
, 
CursÜToR—d
, 
´iv©e
->
cursÜ_r
 - 0x10);

393 
	}
}

399 
	$Ú_šŒ
(
œq
, *
dev
, 
±_»gs
 *
»gs
){

400 
Ãt_deviû
 *
Ãtdev
 = 
dev
;

405 
i¤
 = 
	`RTL_»adw
(
Ãtdev
, 
ISR
);

406 
	`RTL_wr™ew
(
Ãtdev
, 
ISR
, 0xffff);

409 if(
i¤
 & 
TxOK
){

410 
	`Ú_tx
(
Ãtdev
);

412 if(
i¤
 & 
TxE¼
){

413 
	`¥š
("TxErr");

415 if(
i¤
 & 
RxOK
){

416 
	`Ú_rx
Ğ
Ãtdev
 );

418 if(
i¤
 & 
RxE¼
){

419 
	`¥š
("RxErr");

421 if(
i¤
 & 
RxOv”æow
){

422 
	`¥š
( "RxOverflow");

424 if(
i¤
 & 
RxUnd”run
){

425 
	`¥š
( "CARP is written but Rx buffer isƒmpty, or†ink status changed");

427 if(
i¤
 &
RxOv”æow
){

428 
	`İrštf
("Rx FIFIO Overflow, ignore‡nd clear it\n");

430 if(
i¤
 & 
CabL’Chg
){

431 
	`¥š
("Cable Length Change");

433 if(
i¤
 & 
PCSTimeout
){

434 
	`¥š
("PCSTimeout");

436 if(
i¤
 & 
PCIE¼
){

437 
	`¥š
("PCIErr");

439 if(
i¤
 == 0)

441 
	`İrštf
("w¬nšg,‡Àœq oà8139 w™h z”ØISR. s“ ISR:%x \n", 
i¤
);

444 
	}
}

452 
	$¹l8139_¡¬t_xm™
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
){

453 
¹l8139_´iv©e
 * 
´iv©e
 = 
Ãtdev
->private;

454 
	`as£¹
(
´iv©e
->
bsy_desc
 >…riv©e->
tou£_desc
);

455 
	`as£¹
Ğ
	`şi_®»ady
() );

457 
»®desc
 = 
´iv©e
->
tou£_desc
 % 
NUM_TX_DESC
;

458 if(
skb
->
pkgsize
 < 
TX_BUF_SIZE
){

460 
size
 = 
skb
->
pkgsize
 < 60 ? 60 : skb->pkgsize;

461 
	`mem£t
Ğ
	`PRIV
(
Ãtdev
)->
tx_bufs
[
»®desc
], 0xbb, 
size
 );

462 
	`memıy
Ğ
	`PRIV
(
Ãtdev
)->
tx_bufs
[
»®desc
], 
skb
->
‘hhdr
, skb->
pkgsize
 );

463 
	`dev_ä“_skb
(
skb
);

465 
TxStusReg
 
t¤
 = {
v®ue
: 0};

466 
t¤
.
size
 = size;

467 
t¤
.
OWN
 = 0;

468 
t¤
.
th»shŞd
 = 0;

470 
	`RTL_wr™–
(
Ãtdev
, 
TxStus0
 + 
»®desc
 * 4, 
t¤
.
v®ue
);

472 
	`as£¹
("oo†arge…ackage size ");

473 
´iv©e
->
tou£_desc
 ++;

479 if(
´iv©e
->
bsy_desc
 =ğ´iv©e->
tou£_desc
)  -1;

490 
	}
}

492 
boŞ
 
	$¹l8139_tx_busy
(
Ãt_deviû
 *
Ãtdev
){

493  
	`PRIV
(
Ãtdev
)->
tou£_desc
 =ğPRIVÒ‘dev)->
bsy_desc
;

494 
	}
}

497 
	$¹l8139_İ’
(
Ãt_deviû
 *
Ãtdev
){

498 
¹l8139_´iv©e
 *
´iv©e
 = 
Ãtdev
->private;

499 
´iv©e
->
rx_ršg
 = 
	`km®loc2
((32 + 2è* 1024, 
__GFP_DMA
);

500 
´iv©e
->
rx_ršg_dma
 =…riv©e->
rx_ršg
 - 
PAGE_OFFSET
;

501 
´iv©e
->
tx_buf
 = 
	`km®loc2
Ğ
TX_BUF_SIZE
 * 
NUM_TX_DESC
, 
__GFP_DMA
);

502 
´iv©e
->
tx_buf_dma
 =…riv©e->
tx_buf
 - 
PAGE_OFFSET
;

503 
i
 = 0; i < 
NUM_TX_DESC
; i++){

504 
´iv©e
->
tx_bufs
[
i
] =…riv©e->
tx_buf
 + i * 
TX_BUF_SIZE
;

507 
´iv©e
->
bsy_desc
 = 4;

508 
´iv©e
->
tou£_desc
 = 0;

510 
Ãtdev
->
æags
 = 0;

511 
Ãtdev
->
tx_couÁ
 =‚‘dev->
rx_couÁ
 = 0;

512 
	`mem£t
(&
Ãtdev
->
debug
, 0, (netdev->debug));

513 
´iv©e
->
cursÜ_r
 = 0;

514 
´iv©e
->
rx_ršg_Ën
 = 32 * 1024;

516 
	`¹l8139_»£t
(
Ãtdev
);

517 
	`RTL_wr™eb
(
Ãtdev
, 
ChCmd
, 
CmdRxEnb
 | 
CmdTxEnb
);

518 
	`RTL_wr™–
(
Ãtdev
, 
RBSTART
, ()
	`__´iv
Ò‘dev)->
rx_ršg_dma
);

519 
	`RTL_wr™–
(
Ãtdev
, 
RxCÚfig
, 
Acû±AÎPhys
 | 
Acû±MyPhys
 | 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 |
RxNoW¿p
 | 
RxCfgRcv32K
);

521 
	`»que¡_œq
(
Ãtdev
->
œq
, 
Ú_šŒ
, 
SA_INTERRUPT
,‚etdev);

522 
œq_desc
[()
Ãtdev
->
œq
].
¡©us
 &ğ~
IRQ_DISABLED
;

523 
	`RTL_wr™ew
(
Ãtdev
, 
IMR
, 0xffff);

527 
i
 = 0; i < 
NUM_TX_DESC
; i++){

528 
	`RTL_wr™–
(
Ãtdev
, 
TxAddr0
 + 
i
*4, ()(
´iv©e
->
tx_buf_dma
 + 
TX_BUF_SIZE
*i));

530 
Ãtdev
->
Ú_tx_bh
 = 
	`®loc_bh
(
tx_bÙtomh®f
,‚etdev);

531 
Ãtdev
->
Ú_rx_bh
 = 
	`®loc_bh
(
rx_bÙtomh®f
,‚etdev);

532 
Ãtdev
->
tx_queue
.
roÙ
 =‚‘dev->tx_queue.

 = 0;

533 
Ãtdev
->
rx_queue
.
roÙ
 =‚‘dev->rx_queue.

 = 0;

535 
	}
}

538 
	$¹l8139_š™_Úe
(
pci_dev
 *
pcidev
, cÚ¡ 
pci_deviû_id
 *
id
){

539 
	`pci_’abË_deviû
(
pcidev
);

540 
	`pci_£t_ma¡”
(
pcidev
);

541 
Ãt_deviû
 *
Ãtdev
 = 
	`km®loc2
( (net_device), 0 );

543 
pcidev
->
cÜe
 = 
Ãtdev
;

544 
Ãtdev
->
pcidev
 =…cidev;

545 
	`»gi¡”_nic
(
Ãtdev
);

546 
Ãtdev
->
İ’
 = 
¹l8139_İ’
;

547 
Ãtdev
->
¡İ
 = 
¹l8139_¡İ
;

548 
Ãtdev
->
tx_busy
 = 
¹l8139_tx_busy
;

549 
Ãtdev
->
¡¬t_xm™
 = 
¹l8139_¡¬t_xm™
;

551 
	`İrštf
("œq…š: %u ,†še: %u\n", 
pcidev
->
œqpš
,…cidev->
œqlše
);

553 
Ãtdev
->
ba£_addr
 = ()Ğ
pcidev
->
add»ss
[1] & ~0xfè- 
PAGE_OFFSET
;

554 
	`İrštf
("ba£_addr:%x\n", 
Ãtdev
->
ba£_addr
);

556 
Ãtdev
->
œq
 = 
pcidev
->
œqlše
;

557 
mac
[2] = {0};

558 
mac
[0] = 
	`RTL_»adl
(
Ãtdev
, 0);

559 
mac
[1] = 
	`RTL_»adl
(
Ãtdev
, 4);

560 
	`memıy
(
Ãtdev
->
mac
, (*)mac, 6);

561 
Ãtdev
->
mac
[6] = 0;

564 
¹l8139_´iv©e
 *
´iv©e
 = 
	`km®loc2
( (rtl8139_private), 0);

565 
´iv©e
->
pcidev
 =…cidev;

566 
Ãtdev
->
´iv©e
 =…rivate;

568 
i
 = 0; i <= 2; i ++){

569 
	`as£¹
(
i
 != 2);

570 if(
	`memcmp
((*)
Ãtdev
->
mac
, 
cÚfigs
[
i
].mac, 6) == 0){

572 
Ãtdev
->
mask
 = 
cÚfigs
[
i
].ipmask;

573 
Ãtdev
->
g©eway_
 = 
cÚfigs
[
i
].gateway_ip;

574 
Ãtdev
->

 = 
cÚfigs
[
i
].ip;

583 
	}
}

585 
pci_driv”
 
	g¹l8139_driv”
 = {

586 
id_bË
: 
¹l8139_id_tbl
,

587 
´obe
:
¹l8139_š™_Úe
,

590 
	$»gi¡”_¹l8139_driv”
(){

591 
	`pci_»gi¡”_driv”
(&
¹l8139_driv”
);

592 
	}
}

596 
BOOLEAN
 
	$Pack‘OK
Ğ
PPACKETHEADER
 
pPktHdr
 )

598 
BOOLEAN
 
BadPack‘
 = 
pPktHdr
->
RUNT
 ||

599 
pPktHdr
->
LONG
 ||

600 
pPktHdr
->
CRC
 ||…PktHdr->
FAE
;

601 ifĞĞ!
BadPack‘
 ) && ( 
pPktHdr
->
ROK
 ) )

603 iàĞ(
pPktHdr
->
Pack‘L’gth
 > 
RX_MAX_PACKET_LENGTH
 ) ||

604 (
pPktHdr
->
Pack‘L’gth
 < 
RX_MIN_PACKET_LENGTH
 )è(
FALSE
);

605 
Pack‘ReûivedGood
++;

606 
By‹Reûived
 +ğ
pPktHdr
->
Pack‘L’gth
;

607  
TRUE
 ;

609  
FALSE
;

610 
	}
}

611 
BOOLEAN
 
	$RxIÁ”ru±HªdËr
()

613 
TmpCMD
;

614 
PktL’gth
;

615 *
pIncomePack‘
, *
RxR—dPŒ
;

616 
PPACKETHEADER
 
pPack‘H—d”
;

617 
TRUE
)

619 
TmpCMD
 = 
	`špÜtb
(
IOBa£
 + 
CR
);

620 ià(
TmpCMD
 & 
CR_BUFE
) ;

623 
RxR—dPŒ
 = 
RxBufãr
 + 
RxR—dPŒOff£t
;

624 
pPack‘H—d”
 = (
PPACKETHEADER
)
RxR—dPŒ
;

625 
pIncomePack‘
 = 
RxR—dPŒ
 + 4;

626 
PktL’gth
 = 
pPack‘H—d”
->
Pack‘L’gth
;

628 iàĞ
	`Pack‘OK
Ğ
pPack‘H—d”
 ) )

630 iàĞ(
RxR—dPŒOff£t
 + 
PktL’gth
è> 
RX_BUFFER_SIZE
 )

632 
	`memıy
Ğ
RxBufãr
 + 
RX_BUFFER_SIZE
 , RxBuffer,

633 (
RxR—dPŒOff£t
 + 
PktL’gth
 - 
RX_BUFFER_SIZE
) );

635 
	`CİyPack‘
(
pIncomePack‘
,
PktL’gth
 - 4);

637 
RxR—dPŒOff£t
 = (RxR—dPŒOff£ˆ+ 
PktL’gth
 + 4 + 3è& 
RX_READ_POINTER_MASK
;

640 
	`ouÜt
Ğ
IOBa£
 + 
CAPR
, 
RxR—dPŒOff£t
 - 0x10);

644 
	`Re£tRx
();

647 
TmpCMD
 = 
	`špÜtb
(
IOBa£
 + 
CR
);

649 !(
TmpCMD
 & 
CR_BUFE
));

651  (
TRUE
);

653 
	}
}

	@drivers/net/e1000.c

1 
	~<lšux/pci.h
>

2 
	~<asm/io.h
>

3 
	~<lšux/Ãtdeviû.h
>

4 
	~<œq.h
>

5 
	~<lšux/¦ab.h
>

6 
	~<mm.h
>

7 
	~<lšux/skbuff.h
>

9 
	#INTEL_VEND
 0x8086

10 
	#E1000_DEV
 0x100E

11 
	#E1000_I217
 0x153A

12 
	#E1000_82577LM
 0x10EA

13 

	)

16 
	#REG_CTRL
 0x0000

	)

17 
	#REG_STATUS
 0x0008

	)

18 
	#REG_EEPROM
 0x0014

	)

19 
	#REG_CTRL_EXT
 0x0018

	)

20 
	#REG_IMASK
 0x00D0

	)

21 
	#REG_RCTRL
 0x0100

	)

22 
	#REG_RXDESCLO
 0x2800

	)

23 
	#REG_RXDESCHI
 0x2804

	)

24 
	#REG_RXDESCLEN
 0x2808

	)

25 
	#REG_RXDESCHEAD
 0x2810

	)

26 
	#REG_RXDESCTAIL
 0x2818

	)

28 
	#REG_TCTRL
 0x0400

	)

29 
	#REG_TXDESCLO
 0x3800

	)

30 
	#REG_TXDESCHI
 0x3804

	)

31 
	#REG_TXDESCLEN
 0x3808

	)

32 
	#REG_TXDESCHEAD
 0x3810

	)

33 
	#REG_TXDESCTAIL
 0x3818

	)

35 
	#REG_RDTR
 0x2820

36 
	#REG_RXDCTL
 0x3828

37 
	#REG_RADV
 0x282C

38 
	#REG_RSRPD
 0x2C00

39 

	)

40 
	#REG_TIPG
 0x0410

41 
	#ECTRL_SLU
 0x40

42 

	)

43 
	#RCTL_EN
 (1 << 1)

44 
	#RCTL_SBP
 (1 << 2)

45 
	#RCTL_UPE
 (1 << 3)

46 
	#RCTL_MPE
 (1 << 4)

47 
	#RCTL_LPE
 (1 << 5)

48 
	#RCTL_LBM_NONE
 (0 << 6)

49 
	#RCTL_LBM_PHY
 (3 << 6)

50 
	#RTCL_RDMTS_HALF
 (0 << 8)

51 
	#RTCL_RDMTS_QUARTER
 (1 << 8)

52 
	#RTCL_RDMTS_EIGHTH
 (2 << 8)

53 
	#RCTL_MO_36
 (0 << 12)

54 
	#RCTL_MO_35
 (1 << 12)

55 
	#RCTL_MO_34
 (2 << 12)

56 
	#RCTL_MO_32
 (3 << 12)

57 
	#RCTL_BAM
 (1 << 15)

58 
	#RCTL_VFE
 (1 << 18)

59 
	#RCTL_CFIEN
 (1 << 19)

60 
	#RCTL_CFI
 (1 << 20)

61 
	#RCTL_DPF
 (1 << 22)

62 
	#RCTL_PMCF
 (1 << 23)

63 
	#RCTL_SECRC
 (1 << 26)

64 

	)

66 
	#RCTL_BSIZE_256
 (3 << 16)

	)

67 
	#RCTL_BSIZE_512
 (2 << 16)

	)

68 
	#RCTL_BSIZE_1024
 (1 << 16)

	)

69 
	#RCTL_BSIZE_2048
 (0 << 16)

	)

70 
	#RCTL_BSIZE_4096
 ((3 << 16è| (1 << 25))

	)

71 
	#RCTL_BSIZE_8192
 ((2 << 16è| (1 << 25))

	)

72 
	#RCTL_BSIZE_16384
 ((1 << 16è| (1 << 25))

	)

75 
	#CMD_EOP
 (1 << 0)

76 
	#CMD_IFCS
 (1 << 1)

77 
	#CMD_IC
 (1 << 2)

78 
	#CMD_RS
 (1 << 3)

79 
	#CMD_RPS
 (1 << 4)

80 
	#CMD_VLE
 (1 << 6)

81 
	#CMD_IDE
 (1 << 7)

82 

	)

85 
	#TCTL_EN
 (1 << 1)

86 
	#TCTL_PSP
 (1 << 3)

87 
	#TCTL_CT_SHIFT
 4

88 
	#TCTL_COLD_SHIFT
 12

89 
	#TCTL_SWXOFF
 (1 << 22)

90 
	#TCTL_RTLC
 (1 << 24)

91 

	)

92 
	#TSTA_DD
 (1 << 0)

93 
	#TSTA_EC
 (1 << 1)

94 
	#TSTA_LC
 (1 << 2)

95 
	#LSTA_TU
 (1 << 3)

96 

	)

97 
	#E1000_NUM_RX_DESC
 32

	)

98 
	#E1000_NUM_TX_DESC
 8

	)

100 
	se1000_´iv©e
{

101 
pci_dev
 *
	mpcidev
;

102 *
	mmmio_addr
;

103 
	m»gs_Ën
;

107 
pci_deviû_id
 
	ge1000_id_tbl
[] = {

147 
	$tx_bÙtomh®f
Ğ*
_Ãtdev
){

150 
	}
}

152 
	$Ú_tx
(
Ãt_deviû
 *
Ãtdev
){

153 
	}
}

156 
	$rx_bÙtomh®f
Ğ*
_Ãtdev
){

158 
	}
}

159 
	$Ú_rx
(
Ãt_deviû
 *
Ãtdev
){

160 
	}
}

161 
	$Ú_šŒ
(
œq
, *
dev
, *
»gs
){

162 
	}
}

163 
	$e1000_İ’
(
Ãt_deviû
 *
Ãtdev
){

165 
	}
}

167 
	$e1000_¡İ
(
Ãt_deviû
 *
Ãtdev
){

169 
	}
}

170 
	$e1000_¡¬t_xm™
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãtdev
){

172 
	}
}

174 
boŞ
 
	$e1000_tx_busy
(
Ãt_deviû
 *
Ãtdev
){

175 
	`as£¹
(0);

177 
	}
}

179 
	$e1000_š™_Úe
(
pci_dev
 *
pcidev
, cÚ¡ 
pci_deviû_id
 *
id
){

180 
	`pci_’abË_deviû
(
pcidev
);

181 
	`pci_£t_ma¡”
(
pcidev
);

182 
Ãt_deviû
 *
Ãtdev
 = 
	`km®loc2
( (net_device), 0 );

183 
	`»gi¡”_nic
(
Ãtdev
);

184 
Ãtdev
->
pcidev
 =…cidev;

185 
pcidev
->
cÜe
 = 
Ãtdev
;

187 
Ãtdev
->
İ’
 = 
e1000_İ’
;

188 
Ãtdev
->
¡İ
 = 
e1000_¡İ
;

189 
Ãtdev
->
tx_busy
 = 
e1000_tx_busy
;

190 
Ãtdev
->
¡¬t_xm™
 = 
e1000_¡¬t_xm™
;

192 
	`İrštf
("œq…š: %u ,†še: %u\n", 
pcidev
->
œqpš
,…cidev->
œqlše
);

194 
Ãtdev
->
ba£_addr
 = ()Ğ
pcidev
->
add»ss
[1] & ~0xfè- 
PAGE_OFFSET
;

197 
Ãtdev
->
œq
 = 
pcidev
->
œqlše
;

199 
mac
[2] = {0};

200 
mac
[0] = 
	`RTL_»adl
(
Ãtdev
, 0);

201 
mac
[1] = 
	`RTL_»adl
(
Ãtdev
, 4);

202 
	`memıy
(
Ãtdev
->
mac
, (*)mac, 6);

203 
	`İrštf
("MAC:%x %x\n", 
mac
[0], mac[1]);

205 
¹l8139_´iv©e
 *
´iv©e
 = 
	`km®loc2
( (rtl8139_private), 0);

206 
´iv©e
->
pcidev
 =…cidev;

207 
Ãtdev
->
´iv©e
 =…rivate;

208 
Ãtdev
->
mask
 = ~0xff;

209 
Ãtdev
->
g©eway_
 = 
	`MAKE_IP
(192, 168, 1, 1);

210 
u32
 
__loÿl_
;

211 
Ãtdev
->

 = 
__loÿl_
;

215 
‹¡nd
 = 
Ãtdev
;

218 
	}
}

220 
pci_driv”
 
	ge1000_driv”
 = {

221 
id_bË
: 
e1000_id_tbl
,

222 
´obe
:
e1000_š™_Úe
,

225 
	$»gi¡”_e1000_driv”
(){

226 
	`pci_»gi¡”_driv”
(&
e1000_driv”
);

227 
	}
}

	@drivers/pci/pci.c

1 
	~<lšux/pci.h
>

3 
	#PCI_BUS_MAX
 256

	)

4 
	#PCI_DEV_MAX
 32

	)

5 
	#PCI_FUNC_MAX
 8

	)

6 
	~<uts.h
>

7 
	~<lšux/¦ab.h
>

8 
li¡_h—d
 
	gpcidevs_roÙ
;

9 
li¡_h—d
 
	gpcidrvs_roÙ
;

10 
	$pci_š™
(){

11 
	`INIT_LIST_HEAD
(&
pcidevs_roÙ
);

12 
	`INIT_LIST_HEAD
(&
pcidrvs_roÙ
);

14 
	`PciDevTabË_Mk_Fa¡_Acûss
();

15 
bus
 = 0; bu < 
PCI_BUS_MAX
; bus++){

16 
dev
 = 0; dev < 
PCI_DEV_MAX
; dev++){

17 
func
 = 0; funø< 
PCI_FUNC_MAX
; func++){

18 
pÜt0xcfc
 = 
	`g‘_pci_cfg_»g
(
bus
, 
dev
, 
func
, 0);

19 
u16
 
v’dÜ
 = (u16)
pÜt0xcfc
;

21 if(
v’dÜ
 == 0xffff) ;

23 
pci_dev
 *
pcidev
 = 
	`km®loc2
( (pci_dev), 0);

24 
i
 = 0; i < 64; i++){

25 ((*)
pcidev
)[
i
] = 
	`g‘_pci_cfg_»g
(
bus
, 
dev
, 
func
, i);

26 
pcidev
->
bus
 = bus;

27 
pcidev
->
dev
 = dev;

28 
pcidev
->
func
 = func;

30 
	`li¡_add
(&
pcidev
->
node
, &
pcidevs_roÙ
);

33 
pci_šfo_’Œy
 * 
šfo_’t
 = 
	`PciTabË_G‘
(
v’dÜ
, 
pÜt0xcfc
>>16);

34 
pci_v’dÜ_’Œy
 * 
v’dÜ_’t
 = 
	`PciV’dÜTbl_G‘
(
v’dÜ
);

35 if(
v’dÜ_’t
){

36 
	`İrštf
("@%s, ", 
v’dÜ_’t
->
V’FuÎ
);

37 if(
šfo_’t
è
	`İrštf
("%s, %s", info_’t->
Ch
, info_’t->
ChDesc
);

39 
	`İrštf
("@unknown(%x : %x)", 
v’dÜ
, 
pÜt0xcfc
 >> 16);

41 
pÜt0xcfc
 = 
	`g‘_pci_cfg_»g
(
bus
, 
dev
, 
func
, 2);

42 
pci_şasscode
 
şass
 = { 
v®ue
: 
pÜt0xcfc
 >> 8};

43 
pci_şass_’Œy
 *
’t
 = 
	`PciCÏssTbl_G‘
(
şass
.
ba£
, cÏss.
sub
, cÏss.
´og
);

44 if(
’t
è
	`İrštf
("şass(%x): %s, %s, %s\n", 
pÜt0xcfc
>>8,ƒÁ->
Ba£Desc
,ƒÁ->
SubDesc
,ƒÁ->
ProgDesc
);

45 
	`İrštf
("şass(%x): unknowÀ%x %x %x\n",
pÜt0xcfc
>>8, 
şass
.
ba£
, cÏss.
sub
, cÏss.
´og
);

51 if(
func
 =ğ0 && !(
pcidev
->
h—dty³
 & 0x80)) ;

56 
	}
}

58 
šlše


59 
pci_deviû_id
 *

60 
	$id_bË_m©ched
(
pci_deviû_id
 *
id_bË
, 
pci_dev
 *
dev
){

61 
pci_deviû_id
 * 
id
 = 
id_bË
;

62 
id
->
v’dÜ
){

63 if(
id
->
v’dÜ
 =ğ
dev
->v’dÜ && id->
deviû
 == dev->device)  id;

64 
id
++;

66  
çl£
;

67 
	}
}

69 
	$pci_»gi¡”_driv”
(
pci_driv”
 *
driv”
){

70 
	`li¡_add
(&
driv”
->
node
, &
pcidrvs_roÙ
);

71 
li¡_h—d
 *
cu¼_node
 = 
pcidevs_roÙ
.
Ãxt
;

73 
cu¼_node
 !ğ&
pcidevs_roÙ
){

74 
pci_dev
 *
cu¼_dev
 = 
	`MB2STRU
(pci_dev, 
cu¼_node
, 
node
);

75 
pci_deviû_id
 * 
id
 = 
	`id_bË_m©ched
Ğ
driv”
->
id_bË
, 
cu¼_dev
);

76 if(
id
){

77 
cu¼_dev
->
driv”
 = driver;

78 
driv”
->
	`´obe
Ğ
cu¼_dev
, 
id
);

80 
cu¼_node
 = cu¼_node->
Ãxt
;

83 
	}
}

85 
	$pci_’abË_deviû
(
pci_dev
 *
pcidev
){

86 
	`pci_fix_cÚfig_dwÜd
(
pcidev
, 
PCI_COMMAND
, 
PCI_COMMAND_IO
 | 
PCI_COMMAND_MEMORY
);

88 
	}
}

90 
	$pci_£t_ma¡”
(
pci_dev
 *
pcidev
){

91 
	`pci_fix_cÚfig_dwÜd
(
pcidev
, 
PCI_COMMAND
, 
PCI_COMMAND_MASTER
);

93 
	}
}

	@drivers/pci/pci_vendor.c

1 
	~<lšux/pci_v’dÜ.h
>

2 
PCI_VENTABLE
 
	gPciV’TabË
 [] =

15 
	#PCI_VENTABLE_LEN
 ((
PciV’TabË
)/(
PCI_VENTABLE
))

	)

17 
PCI_DEVTABLE
 
	gPciDevTabË
 [] = {

1059 
	#PCI_DEVTABLE_LEN
 ((
PciDevTabË
)/(
PCI_DEVTABLE
))

	)

1061 
PCI_CLASSCODETABLE
 
	gPciCÏssCodeTabË
 [] =

1151 
	#PCI_CLASSCODETABLE_LEN
 ((
PciCÏssCodeTabË
)/(
PCI_CLASSCODETABLE
))

	)

1153 * 
	gPciCommªdFÏgs
 [] =

1174 
	#PCI_COMMANDFLAGS_LEN
 ((
PciCommªdFÏgs
)/(*))

	)

1177 * 
	gPciStusFÏgs
 [] =

1198 
	#PCI_STATUSFLAGS_LEN
 ((
PciStusFÏgs
)/(*))

	)

1201 * 
	gPciDevS–FÏgs
 [] =

1210 
	#PCI_DEVSELFLAGS_LEN
 ((
PciDevS–FÏgs
)/(*))

	)

1214 
	g¡¬t_of_v£g
[255];

1215 
	$PciDevTabË_Mk_Fa¡_Acûss
(){

1216 
i
;

1217 
i
 = 0 ; i < (
¡¬t_of_v£g
)/(); i++)

1218 
¡¬t_of_v£g
[
i
] = 255;

1219 
dÚe
 = -1;

1220 
i
 = 0; i < (
PciDevTabË
)/(
pci_šfo_’Œy
); i++){

1221 
äesh_£g
 = 
PciDevTabË
[
i
].
V’Id
 >> 8;

1222 ifĞ
äesh_£g
 =ğ
dÚe
) ;

1224 
dÚe
 = 
äesh_£g
;

1225 
¡¬t_of_v£g
[
äesh_£g
] = 
i
;

1227 
	}
}

1229 
pci_šfo_’Œy
 * 
	$PciTabË_G‘
(
v’dÜ
, 
deviû
){

1230 
£g
 = 
v’dÜ
 >> 8;

1231 
¡¬t_idx
 = 
¡¬t_of_v£g
[
£g
];

1232 if(
¡¬t_idx
 == 0xff)  0;

1233 
i
 = 
¡¬t_idx
; i < (
PciDevTabË
è/ (
pci_šfo_’Œy
); i++){

1234 if(
PciDevTabË
[
i
].
V’Id
 =ğ
v’dÜ
 && PciDevTabË[i].
DevId
 =ğ
deviû
){

1235  
PciDevTabË
 + 
i
;

1237 if(
PciDevTabË
[
i
].
V’Id
 >> 8 !ğ
£g
)  0;

1240 
	}
}

1242 
pci_v’dÜ_’Œy
 *
	$PciV’dÜTbl_G‘
(
u16
 
v’dÜ
){

1243 
i
 = 0; i < 
PCI_VENTABLE_LEN
; i++){

1244 if(
PciV’TabË
[
i
].
V’Id
 =ğ
v’dÜ
)  PciVenTable + i;

1247 
	}
}

1250 
pci_şass_’Œy
 *
	$PciCÏssTbl_G‘
(
u8
 
şass
, u8 
sub
, u8 
´og
){

1251 
i
 = 0; i < 
PCI_CLASSCODETABLE_LEN
; i++){

1252 if(
PciCÏssCodeTabË
[
i
].
Ba£CÏss
 =ğ
şass
 &&

1253 
PciCÏssCodeTabË
[
i
].
SubCÏss
 =ğ
sub
 &&

1254 
PciCÏssCodeTabË
[
i
].
ProgIf
 =ğ
´og


1255 è 
PciCÏssCodeTabË
 + 
i
;

1258 
	}
}

	@elf.c

1 
	~<–f.h
>

2 
	~<uts.h
>

4 
Elf32_Ehdr
 *
	geh—d”
;

5 
Elf32_Phdr
 *
	gph—d”
;

6 
	$£t
(*
img
){

7 
	`as£¹
(
img
[1] == 'E' && img[2]=='L' && img[3] == 'F');

8 
eh—d”
 = (
Elf32_Ehdr
 *)
img
;

9 
ph—d”
 = (
Elf32_Phdr
 *)(
img
 + 
eh—d”
->
e_phoff
);

11 
	}
}

13 
	$lßd–f
(*
img
){

14 
	`£t
(
img
);

16 
i
 = 0; i < 
eh—d”
->
e_phnum
; i++){

17 if(
ph—d”
[
i
].
p_ty³
 != 1) ;

18 
	`mem£t
((*)
ph—d”
[
i
].
p_vaddr
,…h—d”[i].
p_memsz
, 0);

19 
	`memıy
((*)
ph—d”
[
i
].
p_vaddr
, 
img
 +…h—d”[i].
p_off£t
,…h—d”[i].
p_fesz
);

21  
eh—d”
->
e_’Œy
;

22 
	}
}

	@fs/binfmt_elf.c

1 
	~<lšux/bšfmts.h
>

2 
	~<–f.h
>

3 
	~<lšux/mm.h
>

4 
	~<´oc.h
>

5 
	#MAP_FIXED
 0

	)

6 
	#MAP_DENYWRITE
 0

	)

13 
	$lßd_–f_bš¬y
(
lšux_bš´m
 *
b´m
, 
±_»gs
 *
»gs
){

14 
mm
 *mm = 
cu¼’t
->mm;

15 
Elf32_Ehdr
 *
eh—d”
 = (*)
b´m
->
buf
;

16 
phnum
 = 
eh—d”
->
e_phnum
;

17 
	`as£¹
Ğ
eh—d”
->
e_id’t
[0] == 0x7f &&

18 
eh—d”
->
e_id’t
[1] == 'E' &&

19 
eh—d”
->
e_id’t
[2] == 'L' &&

20 
eh—d”
->
e_id’t
[3] == 'F');

21 
Elf32_Phdr
 *
phdr
 = (*)
	`__®loc_·ge
(0);

22 
off£t
 = 
	`k_£ek
(
b´m
->
fe
, 
eh—d”
->
e_phoff
, 0);

23 
	`as£¹
(
off£t
 =ğ
eh—d”
->
e_phoff
);

24 
rby‹s
 = 
	`k_»ad
(
b´m
->
fe
, (*)
phdr
, 
phnum
 * 
PH_SIZE
);

25 
	`as£¹
Ğ
rby‹s
 =ğ
phnum
 * 
PH_SIZE
);

26 
boŞ
 
m“t_fš®_’Œy
 = 
çl£
;

27 
i
 = 0; i < 
phnum
; i++){

28 
ulÚg
 
vm_æags
;

29 if(
phdr
[
i
].
p_ty³
 !ğ
PT_LOAD
) ;

30 
	`as£¹
(!
m“t_fš®_’Œy
);

31 
	`as£¹
(
phdr
[
i
].
p_memsz
 > 0);

32 
ulÚg
 
vaddr
 = 
phdr
[
i
].
p_vaddr
;

33 
ulÚg
 
feoff
 = 
phdr
[
i
].
p_off£t
;

34 
	`as£¹
(
vaddr
 % 
__4K
 =ğ
feoff
 % __4K);

35 
vaddr
 = 
	`æoÜ_®ign
(vaddr, 
__4K
);

36 
feoff
 = 
	`æoÜ_®ign
(feoff, 
__4K
);

38 
vm_æags
 = 0;

39 if(
phdr
[
i
].
p_æags
 & 
PF_R
è
vm_æags
 |ğ
VM_READ
;

40 if(
phdr
[
i
].
p_æags
 & 
PF_W
){

41 
m“t_fš®_’Œy
 = 
Œue
;

42 
vm_æags
 |ğ
VM_WRITE
;

43 
mm
->
¡¬t_d©a
 = 
phdr
[
i
].
p_vaddr
;

50 
ulÚg
 
’d_d©a
 = 
phdr
[
i
].
p_vaddr
 +…hdr[i].
p_fesz
;

51 
ulÚg
 
’d_bss
 = 
phdr
[
i
].
p_vaddr
 +…hdr[i].
p_memsz
;

52 
mm
->
’d_d©a
 = 
’d_bss
;

53 
mm
->
brk
 = mm->
¡¬t_brk
 = 
	`û_®ign
(
’d_d©a
, 
__4K
);

55 if(
phdr
[
i
].
p_æags
 & 
PF_X
){

56 
vm_æags
 |ğ
VM_EXEC
;

57 
mm
->
¡¬t_code
 = 
phdr
[
i
].
p_vaddr
;

58 
mm
->
’d_code
 = 
phdr
[
i
].
p_vaddr
 +…hdr[i].
p_memsz
;

62 *
»t
 = 
	`mm­
(
vaddr
, 
phdr
[
i
].
p_fesz
, 
vm_æags
,

63 
MAP_FIXED
 | 
MAP_DENYWRITE
, 
b´m
->
fe
, 
feoff
);

64 
	`as£¹
(
»t
 =ğ(*)
vaddr
);

68 
bss_hŞe
 = 
mm
->
’d_d©a
 - mm->
¡¬t_brk
;

69 if(
bss_hŞe
 > 0è
	`k_brk
Ğ
	`û_®ign
(
mm
->
’d_d©a
, 
__4K
) );

71 
»gs
->
cs
 = (
u32
)&
£ËùÜ_¶aš_c3
;

72 
»gs
->
fs
 =„egs->
gs
 = 0;

73 
»gs
->
ds
 =„egs->
es
 =„egs->
ss
 = (
u32
)&
£ËùÜ_¶aš_d3
;

74 
»gs
->
e
 = (
ulÚg
)
eh—d”
->
e_’Œy
;

77 
	}
}

79 
lšux_bšfmt
 
	g–f_fÜm©
 = {

80 
lßd_bš¬y
: 
lßd_–f_bš¬y
,

	@fs/cell/cell.c

1 
	~<lšux/ûÎ.h
>

	@fs/cell/namei.c

5 
	~<lšux/fs.h
>

6 
	~<lšux/ûÎ.h
>

7 
	~<uts.h
>

8 
	~<lšux/blkdev.h
>

9 
	#SB_COMMON
(
su³rblock
è((
ûÎ_sb_šfo
 *)(su³rblock->
commÚ
))

	)

10 
	#I_COMMON
(
šode
èĞ(
ûÎ_šode_šfo
 *)(šode->
commÚ
è)

	)

15 
	#CELL_BLOCKS
(
sb
è(
	`SB_COMMON
(sb)->
ûÎsize
 / 
BLOCK_SIZE
)

	)

17 
	#CELL_START
(
ûÎid
, 
sb
) \

18 ((
	`SB_COMMON
(
sb
)->
roÙûÎ
 / 
BLOCK_SIZE
) \

19 + 
	`CELL_BLOCKS
(
sb
è* 
ûÎid
)

	)

21 
ûÎ_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry);

22 
»ad_šode
(
šode
 *inode);

23 
šode_İ”©iÚs
 
	gûÎ_šode_İ”©iÚs
= {

24 
lookup
: 
ûÎ_lookup
,

27 
su³r_İ”©iÚs
 
	gûÎ_sb_İ”©iÚs
 = {

28 
»ad_šode
:„ead_inode,

31 
»ad
(
fe
 *fe, *
buf
,

32 
size
, *
µos
);

33 
Úşo£
(
fe
 *file);

34 
fe_İ”©iÚs
 
	gûÎ_f_İs
 = {

35 
İ’
: 0,

36 
l£ek
: 0,

37 
»ad
:read,

38 
Úşo£
:onclose,

40 
	$»ad_ûÎ
(
su³r_block
 *
sb
, 
ûÎid
,

41 
ûÎ
 *
buf
)

43 
”r
 = 
	`Î_rw_blocks
(
sb
->
dev
, 
READ
,

44 
	`CELL_START
(
ûÎid
, 
sb
), 
	`CELL_BLOCKS
(sb), 
buf
); 
	`a¤t
(
”r
 == 0);

45  
”r
;

46 
	}
}

49 
ûÎ
 * 
	$ÿche_ûÎ_h—d”
(
su³r_block
 *
sb
, 
ûÎid
){

51 
ûÎ
 * c–Èğ
	`km®loc
(1024);

52 
”r
 = 
	`Î_rw_block2
(
sb
->
dev
, 
READ
, 
	`CELL_START
(
ûÎid
, sb), 1, (*)
ûÎ
);

53 if(
”r
){

54 
	`kä“
(
ûÎ
);

55 
	`¥š
("read cell header failed");

57  
ûÎ
;

58 
	}
}

60 
	$»ad_šode
(
šode
 *inode){

61 
ûÎ
 *cell;

62 
bufãr_h—d
 *
fœ¡4K
;

63 
su³r_block
 *
sb
 = 
šode
->sb;

65 
fœ¡4K
 = 
	`mm­_disk
(
sb
->
dev
, 
	`CELL_START
(
šode
->
šo
, sb)); 
	`a¤t
(first4K);

66 if(!
fœ¡4K
)  1;

68 
ûÎ
 = (*)
fœ¡4K
->
d©a
;

69 
šode
->
mktime
 = 
ûÎ
->mktime;

70 
šode
->
chgtime
 = 
ûÎ
->chgtime;

71 
šode
->
size
 = 
ûÎ
->size;

72 
šode
->
İ”©iÚs
 = &
ûÎ_šode_İ”©iÚs
;

73 
šode
->
fe_İs
 = &
ûÎ_f_İs
;

75 
	}
}

80 
	$ûÎ_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry){

82 
”r
;

83 
su³r_block
 *
sb
 = 
dœ
->sb;

84 
q¡r
 *
Çme
 = &
d’Œy
->name;

85 
ûÎ
 *ûÎ = 
	`km®loc
(
	`SB_COMMON
(
sb
)->
ûÎsize
);

86 
”r
 = 
	`»ad_ûÎ
(
sb
, 
dœ
->
šo
, 
ûÎ
);

87 if(
”r
) {

88 
	`kä“
(
ûÎ
);

89  
”r
;

91 
ûÎ_d’Œy
 *
ûÎ_’t
 = 
ûÎ
->
’ts
;

92 
»maš
;

93 
»maš
 = 
ûÎ
->
size
;„emain > 0;){

94 
’tsize
 = (
ûÎ_d’Œy
è+ 
ûÎ_’t
->
Ën
;

96 
Ën
 = 
ûÎ_’t
->len;

97 if(
Ën
 != 0){

98 if(
Ën
 =ğ
Çme
->ËÀ&& 
	`¡ºcmp
Òame->Çme, 
ûÎ_’t
->name,†en) == 0) ;

99 
»maš
 -ğ
’tsize
;

101 
ûÎ_’t
 = (*)((
u32
)ûÎ_’ˆ+ 
’tsize
);

103 if(
»maš
 <= 0){

104 
	`kä“
(
ûÎ
);

107 
d’Œy
->
šode
 = (*)
ûÎ_’t
->
ûÎid
;

108 
	`kä“
(
ûÎ
);

111 
	}
}

120 
	$ûÎ_»ad_su³r
(
su³r_block
 *
sb
){

121 
bufãr_h—d
 *
su³r_mm­
;

122 
ûÎ_su³rblock
 *
ûÎ_sb
;

125 
	`as£¹
((
ûÎ_šode_šfo
è<ğ(
INODE_COMMON_SIZE
));

126 
	`as£¹
Ğ
CELL_HEADER_SIZE
 < 1024 );

128 
su³r_mm­
 = 
	`mm­_disk
(
sb
->
dev
, 0); 
	`a¤t
(super_mmap);

129 
ûÎ_sb
 = (*)(
su³r_mm­
->
d©a
 + 
__1K
);

132 
sb
->
İ”©iÚs
 = &
ûÎ_sb_İ”©iÚs
;

133 
	`SB_COMMON
(
sb
)->
roÙûÎ
 = 
ûÎ_sb
->rootcell;

134 
	`SB_COMMON
(
sb
)->
ûÎsize
 = 
ûÎ_sb
->cellsize;

135 
	`SB_COMMON
(
sb
)->
ûÎnum
 = 
ûÎ_sb
->cellnum;

136 
	`SB_COMMON
(
sb
)->
b™m­
 = 
ûÎ_sb
->bitmap;

139 
d’Œy
 *
loÿl_roÙ
 = 
	`d_ü—‹
(0, &(
q¡r
){"/", 1, 0});

140 
loÿl_roÙ
->
šode
 = 
	`ig‘
(
sb
, 0);

141 
sb
->
roÙ
 = 
loÿl_roÙ
;

142 
loÿl_roÙ
->
sb
 = sb;

144 
	}
}

146 
	sbuf2
{

147 *
	mfœ¡buf
, *
	mÏ¡buf
;

150 
	$»ad
(
fe
 *fe, *
buf
, 
size
, *
µos
){

152 
šode
 *šodğ
fe
->
d’Œy
->inode;

153 if(!
fe
->
d©a
èfe->d©¨ğ
	`km®loc0
Ğ(
buf2
) );

154 
buf2
 *buf2 = 
fe
->
d©a
;

155 if(!
buf2
->
fœ¡buf
èbuf2->fœ¡buàğ
	`km®loc0
Ğ
BLOCK_SIZE
 );

156 if(!
buf2
->
Ï¡buf
èbuf2->Ï¡buàğ
	`km®loc0
Ğ
BLOCK_SIZE
 );

157 *
fœ¡buf
 = 
buf2
->firstbuf;

158 *
Ï¡buf
 = 
buf2
->lastbuf;

161 
ûÎ_addr
 = 
	`CELL_START
(
šode
->
šo
, inode->
sb
è* 
BLOCK_SIZE
;

162 
pos
 = 
ûÎ_addr
 + 
CELL_HEADER_SIZE
 + 
fe
->pos ;

163 
’d
 = 
pos
 + 
size
 - 1;

165 
fœ¡
 = 
pos
 / 
BLOCK_SIZE
;

166 
Ï¡
 = 
’d
 / 
BLOCK_SIZE
;

168 
	`Î_rw_blocks
(
šode
->
dev
, 
READ
, 
fœ¡
, 1, 
fœ¡buf
);

169 if(
Ï¡
 !ğ
fœ¡
è
	`Î_rw_blocks
(
šode
->
dev
, 
READ
,†a¡, 1, 
Ï¡buf
);

171 
fœ¡_Ëá
 = 
pos
 % 
BLOCK_SIZE
;

172 
fœ¡_right
 = 
BLOCK_SIZE
 - 
fœ¡_Ëá
;

173 *
addr
 = 
buf
 + 
fœ¡_right
;

174 
i
 = 
fœ¡
 + 1; i <ğ
Ï¡
 - 1; i++){

175 
	`Î_rw_blocks
(
šode
->
dev
, 
READ
, 
i
, 1, 
addr
);

176 
addr
 +ğ
BLOCK_SIZE
;

179 
	`memıy
(
buf
, 
fœ¡buf
 + 
fœ¡_Ëá
, 
	`mš
(
fœ¡_right
, 
size
) );

180 if(
Ï¡
 !ğ
fœ¡
è
	`memıy
(
addr
, 
Ï¡buf
, 
’d
 % 
BLOCK_SIZE
 + 1);

182  
size
;

183 
	}
}

185 
	$Úşo£
(
fe
 *file){

186 if(
fe
->
d©a
){

187 
buf2
 *buf2 = 
fe
->
d©a
;

188 
	`kä“
(
buf2
->
fœ¡buf
);

189 
	`kä“
(
buf2
->
Ï¡buf
);

190 
	`kä“
(
buf2
);

193 
	}
}

	@fs/dcache.c

1 
	~<lšux/dÿche.h
>

2 
	~<li¡.h
>

3 
	~<uts.h
>

7 
d’Œy
 *
	$d_ü—‹
(
d’Œy
 *
·»Á
, 
q¡r
 *qstr){

9 
d’Œy
 *d’Œy = 
	`kmem_ÿche_®loc
(
d’Œy_ÿche
, 0);

10 if(!
d’Œy
)  dentry;

11 *
¡r
 = 
	`km®loc
(
q¡r
->
Ën
 + 12);

12 
	`¡ºıy
(
¡r
, 
q¡r
->
Çme
, q¡r->
Ën
);

13 
¡r
[
q¡r
->
Ën
] = 0;

14 
d’Œy
->
Çme
.Çmğ
¡r
;

15 
d’Œy
->
Çme
.
Ën
 = 
q¡r
->len;

16 
d’Œy
->
Çme
.
hash
 = 
q¡r
->hash;

18 
d’Œy
->
·»Á
 = 0;

19 
d’Œy
->
šode
 = 0;

20 
d’Œy
->
İ”©iÚs
 = 0;

21 if(
·»Á
){

22 
d’Œy
->
·»Á
 =…arent;

23 
d’Œy
->
sb
 = 
·»Á
->sb;

26 
	`INIT_LIST_HEAD
(&
d’Œy
->
hash
);

27 
	`INIT_LIST_HEAD
(&
d’Œy
->
vfsmouÁ
);

28  
d’Œy
;

29 
	}
}

31 
	$d_»hash
(
d’Œy
 *
dœ
, 
hash
){

32 
hash
 = hash + (
u32
)
dœ
 / 4;

33  
hash
 % 
D_HASHTABLE_LEN
;

34 
	}
}

36 
d’Œy
 *
	$d_lookup
(
d’Œy
 *
dœ
, 
q¡r
 *
Çme
){

37 
li¡_h—d
 *
‹Áaşe
 = 
d’Œy_hashbË
 + 
	`d_»hash
(
dœ
, 
Çme
->
hash
);

38 
li¡_h—d
 *
’d
 = 
‹Áaşe
;

41  (
‹Áaşe
 =’şe->
Ãxt
)!ğ
’d
){

42 
d’Œy
 *
’t
 = 
	`MB2STRU
(d’Œy, 
‹Áaşe
, 
hash
);

43 if(
’t
->
·»Á
 !ğ
dœ
) ;

44 if(
’t
->
İ”©iÚs
 &&ƒÁ->İ”©iÚs->
com·»
){

45 if(
’t
->
İ”©iÚs
->
	`com·»
Ğ&’t->
Çme
,‚ame)) ;

48 if(
Çme
->
Ën
 !ğ
’t
->name.len) ;

49 if(
	`¡ºcmp
((*)
’t
->
Çme
.Çme, (*êame->Çme,‚ame->
Ën
)) ;

52  
’t
;

55 
	}
}

	@fs/exec.c

1 
	~<lšux/¦ab.h
>

2 
	~<´oc.h
>

3 
	~<lšux/bšfmts.h
>

4 
	~<lšux/mm.h
>

5 
	~<asm/”ºo.h
>

7 * 
cİy_¡ršg
(*
¡r
);

8 ** 
cİy_¡ršgs
(**
¡rs
);

9 
£¬ch_bš¬y_hªdËr
(
lšux_bš´m
 *
bš´m
,

10 
±_»gs
 *
»gs
);

12 
vm_¬—
 *
	$mk_¡ack_¬—
(){

13 
vm_¬—
 *
vma
 = 
	`kmem_ÿche_®loc
(
vm_¬—_ÿche
, 0);

14 
vma
->
’d
 = 
__3G
;

15 
vma
->
¡¬t
 = 
__3G
 - 
__1M
;

16 
vma
->
æags
.
v®ue
 = 
VM_STACK
;

17 
vma
->
mm
 = 
cu¼’t
->mm;

18 
vma
->
İs
 = 
NULL
;

19 
vma
->
fe
 = 
NULL
;

20 
vma
->
pgoff
 = 0;

21 
vma
->
Ãxt
 = vma->
´ev
 = vma;

22 
	`vm_upd©e_pg´Ù
(
vma
);

23  
vma
;

24 
	}
}

29 
	$do_execve
(*
f•©h
, *
¬gv
[], *
’vp
[], 
±_»gs
 *
»gs
){

30 
»t
;

31 
mm
 *
Şdmm
;

32 
lšux_bš´m
 
bš´m
;

33 
fe
 * fğ
	`k_İ’
(
f•©h
, 0, 0);

34 if(!
fe
è -
EINVAL
;

35 
bš´m
.
f•©h
 = filepath;

36 
bš´m
.
¬gv
 =‡rgv;

37 
bš´m
.
’vp
 =ƒnvp;

39 if(
f•©h
 < (*)
__3G
)

40 
bš´m
.
f•©h
 = 
	`cİy_¡ršg
(filepath);

42 if(
¬gv
 &&‡rgv < (**)
__3G
)

43 
bš´m
.
¬gv
 = 
	`cİy_¡ršgs
(argv);

45 if(
’vp
 &&ƒnv°< (**)
__3G
)

46 
bš´m
.
’vp
 = 
	`cİy_¡ršgs
(envp);

48 
bš´m
.
fe
 = file;

49 
rby‹s
 = 
	`k_»ad
(
fe
, 
bš´m
.
buf
, 128);

50 
	`as£¹
(
rby‹s
 == 128);

51 
Şdmm
 = 
cu¼’t
->
mm
;

54 
	`şi
();

58 
mm
 *mm = 
	`kmem_ÿche_®loc
(
mm_ÿche
, 0);

59 
u32
 * 
pgdœ
 = 
	`__®loc_·ge
(
__GFP_ZERO
);

60 
	`memıy
(
pgdœ
 + 256 * 3, (
u32
 *)
	`__va
(
__1M
) + 256*3, 224 * 4);

61 
mm
->
ü3
.
v®ue
 = 
	`__·
(
pgdœ
);

62 
mm
->
¡¬t_brk
 = mm->
brk
 = 0;

63 
mm
->
vma
 = 0;

64 
mm
->
u£rs
 = 1;

65 
cu¼’t
->
mm
 = mm;

67 
__asm__
 
	`__vŞ©e__
 ("mov %0, %%cr3\n\t"

69 :"r"(
cu¼’t
->
mm
->
ü3
.
v®ue
)

71 
g_tss
->
e¥0
 = ()
cu¼’t
 + 
THREAD_SIZE
;

74 if(
Şdmm
){

76 
	`Œy_»Ëa£_u£r_¥aû
(
Şdmm
);

79 
	`put_mm
(
Şdmm
);

85 
cu¼’t
->
mm
->
vma
 = 
	`mk_¡ack_¬—
();

88 
u32
 
e¥
 = 
__3G
;

89 
¬gc
, 
’vc
= 0;

90 **
¡km¬k_of_¬g
 = (*)
	`__®loc_·ge
(0);

91 **
¡km¬k_of_’v
 = (*)
	`__®loc_·ge
(0);

93 
i
;

94 **
§¼
 = 
bš´m
.
’vp
;

95 **
m¬k
 = 
¡km¬k_of_’v
;

96 
cİy_¬gs_to_u£r_¡ack
:

97 
i
 = 0; 
§¼
 && sarr[i]; i++){

98 
Ën
 = 
	`¡ºËn
(
§¼
[
i
], 
__4K
); ifÖ’ =ğ__4Kè -
EINVAL
;

99 
e¥
 -ğ
Ën
 + 1;

100 
	`¡rıy
((*)
e¥
, 
§¼
[
i
]);

101 
m¬k
[
i
] = (*)
e¥
;

103 
m¬k
[
i
] = 0;

104 if(
§¼
 =ğ
bš´m
.
’vp
){

105 
’vc
 = 
i
;

106 
§¼
 = 
bš´m
.
¬gv
;

107 
m¬k
 = 
¡km¬k_of_¬g
;

108 
cİy_¬gs_to_u£r_¡ack
;

110 
¬gc
 = 
i
;

113 
e¥
 &= ~3;

115 
e¥
 -ğ(
’vc
 + 1) * 4;

116 
’vp
 = (*)
e¥
;

117 
i
 = 0; i <ğ
’vc
; i++è
’vp
[i] = 
¡km¬k_of_’v
[i];

119 
e¥
 -ğ(
¬gc
 + 1) * 4;

120 
¬gv
 = (*)
e¥
;

121 
i
 = 0; i <ğ
¬gc
; i++è
¬gv
[i] = 
¡km¬k_of_¬g
[i];

123 
¬gv
[-1] = (*)
¬gc
;

125 
¬gv
[-2] = 0;

129 
»gs
->
e¥
 =ƒsp - 8;

134 
	`__ä“_·ge
(
¡km¬k_of_¬g
);

135 
	`__ä“_·ge
(
¡km¬k_of_’v
);

138 
»t
 = 
	`£¬ch_bš¬y_hªdËr
(&
bš´m
, 
»gs
); 
	`as£¹
(ret == 0);

140 
cu¼’t
->
time_¦iû
 = cu¼’t->
time_¦iû_fuÎ
 = 10;

141 
	`¡ºıy
(
cu¼’t
->
p_Çme
, 
bš´m
.
f•©h
, 
P_NAME_MAX
);

143  
»t
;

147 
	}
}

149 
lšux_bšfmt
 *
	gfÜm©s
;

150 
boŞ
 
	$»gi¡”_bšfmt
(
lšux_bšfmt
* 
bšfmt
){

151 if(!
bšfmt
 || !bšfmt->
lßd_bš¬y
è 
çl£
;

154 
IF
 = 
	`şi_ex
();

155 if(!
fÜm©s
){

156 
fÜm©s
 = 
bšfmt
;

157 
bšfmt
->
Ãxt
 = bšfmt->
´ev
 = binfmt;

160 
	`O_INSERT_BEFORE
(
fÜm©s
, 
bšfmt
);

162 if(
IF
è
	`¡i
();

164  
Œue
;;

165 
	}
}

171 
	$£¬ch_bš¬y_hªdËr
(
lšux_bš´m
 *
bš´m
,

172 
±_»gs
 *
»gs
)

174 
lšux_bšfmt
 *
fmt
 = 
fÜm©s
;

175 if(!
fmt
);

178 
»t
 = 
fmt
->
	`lßd_bš¬y
(
bš´m
, 
»gs
);

179 if(
»t
 =ğ-
ENOEXEC
) ;

180 if(
»t
 == 0 )  0;

181 if(
»t
 !ğ-
ENOEXEC
) „et;

183 
fmt
 = fmt->
Ãxt
;

184 }
fmt
 !ğ
fÜm©s
);

186  -
ENOEXEC
;

187 
	}
}

192 
	$drİ_fd
(
fes_¡ruù
 *
fes
){

193 if(
fes
->
f•
 !ğfes->
Üigš_f•
){

194 
	`kä“2
(
fes
->
f•
);

198 
	}
}

201 * 
	$cİy_¡ršg
(*
¡r
){

202 *
·ge
 = 
	`__®loc_·ge
(0);

203 
	`¡ºıy
(
·ge
, 
¡r
, 
__4K
);

204  
·ge
;

205 
	}
}

210 ** 
	$cİy_¡ršgs
(**
¬¿y
){

211 **
loc
 = 
	`__®loc_·ge
(0);

212 *
·ge
 = 
	`__®loc_·ge
(0);

213 *
de¡
 = 
·ge
;

214 
i
;

215 
i
 = 0; 
¬¿y
[i]; i++){

216 *
¤c
 = 
¬¿y
[
i
];

217 
loc
[
i
] = 
de¡
;

218 *
¤c
){

219 *
de¡
++ =*
¤c
++;

220 if(
de¡
 - 
·ge
 >ğ
__4K
)

221 
	`¥š
("bad");

223 *
de¡
++=0;

225 
loc
[
i
] = 0;

226  
loc
;

227 
	}
}

	@fs/inode.c

1 
	~<li¡.h
>

2 
	~<lšux/fs.h
>

3 
	~<uts.h
>

8 
šode
 *
	$ÿche_šode
(
su³r_block
 *
sb
, 
u32
 
šo
, 
hash
){

10 
šode
 *šodğ
	`kmem_ÿche_®loc
Ğ
šode_ÿche
, 0);

11 
šode
->
šo
 = ino;

12 
šode
->
sb
 = sb;

13 
šode
->
dev
 = 
sb
->dev;

14 
sb
->
İ”©iÚs
->
	`»ad_šode
(
šode
);

17 
	`hashbË_add
(
šode_hashbË
, 
hash
, &
šode
->hash);

18  
šode
;

19 
	}
}

20 
	$hash
(
su³r_block
 *
sb
, 
u32
 
šo
){

21  ((
u32
)
sb
/4 + 
šo
è% 
I_HASHTABLE_LEN
;

22 
	}
}

25 
šode
 *
	$ig‘
(
su³r_block
 *
sb
, 
šo
){

26 
hash_v®ue
 = 
	`hash
(
sb
, 
šo
);

27 
li¡_h—d
 *
h—d
 = 
šode_hashbË
 + 
hash_v®ue
;

28 
li¡_h—d
 *
cu¼
 = 
h—d
->
Ãxt
;

29 
cu¼
 !ğ
h—d
){

30 
šode
 *šodğ
	`MB2STRU
(šode, 
cu¼
, 
hash
);

31 if(
šode
->
šo
 =ğšØ&& inode->
sb
 == sb){

33  
šode
;

35 
cu¼
 = cu¼->
Ãxt
;

39  
	`ÿche_šode
(
sb
, 
šo
, 
hash_v®ue
);

40 
	}
}

	@fs/namei.c

3 
	~<lšux/fs.h
>

4 
	~<´oc.h
>

5 
	~<lšux/”ºo.h
>

6 
	~<li¡.h
>

8 
	#IS_MNT_PT
(
d’Œy
èĞ!
	`li¡_em±y
Ğ&(d’Œy)->
vfsmouÁ
è)

	)

9 
	#LOOKUP_DIR
 1

	)

14 
	$fŞlow_dÙdÙ
Ğ
š_dœ
 *
šdœ
){

16 if(
šdœ
->
d’Œy
 =ğ
cu¼’t
->
fs
->
roÙ
) ;

19 
vfsmouÁ
 *
mÁ_·»Á
 = 
šdœ
->
mÁ
->
·»Á
;

20 if(
šdœ
->
d’Œy
 =ğšdœ->
mÁ
->
sm®l_roÙ
){

23 if(
mÁ_·»Á
 =ğ
šdœ
->
mÁ
) ;

25 
šdœ
->
d’Œy
 = indœ->
mÁ
->
mouÁpošt
;

26 
šdœ
->
mÁ
 = 
mÁ_·»Á
;

27 
	`fŞlow_dÙdÙ
(
šdœ
);

34 
šdœ
->
d’Œy
 = indœ->d’Œy->
·»Á
;

35 
	}
}

42 
vfsmouÁ
 *

43 
	$’‹r_mouÁed
(
d’Œy
 *
mouÁpošt
, 
vfsmouÁ
 *
äom
){

44 
li¡_h—d
 *
tmp
 = 
mouÁpošt
->
vfsmouÁ
.
Ãxt
;

45  
tmp
 !ğ&
mouÁpošt
->
vfsmouÁ
){

46 
vfsmouÁ
 *
mÁ
 = 
	`MB2STRU
(vfsmouÁ, 
tmp
, 
şash
);

47 if(
mÁ
->
·»Á
 =ğ
äom
)  mnt;

48 
tmp
 =mp->
Ãxt
;

51 
	}
}

58 
d’Œy
 *
	$»®_lookup
(
d’Œy
 *
dœ
, 
q¡r
 *
Çme
){

62 
d’Œy
 *
subdœ
 = 
	`d_ü—‹
(
dœ
, 
Çme
);

65 
šode_İ”©iÚs
 *
i_İs
 = 
dœ
->
šode
->
İ”©iÚs
;

66 
”r
 = 
i_İs
->
	`lookup
(
dœ
->
šode
, 
subdœ
);

67 if(
”r
) {

69 
	`kä“
(
subdœ
);

73 
šode
 *šodğ
	`ig‘
(
subdœ
->
sb
, (
u32
)subdir->inode);

74 if(!
šode
){

75 
	`kä“
(
subdœ
);

79 
subdœ
->
šode
 = inode;

80 
	`hashbË_add
(
d’Œy_hashbË
, 
	`d_»hash
(
subdœ
->
·»Á
, subdœ->
Çme
.
hash
),\

81 &
subdœ
->
hash
);

82  
subdœ
;

83 
	}
}

86 
d’Œy
 *
	$ÿched_lookup
(
d’Œy
 *
·»Á
, 
q¡r
 *
·¹Ÿl
, 
æags
)

88 
d’Œy
 *
»suÉ
 = 
	`d_lookup
(
·»Á
, 
·¹Ÿl
);

89  
»suÉ
;

90 
	}
}

92 
	$·thw®k
(*
·th
, 
š_dœ
 *
šdœ
, 
æags
){

93 
hÙæags
 = 0;

94 cÚ¡ *
foÙ
 = 
·th
;

95 
q¡r
 
·¹Ÿl
;

96 if(*
foÙ
 == '/'){

97 
šdœ
->
d’Œy
 = 
cu¼’t
->
fs
->
roÙ
;

98 
šdœ
->
mÁ
 = 
cu¼’t
->
fs
->
roÙmÁ
;

99 
foÙ
++;

102 
šdœ
->
d’Œy
 = 
cu¼’t
->
fs
->
pwd
;

103 
šdœ
->
mÁ
 = 
cu¼’t
->
fs
->
pwdmÁ
;

106 
¡•
:

107 if(*
foÙ
 == 0)  0;

108 
·¹Ÿl
.
Çme
 = 
foÙ
;

110 *
foÙ
 && *foot != '/') foot++;

111 
·¹Ÿl
.
Ën
 = 
foÙ
 -…¬tŸl.
Çme
;

113 
·¹Ÿl
.
hash
 = 
	`¡r_hash
Õ¬tŸl.
Çme
,…¬tŸl.
Ën
);

114 if(*
foÙ
 == '/'){

115 
hÙæags
 |ğ
LOOKUP_DIR
;

116 
foÙ
++;

119 if(
·¹Ÿl
.
Çme
[0] == '.'){

120 
·¹Ÿl
.
Ën
){

122 if(
·¹Ÿl
.
Çme
[1] != '.') ;

123 
	`fŞlow_dÙdÙ
(
šdœ
);

125 
¡•
;

132 
d’Œy
 *
subdœ
 = 
	`ÿched_lookup
(
šdœ
->d’Œy, &
·¹Ÿl
, 
hÙæags
);

133 if(!
subdœ
èsubdœ = 
	`»®_lookup
(
šdœ
->
d’Œy
, &
·¹Ÿl
);

134 if(!
subdœ
)  1;

139 
vfsmouÁ
 *
ju¡_’‹r
 = 
šdœ
->
mÁ
;

140 
boŞ
 
m“t_mÁ
 = 0;

141 
	`IS_MNT_PT
(
subdœ
)){

142 
m“t_mÁ
 = 1;

143 
ju¡_’‹r
 = 
	`’‹r_mouÁed
(
subdœ
, just_enter);

144 if(!
ju¡_’‹r
) ;

145 
subdœ
 = 
ju¡_’‹r
->
sm®l_roÙ
;

146 
šdœ
->
mÁ
 = 
ju¡_’‹r
;

147 
šdœ
->
d’Œy
 = 
subdœ
;

150 if(!
m“t_mÁ
){

151 
šdœ
->
d’Œy
 = 
subdœ
;

153 
¡•
;

154 
	}
}

	@fs/open.c

1 
	~<lšux/fs.h
>

5 
	$g‘_unu£d_fd
(){

6 
fes_¡ruù
 *
fes
 = 
cu¼’t
->files;

7 
i
;

8 
i
 = 0; i < 
fes
->
max_fds
; i++){

9 if(
fes
->
f•
[
i
] == 0){

10 
fes
->
f•
[
i
] = (*)1;

11  
i
;

15 
Ãw_max
 = 
fes
->
max_fds
 * 2;

16 if(
Ãw_max
 > 
cu¼’t
->
¾im™s
[
RLIMIT_NOFILE
].
cur
)  -1;

18 
fe
 **
f•
 = 
	`km®loc
(4 * 
Ãw_max
);

19 
	`memıy
(
f•
, 
fes
->f•, 4 * fes->
max_fds
);

20 
fes
->
max_fds
 = 
Ãw_max
;

21 if(
fes
->
f•
 =ğfes->
Üigš_f•
è
	`kä“
(files->filep);

22 
fes
->
f•
 = filep;

24  
i
;

25 
	}
}

30 
	$sys_İ’
(*
·th
, 
æags
, 
mode
){

31 
š_dœ
 
šdœ
;

32 
”r
;

33 
”r
 = 
	`·thw®k
(
·th
, &
šdœ
, 0);

34 if(
”r
)  -1;

36 
fd
 = 
	`g‘_unu£d_fd
();

37 if(
fd
 == -1)  -1;

40 
fe
 *fğ
	`km®loc
( (file) );

41 
fe
->
d’Œy
 = 
šdœ
.dentry;

42 
fe
->
pos
 = 0;

43 
fe
->
couÁ
 = 1;

44 
fe
->
æags
 = flags;

45 
fe
->
d©a
 = 0;

46 
cu¼’t
->
fes
->
f•
[
fd
] = 
fe
;

53 
fe
->
mode
 = (
æags
 + 1) & 3;

56  
fd
;

57 
	}
}

	@fs/pipe.cn

1 
	~<lšux/fs.h
>

2 
	~<lšux/pe.h
>

4 
	$do_pe
Ğ
fd
[2]){

5 
fe
 *
rfe
, *
wfe
;

6 
rfe
 = 
kmem


7 
	}
}

	@fs/read_write.c

1 
	~<lšux/fs.h
>

2 
	~<lšux/”ºo.h
>

4 
	$do_l£ek
(
fe
 *fe, 
off£t
, 
Üigš
){

5 
Üigš
){

7 
off£t
 +ğ
fe
->
pos
;

10 
off£t
 +ğ
fe
->
d’Œy
->
šode
->
size
;

12 if(
off£t
 < 0è -
EINVAL
;

14 
fe
->
pos
 = 
off£t
;

16  
off£t
;

17 
	}
}

22 
	$sys_l£ek
(
fd
, 
off£t
, 
Üigš
){

23 
fe
 *fğ
	`fcheck
(
fd
);

24 
off£t
 = 
	`do_l£ek
(
fe
, off£t, 
Üigš
);

25 if(
off£t
 < 0) {

29  
off£t
;

30 
	}
}

32 
	$do_şo£
(
fe
 *file){

34 
fe_İ”©iÚs
 *
fİs
 = 
fe
->
d’Œy
->
šode
->
fe_İs
;

35 if(
fİs
->
Úşo£
èfİs->
	`Úşo£
(
fe
);

37 if(--
fe
->
couÁ
 == 0){

38 
	`kä“
(
fe
);

41 
	}
}

46 
	$sys_şo£
(
fd
){

47 
»t
;

48 if(
cu¼’t
->
fes
->
max_fds
 <ğ
fd
è -
EINVAL
;

49 ifĞ
cu¼’t
->
fes
->
f•
[
fd
] =ğ0è -
EINVAL
;

52 
fe
 *fğ
cu¼’t
->
fes
->
f•
[
fd
];

53 
»t
 = 
	`do_şo£
(
fe
);

54 
cu¼’t
->
fes
->
f•
[
fd
] = 0;

55  
»t
;

56 
	}
}

60 
	$do_»ad
(
fe
 *fe, *
buf
, 
size
){

61 if(!
fe
è -
EBADF
;

62 if(!(
fe
->
mode
 & 
FMODE_READ
)è -
EACCES
;

64 
fesize
 = 
fe
->
d’Œy
->
šode
->
size
;

65 if(
fe
->
pos
 + 
size
 > 
fesize
) size = filesize - file->pos;

66 
»t
 = 
fe
->
d’Œy
->
šode
->
fe_İs
->
	`»ad
(fe, 
buf
, 
size
, 0);

67  
»t
;

68 
	}
}

69 
	$sys_»ad
(
fd
, *
buf
, 
size
){

70 
by‹s_r
;

71 
fe
 *fğ
	`fcheck
(
fd
);

72 
by‹s_r
 = 
	`do_»ad
(
fe
, 
buf
, 
size
);

73 if(
by‹s_r
 < 0){

77  
by‹s_r
;

78 
	}
}

83 
fe
 * 
	$k_İ’
(*
·th
, 
ulÚg
 
æags
, ulÚg 
mode
){

84 
fd
 = 
	`sys_İ’
(
·th
, 
æags
, 
mode
);

85  
	`fg‘
(
fd
);

86 
	}
}

88 
	$k_»ad
(
fe
 *fe, *
buf
, 
size
){

89  
	`do_»ad
(
fe
, 
buf
, 
size
);

90 
	}
}

93 
	$k_£ek
(
fe
 *fe, 
off£t
, 
Üigš
){

94  
	`do_l£ek
(
fe
, 
off£t
, 
Üigš
);

95 
	}
}

97 
	$k_şo£
(
fe
*file){

98  
	`do_şo£
(
fe
);

99 
	}
}

	@fs/super.c

1 
	~<lšux/fs.h
>

2 
	~<uts.h
>

3 
fe_sy¡em_ty³
 *
	gfs_ty³s
;

4 
	$š™_vfs
(){

5 
d’Œy_ÿche
 = 
	`kmem_ÿche_ü—‹
("d’Œy_ÿche", (
d’Œy
), 0,

6 
SLAB_HWCACHE_ALIGN
, 0, 0);

7 
šode_ÿche
 = 
	`kmem_ÿche_ü—‹
("šode_ÿche", (
šode
), 0,

8 
SLAB_HWCACHE_ALIGN
, 0, 0);

10 
šode_hashbË
 = 
	`km®loc
((
li¡_h—d
è* 
I_HASHTABLE_LEN
);

11 
d’Œy_hashbË
 = 
	`km®loc
((
li¡_h—d
è* 
D_HASHTABLE_LEN
);

12 
i
 = 0; i < 
I_HASHTABLE_LEN
 || i < 
D_HASHTABLE_LEN
; i++){

13 if(
i
 < 
I_HASHTABLE_LEN
è
	`INIT_LIST_HEAD
(
šode_hashbË
 + i);

14 if(
i
 < 
D_HASHTABLE_LEN
è
	`INIT_LIST_HEAD
(
d’Œy_hashbË
 + i);

16 
	}
}

18 
»gi¡”_fesy¡em
(*
Çme
, (*
»ad_su³r
)(
su³r_block
 *)){

19 
fe_sy¡em_ty³
 *
t
 = 
	`km®loc
((file_system_type));

20 
	`¡rıy
(
t
->
Çme
,‚ame);

21 
t
->
»ad_su³r
 =„ead_super;

22 
	`LL_INSERT
(
fs_ty³s
, fs_ty³s, 
t
);

23 
	}
}

34 
vfsmouÁ
 * 
	$do_mouÁ
(
u16
 
dev
, *
dœ
, *
ty³
){

35 
fe_sy¡em_ty³
 *
cu¼
 = 
fs_ty³s
;

36 
cu¼
){

37 if(
	`¡rcmp
(
cu¼
->
Çme
, 
ty³
) == 0) ;

38 
cu¼
 = cu¼->
Ãxt
;

40 if(!
cu¼
)  0;

42 
š_dœ
 
šdœ
;

45 if(
dœ
[0] == '/' && dir[1] == 0){

46 
šdœ
.
d’Œy
 = 
	`d_ü—‹
(0, &(
q¡r
){"/", 1, 0});

47 
šdœ
.
mÁ
 = 0;

50 
”r
 = 
	`·thw®k
(
dœ
, &
šdœ
, 0);

51 if(
”r
)  0;

54 
vfsmouÁ
 *
vfsmÁ
 = 
	`km®loc
( (vfsmount) );

55 
su³r_block
 *
sb
 = 
	`km®loc
( (super_block) );

56 
sb
->
dev
 = dev;

57 
cu¼
->
	`»ad_su³r
(
sb
);

59 
vfsmÁ
->
sb
 = sb;

60 
vfsmÁ
->
sm®l_roÙ
 = 
sb
->
roÙ
;

61 
vfsmÁ
->
mouÁpošt
 = 
šdœ
.
d’Œy
;

62 
vfsmÁ
->
·»Á
 = 
šdœ
.
mÁ
;

64 
	`li¡_add
(&
vfsmÁ
->
şash
, &
šdœ
.
d’Œy
->
vfsmouÁ
);

65  
vfsmÁ
;

66 
	}
}

68 
	$sys_mouÁ
(* 
dev_Çme
, *
dœ_Çme
, *
ty³
, 
æags
, *
d©a
){

70 
	}
}

	@fs_cell.c

1 
	~"fs_ûÎ.h
"

3 
	$£¬ch_fe
(*
Çme
){

4 
i
 = 0;

5 
i
 < 
CELL_MAX
){

6 if(
	`¡rcmp
(
ûÎmbr
 + 
i
*
NAME_LEN
, 
Çme
) == 0)  i;

7 
i
++;

10 
	}
}

	@func_table.c

1 
	~<lšux/NR_sysÿÎ.h
>

3 (*
sys_execve
)();

4 (*
sys_fÜk
)();

5 (*
sys_´štf
)();

6 (*
sys_ex™
)();

7 (*
sys_wa™4
)();

9 
	#ENTRY
(
Çme
è[
NR_
 ##‚ame] = ()&
sys_
 ## 
	)
Çme

12 
func_bË
[255] =

14 
	`ENTRY
(
fÜk
),

15 
	`ENTRY
(
execve
),

16 
	`ENTRY
(
´štf
),

17 
	`ENTRY
(
ex™
),

18 
	`ENTRY
(
wa™4
),

19 
	}
};

	@garbage.c

2 
	#gpgdœ
 ((
u32
*)0xc0100000)

	)

3 
	#gpgtbl
 ((
u32
*)0xc0101000)

	)

7 
	#bud_equ®_m­
(
·ddr
,
tbÏddr
) \

9 
u32
 
dœ_’t
 = 
·ddr
/0x400000;\

10 
gpgdœ
[
dœ_’t
] = 
tbÏddr
|
PG_P
|
PG_RWW
|
PG_USS
; \

11 
u32
 
tbl_’t
 = (
·ddr
%0x400000)>>12;\

12 ((
u32
*)
	`KV
(
tbÏddr
))[
tbl_’t
] = 
·ddr
|
PG_P
|
PG_RWW
|
PG_USS
;\

13 } 0)

	)

18 
	gmem_’t™y
[0]='G';

19 
	gmem_’t™y
[1]='M';

20 
	gmem_’t™y
[2]='K';

21 
	gmem_’t™y
[3]='B';

	@i8259.c

1 
	~<i8259.h
>

2 
	~<œq.h
>

3 
	~<uts.h
>

4 
	~<asm/b™.h
>

6 
	#PIC1
 0x20

	)

7 
	#PIC2
 0xA0

	)

8 
	#PIC1_CMD
 
PIC1


	)

9 
	#PIC1_DATA
 (
PIC1
+1)

	)

10 
	#PIC2_CMD
 
PIC2


	)

11 
	#PIC2_DATA
 (
PIC2
+1)

	)

16 
	#ICW1_ICW4
 0x01

	)

17 
	#ICW1_SINGLE
 0x02

	)

18 
	#ICW1_INTERVAL4
 0x04

	)

19 
	#ICW1_LEVEL
 0x08

	)

20 
	#ICW1_INIT
 0x10

	)

22 
	#ICW4_8086
 0x01

	)

23 
	#ICW4_AUTO
 0x02

	)

24 
	#ICW4_BUF_SLAVE
 0x08

	)

25 
	#ICW4_BUF_MASTER
 0x0C

	)

26 
	#ICW4_SFNM
 0x10

	)

28 
	$i8259_mask
(
IRQlše
) {

29 
u16
 
pÜt
;

30 
u8
 
v®ue
;

32 if(
IRQlše
 < 8) {

33 
pÜt
 = 
PIC1_DATA
;

35 
pÜt
 = 
PIC2_DATA
;

36 
IRQlše
 -= 8;

38 
v®ue
 = 
	`š_by‹
(
pÜt
è| (1 << 
IRQlše
);

39 
	`out_by‹
(
pÜt
, 
v®ue
);

40 
	}
}

42 
	$i8259_unmask
(
IRQlše
) {

43 
u16
 
pÜt
;

44 
u8
 
v®ue
;

46 if(
IRQlše
 < 8) {

47 
pÜt
 = 
PIC1_DATA
;

49 
pÜt
 = 
PIC2_DATA
;

50 
IRQlše
 -= 8;

52 
v®ue
 = 
	`š_by‹
(
pÜt
è& ~(1 << 
IRQlše
);

53 
	`out_by‹
(
pÜt
, 
v®ue
);

54 
	}
}

56 
	#PIC_READ_IRR
 0x0¨

	)

57 
	#PIC_READ_ISR
 0x0b

	)

60 
u16
 
	$__pic_g‘_œq_»g
(
ocw3
)

64 
	`out_by‹
(
PIC1_CMD
, 
ocw3
);

65 
	`out_by‹
(
PIC2_CMD
, 
ocw3
);

66  (
	`š_by‹
(
PIC2_CMD
è<< 8è| in_by‹(
PIC1_CMD
);

67 
	}
}

70 
u16
 
	$pic_g‘_œr
()

72  
	`__pic_g‘_œq_»g
(
PIC_READ_IRR
);

73 
	}
}

76 
u16
 
	$pic_g‘_i¤
()

78  
	`__pic_g‘_œq_»g
(
PIC_READ_ISR
);

79 
	}
}

80 
	$’d_8259A
(
u32
 
œq
){

82 
	}
}

90 
	$mask_ªd_ack_8259A
(
u32
 
œq
){

91 if(
œq
 >ğ8è
	`out_by‹
(0xa0, 0x20);

92 
	`out_by‹
(0x20, 0x20);

93 
	}
}

95 
	$wr™e_imr_b™
(
boŞ
 
ma¡”
, 
b™_off£t
, 
v®ue
){

96 
pÜt
 = 
ma¡”
 ? 0x21 :0xa1;

97 
mask
 = 
	`š_by‹
(
pÜt
);

98 if(
v®ue
è
	`__bt
(&
mask
, 
b™_off£t
);

99 
	`__bŒ
(&
mask
, 
b™_off£t
);

100 
	`out_by‹
(
pÜt
, 
mask
);

101 
	}
}

103 
	$wr™e_imr_by_œq
(
œq
, 
v®ue
){

104 
	`as£¹
(
œq
 !ğ2 && irq >ğ0 && irq < 
NR_IRQS
);

106 if(
œq
 >= 8){

107 
œq
 -= 8;

108 
	`wr™e_imr_b™
(
çl£
, 
œq
, 
v®ue
);

110 
	`wr™e_imr_b™
(
Œue
, 
œq
, 
v®ue
);

111 
	}
}

113 
	$’abË_8259A_œq
(
u32
 
œq
){

114 
	`wr™e_imr_by_œq
(
œq
, 0);

115 
	}
}

117 
	$di§bË_8259A_œq
(
u32
 
œq
){

118 
	`wr™e_imr_by_œq
(
œq
, 1);

119 
	}
}

121 
	$š™_8259A
(
x
){

123 
	}
}

125 
hw_œq_cÚŒŞËr
 
	gi8259A_œq_ty³
 = {

126 
’abË_8259A_œq
,

127 
di§bË_8259A_œq
,

128 
mask_ªd_ack_8259A
,

129 
’d_8259A


132 
	$š™_ISA_œqs
(){

133 
	`š™_8259A
(0);

135 
i
 = 0; i < 
NR_IRQS
; i++){

136 
œq_desc
[
i
].
¡©us
 = 
IRQ_DISABLED
;

137 
œq_desc
[
i
].
¡©us
 += (1<<31);

138 
œq_desc
[
i
].
aùiÚ
 = 0;

139 if(
i
 < 16è
œq_desc
[i].
hw_hªdËr
 = &
i8259A_œq_ty³
;

140 
	`¥š
("irq channel‚umber > 16 !");

142 
	}
}

	@include/asm-generic/errno-base.h

1 #iâdeà
ERRNO_BASE_H


2 
	#ERRNO_BASE_H


	)

4 
	#EPERM
 1

	)

5 
	#ENOENT
 2

	)

6 
	#ESRCH
 3

	)

7 
	#EINTR
 4

	)

8 
	#EIO
 5

	)

9 
	#ENXIO
 6

	)

10 
	#E2BIG
 7

	)

11 
	#ENOEXEC
 8

	)

12 
	#EBADF
 9

	)

13 
	#ECHILD
 10

	)

14 
	#EAGAIN
 11

	)

15 
	#ENOMEM
 12

	)

16 
	#EACCES
 13

	)

17 
	#EFAULT
 14

	)

18 
	#ENOTBLK
 15

	)

19 
	#EBUSY
 16

	)

20 
	#EEXIST
 17

	)

21 
	#EXDEV
 18

	)

22 
	#ENODEV
 19

	)

23 
	#ENOTDIR
 20

	)

24 
	#EISDIR
 21

	)

25 
	#EINVAL
 22

	)

26 
	#ENFILE
 23

	)

27 
	#EMFILE
 24

	)

28 
	#ENOTTY
 25

	)

29 
	#ETXTBSY
 26

	)

30 
	#EFBIG
 27

	)

31 
	#ENOSPC
 28

	)

32 
	#ESPIPE
 29

	)

33 
	#EROFS
 30

	)

34 
	#EMLINK
 31

	)

35 
	#EPIPE
 32

	)

36 
	#EDOM
 33

	)

37 
	#ERANGE
 34

	)

	@include/asm-generic/errno.h

1 #iâdeà
ERRNO_H


2 
	#ERRNO_H


	)

3 
	~<asm-g’”ic/”ºo-ba£.h
>

	@include/asm-generic/fcntl.h

1 #iâdeà
ASM_GENERIC_FCNTL_H


2 
	#ASM_GENERIC_FCNTL_H


	)

3 
	#O_ACCMODE
 3

	)

4 
	#O_RDONLY
 0

	)

5 
	#O_WRONLY
 1

	)

6 
	#O_RDWR
 2

	)

	@include/asm-generic/io.h

	@include/asm/resource.h

1 #iâdeà
RESOURCE_H


2 
	#RESOURCE_H


	)

4 
	mRLIMIT_CPU
 ,

5 
	mRLIMIT_FSIZE
 ,

6 
	mRLIMIT_NOFILE
 ,

9 
	mRLIMIT_MAX


12 
	s¾im™
{

13 
	mcur
;

14 
	mmax
;

	@include/linux/NR_syscall.h

1 #iâdeà
NR_SYSCALL_H


2 
	#NR_SYSCALL_H


	)

3 
	#NR_bad
 0

	)

4 
	#NR_ex™
 1

	)

5 
	#NR_fÜk
 2

	)

6 
	#NR_»ad
 3

	)

7 
	#NR_wr™e
 4

	)

8 
	#NR_İ’
 5

	)

9 
	#NR_şo£
 6

	)

10 
	#NR_wa™pid
 7

	)

11 
	#NR_ü—t
 8

	)

12 
	#NR_lšk
 9

	)

14 
	#NR_´štf
 10

	)

15 
	#NR_execve
 11

	)

16 
	#NR_chdœ
 12

	)

17 
	#NR_time
 13

	)

18 
	#NR_mknod
 14

	)

19 
	#NR_chmod
 15

	)

20 
	#NR_lchown
 16

	)

21 
	#NR_b»ak
 17

	)

22 
	#NR_Şd¡©
 18

	)

23 
	#NR_l£ek
 19

	)

24 
	#NR_g‘pid
 20

	)

25 
	#NR_mouÁ
 21

	)

26 
	#NR_umouÁ
 22

	)

27 
	#NR_£tuid
 23

	)

28 
	#NR_g‘uid
 24

	)

29 
	#NR_¡ime
 25

	)

30 
	#NR_±¿û
 26

	)

31 
	#NR_®¬m
 27

	)

32 
	#NR_Şdf¡©
 28

	)

33 
	#NR_·u£
 29

	)

34 
	#NR_utime
 30

	)

35 
	#NR_¡ty
 31

	)

36 
	#NR_g‰y
 32

	)

37 
	#NR_acûss
 33

	)

38 
	#NR_niû
 34

	)

39 
	#NR_áime
 35

	)

40 
	#NR_sync
 36

	)

41 
	#NR_kl
 37

	)

42 
	#NR_»Çme
 38

	)

43 
	#NR_mkdœ
 39

	)

44 
	#NR_rmdœ
 40

	)

45 
	#NR_dup
 41

	)

46 
	#NR_pe
 42

	)

47 
	#NR_times
 43

	)

48 
	#NR_´of
 44

	)

49 
	#NR_brk
 45

	)

50 
	#NR_£tgid
 46

	)

51 
	#NR_g‘gid
 47

	)

52 
	#NR_sigÇl
 48

	)

53 
	#NR_g‘euid
 49

	)

54 
	#NR_g‘egid
 50

	)

55 
	#NR_acù
 51

	)

56 
	#NR_umouÁ2
 52

	)

57 
	#NR_lock
 53

	)

58 
	#NR_ioùl
 54

	)

59 
	#NR_fú
 55

	)

60 
	#NR_mpx
 56

	)

61 
	#NR_£gid
 57

	)

62 
	#NR_ulim™
 58

	)

63 
	#NR_ŞdŞduÇme
 59

	)

64 
	#NR_umask
 60

	)

65 
	#NR_chroÙ
 61

	)

66 
	#NR_u¡©
 62

	)

67 
	#NR_dup2
 63

	)

68 
	#NR_g‘µid
 64

	)

69 
	#NR_g‘pg½
 65

	)

70 
	#NR_£tsid
 66

	)

71 
	#NR_sigaùiÚ
 67

	)

72 
	#NR_sg‘mask
 68

	)

73 
	#NR_s£tmask
 69

	)

74 
	#NR_£Œeuid
 70

	)

75 
	#NR_£Œegid
 71

	)

76 
	#NR_sigsu¥’d
 72

	)

77 
	#NR_sig³ndšg
 73

	)

78 
	#NR_£tho¡Çme
 74

	)

79 
	#NR_£Œlim™
 75

	)

80 
	#NR_g‘¾im™
 76

	)

81 
	#NR_g‘ru§ge
 77

	)

82 
	#NR_g‘timeofday
 78

	)

83 
	#NR_£‰imeofday
 79

	)

84 
	#NR_g‘groups
 80

	)

85 
	#NR_£tgroups
 81

	)

86 
	#NR_£Ëù
 82

	)

87 
	#NR_symlšk
 83

	)

88 
	#NR_Şdl¡©
 84

	)

89 
	#NR_»adlšk
 85

	)

90 
	#NR_u£lib
 86

	)

91 
	#NR_sw­Ú
 87

	)

92 
	#NR_»boÙ
 88

	)

93 
	#NR_»addœ
 89

	)

94 
	#NR_mm­
 90

	)

95 
	#NR_munm­
 91

	)

96 
	#NR_Œunÿ‹
 92

	)

97 
	#NR_árunÿ‹
 93

	)

98 
	#NR_fchmod
 94

	)

99 
	#NR_fchown
 95

	)

100 
	#NR_g‘´iÜ™y
 96

	)

101 
	#NR_£riÜ™y
 97

	)

102 
	#NR_´of
 98

	)

103 
	#NR_¡©fs
 99

	)

104 
	#NR_f¡©fs
 100

	)

105 
	#NR_iİ”m
 101

	)

106 
	#NR_sock‘ÿÎ
 102

	)

107 
	#NR_sy¦og
 103

	)

108 
	#NR_£t™im”
 104

	)

109 
	#NR_g‘™im”
 105

	)

110 
	#NR_¡©
 106

	)

111 
	#NR_l¡©
 107

	)

112 
	#NR_f¡©
 108

	)

113 
	#NR_ŞduÇme
 109

	)

114 
	#NR_iİl
 110

	)

115 
	#NR_vhªgup
 111

	)

116 
	#NR_idË
 112

	)

117 
	#NR_vm86Şd
 113

	)

118 
	#NR_wa™4
 114

	)

119 
	#NR_sw­off
 115

	)

120 
	#NR_sysšfo
 116

	)

121 
	#NR_c
 117

	)

122 
	#NR_fsync
 118

	)

123 
	#NR_sig»tuº
 119

	)

124 
	#NR_şÚe
 120

	)

125 
	#NR_£tdomašÇme
 121

	)

126 
	#NR_uÇme
 122

	)

127 
	#NR_modify_ldt
 123

	)

128 
	#NR_adjtimex
 124

	)

129 
	#NR_m´Ùeù
 125

	)

130 
	#NR_sig´ocmask
 126

	)

131 
	#NR_ü—‹_moduË
 127

	)

132 
	#NR_š™_moduË
 128

	)

133 
	#NR_d–‘e_moduË
 129

	)

134 
	#NR_g‘_k”Ãl_syms
 130

	)

135 
	#NR_quÙaùl
 131

	)

136 
	#NR_g‘pgid
 132

	)

137 
	#NR_fchdœ
 133

	)

138 
	#NR_bdæush
 134

	)

139 
	#NR_sysfs
 135

	)

140 
	#NR_³rsÚ®™y
 136

	)

141 
	#NR_afs_sysÿÎ
 137

	)

142 
	#NR_£tfsuid
 138

	)

143 
	#NR_£tfsgid
 139

	)

144 
	#NR__Î£ek
 140

	)

145 
	#NR_g‘d’ts
 141

	)

146 
	#NR__Ãw£Ëù
 142

	)

147 
	#NR_æock
 143

	)

148 
	#NR_msync
 144

	)

149 
	#NR_»adv
 145

	)

150 
	#NR_wr™ev
 146

	)

151 
	#NR_g‘sid
 147

	)

152 
	#NR_fd©async
 148

	)

153 
	#NR__sysùl
 149

	)

154 
	#NR_mlock
 150

	)

155 
	#NR_muÆock
 151

	)

156 
	#NR_mlock®l
 152

	)

157 
	#NR_muÆock®l
 153

	)

158 
	#NR_sched_£¬am
 154

	)

159 
	#NR_sched_g‘·¿m
 155

	)

160 
	#NR_sched_£tscheduËr
 156

	)

161 
	#NR_sched_g‘scheduËr
 157

	)

162 
	#NR_sched_y›ld
 158

	)

163 
	#NR_sched_g‘_´iÜ™y_max
 159

	)

164 
	#NR_sched_g‘_´iÜ™y_mš
 160

	)

165 
	#NR_sched_¼_g‘_š‹rv®
 161

	)

166 
	#NR_Çno¦“p
 162

	)

167 
	#NR_m»m­
 163

	)

168 
	#NR_£Œesuid
 164

	)

169 
	#NR_g‘»suid
 165

	)

170 
	#NR_vm86
 166

	)

171 
	#NR_qu”y_moduË
 167

	)

172 
	#NR_pŞl
 168

	)

173 
	#NR_nfs£rvùl
 169

	)

174 
	#NR_£Œesgid
 170

	)

175 
	#NR_g‘»sgid
 171

	)

176 
	#NR_´ùl
 172

	)

177 
	#NR_¹_sig»tuº
 173

	)

178 
	#NR_¹_sigaùiÚ
 174

	)

179 
	#NR_¹_sig´ocmask
 175

	)

180 
	#NR_¹_sig³ndšg
 176

	)

181 
	#NR_¹_sigtimedwa™
 177

	)

182 
	#NR_¹_sigqueuešfo
 178

	)

183 
	#NR_¹_sigsu¥’d
 179

	)

184 
	#NR_´—d
 180

	)

185 
	#NR_pwr™e
 181

	)

186 
	#NR_chown
 182

	)

187 
	#NR_g‘cwd
 183

	)

188 
	#NR_ÿpg‘
 184

	)

189 
	#NR_ÿp£t
 185

	)

190 
	#NR_sig®t¡ack
 186

	)

191 
	#NR_£ndfe
 187

	)

192 
	#NR_g‘pmsg
 188

	)

193 
	#NR_pumsg
 189

	)

194 
	#NR_vfÜk
 190

	)

195 
	#NR_ug‘¾im™
 191

	)

196 
	#NR_mm­2
 192

	)

197 
	#NR_Œunÿ‹64
 193

	)

198 
	#NR_árunÿ‹64
 194

	)

199 
	#NR_¡©64
 195

	)

200 
	#NR_l¡©64
 196

	)

201 
	#NR_f¡©64
 197

	)

202 
	#NR_lchown32
 198

	)

203 
	#NR_g‘uid32
 199

	)

204 
	#NR_g‘gid32
 200

	)

205 
	#NR_g‘euid32
 201

	)

206 
	#NR_g‘egid32
 202

	)

207 
	#NR_£Œeuid32
 203

	)

208 
	#NR_£Œegid32
 204

	)

209 
	#NR_g‘groups32
 205

	)

210 
	#NR_£tgroups32
 206

	)

211 
	#NR_fchown32
 207

	)

212 
	#NR_£Œesuid32
 208

	)

213 
	#NR_g‘»suid32
 209

	)

214 
	#NR_£Œesgid32
 210

	)

215 
	#NR_g‘»sgid32
 211

	)

216 
	#NR_chown32
 212

	)

217 
	#NR_£tuid32
 213

	)

218 
	#NR_£tgid32
 214

	)

219 
	#NR_£tfsuid32
 215

	)

220 
	#NR_£tfsgid32
 216

	)

221 
	#NR_pivÙ_roÙ
 217

	)

222 
	#NR_mšcÜe
 218

	)

223 
	#NR_madvi£
 219

	)

224 
	#NR_madvi£1
 219

	)

225 
	#NR_g‘d’ts64
 220

	)

226 
	#NR_fú64
 221

	)

	@include/linux/arp.h

1 #iâdeà
LINUX_ARP_H


2 
	#LINUX_ARP_H


	)

3 
	~<Ãt/¬p.h
>

	@include/linux/assert.h

1 #iâdeà
ASSERT_H


2 
	#ASSERT_H


	)

4 
as£¹_func
(*
exp
,*
fe
,*
ba£_fe
,
lše
);

6 
	#as£¹
(
exp
) \

8 if(!(
exp
)è
	`as£¹_func
(#exp,
__FILE__
,
__BASE_FILE__
,
__LINE__
); \

9 } 0)

	)

12 
	#a¤t
 
as£¹


	)

	@include/linux/bh.h

1 #iâdeà
BH_H


2 
	#BH_H


	)

4 (*
	tbh_â
)(*
	td©a
) ;

5 
	#BH_FLAG_DISABLE
 1

	)

6 
bh_æags
;

7 
šlše
 
	$bh_’abË
(){

8 
bh_æags
 &ğ~ 
BH_FLAG_DISABLE
;

9 
	}
}

11 
šlše
 
	$bh_di§bË
(){

12 
bh_æags
 |ğ
BH_FLAG_DISABLE
;

13 
	}
}

15 
®loc_bh
(
bh_â
 
routše
, *
d©a
);

16 
ä“_bh
(
bhid
);

17 
m¬k_bh
(
bhid
);

18 
do_bh
();

	@include/linux/binfmts.h

1 #iâdeà
BINFMTS_H


2 
	#BINFMTS_H


	)

3 
	~<v®Ty³.h
>

4 
	g±_»gs
;

6 
	slšux_bš´m
{

7 *
	mf•©h
;

8 **
	m¬gv
;

9 **
	m’vp
;

11 
fe
 *
	mfe
;

12 
	mbuf
[128];

15 
	slšux_bšfmt
{

16 (*
	mlßd_bš¬y
)(
	mlšux_bš´m
 *, 
	m±_»gs
 *);

17 
lšux_bšfmt
 *
	mÃxt
, *
	m´ev
;

20 
boŞ
 
»gi¡”_bšfmt
(
lšux_bšfmt
* 
bšfmt
);

	@include/linux/blkdev.h

1 #iâdeà
BLKDEV_H


2 
	#BLKDEV_H


	)

3 
	~<v®Ty³.h
>

4 
	~<li¡.h
>

5 
	~<´oc.h
>

6 
	~<lšux/bufãr_h—d.h
>

7 
	#READ
 0

	)

8 
	#WRITE
 1

	)

9 
	#MAJOR
(
dev_id
è((dev_idè>> 8)

	)

10 
	#MINOR
(
dev_id
è((dev_idè& 0xff)

	)

12 
	#MKDEV
(
majÜ
, 
mšÜ
èĞ((majÜè<< 8è+ mšÜ )

	)

15 
	#BLK_UNIT
(
dev_id
è(
blk_devs
[ 
	`MAJOR
(dev_idè].
un™s
[
	`MINOR
(dev_id)])

	)

17 
	#MAX_BLKDEV
 200

	)

18 
	#MAX_REQUEST
 32

	)

19 
	#BLOCK_SIZE
 4096

	)

27 
	#SYSID_EXTEND
 0X5

	)

28 
	#SYSID_LINUX
 0X83

	)

29 
	#SYSID_FAT16
 0X6

	)

30 
	#SYSID_FAT32
 1

	)

31 
	#SYSID_NTFS
 0x7

	)

32 
	#SYSID_CELL
 0x20

	)

33 
	s·¹™iÚ
{

34 
	mboÙ
;

35 
	m¡¬t_h—d
;

36 
	m_¡¬t_£ùÜ
;

37 
	m¡¬t_cyËnd”
;

39 
	msys_id
;

40 
	m’d_h—d
;

41 
	m’d_£ùÜ
;

42 
	m’d_cyËnd”
;

44 
	m¡¬t_£ùÜ
;

45 
	mtÙ®_£ùÜs
;

48 
	s»que¡
{

49 
li¡_h—d
 
	m‹Áaşe
;

50 
u16
 
	mdev_id
;

51 
	mcmd
;

52 
	m¡¬t
;

53 
	mcouÁ
;

54 *
	mbuf
;

55 
pcb
 *
	mask”
;

56 
bufãr_h—d
 *
	mbh
;

62 
	sblk_un™
 {

67 
	m¡¬t_£ùÜ
;

68 
	mtÙ®_£ùÜs
;

69 
li¡_h—d
 *
	mhÙabË
;

70 
	mhÙabË_Ën
;

73 
	#HOTABLE_LEN2
 64

	)

76 
u32
 
	mdev_id
;

77 
boŞ
 
	mhªzi
;

83 
	sblk_dev
{

87 (*
	mdo_»que¡
)(
u32
 
	mdev_id
);

88 (*
	madd_»que¡
)(
»que¡
 *
	mrq
);

89 (*
	mglob®2loÿl
)(
u32
 *
	mdev
, 
ulÚg
 *
	mblock
);

98 
blk_un™
 **
	mun™s
;

99 
	mun™max
;

100 
	mun™cyşe
;

102 
blk_dev
 
	gblk_devs
[
MAX_BLKDEV
];

103 
	s»que¡_queue
{

104 
li¡_h—d
 
	mqueue_h—d
;

116 
	mruÂšg
;

125 
	g»que¡_queue
 * (
	tg‘_queue_â
)(
	tu16
 
	tdev_id
);

126 
	squeue_g‘‹r
{

127 
»que¡_queue
 
	m»que¡_queue
;

128 
g‘_queue_â
 * 
	mg‘_queue
;

129 *
	md©a
;

134 
»que¡_queue
 * 
blk_g‘_queue
(
u16
 
dev_id
);

136 
Î_rw_blocks
(
u32
 
dev_id
, 
rw
, 
ulÚg
 
¡¬t
, ulÚg 
couÁ
, *
buf
);

138 
Î_rw_block
(
rw
, 
bufãr_h—d
 *
bufãrh—d
);

139 
»gi¡”_queue_g‘‹r
(
majÜ
, 
g‘_queue_â
 *
g‘_queue
, *
d©a
);

141 
»gi¡”_blkun™
(
blk_un™
 *
un™
, 
u32
 
dev
);

142 
»gi¡”_blkdev
(
majÜ
);

143 
bufãr_h—d
 *
mm­_disk
(
u32
 
dev
, 
ulÚg
 
block
);

144 
munm­_disk
(
bufãr_h—d
 *
block
);

146 
š™_blkÏy”_basic
();

147 
š™_blkÏy”
();

150 
g’”ic_mk_»que¡
(
rw
, 
bufãr_h—d
 *
bh
);

153 
	#BLOCK_SECTORS
 (
BLOCK_SIZE
 / 512)

	)

154 
	#block2£ùÜs
(
blocknum
èĞ(blocknum )* 
BLOCK_SECTORS
)

	)

155 
	#block2lba
 
block2£ùÜs


	)

156 
	#lba2block
(
lba
èĞÖbaè/ 
BLOCK_SECTORS
)

	)

	@include/linux/buffer_head.h

1 #iâdeà
BUFFER_HEAAD_H


2 
	#BUFFER_HEAAD_H


	)

3 
	~<v®Ty³.h
>

4 
	~<li¡.h
>

7 
	sbufãr_h—d
{

8 
u32
 
	mdev_id
;

9 
ulÚg
 
	mblock
;

10 *
	md©a
;

12 
boŞ
 
	mio
;

13 
boŞ
 
	mlock
;

14 
boŞ
 
	mdœty
;

17 
	mcouÁ
;

18 
li¡_h—d
 
	mhash
;

19 
li¡_h—d
 
	mÌu
;

20 
li¡_h—d
 
	mwa™
;

	@include/linux/byteorder/generic.h

1 #iâdeà
BYTEORDER_GENERIC_H


2 
	#BYTEORDER_GENERIC_H


	)

3 
	~<v®Ty³.h
>

4 
šlše
 
u16
 
	$htÚs
(
u16
 
ho¡shÜt
){

5 
__asm__
 
	`__vŞ©e__
("xchg %%ah, %%al"

6 :"÷"(
ho¡shÜt
)

7 :"a"(
ho¡shÜt
)

9  
ho¡shÜt
;

10 
	}
}

12 
šlše
 
u32
 
	$htÚl
(
u32
 
ho¡lÚg
){

13 
__asm__
 
	`__vŞ©e__
("bswap %1"

14 :"ô"(
ho¡lÚg
)

15 :"r"(
ho¡lÚg
)

17  
ho¡lÚg
;

18 
	}
}

19 
	#Áohs
(
x
è
	`htÚs
(x)

	)

20 
	#Áohl
(
x
è
	`htÚl
(x)

	)

22 
	#BYTE_ENDIAN_FLIP2
(
x
èx = 
	`htÚs
(x)

	)

23 
	#BYTE_ENDIAN_FLIP4
(
x
èx = 
	`htÚl
(x)

	)

	@include/linux/cell.h

1 #iâdeà
CELL_H


2 
	#CELL_H


	)

3 
	~<lšux/ûÎ_commÚ.h
>

5 
	sûÎ_sb_šfo
{

6 
	mroÙûÎ
;

7 
	mûÎsize
;

8 
	mûÎnum
;

9 *
	mb™m­
;

13 
	sûÎ_šode_šfo
{

16 
ûÎ_»ad_su³r
(
su³r_block
 *
sb
);

	@include/linux/cell_common.h

6 #iâdeà
CELL_COMMON_H


7 
	#CELL_COMMON_H


	)

9 
	#ROOTCELL_DEFAULT
 4096

10 
	#CELL_SIZE
 (128 * 1024)

	)

11 
	#CELL_HEADER_SIZE
 ()(((
ûÎ
 *)0)->
d©a
)

	)

12 
	#CELL_DATA_MAX
 (
CELL_SIZE
 - 
CELL_HEADER_SIZE
)

	)

13 
	sûÎ_d’Œy
{

14 
	mËn
;

15 
	mûÎid
;

16 
	mÇme
[0];

18 
	sûÎ
{

19 
	mmktime
;

20 
	mchgtime
;

21 
	msize
;

22 
	mty³
;

24 
ûÎ_d’Œy
 
	m’ts
[0];

25 
	md©a
[0];

28 
	sûÎ_su³rblock
{

31 
	mæags
[4];

32 
	mûÎsize
;

33 
	mûÎnum
;

34 
	mroÙûÎ
;

35 
	mb™m­
[0];

38 
	mroom
[1024];

	@include/linux/ctype.h

1 #iâdeà
CTYPE_H


2 
	#CTYPE_H


	)

3 
	~<v®Ty³.h
>

5 
šlše
 
boŞ
 
	$isdig™
(
c
){

6  
c
 <= 9 && c >= 0;

7 
	}
}

	@include/linux/dcache.h

1 #iâdeà
DCACHE_H


2 
	#DCACHE_H


	)

3 
	~<li¡.h
>

4 
	~<lšux/mouÁ.h
>

6 
li¡_h—d
 *
	gd’Œy_hashbË
;

7 
	#D_HASHTABLE_LEN
 1024

	)

9 
	sq¡r
{

10 cÚ¡ *
	mÇme
;

11 
	mËn
;

12 
	mhash
;

14 
	sd’Œy_İ”©iÚs
{

15 (*
	mcom·»
è(
	mq¡r
 *, qstr *);

17 
	sd’Œy
{

18 
šode
 *
	mšode
;

19 
d’Œy
 *
	m·»Á
;

20 
su³r_block
 *
	msb
;

21 
q¡r
 
	mÇme
;

22 
d’Œy_İ”©iÚs
 *
	mİ”©iÚs
;

23 
li¡_h—d
 
	mvfsmouÁ
;

24 
	mcouÁ
;

26 
li¡_h—d
 
	mhash
;

60 
d’Œy
 *
	$dg‘
(
d’Œy
 *
dœ
){

61 
dœ
->
couÁ
 ++;

62  
dœ
;

63 
	}
}

97 
	$dput
(
d’Œy
 *dentry)

99 ià(!
d’Œy
)

102 
»³©
:

103 ià(
	`©omic_»ad
(&
d’Œy
->
d_couÁ
) == 1)

104 
	`might_¦“p
();

105 ià(!
	`©omic_dec_ªd_lock
(&
d’Œy
->
d_couÁ
, &
dÿche_lock
))

108 
	`¥š_lock
(&
d’Œy
->
d_lock
);

109 ià(
	`©omic_»ad
(&
d’Œy
->
d_couÁ
)) {

110 
	`¥š_uÆock
(&
d’Œy
->
d_lock
);

111 
	`¥š_uÆock
(&
dÿche_lock
);

118 ià(
d’Œy
->
d_İ
 && d’Œy->d_İ->
d_d–‘e
) {

119 ià(
d’Œy
->
d_İ
->
	`d_d–‘e
(dentry))

120 
unhash_™
;

123 ià(
	`d_unhashed
(
d’Œy
))

124 
kl_™
;

125 ià(
	`li¡_em±y
(&
d’Œy
->
d_Ìu
)) {

126 
d’Œy
->
d_æags
 |ğ
DCACHE_REFERENCED
;

127 
	`d’Œy_Ìu_add
(
d’Œy
);

129 
	`¥š_uÆock
(&
d’Œy
->
d_lock
);

130 
	`¥š_uÆock
(&
dÿche_lock
);

133 
unhash_™
:

134 
	`__d_drİ
(
d’Œy
);

135 
kl_™
:

137 
	`d’Œy_Ìu_d–
(
d’Œy
);

138 
d’Œy
 = 
	`d_kl
(dentry);

139 ià(
d’Œy
)

140 
»³©
;

141 
	}
}

154 
d’Œy
 *
d_ü—‹
(d’Œy *
·»Á
, 
q¡r
 *qstr);

155 
d’Œy
 *
d_lookup
(d’Œy *
dœ
, 
q¡r
 *
Çme
);

157 
	~<lšux/¦ab.h
>

158 
¦ab_h—d
 *
	gd’Œy_ÿche
;

160 
d_»hash
(
d’Œy
 *
dœ
, 
hash
);

161 
šlše
 
d’Œy
 * 
	$dg‘
(
d’Œy
 *dentry){

162 
d’Œy
->
couÁ
++;

163  
d’Œy
;

164 
	}
}

166 
šlše
 
	$dput
(
d’Œy
 *dentry){

167 
d’Œy
->
couÁ
--;

168 
	}
}

	@include/linux/errno.h

10 #iâdeà
LINUX_ERRNO_H


11 
	#LINUX_ERRNO_H


	)

12 
	~<asm/”ºo.h
>

	@include/linux/fs.h

1 #iâdeà
FS_H


2 
	#FS_H


	)

3 
	~<lšux/dÿche.h
>

4 
	~<´oc.h
>

5 
	~<lšux/¦ab.h
>

11 
	#FMODE_READ
 1

	)

13 
	#FMODE_WRITE
 2

	)

15 
	#FMODE_SEEK
 4

	)

17 
	sšode_İ”©iÚs
{

26 (*
	mlookup
)(
šode
 *
	mdœ
, 
d’Œy
 *
	md’Œy
);

30 
	gsu³r_block
;

31 
	gfe_İ”©iÚs
;

32 
	sšode
{

33 
	mšo
;

34 
u16
 
	mdev
;

35 
u16
 
	mrdev
;

36 
u32
 
	mmktime
;

37 
u32
 
	mchgtime
;

38 
u32
 
	msize
;

39 
su³r_block
 *
	msb
;

40 
šode_İ”©iÚs
 *
	mİ”©iÚs
;

41 
fe_İ”©iÚs
 *
	mfe_İs
;

42 
li¡_h—d
 
	mhash
;

44 
	#INODE_COMMON_SIZE
 128

	)

45 
	mcommÚ
[
INODE_COMMON_SIZE
];

48 
	ssu³r_İ”©iÚs
{

49 (*
	m»ad_šode
)(
šode
 *
	mšode
);

51 
	ssu³r_block
{

52 
su³r_İ”©iÚs
 *
	mİ”©iÚs
;

53 
d’Œy
 *
	mroÙ
;

54 
u16
 
	mdev
;

55 
	mcommÚ
[512];

58 
	sš_dœ
{

59 
d’Œy
 *
	md’Œy
;

60 
vfsmouÁ
 *
	mmÁ
;

63 
	sfe_sy¡em_ty³
{

64 
	mÇme
[16];

65 (*
	m»ad_su³r
)(
	msu³r_block
 *);

66 
fe_sy¡em_ty³
 *
	mÃxt
, *
	m´ev
;

69 
li¡_h—d
 *
	gšode_hashbË
;

70 
	#I_HASHTABLE_LEN
 4096

	)

72 
	sfe
{

73 
d’Œy
 *
	md’Œy
;

74 
	mpos
;

75 
	mæags
;

76 
	mmode
;

78 
	mcouÁ
;

79 *
	md©a
;

85 
	sfe_İ”©iÚs
{

86 (*
	ml£ek
)(
	mfe
 *, 
	moff£t
, 
	mÜigš
);

87 (*
	m»ad
)(
	mfe
 *, *
	m·th
, 
	msize
,

88 *
	mµos
);

89 (*
	mİ’
)(
	mšode
 *, 
	mfe
 *);

90 (*
	mÚşo£
)(
	mfe
 *);

95 
šlše
 
fe
 *
	$fcheck
(
fd
){

96 if(
fd
 >ğ
cu¼’t
->
fes
->
max_fds
)  0;

97  
cu¼’t
->
fes
->
f•
[
fd
];

98 
	}
}

99 
šlše
 
fe
 *
	$fg‘
(
fd
){

100 
fe
 *fğ
	`fcheck
(
fd
);

101 if(
fe
){

102 
fe
->
couÁ
++;

104  
fe
;

105 
	}
}

106 
»gi¡”_fesy¡em
(*
Çme
, (*
»ad_su³r
)(
su³r_block
 *));

107 
vfsmouÁ
 * 
	`do_mouÁ
(
u16
 
dev
, *
dœ
, *
ty³
);

108 
	`š™_vfs
();

110 
	`·thw®k
(*
·th
, 
š_dœ
 *
šdœ
, 
æags
);

111 
šode
 *
	`ig‘
(
su³r_block
 *
sb
, 
šo
);

112 
	`sys_İ’
(*, , );

113 
	`sys_»ad
(, *, );

115 
¦ab_h—d
 *
šode_ÿche
;

116 
¦ab_h—d
 *
fe_ÿche
;

119 
fe
 * 
	`k_İ’
(*
·th
, 
ulÚg
 
æags
, ulÚg 
mode
);

120 
	`k_£ek
(
fe
 *fe, 
off£t
, 
Üigš
);

121 
	`k_»ad
(
fe
 *fe, *
buf
, 
size
);

122 
	`k_şo£
(
fe
*file);

123 
	#g‘_fe
(
fe
èĞ(fe)->
couÁ
++ )

	)

125 
¦ab_h—d
 *

	@include/linux/fs_struct.h

1 #iâdeà
FS_STRUCT_H


2 
	#FS_STRUCT_H


	)

3 
	sfs_¡ruù
{

4 
d’Œy
 *
	mroÙ
, *
	mpwd
;

5 
vfsmouÁ
 *
	mroÙmÁ
, *
	mpwdmÁ
;

	@include/linux/icmp.h

1 #iâdeà
LINUX_ICMP_H


2 
	#LINUX_ICMP_H


	)

3 
	~<Ãt/icmp.h
>

	@include/linux/ide.h

1 #iâdeà
IDE_H


2 
	#IDE_H


	)

3 
	~<lšux/blkdev.h
>

5 
	#WIN_READ
 0x20

	)

6 
	#WIN_WRITE
 0x30

	)

7 
	#WIN_IDENTIFY
 0xec

	)

9 
	#IDE_NR_PORTS
 255

	)

10 
	#MAX_DRIVES
 2

	)

13 
	#STATUS_ERR
 1

	)

14 
	#STATUS_INDEX
 2

	)

15 
	#STATUS_ECC
 4

	)

16 
	#STATUS_DRQ
 8

	)

17 
	#STATUS_SEEK
 16

	)

18 
	#STATUS_WRERR
 32

	)

19 
	#STATUS_READY
 64

	)

20 
	#STATUS_BUSY
 128

	)

22 
	#REG_DATA
 (0x1f0)

	)

24 
	#REG_ERROR
 (0X1F1)

	)

25 
	#REG_FEATURES
 (0X1F1)

	)

27 
	#REG_COUNT
 (0X1F2)

	)

28 
	#REG_LBA_LOW
 (0X1F3)

	)

29 
	#REG_LBA_MID
 (0X1F4)

	)

30 
	#REG_LBA_HIGH
 (0x1F5)

	)

31 
	#REG_DEVICE
 (0X1F6)

	)

33 
	#REG_STATUS
 (0x1F7)

	)

34 
	#REG_COMMAND
 (0x1F7)

	)

36 
	#REG_CONTROL
 (0X3F6)

	)

38 
	mSLOT_REG_DATA
,

39 
	mSLOT_REG_FEATURES
,

40 
	mSLOT_REG_COUNT
,

41 
	mSLOT_REG_LBA_LOW
,

42 
	mSLOT_REG_LBA_MID
,

43 
	mSLOT_REG_LBA_HIGH
,

44 
	mSLOT_REG_DEVICE
,

45 
	mSLOT_REG_COMMAND
,

47 
	mSLOT_REG_CONTROL
,

48 
	mSLOT_REG_STATUS
 = 
SLOT_REG_COMMAND
,

49 
	mSLOT_REG_ERROR
 = 
SLOT_REG_FEATURES
,

56 
	s£Ëù
{

57 
u8
 
	mh—d
: 4;

58 
u8
 
	mdrv
: 1;

59 
u8
 
	mb™5
: 1;

60 
u8
 
	mlba
: 1;

61 
u8
 
	mb™7
: 1;

63 
	slba
{

64 
u8
 
	mlow
;

65 
u8
 
	mmiddË
;

66 
u8
 
	mhigh
;

67 
£Ëù
 
	m£Ëù
;

71 
	side_drive
{

72 
»que¡_queue
 
	mqueue
;

73 
	m´e£Á
: 1;

76 
	side_hwif
{

77 
	mio_pÜts
[
IDE_NR_PORTS
];

78 
ide_drive
 
	mdrive
[
MAX_DRIVES
];

79 
»que¡
 *
	mcur_rq
;

80 (*
	mhªdËr
)(
	mide_hwif
 *);

83 
ide_š™
();

84 
ide_»ad_·¹©iÚ
(
majÜ
, 
drive
);

	@include/linux/if_ether.h

1 #iâdeà
IF_ETHER_H


2 
	#IF_ETHER_H


	)

3 
	~<v®Ty³.h
>

5 #´agm¨
·ck
(
push
)

6 #´agm¨
·ck
(1)

7 
	s‘hhdr
{

8 
	myourmac
[6];

9 
	mmymac
[6];

10 
u16
 
	m´ÙocŞ
;

12 #´agm¨
·ck
(
pİ
)

14 
	#ETHHDR_LEN
 (Ğ
‘hhdr
è)

	)

	@include/linux/ip.h

1 #iâdeà
LINUX_IP_H


2 
	#LINUX_IP_H


	)

3 
	~<Ãt/.h
>

	@include/linux/kit.h

1 #iâdeà
KIT_H


2 
	#KIT_H


	)

8 
šlše
 
	$û2n
(
x
){

9 
highe¡
;

10 
__asm__
 
	`__vŞ©e__
("bsr %1, %0"

11 :"ô"(
highe¡
)

12 :"r"(
x
)

14 
mask
 = (1 << 
highe¡
) - 1;

15  (
x
 + 
mask
) & ~mask;

16 
	}
}

22 
šlše
 
	$pgÜd”_Ãeded
(
Ä
){

23 
Üd”
;

24 
Ä
 = 
	`û2n
(nr);

25 
__asm__
 
	`__vŞ©e__
("bsr %1, %0"

26 :"ô"(
Üd”
)

27 :"r"(
Ä
)

29  
Üd”
;

30 
	}
}

33 
šlše
 
	$û_div
(
a
, 
b
){

34 
quÙ›Á
;

35 
__asm__
 
	`__vŞ©e__
("xor %%edx, %%edx\n\t"

39 :"÷"(
quÙ›Á
)

40 :"a"(
a
), "b"(
b
));

41  
quÙ›Á
;

42 
	}
}

44 
šlše
 
ulÚg
 
	$û_®ign
(
ulÚg
 
x
, ulÚg 
g¿nuÏr™y
){

45 
ulÚg
 
mask
 = 
g¿nuÏr™y
 - 1;

46  (
x
 + 
mask
) & ~mask;

47 
	}
}

49 
šlše
 
ulÚg
 
	$æoÜ_®ign
(
ulÚg
 
x
, ulÚg 
®ign
){

50 
ulÚg
 
mask
 = 
®ign
 - 1;

51  
x
 & ~
mask
;

52 
	}
}

55 
	#POINTER_SHIFT
(
±
,
ty³
,
Ën
èÑy³*)((
u32
ít+Ën)

	)

56 
	#EXCHG_U32
(
a
,
b
èdo{
c
÷;a=b;b=c;} 0)

	)

57 
	#EXCHG_PTR
(
a
, 
b
èdØ{ *
tmp
 =‡;‡ = b; b =mp; } 0)

	)

58 
	#EXCHG_U16
(
a
,
b
èdo{ 
u16
 
tmp
 =‡;‡ = b; b =mp; } 0)

	)

60 
	#±r_off£t
(
±r
, 
by‹s
) \

61 ((*)Ğ()
±r
 + ()(
by‹s
èè)

	)

	@include/linux/mm.h

1 #iâdeà
LINUX_MM_H


2 
	#LINUX_MM_H


	)

4 
	~<v®Ty³.h
>

5 
	~<uts.h
>

6 
	~<li¡.h
>

7 
	~<mmzÚe.h
>

8 
	~<pmm.h
>

9 
	~<lšux/sched.h
>

13 
	smem_£gšfo
{

14 
u32
 
	mba£_low
, 
	mba£_high
;

15 
u32
 
	mËn_low
, 
	mËn_high
;

16 
u32
 
	mty³
;

21 
mm_š™
();

22 
mm_š™2
();

23 
u32
 
gmemsize
;

26 
šlše
 
	$size2·ges
(
size
){

27 
Ëa¡_·ges
 = (
size
 + (
PAGE_SIZE
 - 1)è>> 
PAGE_SHIFT
;

29  
	`û2n
(
Ëa¡_·ges
);

30 
	}
}

33 #´agm¨
·ck
(
push
)

34 #´agm¨
·ck
(1)

35 
	uvm_æags
{

37 
	m»adabË
: 1;

38 
	mwr™abË
: 1;

39 
	mexecubË
: 1;

40 
	msh¬ed
: 1;

42 
	mmay»ad
: 1;

43 
	mmaywr™e
: 1;

44 
	mmayexec
: 1;

45 
	mmaysh¬e
: 1;

47 
	mgrowsdown
: 1;

48 
	mgrowsup
: 1;

49 
	md’ywr™e
: 1;

50 
	mdÚtcİy
: 1;

52 
	mv®ue
;

54 #´agm¨
·ck
(
pİ
)

57 
	mVM_READ
 = 1<<0,

58 
	mVM_WRITE
 = 1<<1,

59 
	mVM_EXEC
 = 1<<2,

60 
	mVM_SHARED
 = 1<<3,

62 
	mVM_MAYREAD
 = 1<<4,

63 
	mVM_MAYWRITE
 = 1<<5,

64 
	mVM_MAYEXEC
 = 1<<6,

65 
	mVM_MAYSHARE
 = 1<<7,

68 
	mVM_GROWSDOWN
= 1<<8,

69 
	mVM_GROWSUP
 = 1<<9,

70 
	mVM_DENYWRITE
= 1<<10,

71 
	mVM_DONTCOPY
 = 1<<11,

73 
	mVM_STACK
 = 
VM_READ
 | 
VM_WRITE
 | 
VM_GROWSDOWN
 | 
VM_MAYREAD
 | 
VM_MAYWRITE
,

77 
	mMAP_FIXED
 = 0,

80 
	gvm_¬—
;

81 
	svm_İ”©iÚs
{

82 (*
	mİ’
)(
vm_¬—
 *
	m¬—
);

83 (*
	mşo£
)(
vm_¬—
 *
	m¬—
);

84 
	m·ge
 *(*
	mnİage
)(
vm_¬—
 *
	m¬—
, 
u32
 
	madd»ss
, 
pg”r_code
 
	m”rcode
);

87 
	svm_¬—
{

88 
mm
 *
	mmm
;

89 
u32
 
	m¡¬t
;

90 
u32
 
	m’d
;

91 
±e
 
	mem±y_±e
;

95 
vm_æags
 
	mæags
;

97 
vm_¬—
 *
	m´ev
, *
	mÃxt
;

98 
vm_İ”©iÚs
 *
	mİs
;

99 
fe
 *
	mfe
;

100 
u32
 
	mpgoff
;

103 
¦ab_h—d
 *
vm_¬—_ÿche
;

104 
¦ab_h—d
 * 
mm_ÿche
;

105 
vm_upd©e_pg´Ù
(
vm_¬—
 *
vma
);

106 
u32
 
g‘_unm­³d_¬—
(u32 
addr
, u32 
Ën
);

107 
vm_¬—
 *
fšd_vma
(
mm
 *mm, 
addr
);

108 * 
mm­
(
ulÚg
 
addr
, 
u32
 
Ën
, 
vm_æags
, 
m­_æags
, 
fe
 *fe, u32 
off£t
);

110 
·ge
 *

111 
commÚ_no_·ge
(
vm_¬—
 *
vma
, 
u32
 
”r_addr
, 
pg”r_code
 
”rcode
);

114 
šlše
 
vm_¬—
 *

115 
	$fšd_vma_š‹r£ùiÚ
(
mm
 *mm,

116 
¡¬t_addr
, 
’d_addr
)

118 
vm_¬—
 *
b’—th
 = 
	`fšd_vma
(
mm
, 
¡¬t_addr
);

119 if(
b’—th
 && b’—th->
¡¬t
 < 
’d_addr
){

120  
b’—th
;

123 
	}
}

125 
boŞ
 
__»Ëa£_add»ss
(
±e
 *
pgdœ
, 
vaddr
);

126 
·ge
* 
__»sŞve_add»ss
(
±e
 *
pgdœ
, 
u32
 
vaddr
, u32 
pg´Ù
);

127 
boŞ
 
vm_¬—_shršk
(
vm_¬—
 *
vma
, 
Ãw_’d
);

128 
boŞ
 
vm_¬—_ex·nd
(
vm_¬—
 *
vma
, 
Ãw_’d
);

129 
k_brk
(
brk
);

131 
	#PGDIR_OF_MM
(
mm
èĞ(
±e
 *)
	`__va
(mm->
ü3
.
v®ue
 & 
PAGE_MASK
è)

	)

	@include/linux/mount.h

1 #iâdeà
MOUNT_H


2 
	#MOUNT_H


	)

3 
	~<lšux/dÿche.h
>

4 
	~<v®Ty³.h
>

5 
	gsu³r_block
;

6 
	svfsmouÁ
{

7 
u16
 
	mdev
;

8 
su³r_block
 *
	msb
;

9 
d’Œy
 *
	msm®l_roÙ
;

10 
d’Œy
 *
	mmouÁpošt
;

11 
vfsmouÁ
 *
	m·»Á
;

12 
li¡_h—d
 
	mşash
;

13 
	mcouÁ
;

16 
šlše
 
vfsmouÁ
 *
	$mÁg‘
(
vfsmouÁ
 *
mÁ
){

17 
mÁ
->
couÁ
++;

18  
mÁ
;

19 
	}
}

21 
šlše
 
	$mÁput
(
vfsmouÁ
 *
mÁ
){

22 
mÁ
->
couÁ
--;

23 
	}
}

	@include/linux/mylist.h

1 #iâdeà
MYLIST_H


2 
	#MYLIST_H


	)

18 
	#LL2_POP
(
Î2
) \

20 
	`as£¹
Ğ(
Î2
 && (Î2)->
roÙ
 && (Î2)->

)); \

21 
Î2
->
roÙ
 =†l2->roÙ->
Ãxt
; \

22 if(
Î2
->
roÙ
èÎ2->roÙ->
´ev
 = 0; \

23 
Î2
->

 =†l2->
roÙ
; \

24 }0)

	)

27 
	#LL2_A
(
Î2
, 
node
) \

29 
	`as£¹
Ğ(
Î2
è&& (
node
) ); \

30 
	`as£¹
ĞĞ(
Î2
)->
roÙ
 =ğ0 && (Î2)->

 == 0 ) || \

31 Ğ(
Î2
)->
roÙ
 !ğ0 && (Î2)->

 != 0) \

33 (
node
)->
´ev
 = (
Î2
)->

; \

34 ifĞ(
Î2
)->

 ){ \

35 (
Î2
)->

->
Ãxt
 = 
node
; \

38 (
Î2
)->
roÙ
 = 
node
; \

40 (
node
)->
Ãxt
 = 0; \

41 (
Î2
)->

 = 
node
; \

42 }0)

	)

44 
	#LL2_DEL
(
Î2
, 
node
) \

46 
	`as£¹
Ğ(
Î2
è&& (
node
è&& (Î2)->
roÙ
 && (Î2)->

 ); \

47 ifĞ(
node
)->
´ev
 ){ \

48 (
node
)->
´ev
->
Ãxt
 = (node)->next; \

51 
	`as£¹
Ğ(
Î2
)->
roÙ
 =ğ
node
 ); \

52 (
Î2
)->
roÙ
 = (
node
)->
Ãxt
; \

55 ifĞ(
node
)->
Ãxt
 ){ \

56 (
node
)->
Ãxt
->
´ev
 = (node)->prev; \

59 
	`as£¹
Ğ(
Î2
)->

 =ğ
node
 ); \

60 (
Î2
)->

 = (
node
)->
´ev
; \

62 }0)

	)

74 
	#LL_APPEND
(
li¡
, 
loÿtiÚ
, 
Ãw
)\

76 
	`as£¹
((
li¡
è&& (
loÿtiÚ
è&& (
Ãw
));\

77 
d


	)

88 
	#LL_INSERT
(
li¡
,
loÿtiÚ
,
Ãw
)\

90 
	`as£¹
ĞĞ(
li¡
è=ğ(
loÿtiÚ
) ) || ( (list) && (location) ) );\

91 
	`as£¹
((
Ãw
));\

92 if(!
li¡
 && !
loÿtiÚ
) {\

93 
li¡
 = 
Ãw
;\

94 
Ãw
->
Ãxt
 =‚ew->
´ev
 = 0;\

97 
Ãw
->
Ãxt
=
loÿtiÚ
;\

98 
Ãw
->
´ev
=
loÿtiÚ
->prev;\

99 if(
loÿtiÚ
->
´ev
èloÿtiÚ->´ev->
Ãxt
=
Ãw
;\

100 
loÿtiÚ
->
´ev
=
Ãw
;\

101 if(
li¡
==
loÿtiÚ
èli¡=
Ãw
;\

102 } 0)

	)

104 
	#LL_I
(
roÙ
, 
Ãw
) \

106 if(
roÙ
){ \

107 
Ãw
->
´ev
 = 
roÙ
; \

108 
Ãw
->
Ãxt
 = 
roÙ
->next; \

109 if(
roÙ
->
Ãxt
èroÙ->Ãxt->
´ev
 = 
Ãw
; \

110 
roÙ
->
Ãxt
 = 
Ãw
; \

113 
roÙ
 = 
Ãw
; \

114 
Ãw
->
´ev
 =‚ew->
Ãxt
 = 0; \

116 }0)

	)

118 
	#LL_I2
(
roÙ
, 
Ãw
) \

120 
	`as£¹
(
roÙ
); \

121 if(
roÙ
->
Ãxt
èroÙ->Ãxt->
´ev
 = 
Ãw
; \

122 
Ãw
->
Ãxt
 = 
roÙ
->next; \

123 
Ãw
->
´ev
 = 
roÙ
; \

124 
roÙ
->
Ãxt
 = 
Ãw
; \

125 }0)

	)

127 
	#LL_REPLACE
(
roÙ
, 
Şd
, 
Ãw
) \

129 
Ãw
->
´ev
 = 
Şd
->prev; \

130 
Ãw
->
Ãxt
 = 
Şd
->next; \

131 if(
Ãw
->
´ev
èÃw->´ev->
Ãxt
 =‚ew; \

132 if(
Ãw
->
Ãxt
èÃw->Ãxt->
´ev
 =‚ew; \

133 if(
roÙ
 =ğ
Şd
èroÙ = 
Ãw
; \

134 }0)

	)

148 
	#LL_I_INCRE
(
li¡
,
Ãw
,
©Œ
)\

150 
	`as£¹
(
Ãw
);\

151 if(!
li¡
){\

152 
li¡
=
Ãw
;\

153 
Ãw
->
´ev
òew->
Ãxt
=0;\

156 *
roÙ
=
li¡
;\

157 
li¡
->
Ãxt
 && 
Ãw
->
©Œ
 >†ist->attr)†ist=list->next;\

158 if(
Ãw
->
©Œ
 > 
li¡
->attr){\

159 
Ãw
->
Ãxt
 = 0;\

160 
Ãw
->
´ev
=
li¡
;\

161 
li¡
->
Ãxt
 = 
Ãw
;\

162 
li¡
=
roÙ
;\

165 
Ãw
->
Ãxt
 = 
li¡
;\

166 
Ãw
->
´ev
 = 
li¡
->prev;\

167 if(
li¡
->
´ev
èli¡->´ev->
Ãxt
 = 
Ãw
;\

168 
li¡
->
´ev
=
Ãw
;\

169 if(
roÙ
==
li¡
èli¡=
Ãw
;\

170 
li¡
 = 
roÙ
;\

172 } 0)

	)

175 
	#LL_I_DECRE
(
li¡
,
Ãw
,
©Œ
)\

177 
	`as£¹
(
Ãw
);\

178 if(!
li¡
){\

179 
li¡
=
Ãw
;\

180 
Ãw
->
´ev
òew->
Ãxt
=0;\

183 *
roÙ
=
li¡
;\

184 
li¡
->
Ãxt
 && 
Ãw
->
©Œ
 <†ist->attr)†ist=list->next;\

185 if(
Ãw
->
©Œ
 < 
li¡
->attr){\

186 
Ãw
->
Ãxt
 = 0;\

187 
li¡
->
Ãxt
=
Ãw
;\

188 
Ãw
->
´ev
=
li¡
;\

189 
li¡
=
roÙ
;\

192 
Ãw
->
Ãxt
=
li¡
;\

193 
Ãw
->
´ev
=
li¡
->prev;\

194 if(
li¡
->
´ev
èli¡->´ev->
Ãxt
=
Ãw
;\

195 
li¡
->
´ev
=
Ãw
;\

196 if(
roÙ
==
li¡
èli¡=
Ãw
;\

198 } 0)

	)

200 
	#LL_DEL
(
li¡
,
loÿtiÚ
)\

202 
	`as£¹
(
li¡
&&
loÿtiÚ
);\

203 
	`as£¹
(!(!
loÿtiÚ
->
Ãxt
 && !loÿtiÚ->
´ev
 && (
li¡
!=location)));\

204 if(
loÿtiÚ
->
´ev
èloÿtiÚ->´ev->
Ãxt
=location->next;\

205 if(
loÿtiÚ
->
Ãxt
èloÿtiÚ->Ãxt->
´ev
=location->prev;\

206 if(
li¡
==
loÿtiÚ
èli¡öoÿtiÚ->
Ãxt
;\

207 } 0)

	)

209 
	#LL_INFO
(
li¡
,
©Œ
)\

211 *
roÙ
=
li¡
;\

212 
li¡
){\

213 
	`´štf
("%d ",
li¡
->
©Œ
);\

214 
li¡
öi¡->
Ãxt
;\

216 
li¡
=
roÙ
;\

217 } 0)

	)

219 
	#LL_ASSIGN
(
li¡
,
©Œ
,
v®ue
)\

221 *
roÙ
 = 
li¡
;\

222 
li¡
){\

223 
li¡
->
©Œ
=
v®ue
;\

224 
li¡
öi¡->
Ãxt
;\

226 
li¡
 = 
roÙ
;\

227 } 0)

	)

229 
	#LL_SCAN_ON_KEY
(
roÙ
, 
key
, 
v®ue
, 
»suÉ
)\

231 
»suÉ
 = 
roÙ
;\

232 
»suÉ
){\

233 ifĞ(
»suÉ
)->
key
 =ğ(
v®ue
) ){\

236 
»suÉ
 = (»suÉ)->
Ãxt
; \

238 }0)

	)

242 
	#LL_SCAN_ON_kEY_B
(
roÙ
, 
key
, 
v®ue
) \

244 
	`ty³of
(
roÙ
è
cu¼
 =„oot; \

245 
cu¼
 && cu¼->
key
 <ğ(
v®ue
èècu¼ = cu¼->
Ãxt
; \

246 
cu¼
; \

247 })

	)

251 
	#LL_SCAN_ON_KEY_S
(
roÙ
, 
key
, 
v®ue
) \

253 
	`ty³of
(
roÙ
è
cu¼
 =„oot; \

254 
cu¼
 && cu¼->
key
 >ğ(
v®ue
èècu¼ = cu¼->
Ãxt
; \

255 
cu¼
; \

256 })

	)

259 
	#LL_CHECK
(
roÙ
, 
node
) \

261 *
backup
 = 
roÙ
; \

262 
roÙ
){ \

263 if(
roÙ
 =ğ
node
) ; \

264 
roÙ
 =„oÙ->
Ãxt
; \

266 
	`as£¹
(
roÙ
 && "can‚ot find‚ode inhat†ist"); \

267 
roÙ
 = 
backup
; \

268 }0)

	)

274 
	#LL_I_INCRE_ON
(
roÙ
, 
Ãw
, 
mb
) \

276 
Ãw
->
´ev
 = 0; \

277 
Ãw
->
Ãxt
 = 
roÙ
; \

278 
Ãw
->
Ãxt
 &&‚ew->Ãxt->
mb
 <‚ew->mb){ \

279 
Ãw
->
´ev
 =‚ew->
Ãxt
; \

280 
Ãw
->
Ãxt
 =‚ew->next->next; \

282 if(
Ãw
->
Ãxt
èÃw->Ãxt->
´ev
 =‚ew; \

283 if(
Ãw
->
´ev
èÃw->´ev->
Ãxt
 =‚ew; \

284 
roÙ
 = 
Ãw
->
Ãxt
; \

285 })

	)

293 
	#O_INSERT_AFTER
(
_´ev
, 
Ãw
) \

295 
Ãw
->
Ãxt
 = 
_´ev
->next; \

296 
Ãw
->
´ev
 = 
_´ev
; \

297 
_´ev
->
Ãxt
->
´ev
 = 
Ãw
; \

298 
_´ev
->
Ãxt
 = 
Ãw
; \

299 })

	)

301 
	#O_INSERT_BEFORE
(
Next
, 
Ãw
) \

303 
Ãw
->
Ãxt
 = 
Next
; \

304 
Ãw
->
´ev
 = 
Next
->prev; \

305 
Next
->
´ev
->
Ãxt
 = 
Ãw
; \

306 
Next
->
´ev
 = 
Ãw
; \

307 })

	)

310 
	#OL_I_INCRE_ON
(
roÙ
, 
Ãw
, 
mb
)

	)

312 
as£¹
(
roÙ
 && 
Ãw
);

313 
ty³of
(
roÙ
è
	grightÚe
 =„oot;

314 
	gÃw
->
	gmb
 > 
	grightÚe
->mb && 
	gright
->
	gÃxt
 !ğ
roÙ
){

315 
rightÚe
 =„ightÚe->
Ãxt
;

317 
OL_I_BEFORE
(
rightÚe
, 
Ãw
);

318 if(
	groÙ
->
	gmb
 > 
	gÃw
->mbèroÙ = 
Ãw
;

324 
	#O_INSERT_INCRE_ON
(
roÙ
, 
Ãw
, 
mb
) \

326 
	`as£¹
(
roÙ
 && 
Ãw
); \

327 
	`__ty³of__
(
roÙ
è
ËáÚe
 =„oÙ->
´ev
; \

328 
Ãw
->
mb
 > 
ËáÚe
->mb){ \

329 
ËáÚe
 =†eáÚe->
´ev
; \

330 if(
ËáÚe
 =ğ
roÙ
->
´ev
){ \

331 
roÙ
 = 
Ãw
; \

335 
	`O_INSERT_AFTER
(
ËáÚe
, 
Ãw
); \

336 })

	)

341 
	#O_SCAN_UNTIL_MEET_LARGER
(
roÙ
, 
mb
, 
v®ue
) \

343 
	`as£¹
Ğ(
roÙ
) ); \

344 
	`__ty³of__
(
roÙ
è
node
 =„oot; \

346 ifĞ(
node
)->
mb
 > 
v®ue
) ; \

347 
node
 =‚ode->
Ãxt
; \

348 if(
node
 !ğ
roÙ
) ; \

349 
node
 = 0; \

352 
node
; \

353 })

	)

355 
	#O_APPEND
(
roÙ
, 
Ãw
) \

357 (
Ãw
)->
Ãxt
 = 
roÙ
; \

358 (
Ãw
)->
´ev
 = 
roÙ
->prev; \

359 (
roÙ
)->
´ev
->
Ãxt
 = 
Ãw
; \

360 (
roÙ
)->
´ev
 = 
Ãw
; \

361 })

	)

364 
	#O_APPEND_SAFE
(
roÙ
, 
Ãw
) \

366 if(!
roÙ
){ \

367 
roÙ
 = 
Ãw
; \

368 
Ãw
->
´ev
 =‚ew->
Ãxt
 =‚ew; \

370 
	`O_APPEND
(
roÙ
, 
Ãw
); \

371 })

	)

	@include/linux/netdevice.h

1 #iâdeà
NETDEVICE_H


2 
	#NETDEVICE_H


	)

3 
	~<lšux/skbuff.h
>

4 
	~<v®Ty³.h
>

7 
	sskb_queue
{

8 
sk_buff
 *
	mroÙ
;

9 
sk_buff
 *
	m
;

12 
	gpci_dev
;

13 
	sÃt_deviû
{

14 (*
	mİ’
)(
Ãt_deviû
 *
	mdev
);

15 (*
	m¡İ
)(
Ãt_deviû
 *
	mdev
);

16 (*
	m¡¬t_xm™
è(
sk_buff
 *
	mskb
, 
Ãt_deviû
 *
	mdev
);

17 
boŞ
 (*
tx_busy
è(
Ãt_deviû
 *
	mdev
);

18 
u8
 
	mmac
[7];

20 
	mba£_addr
;

21 
	mœq
;

22 
	mæags
;

23 *
	m´iv©e
;

24 
skb_queue
 
	mtx_queue
;

25 
skb_queue
 
	mrx_queue
;

26 
	mÚ_tx_bh
;

27 
	mÚ_rx_bh
;

29 
u32
 
	mmask
;

30 
u32
 
	m
;

31 
u32
 
	mg©eway_
;

32 
u32
 
	mtx_couÁ
;

33 
u32
 
	mrx_couÁ
;

35 
u32
 
	mquick_š£¹
;

36 
u32
 
	mcouÁ_drİ_tok
;

37 }
	mdebug
;

38 
pci_dev
 *
	mpcidev
;

39 
u32
 
	m_id’tif›r
;

51 
nic_wake_queue
(
Ãt_deviû
 *
Ãtdev
);

52 
Ãt_deviû
 *
pick_nic
(
u32
 
de¡_
, u32 
¤c_
);

53 
»gi¡”_nic
(
Ãt_deviû
 *
Ãtdev
);

54 
li¡_nic
();

55 
Ãt_deviû
 * 
who_am_i
(
u8
 *
mac
);

	@include/linux/pci.h

1 #iâdeà
PCI_H


2 
	#PCI_H


	)

3 
	~<lšux/pci_»gs.h
>

4 
	~<lšux/pci_v’dÜ.h
>

5 
	~<li¡.h
>

7 
	spci_deviû_id
{

8 
u16
 
	mv’dÜ
, 
	mdeviû
;

9 
u16
 
	msubv’dÜ
, 
	msubdeviû
;

52 #´agm¨
·ck
(
push
)

53 #´agm¨
·ck
(1)

54 
	spci_cÚfig_addr
{

55 
	m®ways
:2 ;

56 
	m»g
: 6;

59 
	mfunc
: 3;

60 
	mdev
: 5;

61 
	mbus
: 8;

63 
u16
 
	mv®ue
;

65 
	m»£rved
: 7;

66 
	m’abËd
: 1;

68 #´agm¨
·ck
 (
pİ
)

70 #´agm¨
·ck
 (
push
)

71 #´agm¨
·ck
 (1)

72 
	spci_dev
{

73 
u16
 
	mv’dÜ
;

74 
u16
 
	mdeviû
;

75 
u16
 
	mcommªd
;

76 
u16
 
	m¡©us
;

77 
	m»visiÚ
;

78 
	mşass
: 24;

79 
u8
 
	mÿch–še
;

80 
u8
 
	mtim”
;

81 
u8
 
	mh—dty³
;

82 
u8
 
	mbi¡
;

83 
	madd»ss
[6];

84 
	mcis
;

85 
u16
 
	msub_v’dÜ
;

86 
u16
 
	msub_deviû
;

87 
	mromaddr
;

88 
	m»£rved1
;

89 
	m»£rved2
;

90 
	mœqlše
;

91 
	mœqpš
;

92 
	mmšgÁ
;

93 
	mmaxÏt
;

96 
li¡_h—d
 
	mnode
;

97 
pci_driv”
 *
	mdriv”
;

98 
	mvadd»ss
[6];

99 
u8
 
	mbus
;

100 
	mdev
: 5;

101 
	mfunc
: 3;

103 *
	mcÜe
;

105 #´agm¨
·ck
 (
pİ
)

107 
	spci_driv”
{

108 
li¡_h—d
 
	mnode
;

109 *
	mÇme
;

110 
pci_deviû_id
 *
	mid_bË
;

113 (*
	m´obe
)(
pci_dev
 *
	mdev
, cÚ¡ 
pci_deviû_id
 *
	mid
);

121 
šlše
 
	$MK_PCI_CFG_ADDR
(
bus
, 
dev
, 
func
, 
»g
){

122 
pci_cÚfig_addr
 
addr_¡ru
 = {

123 
®ways
: 0,

124 
»g
:„eg,

125 
func
: func,

126 
dev
: dev,

127 
bus
: bus,

128 
»£rved
: 0,

129 
’abËd
: 1

131  *(*)&
addr_¡ru
;

132 
	}
}

134 
šlše
 
	$g‘_pci_cfg_»g
(
bus
, 
dev
, 
func
, 
»g
){

135 
addr
 = 
	`MK_PCI_CFG_ADDR
(
bus
, 
dev
, 
func
, 
»g
);

136 
pÜt0xcfc
 = 0;

137 
__asm__
 
	`__vŞ©e__
 ("out %%eax, %%dx\n\t"

140 :"÷"(
pÜt0xcfc
)

141 :"a"(
addr
), "d"(
PCI_CONFIG_ADDR
)

143  
pÜt0xcfc
;

144 
	}
}

146 
šlše
 
	$£t_pci_cfg_»g
(
bus
, 
dev
, 
func
, 
»g
, 
v®ue
){

147 
addr
 = 
	`MK_PCI_CFG_ADDR
(
bus
, 
dev
, 
func
, 
»g
);

148 
__asm__
 
	`__vŞ©e__
 ("out %%eax, %%dx\n\t"

153 :"a"(
addr
), "d"(
PCI_CONFIG_ADDR
), "b"(
v®ue
)

155 
	}
}

157 
šlše
 
	$pci_»ad_cÚfig_dwÜd
(
pci_dev
 *
pcidev
, 
off£t
){

158  
	`g‘_pci_cfg_»g
(
pcidev
->
bus
,…cidev->
dev
,…cidev->
func
, 
off£t
>>2);

159 
	}
}

161 
šlše
 
	$pci_wr™e_cÚfig_dwÜd
(
pci_dev
 *
pcidev
, 
off£t
, 
v®ue
){

162 
	`£t_pci_cfg_»g
(
pcidev
->
bus
,…cidev->
dev
,…cidev->dev, 
off£t
>>2, 
v®ue
);

163 
	}
}

168 
šlše
 
	$pci_fix_cÚfig_dwÜd
(
pci_dev
 *
pcidev
, 
off£t
, 
v®ue
){

169 
Üigš
 = 
	`pci_»ad_cÚfig_dwÜd
(
pcidev
, 
off£t
);

170 
Üigš
 |ğ
v®ue
;

171 
	`pci_wr™e_cÚfig_dwÜd
(
pcidev
, 
off£t
, 
Üigš
);

172 
	}
}

174 
pci_š™
();

175 
pci_»gi¡”_driv”
(
pci_driv”
 *
driv”
);

176 
pci_’abË_deviû
(
pci_dev
 *
pcidev
);

177 
pci_£t_ma¡”
(
pci_dev
 *
pcidev
);

	@include/linux/pci_ids.h

1 #iâdeà
PCI_IDS_H


2 
	#PCI_IDS_H


	)

15 
	#PCI_CLASS_NOT_DEFINED
 0x0000

	)

16 
	#PCI_CLASS_NOT_DEFINED_VGA
 0x0001

	)

18 
	#PCI_BASE_CLASS_STORAGE
 0x01

	)

19 
	#PCI_CLASS_STORAGE_SCSI
 0x0100

	)

20 
	#PCI_CLASS_STORAGE_IDE
 0x0101

	)

21 
	#PCI_CLASS_STORAGE_FLOPPY
 0x0102

	)

22 
	#PCI_CLASS_STORAGE_IPI
 0x0103

	)

23 
	#PCI_CLASS_STORAGE_RAID
 0x0104

	)

24 
	#PCI_CLASS_STORAGE_SATA
 0x0106

	)

25 
	#PCI_CLASS_STORAGE_SATA_AHCI
 0x010601

	)

26 
	#PCI_CLASS_STORAGE_SAS
 0x0107

	)

27 
	#PCI_CLASS_STORAGE_OTHER
 0x0180

	)

29 
	#PCI_BASE_CLASS_NETWORK
 0x02

	)

30 
	#PCI_CLASS_NETWORK_ETHERNET
 0x0200

	)

31 
	#PCI_CLASS_NETWORK_TOKEN_RING
 0x0201

	)

32 
	#PCI_CLASS_NETWORK_FDDI
 0x0202

	)

33 
	#PCI_CLASS_NETWORK_ATM
 0x0203

	)

34 
	#PCI_CLASS_NETWORK_OTHER
 0x0280

	)

36 
	#PCI_BASE_CLASS_DISPLAY
 0x03

	)

37 
	#PCI_CLASS_DISPLAY_VGA
 0x0300

	)

38 
	#PCI_CLASS_DISPLAY_XGA
 0x0301

	)

39 
	#PCI_CLASS_DISPLAY_3D
 0x0302

	)

40 
	#PCI_CLASS_DISPLAY_OTHER
 0x0380

	)

42 
	#PCI_BASE_CLASS_MULTIMEDIA
 0x04

	)

43 
	#PCI_CLASS_MULTIMEDIA_VIDEO
 0x0400

	)

44 
	#PCI_CLASS_MULTIMEDIA_AUDIO
 0x0401

	)

45 
	#PCI_CLASS_MULTIMEDIA_PHONE
 0x0402

	)

46 
	#PCI_CLASS_MULTIMEDIA_OTHER
 0x0480

	)

48 
	#PCI_BASE_CLASS_MEMORY
 0x05

	)

49 
	#PCI_CLASS_MEMORY_RAM
 0x0500

	)

50 
	#PCI_CLASS_MEMORY_FLASH
 0x0501

	)

51 
	#PCI_CLASS_MEMORY_OTHER
 0x0580

	)

53 
	#PCI_BASE_CLASS_BRIDGE
 0x06

	)

54 
	#PCI_CLASS_BRIDGE_HOST
 0x0600

	)

55 
	#PCI_CLASS_BRIDGE_ISA
 0x0601

	)

56 
	#PCI_CLASS_BRIDGE_EISA
 0x0602

	)

57 
	#PCI_CLASS_BRIDGE_MC
 0x0603

	)

58 
	#PCI_CLASS_BRIDGE_PCI
 0x0604

	)

59 
	#PCI_CLASS_BRIDGE_PCMCIA
 0x0605

	)

60 
	#PCI_CLASS_BRIDGE_NUBUS
 0x0606

	)

61 
	#PCI_CLASS_BRIDGE_CARDBUS
 0x0607

	)

62 
	#PCI_CLASS_BRIDGE_RACEWAY
 0x0608

	)

63 
	#PCI_CLASS_BRIDGE_OTHER
 0x0680

	)

65 
	#PCI_BASE_CLASS_COMMUNICATION
 0x07

	)

66 
	#PCI_CLASS_COMMUNICATION_SERIAL
 0x0700

	)

67 
	#PCI_CLASS_COMMUNICATION_PARALLEL
 0x0701

	)

68 
	#PCI_CLASS_COMMUNICATION_MULTISERIAL
 0x0702

	)

69 
	#PCI_CLASS_COMMUNICATION_MODEM
 0x0703

	)

70 
	#PCI_CLASS_COMMUNICATION_OTHER
 0x0780

	)

72 
	#PCI_BASE_CLASS_SYSTEM
 0x08

	)

73 
	#PCI_CLASS_SYSTEM_PIC
 0x0800

	)

74 
	#PCI_CLASS_SYSTEM_PIC_IOAPIC
 0x080010

	)

75 
	#PCI_CLASS_SYSTEM_PIC_IOXAPIC
 0x080020

	)

76 
	#PCI_CLASS_SYSTEM_DMA
 0x0801

	)

77 
	#PCI_CLASS_SYSTEM_TIMER
 0x0802

	)

78 
	#PCI_CLASS_SYSTEM_RTC
 0x0803

	)

79 
	#PCI_CLASS_SYSTEM_PCI_HOTPLUG
 0x0804

	)

80 
	#PCI_CLASS_SYSTEM_SDHCI
 0x0805

	)

81 
	#PCI_CLASS_SYSTEM_OTHER
 0x0880

	)

83 
	#PCI_BASE_CLASS_INPUT
 0x09

	)

84 
	#PCI_CLASS_INPUT_KEYBOARD
 0x0900

	)

85 
	#PCI_CLASS_INPUT_PEN
 0x0901

	)

86 
	#PCI_CLASS_INPUT_MOUSE
 0x0902

	)

87 
	#PCI_CLASS_INPUT_SCANNER
 0x0903

	)

88 
	#PCI_CLASS_INPUT_GAMEPORT
 0x0904

	)

89 
	#PCI_CLASS_INPUT_OTHER
 0x0980

	)

91 
	#PCI_BASE_CLASS_DOCKING
 0x0a

	)

92 
	#PCI_CLASS_DOCKING_GENERIC
 0x0a00

	)

93 
	#PCI_CLASS_DOCKING_OTHER
 0x0a80

	)

95 
	#PCI_BASE_CLASS_PROCESSOR
 0x0b

	)

96 
	#PCI_CLASS_PROCESSOR_386
 0x0b00

	)

97 
	#PCI_CLASS_PROCESSOR_486
 0x0b01

	)

98 
	#PCI_CLASS_PROCESSOR_PENTIUM
 0x0b02

	)

99 
	#PCI_CLASS_PROCESSOR_ALPHA
 0x0b10

	)

100 
	#PCI_CLASS_PROCESSOR_POWERPC
 0x0b20

	)

101 
	#PCI_CLASS_PROCESSOR_MIPS
 0x0b30

	)

102 
	#PCI_CLASS_PROCESSOR_CO
 0x0b40

	)

104 
	#PCI_BASE_CLASS_SERIAL
 0x0c

	)

105 
	#PCI_CLASS_SERIAL_FIREWIRE
 0x0c00

	)

106 
	#PCI_CLASS_SERIAL_FIREWIRE_OHCI
 0x0c0010

	)

107 
	#PCI_CLASS_SERIAL_ACCESS
 0x0c01

	)

108 
	#PCI_CLASS_SERIAL_SSA
 0x0c02

	)

109 
	#PCI_CLASS_SERIAL_USB
 0x0c03

	)

110 
	#PCI_CLASS_SERIAL_USB_UHCI
 0x0c0300

	)

111 
	#PCI_CLASS_SERIAL_USB_OHCI
 0x0c0310

	)

112 
	#PCI_CLASS_SERIAL_USB_EHCI
 0x0c0320

	)

113 
	#PCI_CLASS_SERIAL_USB_XHCI
 0x0c0330

	)

114 
	#PCI_CLASS_SERIAL_FIBER
 0x0c04

	)

115 
	#PCI_CLASS_SERIAL_SMBUS
 0x0c05

	)

117 
	#PCI_BASE_CLASS_WIRELESS
 0x0d

	)

118 
	#PCI_CLASS_WIRELESS_RF_CONTROLLER
 0x0d10

	)

119 
	#PCI_CLASS_WIRELESS_WHCI
 0x0d1010

	)

121 
	#PCI_BASE_CLASS_INTELLIGENT
 0x0e

	)

122 
	#PCI_CLASS_INTELLIGENT_I2O
 0x0e00

	)

124 
	#PCI_BASE_CLASS_SATELLITE
 0x0f

	)

125 
	#PCI_CLASS_SATELLITE_TV
 0x0f00

	)

126 
	#PCI_CLASS_SATELLITE_AUDIO
 0x0f01

	)

127 
	#PCI_CLASS_SATELLITE_VOICE
 0x0f03

	)

128 
	#PCI_CLASS_SATELLITE_DATA
 0x0f04

	)

130 
	#PCI_BASE_CLASS_CRYPT
 0x10

	)

131 
	#PCI_CLASS_CRYPT_NETWORK
 0x1000

	)

132 
	#PCI_CLASS_CRYPT_ENTERTAINMENT
 0x1001

	)

133 
	#PCI_CLASS_CRYPT_OTHER
 0x1080

	)

135 
	#PCI_BASE_CLASS_SIGNAL_PROCESSING
 0x11

	)

136 
	#PCI_CLASS_SP_DPIO
 0x1100

	)

137 
	#PCI_CLASS_SP_OTHER
 0x1180

	)

139 
	#PCI_CLASS_OTHERS
 0xff

	)

	@include/linux/pci_regs.h

22 #iâdeà
PCI_REGS_H


23 
	#PCI_REGS_H


	)

29 
	#PCI_VENDOR_ID
 0x00

	)

30 
	#PCI_DEVICE_ID
 0x02

	)

31 
	#PCI_COMMAND
 0x04

	)

32 
	#PCI_COMMAND_IO
 0x1

	)

33 
	#PCI_COMMAND_MEMORY
 0x2

	)

34 
	#PCI_COMMAND_MASTER
 0x4

	)

35 
	#PCI_COMMAND_SPECIAL
 0x8

	)

36 
	#PCI_COMMAND_INVALIDATE
 0x10

	)

37 
	#PCI_COMMAND_VGA_PALETTE
 0x20

	)

38 
	#PCI_COMMAND_PARITY
 0x40

	)

39 
	#PCI_COMMAND_WAIT
 0x80

	)

40 
	#PCI_COMMAND_SERR
 0x100

	)

41 
	#PCI_COMMAND_FAST_BACK
 0x200

	)

42 
	#PCI_COMMAND_INTX_DISABLE
 0x400

	)

44 
	#PCI_STATUS
 0x06

	)

45 
	#PCI_STATUS_INTERRUPT
 0x08

	)

46 
	#PCI_STATUS_CAP_LIST
 0x10

	)

47 
	#PCI_STATUS_66MHZ
 0x20

	)

48 
	#PCI_STATUS_UDF
 0x40

	)

49 
	#PCI_STATUS_FAST_BACK
 0x80

	)

50 
	#PCI_STATUS_PARITY
 0x100

	)

51 
	#PCI_STATUS_DEVSEL_MASK
 0x600

	)

52 
	#PCI_STATUS_DEVSEL_FAST
 0x000

	)

53 
	#PCI_STATUS_DEVSEL_MEDIUM
 0x200

	)

54 
	#PCI_STATUS_DEVSEL_SLOW
 0x400

	)

55 
	#PCI_STATUS_SIG_TARGET_ABORT
 0x800

	)

56 
	#PCI_STATUS_REC_TARGET_ABORT
 0x1000

	)

57 
	#PCI_STATUS_REC_MASTER_ABORT
 0x2000

	)

58 
	#PCI_STATUS_SIG_SYSTEM_ERROR
 0x4000

	)

59 
	#PCI_STATUS_DETECTED_PARITY
 0x8000

	)

61 
	#PCI_CLASS_REVISION
 0x08

	)

62 
	#PCI_REVISION_ID
 0x08

	)

63 
	#PCI_CLASS_PROG
 0x09

	)

64 
	#PCI_CLASS_DEVICE
 0x0¨

	)

66 
	#PCI_CACHE_LINE_SIZE
 0x0ø

	)

67 
	#PCI_LATENCY_TIMER
 0x0d

	)

68 
	#PCI_HEADER_TYPE
 0x0

	)

69 
	#PCI_HEADER_TYPE_NORMAL
 0

	)

70 
	#PCI_HEADER_TYPE_BRIDGE
 1

	)

71 
	#PCI_HEADER_TYPE_CARDBUS
 2

	)

73 
	#PCI_BIST
 0x0à

	)

74 
	#PCI_BIST_CODE_MASK
 0x0à

	)

75 
	#PCI_BIST_START
 0x40

	)

76 
	#PCI_BIST_CAPABLE
 0x80

	)

84 
	#PCI_BASE_ADDRESS_0
 0x10

	)

85 
	#PCI_BASE_ADDRESS_1
 0x14

	)

86 
	#PCI_BASE_ADDRESS_2
 0x18

	)

87 
	#PCI_BASE_ADDRESS_3
 0x1ø

	)

88 
	#PCI_BASE_ADDRESS_4
 0x20

	)

89 
	#PCI_BASE_ADDRESS_5
 0x24

	)

90 
	#PCI_BASE_ADDRESS_SPACE
 0x01

	)

91 
	#PCI_BASE_ADDRESS_SPACE_IO
 0x01

	)

92 
	#PCI_BASE_ADDRESS_SPACE_MEMORY
 0x00

	)

93 
	#PCI_BASE_ADDRESS_MEM_TYPE_MASK
 0x06

	)

94 
	#PCI_BASE_ADDRESS_MEM_TYPE_32
 0x00

	)

95 
	#PCI_BASE_ADDRESS_MEM_TYPE_1M
 0x02

	)

96 
	#PCI_BASE_ADDRESS_MEM_TYPE_64
 0x04

	)

97 
	#PCI_BASE_ADDRESS_MEM_PREFETCH
 0x08

	)

98 
	#PCI_BASE_ADDRESS_MEM_MASK
 (~0x0fUL)

	)

99 
	#PCI_BASE_ADDRESS_IO_MASK
 (~0x03UL)

	)

103 
	#PCI_CARDBUS_CIS
 0x28

	)

104 
	#PCI_SUBSYSTEM_VENDOR_ID
 0x2c

	)

105 
	#PCI_SUBSYSTEM_ID
 0x2e

	)

106 
	#PCI_ROM_ADDRESS
 0x30

	)

107 
	#PCI_ROM_ADDRESS_ENABLE
 0x01

	)

108 
	#PCI_ROM_ADDRESS_MASK
 (~0x7ffUL)

	)

110 
	#PCI_CAPABILITY_LIST
 0x34

	)

113 
	#PCI_INTERRUPT_LINE
 0x3ø

	)

114 
	#PCI_INTERRUPT_PIN
 0x3d

	)

115 
	#PCI_MIN_GNT
 0x3

	)

116 
	#PCI_MAX_LAT
 0x3à

	)

119 
	#PCI_PRIMARY_BUS
 0x18

	)

120 
	#PCI_SECONDARY_BUS
 0x19

	)

121 
	#PCI_SUBORDINATE_BUS
 0x1¨

	)

122 
	#PCI_SEC_LATENCY_TIMER
 0x1b

	)

123 
	#PCI_IO_BASE
 0x1ø

	)

124 
	#PCI_IO_LIMIT
 0x1d

	)

125 
	#PCI_IO_RANGE_TYPE_MASK
 0x0fUL

	)

126 
	#PCI_IO_RANGE_TYPE_16
 0x00

	)

127 
	#PCI_IO_RANGE_TYPE_32
 0x01

	)

128 
	#PCI_IO_RANGE_MASK
 (~0x0fUL)

	)

129 
	#PCI_SEC_STATUS
 0x1

	)

130 
	#PCI_MEMORY_BASE
 0x20

	)

131 
	#PCI_MEMORY_LIMIT
 0x22

	)

132 
	#PCI_MEMORY_RANGE_TYPE_MASK
 0x0fUL

	)

133 
	#PCI_MEMORY_RANGE_MASK
 (~0x0fUL)

	)

134 
	#PCI_PREF_MEMORY_BASE
 0x24

	)

135 
	#PCI_PREF_MEMORY_LIMIT
 0x26

	)

136 
	#PCI_PREF_RANGE_TYPE_MASK
 0x0fUL

	)

137 
	#PCI_PREF_RANGE_TYPE_32
 0x00

	)

138 
	#PCI_PREF_RANGE_TYPE_64
 0x01

	)

139 
	#PCI_PREF_RANGE_MASK
 (~0x0fUL)

	)

140 
	#PCI_PREF_BASE_UPPER32
 0x28

	)

141 
	#PCI_PREF_LIMIT_UPPER32
 0x2c

	)

142 
	#PCI_IO_BASE_UPPER16
 0x30

	)

143 
	#PCI_IO_LIMIT_UPPER16
 0x32

	)

146 
	#PCI_ROM_ADDRESS1
 0x38

	)

148 
	#PCI_BRIDGE_CONTROL
 0x3e

	)

149 
	#PCI_BRIDGE_CTL_PARITY
 0x01

	)

150 
	#PCI_BRIDGE_CTL_SERR
 0x02

	)

151 
	#PCI_BRIDGE_CTL_ISA
 0x04

	)

152 
	#PCI_BRIDGE_CTL_VGA
 0x08

	)

153 
	#PCI_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

154 
	#PCI_BRIDGE_CTL_BUS_RESET
 0x40

	)

155 
	#PCI_BRIDGE_CTL_FAST_BACK
 0x80

	)

158 
	#PCI_CB_CAPABILITY_LIST
 0x14

	)

160 
	#PCI_CB_SEC_STATUS
 0x16

	)

161 
	#PCI_CB_PRIMARY_BUS
 0x18

	)

162 
	#PCI_CB_CARD_BUS
 0x19

	)

163 
	#PCI_CB_SUBORDINATE_BUS
 0x1¨

	)

164 
	#PCI_CB_LATENCY_TIMER
 0x1b

	)

165 
	#PCI_CB_MEMORY_BASE_0
 0x1c

	)

166 
	#PCI_CB_MEMORY_LIMIT_0
 0x20

	)

167 
	#PCI_CB_MEMORY_BASE_1
 0x24

	)

168 
	#PCI_CB_MEMORY_LIMIT_1
 0x28

	)

169 
	#PCI_CB_IO_BASE_0
 0x2c

	)

170 
	#PCI_CB_IO_BASE_0_HI
 0x2e

	)

171 
	#PCI_CB_IO_LIMIT_0
 0x30

	)

172 
	#PCI_CB_IO_LIMIT_0_HI
 0x32

	)

173 
	#PCI_CB_IO_BASE_1
 0x34

	)

174 
	#PCI_CB_IO_BASE_1_HI
 0x36

	)

175 
	#PCI_CB_IO_LIMIT_1
 0x38

	)

176 
	#PCI_CB_IO_LIMIT_1_HI
 0x3a

	)

177 
	#PCI_CB_IO_RANGE_MASK
 (~0x03UL)

	)

179 
	#PCI_CB_BRIDGE_CONTROL
 0x3e

	)

180 
	#PCI_CB_BRIDGE_CTL_PARITY
 0x01

	)

181 
	#PCI_CB_BRIDGE_CTL_SERR
 0x02

	)

182 
	#PCI_CB_BRIDGE_CTL_ISA
 0x04

	)

183 
	#PCI_CB_BRIDGE_CTL_VGA
 0x08

	)

184 
	#PCI_CB_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

185 
	#PCI_CB_BRIDGE_CTL_CB_RESET
 0x40

	)

186 
	#PCI_CB_BRIDGE_CTL_16BIT_INT
 0x80

	)

187 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM0
 0x100

	)

188 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM1
 0x200

	)

189 
	#PCI_CB_BRIDGE_CTL_POST_WRITES
 0x400

	)

190 
	#PCI_CB_SUBSYSTEM_VENDOR_ID
 0x40

	)

191 
	#PCI_CB_SUBSYSTEM_ID
 0x42

	)

192 
	#PCI_CB_LEGACY_MODE_BASE
 0x44

	)

197 
	#PCI_CAP_LIST_ID
 0

	)

198 
	#PCI_CAP_ID_PM
 0x01

	)

199 
	#PCI_CAP_ID_AGP
 0x02

	)

200 
	#PCI_CAP_ID_VPD
 0x03

	)

201 
	#PCI_CAP_ID_SLOTID
 0x04

	)

202 
	#PCI_CAP_ID_MSI
 0x05

	)

203 
	#PCI_CAP_ID_CHSWP
 0x06

	)

204 
	#PCI_CAP_ID_PCIX
 0x07

	)

205 
	#PCI_CAP_ID_HT
 0x08

	)

206 
	#PCI_CAP_ID_VNDR
 0x09

	)

207 
	#PCI_CAP_ID_DBG
 0x0A

	)

208 
	#PCI_CAP_ID_CCRC
 0x0B

	)

209 
	#PCI_CAP_ID_SHPC
 0x0C

	)

210 
	#PCI_CAP_ID_SSVID
 0x0D

	)

211 
	#PCI_CAP_ID_AGP3
 0x0E

	)

212 
	#PCI_CAP_ID_EXP
 0x10

	)

213 
	#PCI_CAP_ID_MSIX
 0x11

	)

214 
	#PCI_CAP_ID_AF
 0x13

	)

215 
	#PCI_CAP_LIST_NEXT
 1

	)

216 
	#PCI_CAP_FLAGS
 2

	)

217 
	#PCI_CAP_SIZEOF
 4

	)

221 
	#PCI_PM_PMC
 2

	)

222 
	#PCI_PM_CAP_VER_MASK
 0x0007

	)

223 
	#PCI_PM_CAP_PME_CLOCK
 0x0008

	)

224 
	#PCI_PM_CAP_RESERVED
 0x0010

	)

225 
	#PCI_PM_CAP_DSI
 0x0020

	)

226 
	#PCI_PM_CAP_AUX_POWER
 0x01C0

	)

227 
	#PCI_PM_CAP_D1
 0x0200

	)

228 
	#PCI_PM_CAP_D2
 0x0400

	)

229 
	#PCI_PM_CAP_PME
 0x0800

	)

230 
	#PCI_PM_CAP_PME_MASK
 0xF800

	)

231 
	#PCI_PM_CAP_PME_D0
 0x0800

	)

232 
	#PCI_PM_CAP_PME_D1
 0x1000

	)

233 
	#PCI_PM_CAP_PME_D2
 0x2000

	)

234 
	#PCI_PM_CAP_PME_D3
 0x4000

	)

235 
	#PCI_PM_CAP_PME_D3cŞd
 0x8000

	)

236 
	#PCI_PM_CAP_PME_SHIFT
 11

	)

237 
	#PCI_PM_CTRL
 4

	)

238 
	#PCI_PM_CTRL_STATE_MASK
 0x0003

	)

239 
	#PCI_PM_CTRL_NO_SOFT_RESET
 0x0008

	)

240 
	#PCI_PM_CTRL_PME_ENABLE
 0x0100

	)

241 
	#PCI_PM_CTRL_DATA_SEL_MASK
 0x1e00

	)

242 
	#PCI_PM_CTRL_DATA_SCALE_MASK
 0x6000

	)

243 
	#PCI_PM_CTRL_PME_STATUS
 0x8000

	)

244 
	#PCI_PM_PPB_EXTENSIONS
 6

	)

245 
	#PCI_PM_PPB_B2_B3
 0x40

	)

246 
	#PCI_PM_BPCC_ENABLE
 0x80

	)

247 
	#PCI_PM_DATA_REGISTER
 7

	)

248 
	#PCI_PM_SIZEOF
 8

	)

252 
	#PCI_AGP_VERSION
 2

	)

253 
	#PCI_AGP_RFU
 3

	)

254 
	#PCI_AGP_STATUS
 4

	)

255 
	#PCI_AGP_STATUS_RQ_MASK
 0xff000000

	)

256 
	#PCI_AGP_STATUS_SBA
 0x0200

	)

257 
	#PCI_AGP_STATUS_64BIT
 0x0020

	)

258 
	#PCI_AGP_STATUS_FW
 0x0010

	)

259 
	#PCI_AGP_STATUS_RATE4
 0x0004

	)

260 
	#PCI_AGP_STATUS_RATE2
 0x0002

	)

261 
	#PCI_AGP_STATUS_RATE1
 0x0001

	)

262 
	#PCI_AGP_COMMAND
 8

	)

263 
	#PCI_AGP_COMMAND_RQ_MASK
 0xff000000

	)

264 
	#PCI_AGP_COMMAND_SBA
 0x0200

	)

265 
	#PCI_AGP_COMMAND_AGP
 0x0100

	)

266 
	#PCI_AGP_COMMAND_64BIT
 0x0020

	)

267 
	#PCI_AGP_COMMAND_FW
 0x0010

	)

268 
	#PCI_AGP_COMMAND_RATE4
 0x0004

	)

269 
	#PCI_AGP_COMMAND_RATE2
 0x0002

	)

270 
	#PCI_AGP_COMMAND_RATE1
 0x0001

	)

271 
	#PCI_AGP_SIZEOF
 12

	)

275 
	#PCI_VPD_ADDR
 2

	)

276 
	#PCI_VPD_ADDR_MASK
 0x7ffà

	)

277 
	#PCI_VPD_ADDR_F
 0x8000

	)

278 
	#PCI_VPD_DATA
 4

	)

282 
	#PCI_SID_ESR
 2

	)

283 
	#PCI_SID_ESR_NSLOTS
 0x1à

	)

284 
	#PCI_SID_ESR_FIC
 0x20

	)

285 
	#PCI_SID_CHASSIS_NR
 3

	)

289 
	#PCI_MSI_FLAGS
 2

	)

290 
	#PCI_MSI_FLAGS_64BIT
 0x80

	)

291 
	#PCI_MSI_FLAGS_QSIZE
 0x70

	)

292 
	#PCI_MSI_FLAGS_QMASK
 0x0

	)

293 
	#PCI_MSI_FLAGS_ENABLE
 0x01

	)

294 
	#PCI_MSI_FLAGS_MASKBIT
 0x100

	)

295 
	#PCI_MSI_RFU
 3

	)

296 
	#PCI_MSI_ADDRESS_LO
 4

	)

297 
	#PCI_MSI_ADDRESS_HI
 8

	)

298 
	#PCI_MSI_DATA_32
 8

	)

299 
	#PCI_MSI_MASK_32
 12

	)

300 
	#PCI_MSI_DATA_64
 12

	)

301 
	#PCI_MSI_MASK_64
 16

	)

304 
	#PCI_MSIX_FLAGS
 2

	)

305 
	#PCI_MSIX_FLAGS_QSIZE
 0x7FF

	)

306 
	#PCI_MSIX_FLAGS_ENABLE
 (1 << 15)

	)

307 
	#PCI_MSIX_FLAGS_MASKALL
 (1 << 14)

	)

308 
	#PCI_MSIX_FLAGS_BIRMASK
 (7 << 0)

	)

312 
	#PCI_CHSWP_CSR
 2

	)

313 
	#PCI_CHSWP_DHA
 0x01

	)

314 
	#PCI_CHSWP_EIM
 0x02

	)

315 
	#PCI_CHSWP_PIE
 0x04

	)

316 
	#PCI_CHSWP_LOO
 0x08

	)

317 
	#PCI_CHSWP_PI
 0x30

	)

318 
	#PCI_CHSWP_EXT
 0x40

	)

319 
	#PCI_CHSWP_INS
 0x80

	)

323 
	#PCI_AF_LENGTH
 2

	)

324 
	#PCI_AF_CAP
 3

	)

325 
	#PCI_AF_CAP_TP
 0x01

	)

326 
	#PCI_AF_CAP_FLR
 0x02

	)

327 
	#PCI_AF_CTRL
 4

	)

328 
	#PCI_AF_CTRL_FLR
 0x01

	)

329 
	#PCI_AF_STATUS
 5

	)

330 
	#PCI_AF_STATUS_TP
 0x01

	)

334 
	#PCI_X_CMD
 2

	)

335 
	#PCI_X_CMD_DPERR_E
 0x0001

	)

336 
	#PCI_X_CMD_ERO
 0x0002

	)

337 
	#PCI_X_CMD_READ_512
 0x0000

	)

338 
	#PCI_X_CMD_READ_1K
 0x0004

	)

339 
	#PCI_X_CMD_READ_2K
 0x0008

	)

340 
	#PCI_X_CMD_READ_4K
 0x000ø

	)

341 
	#PCI_X_CMD_MAX_READ
 0x000ø

	)

343 
	#PCI_X_CMD_SPLIT_1
 0x0000

	)

344 
	#PCI_X_CMD_SPLIT_2
 0x0010

	)

345 
	#PCI_X_CMD_SPLIT_3
 0x0020

	)

346 
	#PCI_X_CMD_SPLIT_4
 0x0030

	)

347 
	#PCI_X_CMD_SPLIT_8
 0x0040

	)

348 
	#PCI_X_CMD_SPLIT_12
 0x0050

	)

349 
	#PCI_X_CMD_SPLIT_16
 0x0060

	)

350 
	#PCI_X_CMD_SPLIT_32
 0x0070

	)

351 
	#PCI_X_CMD_MAX_SPLIT
 0x0070

	)

352 
	#PCI_X_CMD_VERSION
(
x
è(((xè>> 12è& 3è

	)

353 
	#PCI_X_STATUS
 4

	)

354 
	#PCI_X_STATUS_DEVFN
 0x000000fà

	)

355 
	#PCI_X_STATUS_BUS
 0x0000ff00

	)

356 
	#PCI_X_STATUS_64BIT
 0x00010000

	)

357 
	#PCI_X_STATUS_133MHZ
 0x00020000

	)

358 
	#PCI_X_STATUS_SPL_DISC
 0x00040000

	)

359 
	#PCI_X_STATUS_UNX_SPL
 0x00080000

	)

360 
	#PCI_X_STATUS_COMPLEX
 0x00100000

	)

361 
	#PCI_X_STATUS_MAX_READ
 0x00600000

	)

362 
	#PCI_X_STATUS_MAX_SPLIT
 0x03800000

	)

363 
	#PCI_X_STATUS_MAX_CUM
 0x1c000000

	)

364 
	#PCI_X_STATUS_SPL_ERR
 0x20000000

	)

365 
	#PCI_X_STATUS_266MHZ
 0x40000000

	)

366 
	#PCI_X_STATUS_533MHZ
 0x80000000

	)

370 
	#PCI_EXP_FLAGS
 2

	)

371 
	#PCI_EXP_FLAGS_VERS
 0x000à

	)

372 
	#PCI_EXP_FLAGS_TYPE
 0x00f0

	)

373 
	#PCI_EXP_TYPE_ENDPOINT
 0x0

	)

374 
	#PCI_EXP_TYPE_LEG_END
 0x1

	)

375 
	#PCI_EXP_TYPE_ROOT_PORT
 0x4

	)

376 
	#PCI_EXP_TYPE_UPSTREAM
 0x5

	)

377 
	#PCI_EXP_TYPE_DOWNSTREAM
 0x6

	)

378 
	#PCI_EXP_TYPE_PCI_BRIDGE
 0x7

	)

379 
	#PCI_EXP_TYPE_RC_END
 0x9

	)

380 
	#PCI_EXP_TYPE_RC_EC
 0x10

	)

381 
	#PCI_EXP_FLAGS_SLOT
 0x0100

	)

382 
	#PCI_EXP_FLAGS_IRQ
 0x3e00

	)

383 
	#PCI_EXP_DEVCAP
 4

	)

384 
	#PCI_EXP_DEVCAP_PAYLOAD
 0x07

	)

385 
	#PCI_EXP_DEVCAP_PHANTOM
 0x18

	)

386 
	#PCI_EXP_DEVCAP_EXT_TAG
 0x20

	)

387 
	#PCI_EXP_DEVCAP_L0S
 0x1c0

	)

388 
	#PCI_EXP_DEVCAP_L1
 0xe00

	)

389 
	#PCI_EXP_DEVCAP_ATN_BUT
 0x1000

	)

390 
	#PCI_EXP_DEVCAP_ATN_IND
 0x2000

	)

391 
	#PCI_EXP_DEVCAP_PWR_IND
 0x4000

	)

392 
	#PCI_EXP_DEVCAP_RBER
 0x8000

	)

393 
	#PCI_EXP_DEVCAP_PWR_VAL
 0x3fc0000

	)

394 
	#PCI_EXP_DEVCAP_PWR_SCL
 0xc000000

	)

395 
	#PCI_EXP_DEVCAP_FLR
 0x10000000

	)

396 
	#PCI_EXP_DEVCTL
 8

	)

397 
	#PCI_EXP_DEVCTL_CERE
 0x0001

	)

398 
	#PCI_EXP_DEVCTL_NFERE
 0x0002

	)

399 
	#PCI_EXP_DEVCTL_FERE
 0x0004

	)

400 
	#PCI_EXP_DEVCTL_URRE
 0x0008

	)

401 
	#PCI_EXP_DEVCTL_RELAX_EN
 0x0010

	)

402 
	#PCI_EXP_DEVCTL_PAYLOAD
 0x00e0

	)

403 
	#PCI_EXP_DEVCTL_EXT_TAG
 0x0100

	)

404 
	#PCI_EXP_DEVCTL_PHANTOM
 0x0200

	)

405 
	#PCI_EXP_DEVCTL_AUX_PME
 0x0400

	)

406 
	#PCI_EXP_DEVCTL_NOSNOOP_EN
 0x0800

	)

407 
	#PCI_EXP_DEVCTL_READRQ
 0x7000

	)

408 
	#PCI_EXP_DEVCTL_BCR_FLR
 0x8000

	)

409 
	#PCI_EXP_DEVSTA
 10

	)

410 
	#PCI_EXP_DEVSTA_CED
 0x01

	)

411 
	#PCI_EXP_DEVSTA_NFED
 0x02

	)

412 
	#PCI_EXP_DEVSTA_FED
 0x04

	)

413 
	#PCI_EXP_DEVSTA_URD
 0x08

	)

414 
	#PCI_EXP_DEVSTA_AUXPD
 0x10

	)

415 
	#PCI_EXP_DEVSTA_TRPND
 0x20

	)

416 
	#PCI_EXP_LNKCAP
 12

	)

417 
	#PCI_EXP_LNKCAP_SLS
 0x0000000à

	)

418 
	#PCI_EXP_LNKCAP_MLW
 0x000003f0

	)

419 
	#PCI_EXP_LNKCAP_ASPMS
 0x00000c00

	)

420 
	#PCI_EXP_LNKCAP_L0SEL
 0x00007000

	)

421 
	#PCI_EXP_LNKCAP_L1EL
 0x00038000

	)

422 
	#PCI_EXP_LNKCAP_CLKPM
 0x00040000

	)

423 
	#PCI_EXP_LNKCAP_SDERC
 0x00080000

	)

424 
	#PCI_EXP_LNKCAP_DLLLARC
 0x00100000

	)

425 
	#PCI_EXP_LNKCAP_LBNC
 0x00200000

	)

426 
	#PCI_EXP_LNKCAP_PN
 0xff000000

	)

427 
	#PCI_EXP_LNKCTL
 16

	)

428 
	#PCI_EXP_LNKCTL_ASPMC
 0x0003

	)

429 
	#PCI_EXP_LNKCTL_RCB
 0x0008

	)

430 
	#PCI_EXP_LNKCTL_LD
 0x0010

	)

431 
	#PCI_EXP_LNKCTL_RL
 0x0020

	)

432 
	#PCI_EXP_LNKCTL_CCC
 0x0040

	)

433 
	#PCI_EXP_LNKCTL_ES
 0x0080

	)

434 
	#PCI_EXP_LNKCTL_CLKREQ_EN
 0x100

	)

435 
	#PCI_EXP_LNKCTL_HAWD
 0x0200

	)

436 
	#PCI_EXP_LNKCTL_LBMIE
 0x0400

	)

437 
	#PCI_EXP_LNKCTL_LABIE
 0x0800

	)

438 
	#PCI_EXP_LNKSTA
 18

	)

439 
	#PCI_EXP_LNKSTA_CLS
 0x000à

	)

440 
	#PCI_EXP_LNKSTA_NLW
 0x03f0

	)

441 
	#PCI_EXP_LNKSTA_LT
 0x0800

	)

442 
	#PCI_EXP_LNKSTA_SLC
 0x1000

	)

443 
	#PCI_EXP_LNKSTA_DLLLA
 0x2000

	)

444 
	#PCI_EXP_LNKSTA_LBMS
 0x4000

	)

445 
	#PCI_EXP_LNKSTA_LABS
 0x8000

	)

446 
	#PCI_EXP_SLTCAP
 20

	)

447 
	#PCI_EXP_SLTCAP_ABP
 0x00000001

	)

448 
	#PCI_EXP_SLTCAP_PCP
 0x00000002

	)

449 
	#PCI_EXP_SLTCAP_MRLSP
 0x00000004

	)

450 
	#PCI_EXP_SLTCAP_AIP
 0x00000008

	)

451 
	#PCI_EXP_SLTCAP_PIP
 0x00000010

	)

452 
	#PCI_EXP_SLTCAP_HPS
 0x00000020

	)

453 
	#PCI_EXP_SLTCAP_HPC
 0x00000040

	)

454 
	#PCI_EXP_SLTCAP_SPLV
 0x00007f80

	)

455 
	#PCI_EXP_SLTCAP_SPLS
 0x00018000

	)

456 
	#PCI_EXP_SLTCAP_EIP
 0x00020000

	)

457 
	#PCI_EXP_SLTCAP_NCCS
 0x00040000

	)

458 
	#PCI_EXP_SLTCAP_PSN
 0xfff80000

	)

459 
	#PCI_EXP_SLTCTL
 24

	)

460 
	#PCI_EXP_SLTCTL_ABPE
 0x0001

	)

461 
	#PCI_EXP_SLTCTL_PFDE
 0x0002

	)

462 
	#PCI_EXP_SLTCTL_MRLSCE
 0x0004

	)

463 
	#PCI_EXP_SLTCTL_PDCE
 0x0008

	)

464 
	#PCI_EXP_SLTCTL_CCIE
 0x0010

	)

465 
	#PCI_EXP_SLTCTL_HPIE
 0x0020

	)

466 
	#PCI_EXP_SLTCTL_AIC
 0x00c0

	)

467 
	#PCI_EXP_SLTCTL_PIC
 0x0300

	)

468 
	#PCI_EXP_SLTCTL_PCC
 0x0400

	)

469 
	#PCI_EXP_SLTCTL_EIC
 0x0800

	)

470 
	#PCI_EXP_SLTCTL_DLLSCE
 0x1000

	)

471 
	#PCI_EXP_SLTSTA
 26

	)

472 
	#PCI_EXP_SLTSTA_ABP
 0x0001

	)

473 
	#PCI_EXP_SLTSTA_PFD
 0x0002

	)

474 
	#PCI_EXP_SLTSTA_MRLSC
 0x0004

	)

475 
	#PCI_EXP_SLTSTA_PDC
 0x0008

	)

476 
	#PCI_EXP_SLTSTA_CC
 0x0010

	)

477 
	#PCI_EXP_SLTSTA_MRLSS
 0x0020

	)

478 
	#PCI_EXP_SLTSTA_PDS
 0x0040

	)

479 
	#PCI_EXP_SLTSTA_EIS
 0x0080

	)

480 
	#PCI_EXP_SLTSTA_DLLSC
 0x0100

	)

481 
	#PCI_EXP_RTCTL
 28

	)

482 
	#PCI_EXP_RTCTL_SECEE
 0x01

	)

483 
	#PCI_EXP_RTCTL_SENFEE
 0x02

	)

484 
	#PCI_EXP_RTCTL_SEFEE
 0x04

	)

485 
	#PCI_EXP_RTCTL_PMEIE
 0x08

	)

486 
	#PCI_EXP_RTCTL_CRSSVE
 0x10

	)

487 
	#PCI_EXP_RTCAP
 30

	)

488 
	#PCI_EXP_RTSTA
 32

	)

489 
	#PCI_EXP_DEVCAP2
 36

	)

490 
	#PCI_EXP_DEVCAP2_ARI
 0x20

	)

491 
	#PCI_EXP_DEVCTL2
 40

	)

492 
	#PCI_EXP_DEVCTL2_ARI
 0x20

	)

493 
	#PCI_EXP_LNKCTL2
 48

	)

494 
	#PCI_EXP_SLTCTL2
 56

	)

497 
	#PCI_EXT_CAP_ID
(
h—d”
è(h—d” & 0x0000ffff)

	)

498 
	#PCI_EXT_CAP_VER
(
h—d”
è((h—d” >> 16è& 0xf)

	)

499 
	#PCI_EXT_CAP_NEXT
(
h—d”
è((h—d” >> 20è& 0xffc)

	)

501 
	#PCI_EXT_CAP_ID_ERR
 1

	)

502 
	#PCI_EXT_CAP_ID_VC
 2

	)

503 
	#PCI_EXT_CAP_ID_DSN
 3

	)

504 
	#PCI_EXT_CAP_ID_PWR
 4

	)

505 
	#PCI_EXT_CAP_ID_ARI
 14

	)

506 
	#PCI_EXT_CAP_ID_ATS
 15

	)

507 
	#PCI_EXT_CAP_ID_SRIOV
 16

	)

510 
	#PCI_ERR_UNCOR_STATUS
 4

	)

511 
	#PCI_ERR_UNC_TRAIN
 0x00000001

	)

512 
	#PCI_ERR_UNC_DLP
 0x00000010

	)

513 
	#PCI_ERR_UNC_POISON_TLP
 0x00001000

	)

514 
	#PCI_ERR_UNC_FCP
 0x00002000

	)

515 
	#PCI_ERR_UNC_COMP_TIME
 0x00004000

	)

516 
	#PCI_ERR_UNC_COMP_ABORT
 0x00008000

	)

517 
	#PCI_ERR_UNC_UNX_COMP
 0x00010000

	)

518 
	#PCI_ERR_UNC_RX_OVER
 0x00020000

	)

519 
	#PCI_ERR_UNC_MALF_TLP
 0x00040000

	)

520 
	#PCI_ERR_UNC_ECRC
 0x00080000

	)

521 
	#PCI_ERR_UNC_UNSUP
 0x00100000

	)

522 
	#PCI_ERR_UNCOR_MASK
 8

	)

524 
	#PCI_ERR_UNCOR_SEVER
 12

	)

526 
	#PCI_ERR_COR_STATUS
 16

	)

527 
	#PCI_ERR_COR_RCVR
 0x00000001

	)

528 
	#PCI_ERR_COR_BAD_TLP
 0x00000040

	)

529 
	#PCI_ERR_COR_BAD_DLLP
 0x00000080

	)

530 
	#PCI_ERR_COR_REP_ROLL
 0x00000100

	)

531 
	#PCI_ERR_COR_REP_TIMER
 0x00001000

	)

532 
	#PCI_ERR_COR_MASK
 20

	)

534 
	#PCI_ERR_CAP
 24

	)

535 
	#PCI_ERR_CAP_FEP
(
x
è((xè& 31è

	)

536 
	#PCI_ERR_CAP_ECRC_GENC
 0x00000020

	)

537 
	#PCI_ERR_CAP_ECRC_GENE
 0x00000040

	)

538 
	#PCI_ERR_CAP_ECRC_CHKC
 0x00000080

	)

539 
	#PCI_ERR_CAP_ECRC_CHKE
 0x00000100

	)

540 
	#PCI_ERR_HEADER_LOG
 28

	)

541 
	#PCI_ERR_ROOT_COMMAND
 44

	)

543 
	#PCI_ERR_ROOT_CMD_COR_EN
 0x00000001

	)

545 
	#PCI_ERR_ROOT_CMD_NONFATAL_EN
 0x00000002

	)

547 
	#PCI_ERR_ROOT_CMD_FATAL_EN
 0x00000004

	)

548 
	#PCI_ERR_ROOT_STATUS
 48

	)

549 
	#PCI_ERR_ROOT_COR_RCV
 0x00000001

	)

551 
	#PCI_ERR_ROOT_MULTI_COR_RCV
 0x00000002

	)

553 
	#PCI_ERR_ROOT_UNCOR_RCV
 0x00000004

	)

555 
	#PCI_ERR_ROOT_MULTI_UNCOR_RCV
 0x00000008

	)

556 
	#PCI_ERR_ROOT_FIRST_FATAL
 0x00000010

	)

557 
	#PCI_ERR_ROOT_NONFATAL_RCV
 0x00000020

	)

558 
	#PCI_ERR_ROOT_FATAL_RCV
 0x00000040

	)

559 
	#PCI_ERR_ROOT_COR_SRC
 52

	)

560 
	#PCI_ERR_ROOT_SRC
 54

	)

563 
	#PCI_VC_PORT_REG1
 4

	)

564 
	#PCI_VC_PORT_REG2
 8

	)

565 
	#PCI_VC_PORT_CTRL
 12

	)

566 
	#PCI_VC_PORT_STATUS
 14

	)

567 
	#PCI_VC_RES_CAP
 16

	)

568 
	#PCI_VC_RES_CTRL
 20

	)

569 
	#PCI_VC_RES_STATUS
 26

	)

572 
	#PCI_PWR_DSR
 4

	)

573 
	#PCI_PWR_DATA
 8

	)

574 
	#PCI_PWR_DATA_BASE
(
x
è((xè& 0xffè

	)

575 
	#PCI_PWR_DATA_SCALE
(
x
è(((xè>> 8è& 3è

	)

576 
	#PCI_PWR_DATA_PM_SUB
(
x
è(((xè>> 10è& 7è

	)

577 
	#PCI_PWR_DATA_PM_STATE
(
x
è(((xè>> 13è& 3è

	)

578 
	#PCI_PWR_DATA_TYPE
(
x
è(((xè>> 15è& 7è

	)

579 
	#PCI_PWR_DATA_RAIL
(
x
è(((xè>> 18è& 7è

	)

580 
	#PCI_PWR_CAP
 12

	)

581 
	#PCI_PWR_CAP_BUDGET
(
x
è((xè& 1è

	)

591 
	#HT_3BIT_CAP_MASK
 0xE0

	)

592 
	#HT_CAPTYPE_SLAVE
 0x00

	)

593 
	#HT_CAPTYPE_HOST
 0x20

	)

595 
	#HT_5BIT_CAP_MASK
 0xF8

	)

596 
	#HT_CAPTYPE_IRQ
 0x80

	)

597 
	#HT_CAPTYPE_REMAPPING_40
 0xA0

	)

598 
	#HT_CAPTYPE_REMAPPING_64
 0xA2

	)

599 
	#HT_CAPTYPE_UNITID_CLUMP
 0x90

	)

600 
	#HT_CAPTYPE_EXTCONF
 0x98

	)

601 
	#HT_CAPTYPE_MSI_MAPPING
 0xA8

	)

602 
	#HT_MSI_FLAGS
 0x02

	)

603 
	#HT_MSI_FLAGS_ENABLE
 0x1

	)

604 
	#HT_MSI_FLAGS_FIXED
 0x2

	)

605 
	#HT_MSI_FIXED_ADDR
 0x00000000FEE00000ULL

	)

606 
	#HT_MSI_ADDR_LO
 0x04

	)

607 
	#HT_MSI_ADDR_LO_MASK
 0xFFF00000

	)

608 
	#HT_MSI_ADDR_HI
 0x08

	)

609 
	#HT_CAPTYPE_DIRECT_ROUTE
 0xB0

	)

610 
	#HT_CAPTYPE_VCSET
 0xB8

	)

611 
	#HT_CAPTYPE_ERROR_RETRY
 0xC0

	)

612 
	#HT_CAPTYPE_GEN3
 0xD0

	)

613 
	#HT_CAPTYPE_PM
 0xE0

	)

616 
	#PCI_ARI_CAP
 0x04

	)

617 
	#PCI_ARI_CAP_MFVC
 0x0001

	)

618 
	#PCI_ARI_CAP_ACS
 0x0002

	)

619 
	#PCI_ARI_CAP_NFN
(
x
è(((xè>> 8è& 0xffè

	)

620 
	#PCI_ARI_CTRL
 0x06

	)

621 
	#PCI_ARI_CTRL_MFVC
 0x0001

	)

622 
	#PCI_ARI_CTRL_ACS
 0x0002

	)

623 
	#PCI_ARI_CTRL_FG
(
x
è(((xè>> 4è& 7è

	)

626 
	#PCI_ATS_CAP
 0x04

	)

627 
	#PCI_ATS_CAP_QDEP
(
x
è((xè& 0x1fè

	)

628 
	#PCI_ATS_MAX_QDEP
 32

	)

629 
	#PCI_ATS_CTRL
 0x06

	)

630 
	#PCI_ATS_CTRL_ENABLE
 0x8000

	)

631 
	#PCI_ATS_CTRL_STU
(
x
è((xè& 0x1fè

	)

632 
	#PCI_ATS_MIN_STU
 12

	)

635 
	#PCI_SRIOV_CAP
 0x04

	)

636 
	#PCI_SRIOV_CAP_VFM
 0x01

	)

637 
	#PCI_SRIOV_CAP_INTR
(
x
è((xè>> 21è

	)

638 
	#PCI_SRIOV_CTRL
 0x08

	)

639 
	#PCI_SRIOV_CTRL_VFE
 0x01

	)

640 
	#PCI_SRIOV_CTRL_VFM
 0x02

	)

641 
	#PCI_SRIOV_CTRL_INTR
 0x04

	)

642 
	#PCI_SRIOV_CTRL_MSE
 0x08

	)

643 
	#PCI_SRIOV_CTRL_ARI
 0x10

	)

644 
	#PCI_SRIOV_STATUS
 0x0¨

	)

645 
	#PCI_SRIOV_STATUS_VFM
 0x01

	)

646 
	#PCI_SRIOV_INITIAL_VF
 0x0ø

	)

647 
	#PCI_SRIOV_TOTAL_VF
 0x0

	)

648 
	#PCI_SRIOV_NUM_VF
 0x10

	)

649 
	#PCI_SRIOV_FUNC_LINK
 0x12

	)

650 
	#PCI_SRIOV_VF_OFFSET
 0x14

	)

651 
	#PCI_SRIOV_VF_STRIDE
 0x16

	)

652 
	#PCI_SRIOV_VF_DID
 0x1¨

	)

653 
	#PCI_SRIOV_SUP_PGSIZE
 0x1ø

	)

654 
	#PCI_SRIOV_SYS_PGSIZE
 0x20

	)

655 
	#PCI_SRIOV_BAR
 0x24

	)

656 
	#PCI_SRIOV_NUM_BARS
 6

	)

657 
	#PCI_SRIOV_VFM
 0x3ø

	)

658 
	#PCI_SRIOV_VFM_BIR
(
x
è((xè& 7è

	)

659 
	#PCI_SRIOV_VFM_OFFSET
(
x
è((xè& ~7è

	)

660 
	#PCI_SRIOV_VFM_UA
 0x0

	)

661 
	#PCI_SRIOV_VFM_MI
 0x1

	)

662 
	#PCI_SRIOV_VFM_MO
 0x2

	)

663 
	#PCI_SRIOV_VFM_AV
 0x3

	)

666 
	#PCI_CONFIG_ADDR
 0xCF8

	)

676 
	#PCI_CONFIG_DATA
 0xCFC

	)

	@include/linux/pci_vendor.h

1 #iâdeà
PCI_VENDOR_H


2 
	#PCI_VENDOR_H


	)

3 
	~<v®Ty³.h
>

10 
	spci_v’dÜ_’Œy


12 
	mV’Id
 ;

13 * 
	mV’ShÜt
 ;

14 * 
	mV’FuÎ
 ;

15 } 
	tPCI_VENTABLE
, *
	tPPCI_VENTABLE
 ;

20 
	spci_šfo_’Œy


22 
	mV’Id
 ;

23 
	mDevId
 ;

24 * 
	mCh
 ;

25 * 
	mChDesc
 ;

26 } 
	tPCI_DEVTABLE
 ;

31 
	spci_şass_’Œy


33 
	mBa£CÏss
 ;

34 
	mSubCÏss
 ;

35 
	mProgIf
 ;

36 * 
	mBa£Desc
 ;

37 * 
	mSubDesc
 ;

38 * 
	mProgDesc
 ;

39 } 
	tPCI_CLASSCODETABLE
, *
	tPPCI_CLASSCODETABLE
 ;

42 #´agm¨
·ck
 (
push
)

43 #´agm¨
·ck
 (1)

44 
	spci_şasscode
{

47 
u8
 
	m»visiÚ
;

48 
u8
 
	m´og
;

49 
u8
 
	msub
;

50 
u8
 
	mba£
;

53 
	m_»visiÚ
: 8;

54 
	mv®ue
: 24;

58 #´agm¨
·ck
 (
pİ
)

60 
pci_šfo_’Œy
 * 
PciTabË_G‘
(
v’dÜ
, 
deviû
);

61 
pci_v’dÜ_’Œy
 *
PciV’dÜTbl_G‘
(
u16
 
v’dÜ
);

62 
PciDevTabË_Mk_Fa¡_Acûss
();

63 
pci_şass_’Œy
 *
PciCÏssTbl_G‘
(
u8
 
şass
, u8 
sub
, u8 
´og
);

	@include/linux/pci_vendor_full.h

5 
	gPCIHDR
.
	gH
: 
PCI
 
V’dÜs
, 
	gDeviûs
, 
ªd
 
CÏss
 
Ty³
 
šfÜm©iÚ


7 
C»©ed
 
autom©iÿÎy
 
äom
 
the
 
web
 
usšg
h
fŞlowšg
 
	gURL
:

8 
h‰p
:

9 
Soáw¬e
 
to
 
ü—‹
 
ªd
 
mašš
 
the
 
PCICODE
 
Li¡
 
wr™‹n
 
by
:

10 
Jim
 
BÛmËr
 (
jbÛmËr
@
h®cyÚ
.
com
)

12 
This
 
h—d”
 
ü—‹d
 
Ú
 
Tue
 
Jun
 7 01:52:41 
EDT
 2016

14 
Too
 
mªy
 
³İË
 
have
 
cÚŒibu‹d
 
to
 
this
 
li¡
Ø
acknowËdge
 
them
 
®l
, 
but


15 
a
 
ãw
 
have
 
´ovided
 
the
 
majÜ™y
 
of
h
šput
 
ªd
 
de£rve
 
¥ecŸl
 
	gm’tiÚ
:

16 
F»d”ic
 
PÙ‹r
, 
who
 
maššs
 
a
 
li¡
 
	gLšux
.

17 
Chris
 
A¡Ú
 
©
 
Madge
 
	gN‘wÜks
.

18 
Thomas
 
DpÚ
 
of
 
	gHewË‰
-
Pack¬d
 
	gGmbH
.

19 
Jurg’
 ("Josh"è
Th–’


20 
WlŸm
 
	gH
. 
Av”y
 
III
 
©
 
AÉ™ech


21 
S”gei
 
Shtylyov
 
of
 
	gB¿š
-
d—d
 
Soáw¬e
 
š
 
	gRussŸ


29 
	spci_v’dÜ_’Œy


31 
	mV’Id
 ;

32 * 
	mV’ShÜt
 ;

33 * 
	mV’FuÎ
 ;

34 } 
	tPCI_VENTABLE
, *
	tPPCI_VENTABLE
 ;

36 
PCI_VENTABLE
 
	gPciV’TabË
 [] =

1611 
	#PCI_VENTABLE_LEN
 ((
PciV’TabË
)/(
PCI_VENTABLE
))

	)

1613 
	spci_šfo_’Œy


1615 
	mV’Id
 ;

1616 
	mDevId
 ;

1617 * 
	mCh
 ;

1618 * 
	mChDesc
 ;

1619 } 
	tPCI_DEVTABLE
 ;

1621 
PCI_DEVTABLE
 
	gPciDevTabË
 [] =

1631 { 0x11DE, 0x6
O57
, "ZR36057PQC", "ZORAN PCI Bridge (interface forransferring video‡crosshe PCI bus)" } ,

2480 { 0x8086, 0x1c02
_
, "8086&dev_1c02", "Intel(R) Desktop/Workstation/Server Express Chipset SATA AHCI Controller" } ,

2513 { 0x8086, 0x1E3A
_
, "C216", "8555555555555999999999999999999999999999999999999999999999999999999900000000000000000001222222222222" } ,

2514 { 0x8086, 0x1E3A
__
, "Z77", "C216 Chipset - Platform controller hub" } ,

2582 { 0x8086, 0x24C5&
SUBSYS_041111
, "2200bg", "PCI Simple Communications Controller" } ,

2584 { 0x8086, 0x24c5
j
, "SUBSYS_21179", "Soundmax Integrated Digital Audio" } ,

2585 { 0x8086, 0x24C5
n
, "82801DBM SoundMAXController (ICH4-M B0 step)", "Intel 82801 DB DBM/DA AC 97 Audio Controller" } ,

2642 { 0x8086, 0x2562@
cc
, "82801FR", "SATA RAID CONTROLLER" } ,

2689 { 0x8086, 0x2652&
CC_0101
, "82801FR/FRW", "SATA Controller" } ,

2690 { 0x8086, 0x2652&
CC_0104
, "82801FR/FRW", "SATA Raid Controller" } ,

2691 { 0x8086, 0x2652&
CC_0106
, "82801FR/FRW", "AHCI Controller" } ,

2693 { 0x8086, 0x2653&
CC_0101
, "82801FBM", "SATA IDE Controller" } ,

2694 { 0x8086, 0x2653&
CC_0106
, "82801FBM", "AHCI Controller" } ,

2751 { 0x8086, 0x27d8x
zx
, "PCI\\VEN_8086&DEV_2485&SUBSYS_AD021458&REV_02", "Microsoft UAA Bus HD Audio" } ,

2758 { 0x8086, 0x27
RR
, "ALC850", "no" } ,

2839 { 0x8086, 0x29B4&
subys
, "4F4A8086&rev_02", "Management Engine Driver" } ,

2843 { 0x8086, 0x29C2
_
, "Intel G33", "Intel(R) G33 chipset GMA3100 video Driver" } ,

2878 { 0x8086, 0x2E24&
CC
, "PCI\\VEN_8086", "Intel Management Engine Interface" } ,

2884 { 0x8086, 0x2E33
_
, "G41 EXPRESS CHIPSET", "ghaphics chipset g41 ghaphics chipset g41 " } ,

3001 { 0x8086, 0x3B64&
subsys
, "REV_06", "Intel Management Engine Interface" } ,

3002 { 0x8086, 0x3B64&
SUBSYS_048210
, "Intel 3B09", "Management Engine Driver" } ,

3003 { 0x8086, 0x3B64&
subsys_048710
, "REV_06", "Intel Management Engine Interface" } ,

3004 { 0x8086, 0x3B64&
SUBSYS_116817
, "REV_06", "Intel Management Engine Interface" } ,

3005 { 0x8086, 0x3B64
SUBSYS_FF1E117
, "REV_06", "intel" } ,

3006 { 0x8086, 0x3b64
_
&
subsys_fd3c1
, "ven_8086&dev_3b64&subsys_fd3c1179&rev_06", "ven_8086&dev_3b64&subsys_fd3c1179&rev_06 [Toshiba C660-1CN]" } ,

3046 { 0x8086, 0x6741
_
, "0x8086", "Intel USB 3.0" } ,

3096 { 0x8086, 0x8086&
DEV
, "9.3.0.1019", "intel" } ,

3097 { 0x8086, 0x8086&
DEV
-24C5, "VIA vynil v700b", "VIA vynil v700b" } ,

3098 { 0x8086, 0x8086&
DEV_1040
, "SUBSYS_148A103C", "REV_00\\3&61AAA01&0&50 " } ,

3099 { 0x8086, 0x8086&
DEV_24C5
, "82801DBM SoundMax Controller", "VIA vynil v700b" } ,

3100 { 0x8086, 0x8086&
DEV_3B64
, "SUBSYS_03701025", "pci simple communications controller" } ,

3101 { 0x8086, 0x8086&
DEV_3B64
&
SUBS
, "SUBSYS_144A103C", "pci simple communications controller" } ,

3102 { 0x8086, 0x8086&
DEV_7191
&
SUBS
, "Intel 3B69Management Engine Driver", "Management Engine Driver" } ,

3155 { 0x8086, 0x9c3¨
Subsys_05eb1
, "9c3a Subsys_05eb1028 &„ev_04\\3 & 11583659", "PCI Simple Communication Controller" } ,

3156 { 0x8086, 0x9c3¨
Subsys_05eb1
, "12", "PCI Simple Communication Controller" } ,

3163 { 0x8086, 0xA
O11
, "02\\3", "3&33FD14CA&0&10" } ,

3164 { 0x8086, 0xA
O12
, "0x0283E", "Intel(R) ICH8 Family SMBus Controller" } ,

3171 { 0x8086, 0x
PCI
\
VEN_8086
&
DEV_2
, "11583659", "PCI\\VEN_8086&DEV_27DA&SUBSYS_31031565" } ,

3172 { 0x8086, 0x
PCI
\
VEN_8086
&
DEV_2
, "11583659", "PCI\\VEN_8086&DEV_8C22&SUBSYS_FA301179&REV_04\\3&11583659&0&FB" } ,

3173 { 0x8086, 0x
PCI
\
VEN_8086
&
DEV_3
, "11583658", "PCI\\VEN_8086&DEV_3B64&SUBSYS_04821025&REV_06" } ,

3177 { 0x8086, 0x
_1c3a
, "REV_04", "REV-04" } ,

3178 { 0x8086, 0x
_1E3A
, "0c05", "i5-3210" } ,

3179 { 0x8086, 0x
_3B64
, "3b69", "Chip Description:Management Engine Driver" } ,

3180 { 0x8086, 0x
__1c3a
, "SUBYS_308C17AA", "REV-04 3&11583659" } ,

3181 { 0x8086, 0x
___1C3A
, "8086", "Intel(R) Management Engine Interface" } ,

3401 { 0x15D7, 
RS56
, "hcf cx11252-41z", "hcf 56" } ,

3675 { 0x14F1, 0x5051
_
, "DG31PR", "Conexant HD-Audio SmartAudio 221" } ,

3676 { 0x14F1, 0x5051
__
, "CX20561", "Conexant HD-Audio SmartAudio 221" } ,

3718 { 0x1969, 0x
R091
, "Killer E2200", "Killer E2200 Network Card" } ,

3749 { 0x0c45, 0x6128
_
, "USB\\VID_0C45&PID_6148&REV_0101", "USB PC Camera Plus" } ,

3758 { 0x0c45, 0x6270
_
, "usb\\vid_oc45&pid_627b\\5&138897&#1044;1&0&5", "webcam" } ,

3857 { 0x197B, 0x
JMB38
, "JMB38X", "JMB38X SD/MMC Host Controller" } ,

4026 { 0x10EC, 0x5289
R—Éek
 , "RTL8411", " PCIE Card Reader" } ,

4082 { 0x0cf3, 0x3002
_
, "unknown", "unknown" } ,

4105 { 0x1912, 0x0015
_
, "EC01-P", "Renesas Electronics USB 3.0 Host Controller" } ,

4134 { 0x168C, 0x001C 
Ùh”
, "AR5BXB63", "Atheros AR5BXB63 WWAN Chip" } ,

4135 { 0x168C, 0x001c
_agaš
, "AR5BXB61", "AR5006EX AR5423a" } ,

4418 { 0x1002, 0x1ab8 
hex
, "2", "ati„adeon " } ,

4486 { 0x1002, 0x4380&
CC_0101
, "ATI SB600", "SATA2" } ,

4487 { 0x1002, 0x4380&
CC_0104
, "ATI SB600", "RAID/AHCI Controller" } ,

4488 { 0x1002, 0x4380&
CC_0106
, "ATI RS690m", "AHCI Controller" } ,

4504 { 0x1002, 0x4391&
CC_0106
, "AMD SB850", "AMD Southbridge incorporating AHCI 1.2 with SATA FISâ€“based switching support" } ,

4507 { 0x1002, 0x4394&
CC_0106
, "5100", "AMD SP5100 South Bridge" } ,

4727 { 0x1002, 0x5960 
AGP
, "A051400005470", "PN 1024-RC26-1F-SA" } ,

4733 { 0x1002, 0x5974&
SUBSYS_022A10
, "RS482", "ATI Radeon Xpress 200M (Mobile)" } ,

4739 { 0x1002, 0x5A41 
ATI
 
RADEON
 
Xp
, "0x5A41 ATI RADEON Xpress 1200 Series 0x1002", "0x5A41 ATI RADEON Xpress 1200 Series 0x1002" } ,

4753 { 0x1002, 0x5B6
O
, "RV370", "ATI RADEON X300/X550/X1050 Series" } ,

4797 { 0x1002, 0x6741
_
, "AMD Radeon HD 7450M (6470M)&#12289;6630M&#12289;In", "PCI\\VEN_1002&DEV_6741&SUBSYS_21E317AA&REV_00" } ,

4913 { 0x1002, 0x71C5 
PCIE
, "M56", "ATI MOBILITY /ATI RADEON X1600" } ,

4995 { 0x1002, 0x791
Z
, "SUBSYS_826D1043", "REV_00" } ,

5150 { 0x1002, 0x
o876
, "", "" } ,

5185 { 0x100B, 0x0020
h
, "DP83815", "10/100 MacPhyter3v PCI Adapter" } ,

5341 { 0x1014, 0x
IBM37C0
, "Unknown", "IBM Netfinity Advanced System Management Processor" } ,

5342 { 0x1014, 0x
IBM37D0
, "n/a", "n/a" } ,

5444 { 0x1022, 0x7801
_
, "amd_sata", "AMD SATA Controller" } ,

5580 { 0x1028, 0x1f
oc
, "n4050", "pci simple communication controller" } ,

5835 { 0x1039, 0x
	g_7012
, "HDAUDIO\\FUNC_01&VEN_&DEV_504514F1&SUBSYS_1631C106&", "PCI Audio Accelerator" } ,

5983 { 0x104A, 0x
	gSMO8800
, "Unknown", "ST Microelectronics Free Fall Sensor" } ,

5984 { 0x104A, 0x
	gSMO8810
, "Unknown", "STMicroelectronics Freefall Sensor" } ,

6625 { 0x1393, 0x104
	gh
, "C104H/PCI", "Smartio" } ,

6951 { 0x109E, 0x0350&
	gSUBSYS_000000
, "Bt848h", "tvuner driverhj" } ,

6956 { 0x109E, 0x036E&
	gSUBSYS_000000
, "Conextant Fucion 878A 25878-123", "Video Capture" } ,

6957 { 0x109E, 0x036E&
	gSUBSYS_000000
, "Conextant Fucion 878A 25878-123", "Video Capture" } ,

6970 { 0x109E, 0x36E&
	gSUBSYS_0000000
, "Bt360 MediaStream &#1050;&#1086;&#1085;&#1090;&#10", "Brooktree Corp" } ,

6971 { 0x109E, 0x36E&
	gSUBSYS_0000000
, "CONEXANT FUSION 878A 25878-13 E153498.1", "conexant 878a" } ,

7178 { 0x10B9, 0x5229&
	gREV_00
, "?", "Ali EIDE" } ,

7179 { 0x10B9, 0x5229&
	gREV_20
, "?", "PATA 33" } ,

7180 { 0x10B9, 0x5229&
	gREV_C2
, "?", "PATA 66" } ,

7181 { 0x10B9, 0x5229&
	gREV_C4
, "?", "PATA 100" } ,

7182 { 0x10B9, 0x5229&
	gREV_C5
, "chipset", "PATA 133" } ,

7298 { 0x10DE, 0x0028 
	gNV05
, "0DF4 ", "MCP67 " } ,

7409 { 0x10DE, 0x0112
	gh
, "???", "Nvidia GeForce2 Go/MX Ultra Video Adapter" } ,

7830 { 0x10DE, 0x06e
	go
, "G98", "NIVIDIA GEFORCE 9300GE" } ,

7841 { 0x10DE, 0x07D8 
	gnVIDIA
, "nForce 7100-630i ", "MCP73PV" } ,

7955 { 0x10DE, 0x10DEb
	gis
, "GFORCE 410", "GFORCE 410" } ,

7964 { 0x10DE, 0x11c
	go
, "0x354e145", "0xa1" } ,

7973 { 0x10DE, 0x135
	gm
, "220gt", "navidia quadro‚vs135m" } ,

7979 { 0x10DE, 0x247
	gPCI
, "know", "Geforce 6100 Go" } ,

7988 { 0x10DE, 0x9876 03F0&
	gSUBSYS_8
, "N/A", "PCI(Has compatible Ids)" } ,

7994 { 0x10DE, 0x
	gODE9
, "GT 630M", "Geforce GT 630M" } ,

7995 { 0x10DE, 0x
	g_026C
, "nVidia Geforce 6150 GPU ( Built-Into Controller )", "Nvidia Motherboard‚Force 430 ( MCP-51 ) with On-Board GeForce 6150 GPU" } ,

8257 { 0x1106, 0x10
	gjn
, "1106", "3108" } ,

8301 { 0x1106, 0x3068&
	gCC_0000
, "VT82C686A/B&VT8231", "APM(or ACPI?)" } ,

8302 { 0x1106, 0x3068&
	gCC_0780
, "VT82C686A/B&VT8231", "MC97 MODEM" } ,

8610 { 0x14E4, 0x1691
	g_
, "BCM57788A", "Broadcom NetLink (TM) Gigabit Ethernet" } ,

8780 { 0x14E4, 0xde
	gv_4311
, "1364103c", "subsys" } ,

8935 { 0x1131, 0x1131 
Phs
 
	gSemic
, "1131", "VerTV Hybrid Super 007 M135RA" } ,

9396 { 0x11BD, 0x11
	gPE
, "49", "Tunner Royal TS 2" } ,

9458 { 0x11C1, 
	gfsu
 00, "", "" } ,

9472 { 0x11D1, 
	gVXP520
, "tag4769", "Video card" } ,

9474 { 0x11D4, 0x11d4
	gnÿh6n
, "266e&subsys", "01791028" } ,

9499 
	#PCI_DEVTABLE_LEN
 ((
PciDevTabË
)/(
PCI_DEVTABLE
))

	)

9501 
	s_PCI_CLASSCODETABLE


9503 
	mBa£CÏss
 ;

9504 
	mSubCÏss
 ;

9505 
	mProgIf
 ;

9506 * 
	mBa£Desc
 ;

9507 * 
	mSubDesc
 ;

9508 * 
	mProgDesc
 ;

9509 } 
	tPCI_CLASSCODETABLE
, *
	tPPCI_CLASSCODETABLE
 ;

9511 
PCI_CLASSCODETABLE
 
	gPciCÏssCodeTabË
 [] =

9601 
	#PCI_CLASSCODETABLE_LEN
 ((
PciCÏssCodeTabË
)/(
PCI_CLASSCODETABLE
))

	)

9603 * 
	gPciCommªdFÏgs
 [] =

9624 
	#PCI_COMMANDFLAGS_LEN
 ((
PciCommªdFÏgs
)/(*))

	)

9627 * 
	gPciStusFÏgs
 [] =

9648 
	#PCI_STATUSFLAGS_LEN
 ((
PciStusFÏgs
)/(*))

	)

9651 * 
	gPciDevS–FÏgs
 [] =

9660 
	#PCI_DEVSELFLAGS_LEN
 ((
PciDevS–FÏgs
)/(*))

	)

	@include/linux/pipe.h

1 #iâdeà
PIPE_H


2 
	#PIPE_H


	)

	@include/linux/printf.h

1 #iâdeà
PRINTF_H


2 
	#PRINTF_H


	)

3 
	~<v®Ty³.h
>

5 
__¥rštf
(*
buf
, *
fÜm©
, 
u32
 *
¬gs
);

6 
¥rštf
(*
buf
, *
fÜm©
, ...);

7 
´štf
(*
fÜm©
, ...);

8 
wr™e_b¬
(
x
, 
y
, *
t™Ë
, *
cÚ‹Á
);

	@include/linux/resource.h

1 #iâdeà
LINUX_RESOURCE_H


2 
	#LINUX_RESOURCE_H


	)

4 
	sru§ge
{

5 
	mkºl_time
;

6 
	mu£r_time
;

	@include/linux/sched.h

1 #iâdeà
LINUX_SCHED_H


2 
	#LINUX_SCHED_H


	)

3 
	g±_»gs
;

4 
	~<v®Ty³.h
>

5 
	~<asm/·ge.h
>

7 
	#TASK_RUNNING
 0

	)

8 
	#TASK_INTERRUPTIBLE
 1

	)

9 
	#TASK_UNINTERRUPTIBLE
 2

	)

10 
	#TASK_STOPPED
 4

	)

11 
	#TASK_TRACED
 8

	)

12 
	#TASK_ZOMBIE
 16

	)

17 
	#CSIGNAL
 0xfà

	)

18 
	#CLONE_VM
 0x100

	)

19 
	#CLONE_FS
 0x200

	)

20 
	#CLONE_FD
 0x400

	)

23 
	smm
{

24 
ü3
 
	mü3
;

25 
vm_¬—
 *
	mvma
;

27 
	m¡¬t_code
, 
	m’d_code
;

28 
	m¡¬t_d©a
, 
	m’d_d©a
;

29 
	m¡¬t_brk
, 
	mbrk
;

31 
	mu£rs
;

34 
k”Ãl_th»ad
((*
â
)(*), *
¬g
, 
æags
);

37 
	`do_execve
(*
f•©h
, *
¬gv
[], *
’vp
[], 
±_»gs
 *
»gs
);

38 
	`scheduË_timeout
(
m£c
);

39 
	`do_tim”
(
±_»gs
 *
´egs
);

41 
	`do_fÜk
(
şÚe_æags
, 
¡ack_¡¬t
,

42 
±_»gs
 *
»gs
, 
¡ack_size
);

	@include/linux/skbuff.h

1 #iâdeà
SKBUFF_H


2 
	#SKBUFF_H


	)

3 
	~<lšux/¦ab.h
>

4 
	~<v®Ty³.h
>

5 
	~<li¡.h
>

6 
	#PROTOCOL_ARP
 0x0806

	)

7 
	#PROTOCOL_IP
 0x0800

	)

9 
	sp£udo_hdr
{

10 
u32
 
	mmy
;

11 
u32
 
	myour
;

12 
u8
 
	mz”o
;

13 
u8
 
	m´ÙocŞ
;

14 
u16
 
	m·ylßd_Ën
;

17 
	g‘hhdr
;

18 
	g¬phdr
;

19 
	ghdr
;

20 
	gicmphdr
;

21 
	gudphdr
;

22 
	gtıhdr
;

23 
	gÃt_deviû
;

29 
	ssk_buff
{

30 
	mpkgsize
;

32 
	mgÙsize
;

33 
	mbufsize
;

36 *
	md©a
;

38 
sk_buff
 *
	mÃxt
, *
	m´ev
;

39 
Ãt_deviû
 *
	mdev
;

41 
‘hhdr
 *
	m‘hhdr
;

43 
hdr
 *
	mhdr
;

44 
¬phdr
 *
	m¬phdr
;

45 *
	m£cÚd_hdr
;

48 
icmphdr
 *
	micmphdr
;

49 
udphdr
 *
	mudphdr
;

50 
tıhdr
 *
	mtıhdr
;

51 *
	mthœd_hdr
;

53 
li¡_h—d
 
	mnode
;

55 
p£udo_hdr
 *
	mp£udo_hdr
;

58 
sk_buff
 *
	mäag_begš
, *
	mäag_’d
;

59 }
	mdebug
;

63 
dev_ä“_skb
Ğ
sk_buff
 *
skb
);

64 
sk_buff
 * 
dev_®loc_skb
Ğ
Ën
 );

65 
sk_buff
 *
dev_®loc_skb2
(
u32
 
msgty³
, 
size_t
 
Ën
);

66 
Ãt_š™
();

67 
skbuff_š™
();

	@include/linux/slab.h

1 #iâdeà
SLAB_H


2 
	#SLAB_H


	)

4 
	g¦ab_h—d
;

5 
	#SLAB_HWCACHE_ALIGN
 1

	)

6 
	#SLAB_CACHE_DMA
 2

	)

7 
	#SLAB_ZERO
 4

	)

9 
	#L1_CACHLINE_SIZE
 32

	)

10 
	#BYTES_PER_WORD
 4

	)

13 
¦ab_h—d
 * 
»gi¡”_¦ab_ty³
(*
Çme
, 
objsize
,

14 
off£t
, 
æags
,

15 (*
ùÜ
)(*, 
¦ab_h—d
 *, ),

16 (*
dtÜ
)(*, 
¦ab_h—d
 *, )

18 
	#kmem_ÿche_ü—‹
 
»gi¡”_¦ab_ty³


	)

19 *
	`km®loc2
(
size
, 
æags
);

20 
	`kä“2
(*
obj
);

21 * 
	`kmem_ÿche_®loc
(
¦ab_h—d
 *
¦abh—d
, 
æags
);

22 
	`kmem_ÿche_ä“
(
¦ab_h—d
 *
¦abh—d
, *
obj
);

23 
	`kmem_ÿche_š™
();

24 
	`kmem_ÿche_‹¡
();

26 *
	`¡©ic_®loc
(
objsize
, 
objnum
);

28 
	#¡©ic_cursÜ_up


	)

	@include/linux/string.h

1 #iâdeà
LINUX_STRING_H


2 
	#LINUX_STRING_H


	)

5 
	~<v®Ty³.h
>

7 
¡¾’
(*
¡r
);

8 
¡ºËn
(*
¡r
, 
ulÚg
 
n
);

9 *
¡rıy
(*
de¡
,*
¤c
);

10 *
¡ºıy
(*
de¡
, cÚ¡ *
¤c
, 
n
);

11 
¡rcmp
(cÚ¡ *
¡r1
, cÚ¡ *
¡r2
);

12 
¡ºcmp
(cÚ¡ *
¡r1
, cÚ¡ *
¡r2
, 
n
);

13 
boŞ
 
¡rm©ch
(*
£g
,*
whŞe
);

	@include/linux/timer.h

1 #iâdeà
LINUX_TIMER_H


2 
	#LINUX_TIMER_H


	)

3 
	~<v®Ty³.h
>

4 
	~<li¡.h
>

6 
	mTIMER_STOPPED
,

7 
	mTIMER_RUNNING


9 
	stim”
{

10 
u32
 
	mÜigš
;

11 
u32
 
	mliã
;

12 (*
	maù
)(*
	md©a
);

13 * 
	md©a
;

14 
	m¡©e
;

15 
li¡_h—d
 
	mnode
;

18 
my_tim”li¡_dida
();

19 
š™_mytim”
();

20 
tim”
 *
ü—‹_mytim”
(
u32
 
liã
, (*
aù
)(* 
d©a
), *data);

21 
	`Œigg”_mytim”
(
tim”
 *timer);

22 
	`¡¬t_mytim”
(
tim”
 *timer);

	@include/linux/udp.h

1 #iâdeà
LINUX_UDP_H


2 
	#LINUX_UDP_H


	)

3 
	~<Ãt/udp.h
>

	@include/linux/wait.h

1 #iâdeà
LINUX_WAIT_H


2 
	#LINUX_WAIT_H


	)

4 
	#WNOHANG
 1

	)

5 
	#WUNTRACED
 2

	)

	@include/net/arp.h

1 #iâdeà
ARP_H


2 
	#ARP_H


	)

3 
	~<v®Ty³.h
>

4 
	~<lšux/if_‘h”.h
>

5 
	~<lšux/skbuff.h
>

7 #´agm¨
·ck
(
push
)

8 #´agm¨
·ck
(1)

10 
	s¬phdr
{

11 
u16
 
	mh¬dw¬e
;

12 
u16
 
	m´ÙocŞ
;

13 
u8
 
	mhaddr_Ën
;

14 
u8
 
	m·ddr_Ën
;

15 
u16
 
	mİ”©iÚ
;

16 
u8
 
	mmymac
[6];

17 
u32
 
	mmy
;

18 
u8
 
	myourmac
[6];

19 
u32
 
	myour
;

22 
	s¬p_·ck‘
{

23 
‘hhdr
 
	m‘hhdr
;

24 
¬phdr
 
	m¬phdr
;

27 #´agm¨
·ck
(
pİ
)

29 
	#ARP_PACK_SIZE
 ((
¬p_·ck‘
))

	)

31 
mk_¬p_·ck‘
(
¬p_·ck‘
 *
·ck‘
, 
u8
 *
mymac
, 
my
, u8 *
yourmac
, 
u32
 
your
);

32 
¬p_š™
();

33 
¬p_Ïy”_»ûive
(
sk_buff
 *
skb
);

34 
¬p_down
(
sk_buff
 *
skb
);

35 
¬p_šquœe
(
u32
 
your
);

	@include/net/icmp.h

1 #iâdeà
ICMP_H


2 
	#ICMP_H


	)

3 
	~<lšux/if_‘h”.h
>

4 
	~<lšux/udp.h
>

5 
	~<lšux/.h
>

7 
	#ICMP_ECHOREPLY
 0

	)

8 
	#ICMP_DEST_UNREACH
 3

	)

9 
	#ICMP_SOURCE_QUENCH
 4

	)

10 
	#ICMP_REDIRECT
 5

	)

11 
	#ICMP_ECHO
 8

	)

12 
	#ICMP_TIME_EXCEEDED
 11

	)

13 
	#ICMP_PARAMETERPROB
 12

	)

14 
	#ICMP_TIMESTAMP
 13

	)

15 
	#ICMP_TIMESTAMPREPLY
 14

	)

16 
	#ICMP_INFO_REQUEST
 15

	)

17 
	#ICMP_INFO_REPLY
 16

	)

18 
	#ICMP_ADDRESS
 17

	)

19 
	#ICMP_ADDRESSREPLY
 18

	)

20 
	#NR_ICMP_TYPES
 18

	)

24 
	#ICMP_NET_UNREACH
 0

	)

25 
	#ICMP_HOST_UNREACH
 1

	)

26 
	#ICMP_PROT_UNREACH
 2

	)

27 
	#ICMP_PORT_UNREACH
 3

	)

28 
	#ICMP_FRAG_NEEDED
 4

	)

29 
	#ICMP_SR_FAILED
 5

	)

30 
	#ICMP_NET_UNKNOWN
 6

	)

31 
	#ICMP_HOST_UNKNOWN
 7

	)

32 
	#ICMP_HOST_ISOLATED
 8

	)

33 
	#ICMP_NET_ANO
 9

	)

34 
	#ICMP_HOST_ANO
 10

	)

35 
	#ICMP_NET_UNR_TOS
 11

	)

36 
	#ICMP_HOST_UNR_TOS
 12

	)

37 
	#ICMP_PKT_FILTERED
 13

	)

38 
	#ICMP_PREC_VIOLATION
 14

	)

39 
	#ICMP_PREC_CUTOFF
 15

	)

40 
	#NR_ICMP_UNREACH
 15

	)

43 
	#ICMP_REDIR_NET
 0

	)

44 
	#ICMP_REDIR_HOST
 1

	)

45 
	#ICMP_REDIR_NETTOS
 2

	)

46 
	#ICMP_REDIR_HOSTTOS
 3

	)

49 
	#ICMP_EXC_TTL
 0

	)

50 
	#ICMP_EXC_FRAGTIME
 1

	)

52 #´agm¨
·ck
(
push
)

53 #´agm¨
·ck
(1)

55 
	sicmphdr
{

56 
u8
 
	mty³
;

57 
u8
 
	msubty³
;

58 
u16
 
	mchecksum
;

60 
u32
 
	mignÜe
;

62 
u16
 
	mid
;

63 
u16
 
	m£qu’û
;

67 
u32
 
	mdwÜd
[0];

68 }
	md©a
;

71 
	sicmpmsg_un
{

72 
icmphdr
 
	mh—d”
;

73 
hdr
 
	ml_hdr
;

75 
udphdr
 
	ml_udphdr
;

76 
	ml_d©a
[8];

80 
	sicmpmsg_mask
{

81 
icmphdr
 
	mh—d”
;

82 
	maddr_mask
;

85 
	sicmpmsg_t¡amp
{

86 
icmphdr
 
	mh—d”
;

87 
	mt_Üig
;

88 
	mt_»cv
;

89 
	mt_»tuº
;

91 #´agm¨
·ck
(
pİ
)

111 
icmp_»ûive
(
sk_buff
 *
com”
);

	@include/net/ip.h

1 #iâdeà
IP_H


2 
	#IP_H


	)

3 
	~<v®Ty³.h
>

4 
	#PROTOCOL_ICMP
 1

	)

5 
	#PROTOCOL_IGMP
 2

	)

6 
	#PROTOCOL_TCP
 6

	)

7 
	#PROTOCOL_UDP
 17

	)

8 #´agm¨
·ck
(
push
)

9 #´agm¨
·ck
(1)

30 
	shdr
{

31 
u32
 
	mËn
: 4;

32 
	mv”siÚ
: 4;

33 
u8
 
	mignÜe
;

34 
u16
 
	mtÙ_Ën
;

35 
u16
 
	mmsgid
;

38 
u16
 
	mme_off£t
: 13;

39 
	mæag_mf
: 1;

40 
	mæag_df
: 1;

41 
	mæag_»£rved
: 1;

43 
u16
 
	mæag_off
;

45 
u8
 
	m‰l
;

46 
u8
 
	m´ÙocŞ
;

47 
u16
 
	mchksum
;

48 
u32
 
	mmy
;

49 
u32
 
	myour
;

52 #´agm¨
·ck
(
pİ
)

54 
	#IPHDR_LEN
 ( Ğ
hdr
 ) )

	)

55 
	#IP_PAYLOAD_LEN
(
hdr
è(hdr->
tÙ_Ën
 - (hdr->
Ën
 * 4è)

	)

56 
šlše
 
	$hash
(

){

57 
u8
 *
by‹
 = (u8 *)&

;

58  (
by‹
[0] + byte[1] + byte[2] + byte[3]);

59 
	}
}

61 
	gsk_buff
;

62 
_echo_down
(
sk_buff
 *
skb
, 
u8
 
me_´ÙocŞ
, u8 
‰l
);

63 
_down
(
sk_buff
 *
skb
, 
u8
 
me_´ÙocŞ
,

64 
u32
 
de¡_
, u32 
¤c_
,

65 
u8
 
‰l
);

66 
_Ïy”_š™
();

67 
_Ïy”_»ûive
(
sk_buff
 *
skb
);

	@include/net/tcp.h

1 #iâdeà
NET_TCP_H


2 
	#NET_TCP_H


	)

3 
	~<v®Ty³.h
>

4 
	~<lšux/.h
>

6 
	#TCP_FLAG_FIN
 (1)

	)

7 
	#TCP_FLAG_SYN
 (1<<1)

	)

8 
	#TCP_FLAG_RST
 (1<<2)

	)

9 
	#TCP_FALG_PSH
 (1<<3)

	)

10 
	#TCP_FLAG_ACK
 (1<<4)

	)

11 
	#TCP_FALG_URG
 (1<<5)

	)

12 
	#TCP_FALG_ECE
 (1<<6)

	)

13 
	#TCP_FALG_CWR
 (1<<7)

	)

15 #´agm¨
·ck
(
push
)

16 #´agm¨
·ck
(1)

18 
	stı_İt
{

19 
u8
 
	mkšd
;

20 
u8
 
	mËn
;

22 
u8
 
	mby‹
[0];

23 
u16
 
	mwÜd
[0];

24 
u32
 
	mdwÜd
[0];

25 }
	md©a
;

49 
	stıhdr
{

50 
u16
 
	mmypÜt
;

51 
u16
 
	myou½Üt
;

52 
u32
 
	m£q
;

53 
u32
 
	mack
;

54 
	m»sv
: 4;

55 
	mËn
: 4;

58 
	mæag_fš
: 1;

59 
	mæag_syn
: 1;

60 
	mæag_r¡
: 1;

61 
	mæag_psh
: 1;

62 
	mæag_ack
: 1;

63 
	mæag_urg
: 1;

64 
	mæag_eû
: 1;

65 
	mæag_cwr
: 1;

67 
u8
 
	mæags
;

69 
u16
 
	mwndsize
;

70 
u16
 
	mchksum
;

71 
u16
 
	murg±r
;

72 
tı_İt
 
	mİt_¬—
[0];

75 #´agm¨
·ck
(
pİ
)

77 
	#TCPHDR_LEN
 ((
tıhdr
))

	)

78 
šlše
 
u32
 
	$tıhash
(
u32
 
his
, 
u16
 
hi¥Üt
, u32 
mypÜt
){

79 
u32
 
hash
 = 
	`hash
(
his
è+ (
hi¥Üt
 & 0xff) + (hisport >> 8)

80 + (
mypÜt
 & 0xff) + (myport >> 8);

81  
hash
;

82 
	}
}

83 
š™_tı
();

84 
tı_Ïy”_»cv
(
sk_buff
 *
com”
);

	@include/net/udp.h

1 #iâdeà
UDP_H


2 
	#UDP_H


	)

3 
	~<lšux/skbuff.h
>

4 
	~<v®Ty³.h
>

6 #´agm¨
·ck
(
push
)

7 #´agm¨
·ck
(1)

9 
	sudphdr
{

10 
u16
 
	mmypÜt
;

11 
u16
 
	myou½Üt
;

12 
u16
 
	mtÙ_Ën
;

13 
u16
 
	mchksum
;

14 
	md©a
[0];

17 #´agm¨
·ck
(
pİ
)

20 
udp_Ïy”_»ûive
(
sk_buff
 *
com”
);

	@include/old/asm_lable.h

1 #iâdeà
ASM_LABLE_H


2 
	#ASM_LABLE_H


	)

3 
»¡Üe_®l
();

4 
»t_äom_šŒ
();

5 
»t_äom_sys_ÿÎ
();

6 
»t_w™h_»scheduË
();

7 
»scheduË
();

8 
·ge_çuÉ
();

10 
RAMDISK_BASE
();

	@include/old/atomic.h

1 
	~<v®Ty³.h
>

3 
	#ATOMIC_INIT
(
i
è{i}

	)

5 
šlše
 
	$©omic_»ad
(
©omic_t
 *
v
){

6  
v
->
couÁ”
;

7 
	}
}

9 
šlše
 
	$©omic_£t
(
i
, 
©omic_t
 *
v
){

10 
v
->
couÁ”
 = 
i
;

11 
	}
}

13 
šlše
 
	$©omic_add
(
i
, 
©omic_t
 *
v
){

14 
asm
 volatile(

16 :"m"(
v
->
couÁ”
)

17 :"r"(
i
)

20 
	}
}

	@include/old/blk.h

1 #iâdeà
BLK_H


2 
	#BLK_H


	)

7 
	s»que¡
{

8 
	mdev
;

9 
	mcmd
;

10 
	mlba
;

11 
	mcouÁ
;

12 *
	mbufãr
;

	@include/old/bootinfo.h

1 #iâdeà
BOOT_INFO_H


2 
	#BOOT_INFO_H


	)

5 #iâdeà
ENV_NOT_KERNEL


6 
	~<mm.h
>

10 
	s»®mod_šfo_¡ruù
{

11 
	mmem_£gnum
;

13 
mem_£gšfo
 
	mmem_£gšfo
[10];

14 
	m·ddšg
[256];

18 
»®mod_šfo_¡ruù
 
»®mod_šfo
;

19 
	#»®mod_šfo
 ((
»®mod_šfo_¡ruù
*)
	`KV
(&
»®mod_šfo
))

	)

22 
	#KV
(
physiÿl_addr
è((
u32
)Õhysiÿl_addr)+
KROOM_ADDR
)

	)

25 
_k”Ãl_image_¡¬t_£ùÜ
;

26 
	#k”Ãl_image_¡¬t_£ùÜ
 (()&
_k”Ãl_image_¡¬t_£ùÜ
)

	)

27 
_fiximg_¡¬t_£ùÜ
;

28 
	#fiximg_¡¬t_£ùÜ
 (()&
_fiximg_¡¬t_£ùÜ
)

	)

30 
_mem£g_num
;

31 
	#g_mem£g_num
 (*(*)
	`KV
(&
_mem£g_num
))

	)

33 
_ba£_memšfo
;

34 
	#g_mem£g_šfo
 ( (
mem£g_šfo
 *)
	`KV
(&
_ba£_memšfo
è)

	)

	@include/old/disp.h

1 #iâdeà
DISP_H


2 
	#DISP_H


	)

5 
k_sü“n_»£t
();

6 
k_show_ch¬s
(*
±_h—d
,
’d_æag
);

7 
İrštf
(*
fÜm©
,...);

8 
k_süŞl
();

9 
k_checkbound
();

12 
k_show_v¬
(
x
,
v®_ty³
);

13 
show_asciis_bufãr
();

14 
wr™e_asciis_bufãr
(
x
,
v®_ty³
);

15 
š™_asciis_bufãr
();

	@include/old/elf.h

1 #iâdeà
ELF_H


2 
	#ELF_H


	)

3 
	~<Şd/v®Ty³.h
>

5 #´agm¨
·ck
(
push
)

6 #´agm¨
·ck
(1)

10 
	#ET_NONE
 0

	)

11 
	#ET_REL
 1

	)

12 
	#ET_EXEC
 2

	)

13 
	#ET_DYN
 3

	)

14 
	#ET_CORE
 4

	)

15 
	#ET_NUM
 5

	)

16 
	#ET_LOOS
 0xã00

	)

17 
	#ET_HIOS
 0xãfà

	)

18 
	#ET_LOPROC
 0xff00

	)

19 
	#ET_HIPROC
 0xfffà

	)

23 
	#SHT_NULL
 0

	)

24 
	#SHT_PROGBITS
 1

	)

25 
	#SHT_SYMTAB
 2

	)

26 
	#SHT_STRTAB
 3

	)

27 
	#SHT_RELA
 4

	)

28 
	#SHT_HASH
 5

	)

29 
	#SHT_DYNAMIC
 6

	)

30 
	#SHT_NOTE
 7

	)

31 
	#SHT_NOBITS
 8

	)

32 
	#SHT_REL
 9

	)

33 
	#SHT_SHLIB
 10

	)

34 
	#SHT_DYNSYM
 11

	)

35 
	#SHT_INIT_ARRAY
 14

	)

36 
	#SHT_FINI_ARRAY
 15

	)

37 
	#SHT_PREINIT_ARRAY
 16

	)

38 
	#SHT_GROUP
 17

	)

39 
	#SHT_SYMTAB_SHNDX
 18

	)

40 
	#SHT_NUM
 19

	)

41 
	#SHT_LOOS
 0x60000000

	)

42 
	#SHT_GNU_ATTRIBUTES
 0x6ffffff5

	)

43 
	#SHT_GNU_HASH
 0x6ffffff6

	)

44 
	#SHT_GNU_LIBLIST
 0x6ffffff7

	)

45 
	#SHT_CHECKSUM
 0x6ffffff8

	)

46 
	#SHT_LOSUNW
 0x6fffffç

	)

47 
	#SHT_SUNW_move
 0x6fffffç

	)

48 
	#SHT_SUNW_COMDAT
 0x6ffffffb

	)

49 
	#SHT_SUNW_symšfo
 0x6ffffffc

	)

50 
	#SHT_GNU_v”def
 0x6ffffffd

	)

51 
	#SHT_GNU_v”Ãed
 0x6fffffã

	)

52 
	#SHT_GNU_v”sym
 0x6ffffffà

	)

53 
	#SHT_HISUNW
 0x6ffffffà

	)

54 
	#SHT_HIOS
 0x6ffffffà

	)

55 
	#SHT_LOPROC
 0x70000000

	)

56 
	#SHT_HIPROC
 0x7ffffffà

	)

57 
	#SHT_LOUSER
 0x80000000

	)

58 
	#SHT_HIUSER
 0x8ffffffà

	)

62 
	#AT_NULL
 0

	)

63 
	#AT_IGNORE
 1

	)

64 
	#AT_EXECFD
 2

	)

65 
	#AT_PHDR
 3

	)

66 
	#AT_PHENT
 4

	)

67 
	#AT_PHNUM
 5

	)

68 
	#AT_PAGESZ
 6

	)

69 
	#AT_BASE
 7

	)

70 
	#AT_FLAGS
 8

	)

71 
	#AT_ENTRY
 9

	)

72 
	#AT_NOTELF
 10

	)

73 
	#AT_UID
 11

	)

74 
	#AT_EUID
 12

	)

75 
	#AT_GID
 13

	)

76 
	#AT_EGID
 14

	)

77 
	#AT_CLKTCK
 17

	)

80 
	#AT_PLATFORM
 15

	)

81 
	#AT_HWCAP
 16

	)

86 
	#AT_FPUCW
 18

	)

89 
	#AT_DCACHEBSIZE
 19

	)

90 
	#AT_ICACHEBSIZE
 20

	)

91 
	#AT_UCACHEBSIZE
 21

	)

95 
	#AT_IGNOREPPC
 22

	)

97 
	#AT_SECURE
 23

	)

99 
	#AT_BASE_PLATFORM
 24

	)

101 
	#AT_RANDOM
 25

	)

103 
	#AT_EXECFN
 31

	)

107 
	#AT_SYSINFO
 32

	)

108 
	#AT_SYSINFO_EHDR
 33

	)

112 
	#AT_L1I_CACHESHAPE
 34

	)

113 
	#AT_L1D_CACHESHAPE
 35

	)

114 
	#AT_L2_CACHESHAPE
 36

	)

115 
	#AT_L3_CACHESHAPE
 37

	)

117 
u8
 
	me_id’t
[16];

118 
Elf32_H®f
 
	me_ty³
;

119 
Elf32_H®f
 
	me_machše
;

120 
Elf32_WÜd
 
	me_v”siÚ
;

121 
Elf32_Addr
 
	me_’Œy
;

122 
Elf32_Off
 
	me_phoff
;

123 
Elf32_Off
 
	me_shoff
;

124 
Elf32_WÜd
 
	me_æags
;

125 
Elf32_H®f
 
	me_ehsize
;

126 
Elf32_H®f
 
	me_ph’tsize
;

127 
Elf32_H®f
 
	me_phnum
;

128 
Elf32_H®f
 
	me_sh’tsize
;

129 
Elf32_H®f
 
	me_shnum
;

130 
Elf32_H®f
 
	me_sh¡ºdx
;

131 } 
	tElf32_Ehdr
;

135 
Elf32_WÜd
 
	mp_ty³
;

136 
Elf32_Off
 
	mp_off£t
;

137 
Elf32_Addr
 
	mp_vaddr
;

138 
Elf32_Addr
 
	mp_·ddr
;

139 
Elf32_WÜd
 
	mp_fesz
;

140 
Elf32_WÜd
 
	mp_memsz
;

141 
Elf32_WÜd
 
	mp_æags
;

142 
Elf32_WÜd
 
	mp_®ign
;

143 } 
	tElf32_Phdr
;

147 
	#PF_R
 0x4

	)

148 
	#PF_W
 0x2

	)

149 
	#PF_X
 0x1

	)

152 
	#PT_NULL
 0

	)

153 
	#PT_LOAD
 1

	)

154 
	#PT_DYNAMIC
 2

	)

155 
	#PT_INTERP
 3

	)

156 
	#PT_NOTE
 4

	)

157 
	#PT_SHLIB
 5

	)

158 
	#PT_PHDR
 6

	)

159 
	#PT_TLS
 7

	)

160 
	#PT_LOOS
 0x60000000

	)

161 
	#PT_HIOS
 0x6ffffffà

	)

162 
	#PT_LOPROC
 0x70000000

	)

163 
	#PT_HIPROC
 0x7fffffff

	)

164 
	#PT_GNU_EH_FRAME
 0x6474e550

	)

166 
	#PT_GNU_STACK
 (
PT_LOOS
 + 0x474e551)

	)

169 
	#PH_SIZE
 ((
Elf32_Phdr
))

	)

173 
u32
 
	ma_ty³
;

174 
u32
 
	ma_v®
;

175 } 
	tElf32_auxv_t
;

181 
Elf32_WÜd
 
	msh_Çme
;

182 
Elf32_WÜd
 
	msh_ty³
;

183 
Elf32_WÜd
 
	msh_æags
;

184 
Elf32_Addr
 
	msh_addr
;

185 
Elf32_Off
 
	msh_off£t
;

186 
Elf32_WÜd
 
	msh_size
;

187 
Elf32_WÜd
 
	msh_lšk
;

188 
Elf32_WÜd
 
	msh_šfo
;

189 
Elf32_WÜd
 
	msh_add¿lign
;

190 
Elf32_WÜd
 
	msh_’tsize
;

191 } 
	tElf32_Shdr
;

197 
Elf32_WÜd
 
	m¡_Çme
;

198 
Elf32_Addr
 
	m¡_v®ue
;

199 
Elf32_WÜd
 
	m¡_size
;

203 
	m¡_ty³
:4;

204 
	m¡_bšd
:4;

206 
	m¡_šfo
;

208 
	m¡_Ùh”
;

209 
Elf32_H®f
 
	m¡_shndx
;

210 } 
	tElf32_Sym
;

213 
	#SHN_UNDEF
 0

	)

214 
	#SHN_LORESERVE
 0xff00

	)

215 
	#SHN_LOPROC
 0xff00

	)

216 
	#SHN_BEFORE
 0xff00

	)

218 
	#SHN_AFTER
 0xff01

	)

220 
	#SHN_HIPROC
 0xff1à

	)

221 
	#SHN_LOOS
 0xff20

	)

222 
	#SHN_HIOS
 0xff3à

	)

223 
	#SHN_ABS
 0xfff1

	)

224 
	#SHN_COMMON
 0xfff2

	)

225 
	#SHN_XINDEX
 0xfffà

	)

226 
	#SHN_HIRESERVE
 0xfffà

	)

230 
	#STB_LOCAL
 0

	)

231 
	#STB_GLOBAL
 1

	)

232 
	#STB_WEAK
 2

	)

233 
	#STB_NUM
 3

	)

234 
	#STB_LOOS
 10

	)

235 
	#STB_GNU_UNIQUE
 10

	)

236 
	#STB_HIOS
 12

	)

237 
	#STB_LOPROC
 13

	)

238 
	#STB_HIPROC
 15

	)

242 
	#STT_NOTYPE
 0

	)

243 
	#STT_OBJECT
 1

	)

244 
	#STT_FUNC
 2

	)

245 
	#STT_SECTION
 3

	)

246 
	#STT_FILE
 4

	)

247 
	#STT_COMMON
 5

	)

248 
	#STT_TLS
 6

	)

249 
	#STT_NUM
 7

	)

250 
	#STT_LOOS
 10

	)

251 
	#STT_GNU_IFUNC
 10

	)

252 
	#STT_HIOS
 12

	)

253 
	#STT_LOPROC
 13

	)

254 
	#STT_HIPROC
 15

	)

261 
Elf32_Addr
 
	mr_off£t
;

264 
	mr_ty³
:8;

265 
	mr_symndx
:24;

267 
Elf32_WÜd
 
	mr_šfo
;

269 } 
	tElf32_R–
;

272 
	#R_386_NONE
 0

	)

273 
	#R_386_32
 1

	)

274 
	#R_386_PC32
 2

	)

275 
	#R_386_GOT32
 3

	)

276 
	#R_386_PLT32
 4

	)

277 
	#R_386_COPY
 5

	)

278 
	#R_386_GLOB_DAT
 6

	)

279 
	#R_386_JMP_SLOT
 7

	)

280 
	#R_386_RELATIVE
 8

	)

281 
	#R_386_GOTOFF
 9

	)

282 
	#R_386_GOTPC
 10

	)

283 
	#R_386_32PLT
 11

	)

284 
	#R_386_TLS_TPOFF
 14

	)

285 
	#R_386_TLS_IE
 15

	)

287 
	#R_386_TLS_GOTIE
 16

	)

289 
	#R_386_TLS_LE
 17

	)

291 
	#R_386_TLS_GD
 18

	)

293 
	#R_386_TLS_LDM
 19

	)

296 
	#R_386_16
 20

	)

297 
	#R_386_PC16
 21

	)

298 
	#R_386_8
 22

	)

299 
	#R_386_PC8
 23

	)

300 
	#R_386_TLS_GD_32
 24

	)

302 
	#R_386_TLS_GD_PUSH
 25

	)

303 
	#R_386_TLS_GD_CALL
 26

	)

305 
	#R_386_TLS_GD_POP
 27

	)

306 
	#R_386_TLS_LDM_32
 28

	)

308 
	#R_386_TLS_LDM_PUSH
 29

	)

309 
	#R_386_TLS_LDM_CALL
 30

	)

311 
	#R_386_TLS_LDM_POP
 31

	)

312 
	#R_386_TLS_LDO_32
 32

	)

313 
	#R_386_TLS_IE_32
 33

	)

315 
	#R_386_TLS_LE_32
 34

	)

317 
	#R_386_TLS_DTPMOD32
 35

	)

318 
	#R_386_TLS_DTPOFF32
 36

	)

319 
	#R_386_TLS_TPOFF32
 37

	)

321 
	#R_386_TLS_GOTDESC
 39

	)

322 
	#R_386_TLS_DESC_CALL
 40

	)

325 
	#R_386_TLS_DESC
 41

	)

329 
	#R_386_IRELATIVE
 42

	)

331 
	#R_386_NUM
 43

	)

338 
	md_g
;

341 
Elf32_WÜd
 
	md_v®
;

342 
Elf32_Addr
 
	md_±r
;

344 } 
	tElf32_Dyn
;

348 
	#DT_NULL
 0

	)

349 
	#DT_NEEDED
 1

	)

350 
	#DT_PLTRELSZ
 2

	)

351 
	#DT_PLTGOT
 3

	)

352 
	#DT_HASH
 4

	)

353 
	#DT_STRTAB
 5

	)

354 
	#DT_SYMTAB
 6

	)

355 
	#DT_RELA
 7

	)

356 
	#DT_RELASZ
 8

	)

357 
	#DT_RELAENT
 9

	)

358 
	#DT_STRSZ
 10

	)

359 
	#DT_SYMENT
 11

	)

360 
	#DT_INIT
 12

	)

361 
	#DT_FINI
 13

	)

362 
	#DT_SONAME
 14

	)

363 
	#DT_RPATH
 15

	)

364 
	#DT_SYMBOLIC
 16

	)

365 
	#DT_REL
 17

	)

366 
	#DT_RELSZ
 18

	)

367 
	#DT_RELENT
 19

	)

368 
	#DT_PLTREL
 20

	)

369 
	#DT_DEBUG
 21

	)

370 
	#DT_TEXTREL
 22

	)

371 
	#DT_JMPREL
 23

	)

372 
	#DT_BIND_NOW
 24

	)

373 
	#DT_INIT_ARRAY
 25

	)

374 
	#DT_FINI_ARRAY
 26

	)

375 
	#DT_INIT_ARRAYSZ
 27

	)

376 
	#DT_FINI_ARRAYSZ
 28

	)

377 
	#DT_RUNPATH
 29

	)

378 
	#DT_FLAGS
 30

	)

379 
	#DT_ENCODING
 32

	)

380 
	#DT_PREINIT_ARRAY
 32

	)

381 
	#DT_PREINIT_ARRAYSZ
 33

	)

382 
	#DT_NUM
 34

	)

383 
	#DT_LOOS
 0x6000000d

	)

384 
	#DT_HIOS
 0x6ffff000

	)

385 
	#DT_LOPROC
 0x70000000

	)

386 
	#DT_HIPROC
 0x7ffffffà

	)

387 
	#DT_PROCNUM
 
DT_MIPS_NUM


	)

400 #´agm¨
·ck
(
pİ
)

	@include/old/fork.h

1 #iâdeà
FORK_H


2 
	#FORK_H


	)

4 
chgpg
(*
dœ
,
vpg
,
rw
);

	@include/old/fs.h

1 #iâdeà
FS_H


2 
	#FS_H


	)

	@include/old/fs_cell.h

1 #iâdeà
FS_CELL_H


2 
	#FS_CELL_H


	)

4 
	#NAME_LEN
 16

	)

5 
	#CELL_SECTORS
 32

	)

6 
	#CELL_MAX
 8

	)

8 *
	gûÎmbr
;

9 
£¬ch_fe
(*
Çme
);

	@include/old/fs_ext.h

1 #iâdeà
FS_EXT__H


2 
	#FS_EXT__H


	)

3 
	~<v®Ty³.h
>

4 
	~<fs.h
>

6 
	#INODE_FILE_DIR
 4

	)

8 
	#BLOCK_FILE_REGULAR
 1

	)

9 
	#BLOCK_FILE_DIR
 2

	)

11 
__Ë32
 
	ms_šodes_couÁ
;

12 
__Ë32
 
	ms_blocks_couÁ
;

13 
__Ë32
 
	ms_r_blocks_couÁ
;

14 
__Ë32
 
	ms_ä“_blocks_couÁ
;

15 
__Ë32
 
	ms_ä“_šodes_couÁ
;

16 
__Ë32
 
	ms_fœ¡_d©a_block
;

17 
__Ë32
 
	ms_log_block_size
;

18 
__Ë32
 
	ms_log_äag_size
;

19 
__Ë32
 
	ms_blocks_³r_group
;

20 
__Ë32
 
	ms_äags_³r_group
;

21 
__Ë32
 
	ms_šodes_³r_group
;

22 
__Ë32
 
	ms_mtime
;

23 
__Ë32
 
	ms_wtime
;

24 
__Ë16
 
	ms_mÁ_couÁ
;

25 
__Ë16
 
	ms_max_mÁ_couÁ
;

26 
__Ë16
 
	ms_magic
;

27 
__Ë16
 
	ms_¡©e
;

28 
__Ë16
 
	ms_”rÜs
;

29 
__Ë16
 
	ms_mšÜ_»v_Ëv–
;

30 
__Ë32
 
	ms_Ï¡check
;

31 
__Ë32
 
	ms_checkš‹rv®
;

32 
__Ë32
 
	ms_ü—tÜ_os
;

33 
__Ë32
 
	ms_»v_Ëv–
;

34 
__Ë16
 
	ms_def_»suid
;

35 
__Ë16
 
	ms_def_»sgid
;

37 
__Ë32
 
	ms_fœ¡_šo
;

38 
__Ë16
 
	ms_šode_size
;

39 
__Ë16
 
	ms_block_group_Ä
;

40 
__Ë32
 
	ms_ã©u»_com·t
;

41 
__Ë32
 
	ms_ã©u»_šcom·t
;

42 
__Ë32
 
	ms_ã©u»_ro_com·t
;

43 
__u8
 
	ms_uuid
[16] ;

44 
	ms_vŞume_Çme
[16] ;

45 
	ms_Ï¡_mouÁed
[64] ;

46 
__Ë32
 
	ms_®gÜ™hm_u§ge_b™m­
;

48 
__u8
 
	ms_´—Îoc_blocks
;

49 
__u8
 
	ms_´—Îoc_dœ_blocks
;

50 
__u16
 
	ms_·ddšg1
;

52 
__u8
 
	ms_jouº®_uuid
[16] ;

53 
__u32
 
	ms_jouº®_šum
;

54 
__u32
 
	ms_jouº®_dev
;

55 
__u32
 
	ms_Ï¡_Üphª
;

56 
__u32
 
	ms_hash_£ed
[4] ;

57 
__u8
 
	ms_def_hash_v”siÚ
;

58 
__u8
 
	ms_»£rved_ch¬_·d
;

59 
__u16
 
	ms_»£rved_wÜd_·d
;

60 
__Ë32
 
	ms_deçuÉ_mouÁ_İts
;

61 
__Ë32
 
	ms_fœ¡_m‘a_bg
;

62 
__u32
 
	ms_»£rved
[190] ;

63 }
	tSUPER_BLOCK
;

70 
__Ë32
 
	mbg_block_b™m­
;

71 
__Ë32
 
	mbg_šode_b™m­
;

72 
__Ë32
 
	mbg_šode_bË
;

73 
__Ë16
 
	mbg_ä“_blocks_couÁ
;

74 
__Ë16
 
	mbg_ä“_šodes_couÁ
;

75 
__Ë16
 
	mbg_u£d_dœs_couÁ
;

76 
__Ë16
 
	mbg_·d
;

77 
__Ë32
 
	mbg_»£rved
[3];

78 }
	tGROUP_DESC
;

85 
__Ë16
 
	mi_mode
;

86 
__Ë16
 
	mi_uid
;

87 
__Ë32
 
	mi_size
;

88 
__Ë32
 
	mi_©ime
;

89 
__Ë32
 
	mi_ùime
;

90 
__Ë32
 
	mi_mtime
;

91 
__Ë32
 
	mi_dtime
;

92 
__Ë16
 
	mi_gid
;

93 
__Ë16
 
	mi_lšks_couÁ
;

94 
	mblock_couÁ
;

95 
__Ë32
 
	mi_æags
;

96 
	mos_šfÜm©iÚ
;

97 
	mblocks
[12];

98 
	m£edblock1
;

99 
	m£edblock2
;

100 
	m£edblock3
;

101 
	m·dd’1
[128/4-25];

102 }
	tINODE
;

105 
	mšode
;

106 
u16
 
	m»cÜd_Ën
;

107 
u8
 
	mÇme_Ën
;

108 
u8
 
	mfe_ty³
;

109 
	mÇme
[128];

110 }
	tDIRENT
;

112 
fs_ext
();

	@include/old/func_table.h

1 #iâdeà
FUNC_TABLE_H


2 
	#FUNC_TABLE_H


	)

4 
k_¦“p
(
msg_ty³
,
msg_bšd
);

	@include/old/hd.h

1 #iâdeà
HD_H


2 
	#HD_H


	)

4 
	#SIZE_SECTOR
 512

	)

6 
	#OFFSET2
 (0x0)

	)

7 
	#REG_DATA
 (0x1f0-
OFFSET2
)

	)

9 
	#REG_ERROR
 (0X1F1-
OSFSET2
)

	)

10 
	#REG_FEATURES
 (0X1F1-
OFFSET2
)

	)

12 
	#REG_COUNT
 (0X1F2-
OFFSET2
)

	)

13 
	#REG_LBA_LOW
 (0X1F3-
OFFSET2
)

	)

14 
	#REG_LBA_MID
 (0X1F4-
OFFSET2
)

	)

15 
	#REG_LBA_HIGH
 (0x1F5-
OFFSET2
)

	)

16 
	#REG_DEVICE
 (0X1F6-
OFFSET2
)

	)

18 
	#REG_STATUS
 (0x1F7-
OFFSET2
)

	)

19 
	#REG_COMMAND
 (0x1F7-
OFFSET2
)

	)

21 
	#REG_CONTROL
 (0X3F6-
OFFSET2
)

	)

23 
	#MASK_BSY
 0x80

	)

25 
	#COMMAND_IDENTIFY
 0xec

	)

26 
	#COMMAND_NULL
 0x0

	)

27 
	#COMMAND_READ
 0x20

	)

28 
	#COMMAND_WRITE
 0x30

	)

29 
	#COMMAND_CHECK
 0X90

	)

30 
	#COMMAND_OPEN
 0x1

	)

31 
	#COMMAND_CLOSE
 0x2

	)

32 
	#COMMAND_SEEK
 0x3

	)

33 
	#STATUS_BSY
 (
	`š_by‹
(
REG_STATUS
)&
MASK_BSY
)

	)

35 
	#MAKE_REG_DEVICE
(
lba
,
drv
,
lba_highe¡
è(Öba<<6)|(drv<<4)|Öba_highe¡)|0XA0)

	)

37 
	#SECTOR_THROUGHPUT
 256

	)

42 
	s£Ëù
{

43 
u8
 
	mh—d
: 4;

44 
u8
 
	mdrv
: 1;

45 
u8
 
	mb™5
: 1;

46 
u8
 
	mlba
: 1;

47 
u8
 
	mb™7
: 1;

49 
	slba
{

50 
u8
 
	mlow
;

51 
u8
 
	mmiddË
;

52 
u8
 
	mhigh
;

53 
£Ëù
 
	m£Ëù
;

55 
	s»quœe
{

58 
u8
 
	mlow
;

59 
u8
 
	mmid
;

60 
u8
 
	mhigh
;

61 
u8
 
	m·dd’
;

62 }
	mlba_¡ru
;

63 
u32
 
	mlba
;

65 
u8
 
	mã©u»s
;

66 
u32
 
	m»g_couÁ
;

67 
u8
 
	mdeviû
;

68 
u8
 
	mcommªd
;

71 *
	mbuf
;

72 
u32
 
	mcouÁ
;

74 *
	m±_cu¼
;

77 
	#STATUS_BSY
 (
	`š_by‹
(
REG_STATUS
)&0x80)

	)

78 
	#STATUS_DRQ
 (
	`š_by‹
(
REG_STATUS
)&0x8)

	)

	@include/old/hd_drv.h

1 #iâdeà
HD_DRV_H


2 
	#HD_DRV_H


	)

3 
	~<uts.h
>

4 
	~<v®Ty³.h
>

	@include/old/heap.h

1 #iâdeà
HEAP_H


2 
	#HEAP_H


	)

3 
	#CELL_FREE
 0

	)

4 
	#CELL_USED
 1

	)

5 
	#BASE_HEAP
 (0x400000+4096)

6 
	#SIZE_HEAP
 0x1000000

7 
	#SIZE_HEADER_HEAPCELL
 ((
HEADER_HEAPCELL
))

	)

8 
	sh—d”_h—pC–l
{

9 
h—d”_h—pC–l
* 
	m±_´ev
;

10 
h—d”_h—pC–l
* 
	m±_Ãxt
;

11 
	msize
;

12 
	mty³
;

13 }
	tHEADER_HEAPCELL
;

15 
š™H—p
();

16 * 
om®loc
(
num4
);

17 
oä“
(* 
±
);

	@include/old/hs.h

1 #iâdeà
HS_H


2 
	#HS_H


	)

3 
	~<uts.h
>

4 
	~<hd_drv.h
>

5 
	~<v®Ty³.h
>

6 
	~<mm.h
>

7 
	#SIZE_SECTOR
 512

	)

9 
	#OFFSET2
 (0x0)

	)

10 
	#REG_DATA
 (0x1f0-
OFFSET2
)

	)

12 
	#REG_ERROR
 (0X1F1-
OSFSET2
)

	)

13 
	#REG_FEATURES
 (0X1F1-
OFFSET2
)

	)

15 
	#REG_COUNT
 (0X1F2-
OFFSET2
)

	)

16 
	#REG_LBA_LOW
 (0X1F3-
OFFSET2
)

	)

17 
	#REG_LBA_MID
 (0X1F4-
OFFSET2
)

	)

18 
	#REG_LBA_HIGH
 (0x1F5-
OFFSET2
)

	)

19 
	#REG_DEVICE
 (0X1F6-
OFFSET2
)

	)

21 
	#REG_STATUS
 (0x1F7-
OFFSET2
)

	)

22 
	#REG_COMMAND
 (0x1F7-
OFFSET2
)

	)

24 
	#REG_CONTROL
 (0X3F6-
OFFSET2
)

	)

26 
	#MASK_BSY
 0x80

	)

28 
	#COMMAND_IDENTIFY
 0xec

	)

29 
	#COMMAND_NULL
 0x0

	)

30 
	#COMMAND_READ
 0x20

	)

31 
	#COMMAND_WRITE
 0x30

	)

32 
	#COMMAND_CHECK
 0X90

	)

33 
	#COMMAND_OPEN
 0x1

	)

34 
	#COMMAND_CLOSE
 0x2

	)

35 
	#COMMAND_SEEK
 0x3

	)

36 
	#STATUS_BSY
 (
	`š_by‹
(
REG_STATUS
)&
MASK_BSY
)

	)

38 
	#MAKE_REG_DEVICE
(
lba
,
drv
,
lba_highe¡
è(Öba<<6)|(drv<<4)|Öba_highe¡)|0XA0)

	)

40 
	#SECTOR_THROUGHPUT
 256

	)

44 
u8
 
	mlow
;

45 
u8
 
	mmid
;

46 
u8
 
	mhigh
;

47 
u8
 
	m·dd’
;

48 }
	mlba_¡ru
;

49 
u32
 
	mlba
;

51 
u8
 
	mã©u»s
;

52 
u32
 
	m»g_couÁ
;

53 
u8
 
	mdeviû
;

54 
u8
 
	mcommªd
;

57 *
	mbuf
;

58 
u32
 
	mcouÁ
;

60 *
	m±_cu¼
;

61 
pcb
 * 
	mask”
;

62 }
	tHS_CMD
;

65 
hs_cmd_out
(
HS_CMD
*
cmd
);

66 
hs_cmd_š™
(
u32
 
lba
,u32 
couÁ
,
u8
 
commªd
,*
buf
);

67 
hs
();

68 
id’tify_šfo
();

69 
cmd_šfo
();

70 
askhs
(
commªd
,
lba
,
couÁ
,*
buf
);

	@include/old/i8259.h

1 #iâdeà
I8259_H


2 
	#I8259_H


	)

4 
	~<v®Ty³.h
>

5 
š™_ISA_œqs
();

6 
u16
 
pic_g‘_i¤
();

	@include/old/irq.h

1 #iâdeà
IRQ_H


2 
	#IRQ_H


	)

3 
	~<v®Ty³.h
>

4 
	g±_»gs
;

7 
	#NR_IRQS
 16

	)

9 
	#IRQ_PENDING
 1

	)

10 
	#IRQ_INPROCESS
 (1<<1)

	)

11 
	#IRQ_DISABLED
 (1<<2)

	)

13 (*
	m’abË
)(
	mœq
);

14 (*
	mdi§bË
)(
	mœq
);

15 (*
	mack
)(
	mœq
);

16 (*
	m’d
)(
	mœq
);

17 }
	thw_œq_cÚŒŞËr
;

20 
	m¡©us
;

21 
œqaùiÚ
 *
	maùiÚ
;

22 
hw_œq_cÚŒŞËr
 *
	mhw_hªdËr
;

23 }
	tœq_desc_t
;

26 
	#SA_SHIRQ
 1

	)

27 
	#SA_INTERRUPT
 (1<<1è

	)

28 
	sœqaùiÚ
{

32 (*
	mfunc
è(
	mœq
, *
	mdev
, 
±_»gs
 *
	m»gs
);

33 
	mæags
;

34 *
	mdev
;

36 
œqaùiÚ
 *
	mÃxt
;

39 
œq_desc_t
 
	gœq_desc
[
NR_IRQS
];

43 
»que¡_œq
(
œq
, (*
hªdËr
)(, *, 
±_»gs
 *), 
æags
, *
dev
);

44 
boŞ
 
	`š_š‹¼u±
();

	@include/old/kbd_drv.h

1 #iâdeà
_ORANGES_KEYMAP_H_


2 
	#_ORANGES_KEYMAP_H_


	)

5 
	#NR_SCAN_CODES
 0X40

	)

6 
	#MAP_COLS
 3

	)

8 
	#ESC
 0

	)

9 
	#BACKSPACE
 '\b'

	)

10 
	#TAB
 0

	)

11 
	#SHIFT_L
 0

	)

12 
	#SHIFT_R
 0

	)

13 
	#CTRL_L
 0

	)

14 
	#CTRL_R
 0

	)

15 
	#ALT_L
 0

	)

16 
	#ALT_R
 0

	)

17 
	#ENTER
 '\n'

	)

19 
	#MC_SHIFT_L
 0x2A

	)

20 
	#MC_SHIFT_R
 0x36

	)

21 
	#MC_CTRL_L
 0x1D

	)

23 
	#BC_SHIFT_L
 0xAA

	)

24 
	#BC_SHIFT_R
 0xB6

	)

25 
	#BC_CTRL_L
 0x9D

	)

	@include/old/ku_mm.h

1 #iâdeà
KU_MM_H


2 
	#KU_MM_H


	)

3 
	~<pmm.h
>

5 
	#USR_PSP_LEN
 (64)

	)

6 
	#USR_PSP_BASE
 (
PAGE_OFFSET
-
USR_PSP_LEN
)

	)

7 
	#USR_STACK_BASE
 (
USR_PSP_BASE
 - 4)

	)

8 
	su¤_p¥_¡ruù
{

9 
	mpid
;

10 
	m_”ºo
;

13 
	#__u¤_p¥
 ((
u¤_p¥_¡ruù
 *)
USR_PSP_BASE
)

	)

	@include/old/ku_proc.h

2 #iâdeà
KU_PROC_H


3 
	#KU_PROC_H


	)

5 
	#MSGTYPE_TIMER
 255

	)

6 
	#MSGTYPE_DEEP
 0

	)

7 
	#MSGTYPE_CHAR
 1

	)

8 
	#MSGTYPE_FS_ASK
 2

	)

9 
	#MSGTYPE_HD_DONE
 3

	)

10 
	#MSGTYPE_HS_READY
 4

	)

11 
	#MSGTYPE_HS_DONE
 5

	)

12 
	#MSGTYPE_FS_READY
 8

	)

13 
	#MSGTYPE_USR_ASK
 6

	)

14 
	#MSGTYPE_FS_DONE
 7

	)

	@include/old/ku_utils.h

1 #iâdeà
KU_UTILS_H


2 
	#KU_UTILS_H


	)

3 
	~<v®Ty³.h
>

4 
	#mš
(
x
,
y
è((x)<(y)?(x):(y))

	)

5 
	#MAX
(
x
, 
y
è((x)>(y)?(x):(y))

	)

8 
	#—t_hex
(
±
,
x
)\

9 *
__±
=(
±
);\

10 
x
=0;\

11 if(*
__±
!='0'||*(__pt+1)!='x'){\

12 
x
=-1;\

13 
dÚÙhšg
;\

15 
__±
+=2;\

16 if(!((*
__±
>='0'&&*__pt<='9')||(*__pt>='a'&&*__pt<='f'))){\

17 
x
=-1;\

18 
dÚÙhšg
;\

20 (*
__±
>='0'&&*__pt<='9')||(*__pt>='a'&&*__pt<='f')) __pt++;\

21 
__±
--;\

22 
__Ën
=
__±
-
±
+1-2;\

23 
__i
=0;__i<
__Ën
;__i++){\

24 
x
+=
	`hex_št
(*
__±
)*
	`pow_št
(16,
__i
);\

25 
__±
--;\

27 (
±
)+=(2+
__Ën
);\

28 
dÚÙhšg
:;

	)

31 
	#—t_dec
(
±
,
x
)\

32 if(*
±
<'0'||*±>'9'è
dÚÙhšg
;\

33 
x
=0;\

34 *
__±
=(
±
);\

35 *(
__±
+1)>='0'&&*(__pt+1)<='9') __pt++;\

36 
__Ën
=
__±
-(
±
)+1;\

37 
__i
=0;__i<
__Ën
;__i++){\

38 
x
+=(*
__±
-48)*
	`pow_št
(10,
__i
);\

39 
__±
--;\

41 (
±
)+=
__Ën
;\

42 
dÚÙhšg
:;

	)

44 
	#—t_dec_w™h_Ën
(
±
,
x
,
x_Ën
) \

45 *
__±
=(
±
);\

46 *(
__±
+1)>='0'&&*(__pt+1)<='9') __pt++;\

47 
Ën
=
__±
-(
±
)+1;\

48 
__i
=0;__i<
x_Ën
;__i++){\

49 
x
+=(*
__±
-48)*
	`pow_št
(10,
__i
);\

50 
__±
--;\

52 (
±
)+=
x_Ën
;

	)

53 
	gmem_’t™y
[4];

54 
mem£tw
(*
de¡
,
wÜd
,
v®ue
);

55 
mem£t
(*
de¡
,
v®ue
,
n
);

56 
ch¬s_to_¡r
(*
¡r
,*
ch¬s
);

57 
ch¬scmp
(*
±1
,*
±2
,
’d_æag
);

58 
û_divide
(
a
,
b
);

59 
pow_št
(
ba£
,
exp
);

60 
humª_memsize_što
(*
gmkb
,
size
,
š™Ÿl_sÿË_couÁ
);

61 *
humª_memsize
(
size
,
š™Ÿl_sÿË_couÁ
);

62 
hex_št
(
x
);

	@include/old/list.h

1 #iâdeà
LIST_H


2 
	#LIST_H


	)

5 #iâdeà
__USER


6 
	~<lšux/as£¹.h
>

8 
	~<as£¹.h
>

10 
	sli¡_h—d
{

11 
li¡_h—d
 *
	m´ev
;

12 
li¡_h—d
 *
	mÃxt
;

13 }
	tli¡_h—d_t
;

15 
	#INIT_LIST_HEAD
(
l
)\

17 (
l
)->
´ev
 = (l)->
Ãxt
 =†;\

18 } 0)

	)

20 
šlše
 
	$__li¡_add
(
li¡_h—d_t
 *
Ãw
,†i¡_h—d_ˆ*
´ev
,

21 
li¡_h—d_t
 *
Ãxt
){

22 
	`as£¹
Ğ
Ãw
 && 
´ev
 && 
Ãxt
\

23 && 
´ev
->´ev &&…»v->
Ãxt
 &&‚ext->prev &&‚ext->next);

24 
Ãw
->
Ãxt
 =‚ext;

25 
Ãxt
->
´ev
 = 
Ãw
;

26 
Ãw
->
´ev
 =…rev;

27 
´ev
->
Ãxt
 = 
Ãw
;

28 
	}
}

35 
šlše
 
	$li¡_add
(
li¡_h—d_t
 *
Ãw
,†i¡_h—d_ˆ*
h—d
){

36 
	`__li¡_add
(
Ãw
, 
h—d
, h—d->
Ãxt
);

37 
	}
}

39 
šlše
 
	$li¡_add_
(
li¡_h—d_t
 *
Ãw
,†i¡_h—d_ˆ*
h—d
){

40 
	`__li¡_add
(
Ãw
, 
h—d
->
´ev
, head);

41 
	}
}

49 
šlše
 
	$__li¡_d–
(
li¡_h—d_t
 *
´ev
,†i¡_h—d_ˆ*
Ãxt
){

50 
	`as£¹
(
´ev
 && 
Ãxt
 &&…rev->next &&…rev->prev &&‚ext->prev &&‚ext->next);

51 
´ev
->
Ãxt
 =‚ext;

52 
Ãxt
->
´ev
 =…rev;

53 
	}
}

56 
šlše
 
	$li¡_d–
(
li¡_h—d_t
 *
’Œy
){

57 
	`__li¡_d–
(
’Œy
->
´ev
,ƒÁry->
Ãxt
);

58 
	}
}

60 
šlše
 
	$li¡_d–_š™
(
li¡_h—d_t
 *
’Œy
){

61 
	`__li¡_d–
(
’Œy
->
´ev
,ƒÁry->
Ãxt
);

62 
	`INIT_LIST_HEAD
(
’Œy
);

63 
	}
}

65 
šlše
 
	$li¡_em±y
(
li¡_h—d_t
 *
’Œy
){

66  
’Œy
->
Ãxt
 ==ƒntry;

67 
	}
}

69 
šlše
 
	$li¡_m“t_
(
li¡_h—d_t
 *
fœ¡
,†i¡_h—d_ˆ*
’Œy
){

70  
’Œy
->
Ãxt
 =ğ
fœ¡
;

71 
	}
}

74 
	#LIST_FIND2
(
¡ru_t
, 
mb_t
, 
roÙ
, 
key
, 
v®ue
, 
»suÉ
) \

76 
li¡_h—d
 * 
node
 = 
roÙ
->
Ãxt
; \

77 
¡ru_t
 *
obj
; \

78 
node
 !ğ
roÙ
){ \

79 *
obj
 = 
	`MB2STRU
(
¡ru_t
, 
node
, 
mb_t
); \

80 ifĞ(
obj
)->
key
 =ğ
v®ue
 ) ; \

81 
node
 =‚ode->
Ãxt
; \

83 if(
node
 =ğ
roÙ
è
»suÉ
 = 0; \

84 
»suÉ
 = 
obj
; \

85 } 0);

	)

87 
šlše
 
	$hashbË_add
(
li¡_h—d_t
 *
hashbË
, 
hash
,†i¡_h—d_ˆ*
Ãw
){

88 
	`li¡_add
(
Ãw
, 
hashbË
 + 
hash
) ;

89 
	}
}

93 
	#MB2STRU
(
¡ru_ty³
, 
mb_addr
, 
mb_Çme
)\

94 (
¡ru_ty³
 *)Ğ()(
mb_addr
)- ()&((¡ru_ty³ *)0)->
mb_Çme
 )

	)

98 
	#cÚš”_of
(
h—d
, 
¡ru
, 
memb”
è
	`MB2STRU
(¡ru, h—d, memb”)

	)

104 
	#li¡_fÜ_—ch_§ã
(
roÙ
, 
cÚš”
, 
mbÇme
) \

106 
li¡_h—d
 *
node
 = (
roÙ
)->
Ãxt
, *next =‚ode->next; \

107 ((
cÚš”
 = 
	`cÚš”_of
(
node
, 
	`__ty³of__
(*cÚš”), 
mbÇme
)) || 1)\

108 && 
node
 !ğ
roÙ
; \

109 
node
 = 
Ãxt
,‚ext =‚ext->next \

110 )

	)

	@include/old/mm.h

1 #iâdeà
MM_H


2 
	#MM_H


	)

3 
	~<lšux/mm.h
>

	@include/old/mmzone.h

1 #iâdeà
MMZONE_H


2 
	#MMZONE_H


	)

3 
	~<li¡.h
>

4 
	~<lšux/mm.h
>

5 
	~<asm/·ge.h
>

7 
	#G_PGNUM
 (
gmemsize
>>12)

	)

8 
	s·ge
{

9 
li¡_h—d
 
	mÌu
;

10 
	m_couÁ
;

11 
	mcow_sh¬ed
;

16 
	m´iv©e
;

17 
	mPG_highmem
:1;

18 
	mPG_´iv©e
:1;

19 
	mPG_zid
:2;

20 
	mdebug
:8;

21 
	m·dd’
:20;

22 }
	t·ge_t
;

24 
	#·ge_idx
(
·ge_t
è(()(Õage_tè- 
mem_m­
))

	)

25 
	#±e_pâ
(
±e
è(Õ‹)>>
PAGE_SHIFT
)

	)

26 
	#pâ_·ge
(
pâ
è(
mem_m­
 + (pâ))

	)

27 
	#±e_·ge
(
±e
èĞ
	`pâ_·ge
Ğ
	`±e_pâ
Õ‹èè)

	)

28 
	#·ge_va
(
·ge
è
	`__va
ĞÕag- 
mem_m­
è<< 
PAGE_SHIFT
)

	)

29 
	#vœt_to_·ge
(
vaddr
è
	`pâ_·ge
Ğ
	`__·
(vaddrè>> 
PAGE_SHIFT
)

	)

30 
·ge
 *
	gmem_m­
;

32 
	#MAX_ORDER
 10

	)

34 
	#__GFP_DEFAULT
 0

	)

35 
	#__GFP_ZERO
 (1<<0)

	)

36 
	#__GFP_DMA
 (1<<1)

	)

37 
	#__GFP_HIGHMEM
 (1<<2)

	)

38 
	#__GFP_NORMAL
 (1<<3)

	)

40 
	#ZONE_DMA
 0

	)

41 
	#ZONE_NORMAL
 1

	)

42 
	#ZONE_HIGHMEM
 2

	)

43 
	#ZONE_MAX
 3

	)

45 
	#ZONE_DMA_PA
 0

	)

46 
	#ZONE_NORMAL_PA
 0X1000000

	)

47 
	#ZONE_HIGHMEM_PA
 (896*0x100000)

	)

49 
	sä“_¬—_¡ruù
{

50 
li¡_h—d
 
	mä“_li¡
;

51 
	mÄ_ä“
;

52 
	mä“s
,
	m®locs
;

53 }
	tä“_¬—_t
;

55 
	szÚe_¡ruù
{

57 
	mä“_·ges
;

58 
ä“_¬—_t
 
	mä“_¬—
[
MAX_ORDER
+1];

59 
·ge
 *
	mzÚe_mem_m­
;

60 
	m¥ªÃd_·ges
;

61 
	m®locs
,
	mä“s
;

62 }
	tzÚe_t
;

64 
zÚe_t
 
	gzÚe_dma
;

65 
zÚe_t
 
	gzÚe_nÜm®
;

66 
zÚe_t
 
	gzÚe_highmem
;

67 
zÚe_t
 *
	g__zÚes
[3];

68 
	gsize_of_zÚe
[3];

69 
š™_zÚe
();

74 
ä“_·ges
(
·ge
 *·ge, 
Üd”
);

90 
šlše
 
	$__ä“_·ges
(* 
äame_addr
, 
Üd”
){

91 
	`as£¹
(
äame_addr
 >ğ(*)
__3G
);

92 
µg
 = 
	`__·
(
äame_addr
) >> 12;

93 
	`ä“_·ges
(
mem_m­
 + 
µg
, 
Üd”
);

94 
	}
}

96 
šlše
 
	$__ä“_·ge
(* 
äame_addr
){

97 
	`__ä“_·ges
(
äame_addr
, 0);

98 
	}
}

100 
šlše
 
	$ä“_·ge
(
·ge
 *…age){

101 
	`ä“_·ges
(
·ge
, 0);

102 
	}
}

109 
·ge
 *
®loc_·ges
(
u32
 
gå_mask
, 
Üd”
);

110 
šlše
 * 
	$__®loc_·ges
(
u32
 
gå_mask
, 
Üd”
){

111 
u32
 
µg
 = 
	`·ge_idx
(
	`®loc_·ges
(
gå_mask
, 
Üd”
));

112  (*)
	`KV
(
µg
<<12);

113 
	}
}

115 
šlše
 
·ge
 *
	$®loc_·ge
(
u32
 
gå
)

117  
	`®loc_·ges
(
gå
, 0);

118 
	}
}

120 
šlše
 * 
	$__®loc_·ge
(
u32
 
gå
)

122  
	`__®loc_·ges
(
gå
, 0);

123 
	}
}

128 
šlše
 
·ge
 *
	$__va2·ge_t
(
vaddr
){

129 
	`as£¹
(
vaddr
 > 
__3G
);

130  (
mem_m­
 + ((
vaddr
 - 
PAGE_OFFSET
) >> 12));

131 
	}
}

135 
šlše
 
·ge
 *
	$g‘_·ge
(
·ge
 *page){

136 
	`as£¹
(
·ge
->
_couÁ
 >= 1);

137 
·ge
->
_couÁ
++;

138  
·ge
;

139 
	}
}

141 
šlše
 
	$put_·ge
(
·ge
 *page){

142 
	`as£¹
(
·ge
->
_couÁ
 >= 1);

143 if(
·ge
->
_couÁ
 == 1){

144 
	`ä“_·ge
(
·ge
);

146 
·ge
->
_couÁ
--;

147 
	}
}

149 
šlše
 
·ge
 *
	$±e2·ge_t
(
±e
…te){

150 
	`as£¹
(
±e
.
v®ue
 &&…‹.
´e£Á
);

151  ( 
mem_m­
 + (
±e
).
physiÿl
 );

152 
	}
}

	@include/old/ntfs.h

1 #iâdeà
__NTFS_H__


2 
	#__NTFS_H__


	)

4 
	~<v®Ty³.h
>

12 
u16
 
	tWCHAR
;

13 
	#MAX_PATH
 260

	)

15 #´agm¨
·ck
(1)

16 
	sg_NTFS_h—d”
{

17 
by‹
 
	mbJmp
[3];

18 
by‹
 
	mbNTFÏgs
[4];

19 
by‹
 
	mbRe£rve1
[4];

20 
	mwBy‹P”SeùÜ
;

21 
by‹
 
	mbSeùÜP”Clu¡”
;

22 
	mwRe£rveSeùÜs
;

23 
by‹
 
	mbF©Num
;

24 
	mwRoÙDœNum
;

25 
	mwSeùÜOfP¬ti
;

26 
by‹
 
	mbMedium
;

27 
	mwSeùÜP”F©
;

28 
	mwSeùÜP”T¿ck
;

29 
	mwH—dNum
;

30 
	mdwHideSeùÜ
;

31 
	mdwSeùoOfP¬ti
;

32 
by‹
 
	mbDeviûFÏg
;

33 
by‹
 
	mbRe£rve2
;

34 
	mwRe£rve3
;

35 
ušt64_t
 
	muÎSeùÜsOfP¬ti
;

36 
ušt64_t
 
	muÎMFTAddr
;

37 
ušt64_t
 
	muÎMFTMœrAddr
;

38 
by‹
 
	mbClu¡”P”Fe
;

39 
by‹
 
	mbRe£rve4
[3];

40 
	mdwClu¡”P”INDX
;

41 
by‹
 
	mbS”ŸlID
[8];

42 } 
	tÁfs_h—d”
, *
	t²tfs_h—d”
;

47 
	sg_MFTHEAD
 {

48 
by‹
 
	mbH—dID
[4];

49 
u16
 
	musFixupOff£t
;

50 
u16
 
	musFixupNum
;

51 
by‹
 
	mbRe£rve1
[8];

52 
u16
 
	mwUnknownSeqNum
;

53 
u16
 
	musLškNum
;

54 
u16
 
	musA‰rOff£t
;

55 
	mwResid’t
;

56 
	mulMFTSize
;

57 
	mulMFTAÎocSize
;

58 
ušt64_t
 
	muÎMašMFT
;

59 
u16
 
	mwNextF»eID
;

60 
u16
 
	mwFixup
[0x10];

61 } 
	tmá_h—d
;

63 
	sg_RESIDATTR
 {

64 
u32
 
	mulD©aSize
;

65 
u16
 
	musRD©aOff£t
;

66 
	mwUnknownA‰rIndexID
;

67 } 
	tRESIDATTR
, *
	tLPRESIDATTR
;

69 
	sg_NONRESIDATTR
 {

70 
ušt64_t
 
	muÎVCNS¹
;

71 
ušt64_t
 
	muÎVCNEnd
;

72 
u16
 
	musNrD©aOff£t
;

73 
	mwCom´Engše
;

74 
	mdeRe£rve2
;

75 
ušt64_t
 
	muÎAÎocSize
;

76 
ušt64_t
 
	muÎD©aSize
;

77 
ušt64_t
 
	muÎIn™Size
;

78 
ušt64_t
 
	muÎCom´Size
;

79 } 
	tNONRESIDATTR
, *
	tLPNONRESIDATTR
;

81 
	sg_MFTATTR
 {

82 
	mdwA‰rTy³
;

83 
u16
 
	musA‰rSize
;

84 
	mwRe£rve1
;

85 
by‹
 
	mbISResid’t
;

86 
by‹
 
	mbL’Name
;

87 
u16
 
	musD©aOff£t
;

88 
	mwISCom´
;

89 
	mwA‰rID
;

90 
	uunA‰rib
{

91 
RESIDATTR
 
	mResidA‰r
;

92 
NONRESIDATTR
 
	mNÚResidA‰r
;

93 } 
	munA‰rib
;

94 } 
	tMFTATTR
, *
	tLPMFTATTR
;

98 
	sg_FILE_NAME


100 
u32
 
	mdwMFTIndex
;

101 
	mwRe£rve1
;

102 
	mwRe£rve2
;

103 
ušt64_t
 
	muÎTime1
;

104 
ušt64_t
 
	muÎTime2
;

105 
ušt64_t
 
	muÎTime3
;

106 
ušt64_t
 
	muÎTime4
;

107 
ušt64_t
 
	muÎAÎocSize
;

108 
ušt64_t
 
	muÎFeSize
;

109 
ušt64_t
 
	muÎFeA‰r
;

110 
by‹
 
	mbNameL’
;

111 
by‹
 
	mbNameTy³
;

112 
WCHAR
 
	mpwCh¬
[
MAX_PATH
];

113 } 
	tFILE_NAME
, *
	tLPFILENAME
;

115 
	sg_INDXENTRY


117 
u32
 
	mdwMFTIndx
;

118 
u32
 
	mdwRe£rve1
;

119 
	mwEÁrySize
;

120 
	mwRe£rve2
;

121 
by‹
 
	mbISSubNode
;

122 
by‹
 
	mbRe£rve3
[3];

123 
u32
 
	mdwAµ—r
;

124 
u32
 
	mdwRe£rve4
;

125 
ušt64_t
 
	muÎFeTime
[4];

126 
ušt64_t
 
	muÎD©aAlcSize
;

127 
ušt64_t
 
	muÎD©aSize
;

128 
ušt64_t
 
	muÎRe£rve5
;

129 
by‹
 
	mbNameL’
;

130 
by‹
 
	mbNameTy³
;

131 
WCHAR
 
	mwzFeName
[
MAX_PATH
];

133 } 
	tINDXENTRY
, *
	tLPINDXENTRY
;

135 
	sg_INDX


137 
by‹
 
	mbDœID
[4];

138 
	mwFixupOff£t
;

139 
	mwFixupNum
;

140 
by‹
 
	mwRe£rve1
[8];

141 
by‹
 
	mbRe£rve2
[8];

142 
	mwH—dSize
;

143 
	mwRe£rve3
;

144 
u32
 
	mdwU£Size
;

145 
u32
 
	mdwAÎocSize
;

146 
u32
 
	mdwRe£rve3
;

147 
by‹
 
	mbFixup
[0x0A];

149 } 
	tINDX
, *
	tLPINDX
;

151 
	sg_INDXATTR


153 
u32
 
	mdwMFTIndx
;

154 
	mwRe£rve1
;

155 
	mwRe£rve2
;

156 
	mwcbSize
;

157 
	mwNameA‰rL’
;

158 
	mwISSubNode
;

159 
by‹
 
	mbRe£rve3
[2];

160 
u32
 
	mdwP¬’tMFTIndx
;

161 
u32
 
	mdwRe£rve4
;

162 
ušt64_t
 
	muÎC»©eTime
;

163 
ušt64_t
 
	muÎLa¡ModTime
;

164 
ušt64_t
 
	muÎModRcdTime
;

165 
ušt64_t
 
	muÎLa¡AccTime
;

166 
ušt64_t
 
	muÎAÎocSize
;

167 
ušt64_t
 
	muÎFeSize
;

168 
ušt64_t
 
	muÎFeFÏgs
;

169 
by‹
 
	mbFeNameL’
;

170 
by‹
 
	mbFeNS·û
;

171 
WCHAR
 
	mwzFeName
[
MAX_PATH
];

173 } 
	tINDXATTR
, *
	tLPINDXATTR
;

175 
	sg_INDXROOT


177 
u32
 
	mdwA‰rTy³
;

178 
u32
 
	mdwCÚRuË
;

179 
u32
 
	mdwEÁrySize
;

180 
by‹
 
	mbClu¡”P”Index
;

181 
by‹
 
	mbPad
[3];

183 } 
	tINDXROOT
, *
	tLPINDXROOT
;

185 
	sg_INDXHEAD
{

186 
u32
 
	mdw1IndxOff£t
;

187 
u32
 
	mdwIndxSize
;

188 
u32
 
	mdwInxAlcSize
;

189 
by‹
 
	mbFÏgs
;

190 
by‹
 
	mbPad
[3];

191 } 
	tINDXHEAD
, *
	tLPINDXHEAD
;

193 #´agm¨
·ck
()

198 
	mA‰ribu‹Snd¬dInfÜm©iÚ
 = 0x10,

199 
	mA‰ribu‹A‰ribu‹Li¡
 = 0x20,

200 
	mA‰ribu‹FeName
 = 0x30,

201 
	mA‰ribu‹ObjeùId
 = 0x40,

202 
	mA‰ribu‹Secur™yDesütÜ
 = 0x50,

203 
	mA‰ribu‹VŞumeName
 = 0x60,

204 
	mA‰ribu‹VŞumeInfÜm©iÚ
 = 0x70,

205 
	mA‰ribu‹D©a
 = 0x80,

206 
	mA‰ribu‹IndexRoÙ
 = 0x90,

207 
	mA‰ribu‹IndexAÎoÿtiÚ
 = 0xA0,

208 
	mA‰ribu‹B™m­
 = 0xB0,

209 
	mA‰ribu‹R•¬£Pošt
 = 0xC0,

210 
	mA‰ribu‹EAInfÜm©iÚ
 = 0xD0,

211 
	mA‰ribu‹EA
 = 0xE0,

212 
	mA‰ribu‹Prİ”tyS‘
 = 0xF0,

213 
	mA‰ribu‹LoggedUt™ySŒ—m
 = 0x100

214 } 
	tATTRIBUTE_TYPE
, *
	tPATTRIBUTE_TYPE
;

216 
‹¡_»ad_Áfs_h—d”
();

	@include/old/pmm.h

1 #iâdeà
PMM_H


2 
	#PMM_H


	)

3 
	~<v®Ty³.h
>

4 
	~<asm/·ge.h
>

8 
	#HEAP_BASE
 18*0x100000

	)

9 
	#HEAP_SIZE
 (64*0x100000)

	)

10 
	sem±y_blockk
{

11 
em±y_blockk
*
	m´ev
;

12 
em±y_blockk
*
	mÃxt
;

13 
	msize
;

14 }
	tEMPTY_BLOCK
;

15 
	#BLOCK_DATA_END
(
block
è(()((*)block+(
EMPTY_BLOCK
)+block->
size
-1))

	)

16 * 
km®loc0
(
by‹s
);

17 *
km®loc
(
by‹
);

18 
kä“
(*
±
);

19 
h—p_š™
();

20 
d–_node
(
EMPTY_BLOCK
*
block
);

21 
š£¹_aá”
(
EMPTY_BLOCK
*
mÙh”
,EMPTY_BLOCK*
block
);

	@include/old/proc.h

1 #iâdeà
PROC_H


2 
	#PROC_H


	)

3 
	~"v®Ty³.h
"

4 
	~<uts.h
>

5 
	~<ku_´oc.h
>

6 
	~<mm.h
>

7 
	~<asm/»sourû.h
>

8 
	~<lšux/mm.h
>

10 
	#P_NAME_MAX
 16

	)

12 
tss
 
ba£_tss
;

13 
	#g_tss
 (&
ba£_tss
)

	)

15 
pcb
 *
sk0
, *
sk1
;

18 
pcb
 *
	g__hs_pcb
;

19 
pcb
 *
	g__ext_pcb
;

24 
	#size_bufãr
 16

	)

26 
	mc
[
size_bufãr
];

27 
	mh—d
;

28 
	m
;

29 
	mnum
;

30 }
	tOBUFFER
;

36 
£ËùÜ_¶aš_c0
,
£ËùÜ_¶aš_d0
,
£ËùÜ_¶aš_c1
,
£ËùÜ_¶aš_d1
,
£ËùÜ_¶aš_c3
,
£ËùÜ_¶aš_d3
;

38 
	gd’Œy
; 
	gvfsmouÁ
; 
	gfe
;

39 
	sfs_¡ruù
{

40 
	mcouÁ
;

41 
d’Œy
 *
	mroÙ
, *
	mpwd
;

42 
vfsmouÁ
 *
	mroÙmÁ
, *
	mpwdmÁ
;

45 
	#NR_OPEN_DEFAULT
 32

	)

50 
	sfes_¡ruù
{

55 
	mmax_fds
;

56 
fe
 **
	mf•
;

57 
fe
 *
	mÜigš_f•
[
NR_OPEN_DEFAULT
];

58 
	mcouÁ
;

61 
	sth»ad
{

62 
	me¥
;

63 
	me
;

67 
	s±_»gs
{

68 
u32
 
	mebx
,
	mecx
,
	medx
,
	mesi
;

69 
u32
 
	medi
,
	mebp
,
	m—x
;

70 
u32
 
	mds
,
	mes
,
	mgs
,
	mfs
;

71 
u32
 
	m”r_code
;

72 
u32
 
	me
,
	mcs
,
	meæags
,
	me¥
,
	mss
;

73 }
	t¡ack_äame
;

75 
	#EFLAGS_STACK_LEN
 7

	)

76 
	seæags_¡ack
{

77 
	mba£
[
EFLAGS_STACK_LEN
 + 1];

78 
	me¥
;

80 
	#PCB_SIZE
 0x2000

	)

81 
	#THREAD_SIZE
 0x2000

	)

84 
	spcb
{

87 
	mÃed_»sched
;

88 
	msig³ndšg
;

89 
	m¡©e
;

90 
	mex™_¡©us
;

91 
pcb
 *
	m´ev
;

92 
pcb
 *
	mÃxt
;

93 
u32
 
	mpid
;

94 
	mp_Çme
[16];

95 
u32
 
	m´io
;

96 
u32
 
	mtime_¦iû
,
	mtime_¦iû_fuÎ
;

97 
u32
 
	mmsg_ty³
,
	mmsg_bšd
;

98 
mm
 *
	mmm
;

99 
th»ad
 
	mth»ad
;

100 
fs_¡ruù
 *
	mfs
;

101 
fes_¡ruù
 *
	mfes
;

102 
¾im™
 
	m¾im™s
[
RLIMIT_MAX
];

103 
eæags_¡ack
 
	mf¡ack
;

104 
u32
 
	mmagic
;

105 
li¡_h—d
 
	mchd»n
;

106 
li¡_h—d
 
	msiblšg
;

107 
pcb
 *
	mmÙh”
;

108 
pcb
 *
	mmÚ™Ü
;

109 
li¡_h—d
 
	m¦“p
;

110 
u32
 
	m__sk_¡ruù_’d
;

112 
	m·dd’
[
PCB_SIZE
-(
¡ack_äame
)];

114 
¡ack_äame
 
	m»gs
;

118 
	#cu¼’t
 (
	`g‘_cu¼’t
())

	)

119 
pcb
 *
g‘_cu¼’t
();

121 
	~<lšux/fs.h
>

122 
	stss
{

123 
	mback_lšk
,
	m__blh
;

124 
	me¥0
;

125 
	mss0
,
	m__ss0h
;

126 
	me¥1
;

127 
	mss1
,
	m__ss1h
;

128 
	me¥2
;

129 
	mss2
,
	m__ss2h
;

130 
	mü3
;

131 
	me
;

132 
	meæags
;

133 
	m—x
,
	mecx
,
	medx
,
	mebx
;

134 
	me¥
;

135 
	mebp
;

136 
	mesi
;

137 
	medii
;

138 
	mes
, 
	m__esh
;

139 
	mcs
, 
	m__csh
;

140 
	mss
, 
	m__ssh
;

141 
	mds
, 
	m__dsh
;

142 
	mfs
, 
	m__fsh
;

143 
	mgs
, 
	m__gsh
;

144 
	mldt
, 
	m__ldth
;

145 
	mŒaû
, 
	mb™m­
;

146 
	m__ÿch–še_fËr
[5] ;

150 
	#SET_PID_EAX
(
pid
,
»tuº_v®
è
pcb_bË
[pid].
»gs
.
—x
=
	)
»tuº_v®

152 
fœe
(
pcb
 *
p
);

153 
fœe_asm
(
u32
 
addr_pcb
);

154 
´oc_š™
();

155 
pcb
 * 
ü—‹_´oûss
(
u32
 
addr
,
´io
,
time_¦iû
,*
p_Çme
);

157 
obufãr_š™
(
OBUFFER
* 
±_obufãr
);

158 
obufãr_push
(
OBUFFER
* 
±_obufãr
,
c
);

159 
obufãr_shiá
(
OBUFFER
* 
±_obufãr
);

170 
	#__f¡ack
 (
cu¼’t
->
f¡ack
)

	)

171 
šlše
 
	$şi_push
(){

172 
__asm__
 
	`__vŞ©e__
("pushfl\n\t"

175 :"ô"(
__f¡ack
.
ba£
[++__f¡ack.
e¥
])

177 if(
__f¡ack
.
e¥
 =ğ
EFLAGS_STACK_LEN
è
	`¥š
("eflags stack overflow !");

178 
	}
}

180 
šlše
 
	$¡i_push
(){

181 
e¥
 = 
__f¡ack
.esp;

182 
__asm__
 
	`__vŞ©e__
("pushfl\n\t"

185 :"ô"(
__f¡ack
.
ba£
[++
e¥
])

187 if(
e¥
 =ğ
EFLAGS_STACK_LEN
è
	`¥š
("eflags stack overflow !");

188 
__f¡ack
.
e¥
 =ƒsp;

189 
	}
}

191 
šlše
 
	$æagi_pİ
(){

192 if(
__f¡ack
.
e¥
 =ğ-1è
	`¥š
("eflags stack bottom boundary!");

193 
__asm__
 
	`__vŞ©e__
("pushfl\n\t"

198 :"r"(
__f¡ack
.
ba£
[__f¡ack.
e¥
--] & (1<<9) )

201 
	}
}

202 
š™_pcb
(
pcb
 *
baby
,
u32
 
addr
,
´io
,
time_¦iû
,*
p_Çme
);

203 
fœe_th»ad
(
pcb
 *
p
);

206 
®loc_pid
(
pid
);

208 
šlše


209 
fes_¡ruù
 *
	$g‘_fes
(
fes_¡ruù
 *
fes
){

210 
fes
->
couÁ
++;

211  
fes
;

212 
	}
}

213 
put_fes
(
fes_¡ruù
 *
fes
);

216 
put_fs
(
fs_¡ruù
 *
fs
);

217 
šlše


218 
fs_¡ruù
 *
	$g‘_fs
(
fs_¡ruù
 *
fs
){

219 
fs
->
couÁ
++;

220  
fs
;

221 
	}
}

223 
Œy_»Ëa£_kºl_»sourû
(
pcb
 *
p
);

224 
Œy_»Ëa£_u£r_¥aû
(
mm
 *mm);

225 
__»Ëa£_mm
(
mm
 *mm);

234 
šlše
 

235 
	$put_mm
(
mm
 *
th©
){

236 
th©
->
u£rs
--;

237 if(
th©
->
u£rs
 == 0){

238 
	`__»Ëa£_mm
(
th©
);

240 
	}
}

242 
šlše
 
mm
 *

243 
	$g‘_mm
(
mm
 *
th©
){

244 
th©
->
u£rs
++;

245  
th©
;

246 
	}
}

248 
¦ab_h—d
 *
fs_¡ruù_ÿche
, *
fes_¡ruù_ÿche
;

	@include/old/ramdisk.h

1 #iâdeà
RAMDISK_H


2 
	#RAMDISK_H


	)

3 
	~"asm_ÏbË.h
"

	@include/old/schedule.h

1 #iâdeà
SCHEDULE_H


2 
	#SCHEDULE_H


	)

3 
	~<v®Ty³.h
>

4 
	~<li¡.h
>

5 
ticks
;

9 
pcb
 *
	gli¡_aùive
;

14 
pcb
 *
	gli¡_expœe
;

16 
¦“p_aùive
(
pcb
 *
p
);

17 
scheduË
();

18 
wake_up
(
li¡_h—d
 *
roÙ
);

19 
¦“p_Ú
(
li¡_h—d
 *
roÙ
);

21 
	#__SAVE
()\

22 
__asm__
 
	`__vŞ©e__
(\

36 :"=m"(
cu¼’t
->
´egs
)\

38 )

	)

40 
kp_¦“p
(
u32
 
msg_ty³
,u32 
msg_bšd
);

	@include/old/struinfo.h

1 #iâdeà
STRUINFO_H


2 
	#STRUINFO_H


	)

3 
wÜkÚ
(*
p_¡ru
,**
p_Çmes
,*
p_widths
,*
p_Ëns
,
memb”s
);

4 
¡rušfo
();

6 
	#WORKON
(
INSTANCE
,
STRU_NAME
è
	`wÜkÚ
((*)INSTANCE,
memb”Çme_
##STRU_NAME,
memb”width_
##STRU_NAME,
memb”Ën_
##STRU_NAME,(memb”Çme_##STRU_NAME)/4)

	)

	@include/old/time.h

1 #iâdeà
TIME_H


2 
	#TIME_H


	)

4 
š™_time
();

	@include/old/tty.h

1 #iâdeà
TTY_H


2 
	#TTY_H


	)

3 
	~<v®Ty³.h
>

4 
	gglob®_‹xt_µg
;

5 
»£t_cmd_asciis
();

6 
g‘ch¬
();

7 
·r£_cmd_asciis
();

8 
wr™e_cmd_asciis
(
ascii
);

9 
show_dœ
(*
buf
);

	@include/old/utils.h

1 #iâdeà
UTILS_H


2 
	#UTILS_H


	)

3 
	~<ku_uts.h
>

4 
	~<lšux/myli¡.h
>

5 
	~<v®Ty³.h
>

6 
	~<lšux/as£¹.h
>

7 
	~<lšux/by‹Üd”/g’”ic.h
>

8 
	~<lšux/¡ršg.h
>

9 
	~<lšux/k™.h
>

11 
šlše
 
	$¡r_hash
(cÚ¡ *
¡r
, 
Ën
){

12 
£ed
 = 131;

13 
hash
 = 0;

14 
i
 = 0; i < 
Ën
; i++è
hash
 = hash * 
£ed
 + 
¡r
[i];

16  
hash
;

17 
	}
}

19 
šlše
 
	$__BSR
(
x
){

20 
highe¡
;

21 
__asm__
 
	`__vŞ©e__
("bsr %1, %0"

22 :"ô"(
highe¡
)

23 :"r"(
x
)

25  
highe¡
;

26 
	}
}

28 
	~<mm.h
>

32 
	#»tuº_§y
(
msg
èdo{
	`İrštf
("%s",msg);;} 0)

	)

33 
	#»tuºx_§y
(
x
,
msg
èdo{
	`İrštf
("%s",msg); x;} 0)

	)

35 
d‘eù_ıu
();

36 
di¥AX
();

37 
di¥EAX
();

38 
di¥SŒ
(cÚ¡*cÚ¡ 
±
,
ahMod
);

39 
di¥IÁ
();

40 
di¥SŒn
(cÚ¡*cÚ¡ 
±
,
ahMod
);

41 
š_by‹
(
pÜt
);

42 
u32
 
š_dw
(
pÜt
);

43 
out_by‹
(
pÜt
,
v®ue
);

44 
out_dw
(
pÜt
,
u32
 
v®ue
);

45 
ršg
,
·th_ršg0
,
›Á”
,
¡ack_pos™iÚ
,
üack_e
;

46 
pÜt_»ad
(
pÜt
,*
buf
,
by‹
);

47 
pÜt_wr™e
(
pÜt
,*
buf
,
by‹
);

48 
£nd_hd_eoi
();

49 
¥š
(*
msg
);

63 
b™sÿn111
(
u32
 
addr
, 
num_111
, 
scİe
);

69 
b™£t
(
u32
 
addr
,
b™_off
);

71 
b™ş—r
(
u32
 
addr
, 
b™_off
);

77 
b™s£t
(
u32
 
addr
, 
b™_off
, 
num
);

79 
b™sş—r
(
u32
 
addr
, 
b™_off
, 
num
);

84 
boŞ
 
b™s£t_lÚg
(
u32
 
addr
, 
b™_off
, 
num
);

85 
boŞ
 
b™sş—r_lÚg
(
u32
 
addr
, 
b™_off
, 
num
);

87 
b™1_couÁ
(*
addr
,
by‹s
);

88 
memıy
(*
de¡
,*
¤c
,
by‹s
);

90 
	#DSI
(
¡r
,
i
)\

91 
	`di¥SŒ
(
¡r
,0x400);\

92 
	`di¥IÁ
(
i
);

	)

94 
boŞ—n
 
¡rm©ch
(*
£g
,*
whŞe
);

95 
šfo_h—p
();

113 
	#MEMBER_OFFSET
(
¡ru_ty³
, 
memb”_Çme
) \

114 Ğ()&(((
¡ru_ty³
 *)0)->
memb”_Çme
è)

	)

116 
mem‹¡
(*, 
Ën
);

117 
ud–ay
(
u£cs
);

120 
šlše
 
	$__RDTSC_U
(){

121 
tsc
;

122 
__asm__
 
	`__vŞ©e__
("rdtsc\n\t"

126 :"=d"(
tsc
));

127  
tsc
;

128 
	}
}

130 
šlše
 
	$__RDTSC
(){

131 
tsc
;

132 
__asm__
 
	`__vŞ©e__
("rdtsc\n\t"

136 :"=d"(
tsc
));

137  
tsc
;

138 
	}
}

140 
šlše
 
	$b¬r›r
(){

141 
__asm__
 
	`__vŞ©e__
("":::"memory");

142 
	}
}

144 
šlše
 
	$md–ay
(
ms
){

145 
cu¼
 = 
	`__RDTSC
();

146 
şock
 = 
cu¼
 + 
ms
;

148 
	`b¬r›r
();

149 if(
	`__RDTSC
(è>ğ
şock
) ;

151 
	}
}

153 
šlše
 
	$şi
(){

154 
__asm__
 
	`__vŞ©e__
("cli");

155 
	}
}

157 
šlše
 
	$¡i
(){

158 
__asm__
 
	`__vŞ©e__
("sti");

159 
	}
}

165 
šlše
 
boŞ
 
	$şi_ex
(){

166 
IF
;

167 
__asm__
 
	`__vŞ©e__
("pushf\n\t"

171 :"ô"(
IF
)

173  
IF
;

174 
	}
}

176 
šlše
 
	$g‘_eæags
(){

177 
eæags
;

178 
__asm__
 
	`__vŞ©e__
("pushfl\n\t"

180 :"ô"(
eæags
)

182  
eæags
;

183 
	}
}

185 
šlše
 
boŞ
 
	$şi_®»ady
(){

186 
eæags
 = 
	`g‘_eæags
();

187  !(
eæags
 & (1 << 9)) ;

188 
	}
}

190 
šlše
 
boŞ
 
	$¡i_®»ady
(){

191  !
	`şi_®»ady
();

192 
	}
}

193 
	#MAKE_IP
(
a
, 
b
, 
c
, 
d
è((×)<<24è+ ((b)<<16è+ ((c)<<8è+ d)

	)

194 *
MAKE_IP_STR
(
u32
 

);

195 
İrštf
(*
fÜm©
,...);

196 
šlše
 
	$´št_mac
(
u8
 * 
mac
){

197 
	`İrštf
(" %x %x %x %x %x %x ", 
mac
[0], mac[1], mac[2], mac[3], mac[4], mac[5]);

198 
	}
}

199 
šlše
 
	$´št_
(
u32
 

){

200 
	`İrštf
(" %u.%u.%u.%u ", 

>>24&0xff, ip>>16&0xff, ip>>8&0xff, ip&0xff);

201 
	}
}

203 
	#ARR_CELLS
(
¬¿y
, 
¡ru_t
èĞ×¼ayè/ (¡ru_t))

	)

204 
»ad_imr_of8259
();

218 
u16
 
üc16_compu‹_be
(*
¬—
, 
Ën
);

227 
šlše
 
u16
 
	$üc16_wr™e_be
(*
¬—
, 
Ën
, 
u16
 *
chksum
){

228 *
chksum
 = 0;

229 
u16
 
x
 = 
	`üc16_compu‹_be
(
¬—
, 
Ën
);

230 *
chksum
 = 
	`htÚs
(~
x
);

231  
x
;

232 
	}
}

234 
__Ëss
(*
buf
, 
Ën
);

236 
memcmp
(*
s1
, *
s2
, 
Ën
);

237 
	s__—x
 { 
u8
 
	m®
; u8 
	mah
; u8 
	mAL
; u8 
	mAH
;};

238 * 
mk_¡r
(
u32
 

);

240 
__bs0s
(*);

	@include/old/valType.h

2 #iâdeà
VALTYPE_H


3 
	#VALTYPE_H


	)

5 
	#boŞ
 
_BoŞ


	)

6 
	#boŞ—n
 
_BoŞ


	)

7 
	#Œue
 1

	)

8 
	#çl£
 0

	)

9 
	#__DEBUG


	)

11 #iâdeà
NULL


12 
	#NULL
 0

	)

15 
	tulÚg
;

16 
	tu64
;

17 
	tu8
;

18 
	tu16
;

19 
	tu32
;

20 sigÃd 
	ts8
;

21 sigÃd 
	ts16
;

22 sigÃd 
	ts32
;

24 
	tsize_t
;

27 
	tby‹
;

28 
	tušt64_t
;

29 
	tšt64_t
;

33 
	t__Ë32
;

34 
	t__u32
;

35 
	t__Ë16
;

36 
	t__u16
;

37 
	t__u8
;

38 
	tElf32_WÜd
;

39 
	tElf32_Off
;

40 
	tElf32_Addr
;

41 
	tElf32_H®f
;

42 
	sdesütÜr
{

43 
u16
 
	mlim™_01
;

44 
u16
 
	mba£_01
;

45 
u8
 
	mba£_2
;

46 
u8
 
	m©Œ1
;

47 
u8
 
	mlim™_©Œ
;

48 
u8
 
	mba£_3
;

50 }
	tDESCRIPTOR
;

54 vŞ©
	mcouÁ”
;

55 }
	t©omic_t
;

59 
	#__1K
 1024

	)

60 
	#__4K
 0x1000

	)

61 
	#__8K
 0x2000

	)

62 
	#__1M
 0x100000

	)

63 
	#__4M
 0x400000

	)

64 
	#__1G
 0x40000000

	)

65 
	#__3G
 0xc0000000

	)

	@include/old/video_drv.h

1 #iâdeà
VIDEO_DRV_H


2 
	#VIDEO_DRV_H


	)

5 
	#CRTC_ADDR_REG
 0x3D4

	)

6 
	#CRTC_DATA_REG
 0x3D5

	)

7 
	#START_ADDR_H
 0xC

	)

8 
	#START_ADDR_L
 0xD

	)

9 
	#CURSOR_H
 0xE

	)

10 
	#CURSOR_L
 0xF

	)

11 
	#V_MEM_BASE
 0xB8000

	)

12 
	#V_MEM_SIZE
 0x8000

	)

14 
£t_cursÜ
(
pos
);

15 
£t_¡¬t
(
pos
);

16 
g‘_¡¬t
();

	@irq.c

1 
	~<lšux/”ºo.h
>

2 
	~<œq.h
>

3 
	~<´oc.h
>

4 
	~<lšux/bh.h
>

5 
	~<i8259.h
>

6 
	~<lšux/´štf.h
>

7 
u32
 
	gcouÁ_œq_’‹r
, 
	gcouÁ_œq_out
;

8 
hªdË_IRQ_ev’t
(
œq
, 
±_»gs
 *);

9 
£tup_œq
(
œq
, 
œqaùiÚ
 *
Ãw
);

15 
»que¡_œq
(
œq
, (*
hªdËr
)(, *, 
±_»gs
 *), 
æags
, *
dev
){

16 if(
œq
 < 0 || irq >=
NR_IRQS
 || !
hªdËr
è -
EINVAL
;

18 
œqaùiÚ
 *
aùiÚ
 = 
	`km®loc
((irqaction));

19 
aùiÚ
->
func
 = 
hªdËr
;

20 
aùiÚ
->
æags
 = flags;

21 
aùiÚ
->
dev
 = dev;

22 
aùiÚ
->
Ãxt
 = 0;

24 
»tv®
 = 
	`£tup_œq
(
œq
, 
aùiÚ
);

25 if(
»tv®
è
	`kä“
(
aùiÚ
);

26  
»tv®
;

27 
	}
}

29 
	$£tup_œq
(
œq
, 
œqaùiÚ
 *
Ãw
){

35 
œqaùiÚ
 *
cu¼
 = 
œq_desc
[
œq
].
aùiÚ
;

36 if(!
cu¼
è
œq_desc
[
œq
].
aùiÚ
 = 
Ãw
;

38 
cu¼
->
Ãxt
) curr = curr->next;

39 
cu¼
->
Ãxt
 = 
Ãw
;

42 
	}
}

47 
	$do_IRQ
(
¡ack_äame
 
»gs
){

48 
couÁ_œq_’‹r
++;

49 
”r_code
 = 
»gs
.err_code + 256;

50 
œq
 = 
”r_code
 - 0x20;

52 
œq_desc_t
 *
desc
 = 
œq_desc
 + 
œq
;

53 
¡©us
 = 
desc
->status;

55 
u16
 
i¤
 = 
	`pic_g‘_i¤
();

56 
u16
 
imr
 = 
	`»ad_imr_of8259
();

57 
œq
){

59 
	`as£¹
(!(
i¤
 >> 15));

60 
	`as£¹
(
imr
 >> 15);

61 
	`out_by‹
(0x20, 0x20);

63 
	`as£¹
(!(
i¤
 & 0x80));

64 
	`as£¹
(
imr
 & 0x80);

68 
desc
->
hw_hªdËr
->
	`ack
(
œq
);

70 if(
œq
 == 1){

72 
key_code
=
	`š_by‹
(0x60);

73 
	`İrštf
("dÚ'ˆu£ keybßrd..‡ bug oÀœq_út_š may‡Ì—dy h­³nd, *%x* ", 
key_code
);

74 
__Ëss_go
;

75 if(
key_code
 <ğ0x34è
__Ëss_go
 = 
Œue
;

80 if(!
desc
->
aùiÚ
 || 
¡©us
 & (
IRQ_INPROCESS
 | 
IRQ_DISABLED
)){

81 
desc
->
¡©us
 |ğ
IRQ_PENDING
;

84 
out
;

88 
desc
->
¡©us
 |ğ
IRQ_INPROCESS
;

92 
	`hªdË_IRQ_ev’t
(
œq
, &
»gs
);

95 if(!(
desc
->
¡©us
 & 
IRQ_PENDING
)) ;

96 
desc
->
¡©us
 &ğ~
IRQ_PENDING
;

98 
out
:

101 
desc
->
¡©us
 &ğ~
IRQ_INPROCESS
;

102 
desc
->
hw_hªdËr
->
	`’d
(
œq
);

105 if(
bh_æags
 & 
BH_FLAG_DISABLE
){

106 
bh_cŞlisiÚ_couÁ
 = 0;

107 
bh_cŞlisiÚ_couÁ
++;

108 
t™Ë
[] = {'B', 'H', 0xAE, 0};

109 
buf
[16];

110 
	`¥rštf
(
buf
, " %u", 
bh_cŞlisiÚ_couÁ
);

111 
	`wr™e_b¬
(1, 0, 
t™Ë
, 
buf
);

114 
	`do_bh
();

116 
couÁ_œq_out
++;

118 
	}
}

120 
boŞ
 
	$š_š‹¼u±
(){

121  
couÁ_œq_’‹r
 !ğ
couÁ_œq_out
;

122 
	}
}

126 
	$hªdË_IRQ_ev’t
(
œq
, 
±_»gs
 *
´egs
){

127 
¡©us
 = 0;

128 
œqaùiÚ
 *
aùiÚ
 = 
œq_desc
[
œq
].action;

130 
aùiÚ
){

132 if(!(
aùiÚ
->
æags
 & 
SA_INTERRUPT
)){

133 
	`¥š
("sti‚ow");

134 
__asm__
 
	`__vŞ©e__
 ("sti");

136 
aùiÚ
->
	`func
(
œq
,‡ùiÚ->
dev
, 
´egs
);

137 
__asm__
 
	`__vŞ©e__
 ("cli");

139 
aùiÚ
 =‡ùiÚ->
Ãxt
;

142  
¡©us
;

143 
	}
}

	@kernel.asm

1 ; {
symbŞ


2 
glob®
 
NEED_RESCHED_OFFSET


4 
REGS_FS_OFFSET
 
equ
 (10*4)

5 
REGS_ERR_CODE_OFFSET
 
equ
 (11*4)

6 
REGS_CS_OFFSET
 
equ
 (13*4)

7 
NEED_RESCHED_OFFSET
 
equ
 (0)

8 
SIGPENDING_OFFSET
 
equ
 (2*4)

11 
LATCH
 
	gequ
 1193180/100

12 
do_IRQ


13 
İrštf


14 
¥š


16 
glob®
 
»t_äom_sys_ÿÎ


17 
glob®
 
·ge_çuÉ


18 
glob®
 
»¡Üe_®l


19 
glob®
 
£ËùÜ_room_¶aš


20 
glob®
 
£ËùÜ_video


21 
glob®
 
£ËùÜ_¶aš_c3
,
£ËùÜ_¶aš_d3
,
£ËùÜ_¶aš_c1
,
£ËùÜ_¶aš_d1
,
£ËùÜ_¶aš_c0
,
£ËùÜ_¶aš_d0
;

22 
glob®
 
£c_d©a


23 
glob®
 
tss


24 
glob®
 
i20h


25 
glob®
 
p3


26 
glob®
 
outoåroc


27 
glob®
 
ba£_tss


28 
func_bË


29 
wake_hs
,
do_·ge_çuÉ
, 
do_b»akpošt_çuÉ
, 
do_g’”®_´Ùeù_çuÉ


30 
no_»’‹r


31 
dump_sys


32 
key_hªdËr


33 
š™8253


34 
k”Ãl_c


35 
š™8259A


36 
do_tim”
,
scheduË
,
ticks


38 ;
edi
 
	gequ
 7e00
h


39 
ba£_k”ÃlSck
 
	gequ
 0ffã
	gh
 ; 
	gk”Ãl
-
¡ack
 
¿nge
 
	gäom
 0ffã
h
 
	gto
 7f00h,
	gabout
 32
kb


41 
ba£_‹xt
 
equ
 
	gba£_k”Ãl_»£t
+0xc0000000

42 
ba£_tss
 
equ
 
	gba£_‹xt
 + (
	gtss
 -
	g_¡¬t
)

43 ;}
’d
 
	gsymbŞ


45 %
	gšşude
 "include/old/pm.inc"

46 %
	gšşude
 "include/old/utils.inc"

47 %
	gšşude
 "bootinfo.asm"

49 
glob®
 
	g_¡¬t


50 [
£ùiÚ
 .
‹xt
]

51 
	g_¡¬t
:

52 
mov
 
e¥
,0xc0300000 ;ä½¿ç”¨3
	gM
å¤„çš„åœ°å€ä½œä¸ºå †æ ˆ,ä¸ä¼šç ´å
buddy
 
	gsy¡em
å—

53 
jmp
 
	g_»®ly¡¬t


54 ;
¡Üe
 
some
 
d©a


55 
	gtss
:

56 
TSS1
 
£ËùÜ_¶aš_d0
,
	gršg0_sm®l¡ack_bÙtom
, 0, 0, 0, 0

57 
Ën_tss
 
equ
 
	g$
 - 
tss


59 
	g_»®ly¡¬t
:

60 
lgdt
 [
gdtPŒ
] ; 
	ggdt
,
£ËùÜ
 
ds
 
´•¬ed
 
duršg
 
	gboÙ
.
bš


61 
jmp
 
	g£ËùÜ_¶aš_c0
:
Ãwcs
 ;
upd©e
 
cs


63 
	gÃwcs
:
nİ


64 ;{
š™


65 
	gpush
 11931 ;1193180/100

66 
ÿÎ
 
	gš™8253
 ; 
	gš™
 8253

69 ;
	gIRQ0


70 ; 
	gTime


72 ;
	gIRQ1


73 ; 
	gKeyBßrd


75 ;
	gIRQ2


76 ; 
Redœeù
 
	gIRQ9


77 ; ä¸
	gIRQ9
ç›¸æ¥ï¼Œ
	gMPU
-401 
	gMDI
ä½¿ç”¨è¯¥
	gIRQ


78 ;
	gIRQ3


79 ; 
	gCOM2


81 ;
	gIRQ4


82 ; 
	gCOM1


84 ;
	gIRQ5


85 ; 
	gLPT2


86 ; å»ºè®®å£°å¡ä½¿ç”¨è¯¥
	gIRQ


87 ;
	gIRQ6


88 ; 
	gFDD


90 ;
	gIRQ7


91 ; 
	gLPT1


93 ;
	gIRQ8


94 ; 
CMOS
 
	gAË¹


96 ;
	gIRQ9


97 ; 
Redœeù
 
	gIRQ2


98 ; ä¸
	gIRQ2
ç›¸æ¥ï¼›å¯è®¾å®šç»™å…¶å®ƒç¡¬ä»¶ä½¿ç”¨

99 ;
	gIRQ10


100 ; 
	gRev”£d


101 ; å»ºè®®ä¿ç•™ç»™ç½‘å¡ä½¿ç”¨è¯¥
	gIRQ


102 ;
	gIRQ11


103 ; 
	gRev”£d


104 ; å»ºè®®ä¿ç•™ç»™
	gAGP
æ˜¾å¡ä½¿ç”¨

105 ;
	gIRQ12


106 ; 
	gPS
/2
	gMou£


107 ; æ¥
	gPS
/2é¼ æ ‡ï¼Œè‹¥æ— ä¹Ÿå¯è®¾å®šç»™å…¶ä»–ç¡¬ä»¶ä½¿ç”¨

108 ;
	gIRQ13


109 ; 
	gFPU


110 ; åå¤„ç†å™¨ç”¨ï¼Œä¾‹å¦‚
	gFPU
ï¼ˆæµ®ç‚¹è¿ç®—å™¨ï¼‰

111 ;
	gIRQ14


112 ; 
Prim¬y
 
	gIDE


113 ; 
	gIDE0
ä¼ è¾“æ§åˆ¶ç”¨

114 ;
	gIRQ15


115 ; 
SecÚd¬y
 
	gIde


116 ; 
	gIDE1
ä¼ è¾“æ§åˆ¶ç”¨

118 
add
 
	ge¥
,4

119 ;
	gpush
 11111000b

120 
	gpush
 11011000b

121 
ÿÎ
 
	gš™8259A
 ; 
	gš™
 8259A

122 
add
 
	ge¥
,4

123 ;
š™
 
	g£gm’t
-
»gs


124 
mov
 
	gax
, 
£ËùÜ_¶aš_d0


125 
mov
 
	gfs
, 
ax


126 
mov
 
	gss
, 
ax


127 
mov
 
	gds
, 
	gax


128 ;
mov
 
	ge¥
, 
	gba£_k”ÃlSck
 ; 
the
 
¡ack
 
¡¬t
 
	g©
 7f00
h
 
ERR
 
be
 
ÿ»
 ¡ack 
wl
 
boed


129 
mov
 
	gax
, 
£ËùÜ_video


130 
mov
 
	ggs
, 
ax


131 
mov
 
	ges
, 
	gax


132 ;
	g’d


134 ;
£t
 
idt


135 
şi


136 
	glidt
 [
idtPŒ
]

137 
mov
 
	gax
,
£ËùÜ_tss


138 
Ér
 
	gax


139 ;
	gdÚe


142 
jmp
 
	gk”Ãl_c
;

144 ;{
exû±iÚ
 
hªdËr


145 
	gexû±iÚ_hªdËr
:

146 
divide_”rÜ
:

147 
§ve


148 
jmp
 
exû±iÚ_hªdËr_¡•1


149 
Ën_divide_”rÜ
 
equ
 
$
 - 
divide_”rÜ


151 
sšgË_¡•
:

152 
push
 0

153 
push
 
do_b»akpošt_çuÉ


154 
jmp
 
”rÜ_code


155 
Ën_sšgË_¡•
 
equ
 
$
 - 
sšgË_¡•


157 
nmi
:

158 
push
 0xffffffff

159 
push
 2

160 
jmp
 
exû±iÚ_hªdËr_¡•1


161 
Ën_nmi
 
equ
 
$
 - 
nmi


163 
b»akPošt
:

164 
push
 0

165 
push
 
do_b»akpošt_çuÉ


166 
jmp
 
”rÜ_code


168 
Ën_b»akPošt
 
equ
 
$
 - 
b»akPošt


170 
ov”æow
:

171 
push
 0xffffffff

172 
push
 4

173 
jmp
 
exû±iÚ_hªdËr_¡•1


174 
Ën_ov”æow
 
equ
 
$
 - 
ov”æow


176 
bounds_check
:

177 
push
 0xffffffff

178 
push
 5

179 
jmp
 
exû±iÚ_hªdËr_¡•1


181 
Ën_bounds_check
 
equ
 
$
 - 
bounds_check


183 
šv®_İcode
:

184 
push
 0xffffffff

185 
push
 6

186 
jmp
 
exû±iÚ_hªdËr_¡•1


187 
Ën_šv®_İcode
 
equ
 
$
 - 
šv®_İcode


189 
cİr_nÙ_avŸÏbË
:

190 
push
 0xffffffff

191 
push
 7

192 
jmp
 
exû±iÚ_hªdËr_¡•1


193 
Ën_cİr_nÙ_avŸÏbË
 
equ
 
$
 - 
cİr_nÙ_avŸÏbË


195 
doubË_çuÉ
:

196 
push
 8

197 
jmp
 
exû±iÚ_hªdËr_¡•1


198 
Ën_doubË_çuÉ
 
equ
 
$
 - 
doubË_çuÉ


200 
cİr_£g_ov”run
:

201 
push
 0xffffffff

202 
push
 9

203 
jmp
 
exû±iÚ_hªdËr_¡•1


204 
Ën_cİr_£g_ov”run
 
equ
 
$
 - 
cİr_£g_ov”run


206 
šv®_tss
:

207 
push
 10

208 
jmp
 
exû±iÚ_hªdËr_¡•1


209 
Ën_šv®_tss
 
equ
 
$
 - 
šv®_tss


211 
£gm’t_nÙ_´e£Á
:

212 
push
 11

213 
jmp
 
exû±iÚ_hªdËr_¡•1


214 
Ën_£gm’t_nÙ_´e£Á
 
equ
 
$
 - 
£gm’t_nÙ_´e£Á


216 
¡ack_”rÜ
:

217 
push
 12

218 
jmp
 
exû±iÚ_hªdËr_¡•1


219 
Ën_¡ack_”rÜ
 
equ
 
$
 - 
¡ack_”rÜ


222 ; 
A
 
G’”®
 
PrÙeùiÚ
 
FauÉ
 
may
 
occur
 
v¬ious
 
	g»asÚs
. 
The
 
mo¡
 
commÚ
 
	g¬e
:

224 ; 
Segm’t
 
”rÜ
 (
´ivege
, 
ty³
, 
lim™
, 
»ad
/
wr™e
 
rights
).

225 ; 
Executšg
 
a
 
´iveged
 
š¡ruùiÚ
 
	gCPL
 != 0.

226 ; 
Wr™šg
 
	ga
 1 
š
 
a
 
»£rved
 
	gf›ld
.

227 ; 
Reã»ncšg
 
Ü
 
acûssšg
 
a
 
	gnuÎ
-
	gdesütÜ
.

229 ; 
E¼Ü
 
	gcode
: 
The
 
G’”®
 
PrÙeùiÚ
 
FauÉ
 
£ts
 
ª
 
”rÜ
 
code
, 
which
 
is
 
the
 
£gm’t
 
£ËùÜ
 
šdex
 
wh’
h
exû±iÚ
 i £gm’ˆ
	g»Ï‹d
. 
	gOth”wi£
, 0.

234 ; | 
	gRe£rved
 | 
	gIndex
 | 
	gTbl
 | 
	gE
 |

237 ; @
	gTbl


238 ; 2 
b™s
 
	gIDT
/
	gGDT
/
LDT
 
	gbË


239 ; 0b00 
The
 
S–eùÜ
 
Index
 
»ã»nûs
 
a
 
desütÜ
 
š
 
the
 
	gGDT
.

240 ; 0b01 
The
 
S–eùÜ
 
Index
 
»ã»nûs
 
a
 
desütÜ
 
š
 
the
 
	gIDT
.

241 ; 0b10 
The
 
S–eùÜ
 
Index
 
»ã»nûs
 
a
 
desütÜ
 
š
 
the
 
	gLDT
.

242 ; 0b11 
The
 
S–eùÜ
 
Index
 
»ã»nûs
 
a
 
desütÜ
 
š
 
the
 
	gIDT
.

243 ; @
	gE


244 ; 1 
b™
 
	gEx‹º®


245 ; 
Wh’
 
	g£t
, 
the
 
exû±iÚ
 
Üigš©ed
 
ex‹º®ly
 
to
h
	g´oûssÜ
.

247 
	gg’”®_´ÙeùiÚ
:

248 
push
 
do_g’”®_´Ùeù_çuÉ


249 
jmp
 
”rÜ_code
;

250 
Ën_g’”®_´ÙeùiÚ
 
equ
 
	g$
 - 
g’”®_´ÙeùiÚ


252 
	gcİr_”rÜ
:

253 
push
 0xffffffff

254 
push
 16

255 
jmp
 
exû±iÚ_hªdËr_¡•1


256 
Ën_cİr_”rÜ
 
equ
 
$
 - 
cİr_”rÜ


258 
exû±iÚ_hªdËr_¡•1
:

259 
jmp
 
$
 ; 
	gdÚ
'ˆwªˆtØhªdËhe£ƒxû±iÚ‚ow, ju¡ bËs they wÚ'
t
 
h­³n


260 
mov
 
	gax
, [
e¥
+4]

261 
cmp
 
	gax
, 0ffff
h


262 
	gje
 .
	gno_”rÜ_code


263 .
	gouut_”rÜ_code
:

264 
jmp
 .
ş—nSck


265 .
no_”rÜ_code
:

266 .
ş—nSck
:

267 
add
 
e¥
, 8 ;
have
 
checked
‡dd 
	ge¥
,8 
	gcÜ»ù


269 .
	g’dOfhªdËr
:

270 
mov
 
—x
, [
e¥
+8]

271 
ÿÎ
 
dump_sys


272 
jmp
 
$


273 
	gœ‘d


275 ; 
tim”
 
š‹¼u±


276 
	gi20h
:

277 
push
 0x20 - 256

278 
jmp
 
commÚ_š‹¼u±


279 ; 
keybßrd
 
š‹¼u±


280 
	gi21h
:

281 
push
 0x21 - 256

282 
jmp
 
commÚ_š‹¼u±


283 
i22h
:

284 
push
 0x22 - 256

285 
jmp
 
commÚ_š‹¼u±


286 
i23h
:

287 
push
 0x23 - 256

288 
jmp
 
commÚ_š‹¼u±


289 
i24h
:

290 
push
 0x24 - 256

291 
jmp
 
commÚ_š‹¼u±


292 
i25h
:

293 
push
 0x25 - 256

294 
jmp
 
commÚ_š‹¼u±


295 
i26h
:

296 
push
 0x26 - 256

297 
jmp
 
commÚ_š‹¼u±


298 
i27h
:

299 
push
 0x27 - 256

300 
jmp
 
commÚ_š‹¼u±


301 
i28h
:

302 
push
 0x28 - 256

303 
jmp
 
commÚ_š‹¼u±


304 
i29h
:

305 
push
 0x29 - 256

306 
jmp
 
commÚ_š‹¼u±


307 
i2ah
:

308 
push
 0x2a - 256

309 
jmp
 
commÚ_š‹¼u±


310 
i2bh
:

311 
push
 0x2b - 256

312 
jmp
 
commÚ_š‹¼u±


313 
i2ch
:

314 
push
 0x2c - 256

315 
jmp
 
commÚ_š‹¼u±


316 
i2dh
:

317 
push
 0x2d - 256

318 
jmp
 
commÚ_š‹¼u±


319 
i2eh
:

320 
push
 0x2e - 256

321 
jmp
 
commÚ_š‹¼u±


322 
i2fh
:

323 
push
 0x2f - 256

324 
jmp
 
commÚ_š‹¼u±


327 
i30h
:

328 
jmp
 
$


329 
§ve


330 
mov
 
e¥
,[
k”Ãl_e¥
]

332 ; 
·ge
 
çuÉ


333 
	g·ge_çuÉ
:

334 ;æœ‰å‡ºé”™ç çš„ï¼ä¸è¦
	gpush
äº†

335 
push
 
	gdo_·ge_çuÉ
 ;è¿™ä¸ª
	gpush
ä½ç½®æœ¬è¯¥æ˜¯
	gfs
ã€‚

336 
jmp
 
”rÜ_code


338 
Ën_·ge_çuÉ
 
equ
 
	g$
 - 
	g·ge_çuÉ


340 ; 
sy¡em
 
ÿÎ


341 
	gi80
:

342 
push
 7 ;
no
 
”r_code


343 
	gSAVE_ALL
 ;å¯„å­˜å™¨å…¥æ ˆé¡ºåºçº¦å®šäº†

344 ;
SET_PREG


345 
ÿÎ
 
	gdwÜd
 [
—x
*4+
func_bË
]

346 
	gmov
 [
e¥
 + 4 *6], 
—x


347 
jmp
 
»t_äom_sys_ÿÎ


348 
	gi81
: ;
ª
 
	gI
-
g©e
 
k”Ãl
 
th»ad
 
to
 
subm™
 
theœ
 
time
 
	g¦iû
.

349 
OPRINTF
 
	g£c_d©a
.
¥š


350 
jmp
 
$


351 
	gpush
 0 ;
no
 
”r_code


352 
	g§ve


353 ;
§ve
 
cu¼’t
 
e¥
 
	gto
 'current->pregs'

354 
mov
 
	gesi
,
e¥


355 
ªd
 
	gesi
,0xffffe000

356 
	gmov
 [
esi
],
e¥


358 
ÿÎ
 
	gscheduË


359 ;
çr
 
away


360 
	g”rÜ_code
:

361 
SAVE_ALL_EXCEPT_FS


363 
mov
 
edi
, 
fs


364 
xchg
 
	gedi
, [
e¥
 + 
REGS_FS_OFFSET
]

365 
mov
 
	g—x
, -1

366 
	gxchg
 [
e¥
 + 
REGS_ERR_CODE_OFFSET
], 
	g—x


369 ;æœåŠ¡ä¾‹ç¨‹éƒ½éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œ
	g´eg
, 
”r_code


370 
mov
 
	gebx
, 
	ge¥
 ;e¥ç°åœ¨å°±æ˜¯
	g´eg
ï¼Œå…ˆå­˜èµ·æ¥

371 
push
 
	g—x
 ;
”rÜ
 
code


372 
push
 
	gebx
 ;* 
±_»gs


373 
ÿÎ
 
	gedi
 ;ÿÎ 
	gâ


376 
add
 
	ge¥
, 8

377 
jmp
 
	g»t_äom_exû±iÚ
 ;
run
 
away


381 
	gcommÚ_š‹¼u±
:

382 
SAVE_ALL


383 ;
SET_PREG


385 
push
 
»t_äom_šŒ


386 
jmp
 
do_IRQ


388 
	g»t_äom_exû±iÚ
:

389 ;dØ
possibË
 
soá
 
œq


390 
	g»t_äom_šŒ
:

391 
GET_CURRENT
(
ebx
)

392 ; 
mov
 
	gecx
, [
ebx
] ;
g‘
 
	g´egs


393 ;è‹¥ä¸­æ–­å‰å¤•æ˜¯å†…æ ¸æ€ï¼Œç›´æ¥
»¡Üe


394 
mov
 
	g—x
, [
e¥
 + 
REGS_CS_OFFSET
]

395 
ªd
 
	g—x
, 0x3

396 
cmp
 
	g—x
,0

397 
je
 
	g»¡Üe_®l
 ;å‰å¤•æ˜¯å†…æ ¸æ€ã€‚ å‘ç”Ÿåœ¨å†…æ ¸æ€çš„ä¸­æ–­ä¸ä¼šå¼•èµ·è°ƒåº¦ã€‚

398 
jmp
 
	g»t_w™h_»scheduË
 ;ä¸­æ–­å‰å¤•æ˜¯ç”¨æˆ·æ€

400 
	g»t_äom_sys_ÿÎ
:

401 
	$GET_CURRENT
(
ebx
)

402 
nİ
 ;dØ
soáœp
 
š
 
futu»
 
v”siÚ


404 
»t_w™h_»scheduË
:

405 
	$GET_CURRENT
(
ebx
)

406 
cmp
 
dwÜd
 [
ebx
 + 
NEED_RESCHED_OFFSET
], 1 ;éœ€è¦
»cheduË
å—

407 
je
 
»scheduË


408 
cmp
 
dwÜd
 [
ebx
 + 
SIGPENDING_OFFSET
], 1 ;æœ‰ä¿¡å·éœ€è¦å¤„ç†å—

409 
je
 
sigÇl_»tuº


411 
»¡Üe_®l
:

412 ;
	`GET_CURRENT
(
ebx
)

413 ;
mov
 
e¥
, [
ebx
] ;å¯¹
··ya
å†…æ ¸ï¼Œè¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸º
¡ackäame
çš„ä½ç½®ä¸å›ºå®šã€‚

414 
RESTORE_ALL


417 
»scheduË
:

418 
ÿÎ
 
scheduË


419 
jmp
 
»t_äom_sys_ÿÎ


421 
sigÇl_»tuº
:

422 
jmp
 
»¡Üe_®l


425 [
£ùiÚ
 .
d©a
]

426 
£c_d©a
:

427 .
¡r1
: 
db
 'h',0

428 .
¡r2
: 
db
 'hello world->wws',0

429 .
¡r3
: 
dd
 0,1,2,3,4,5,6,7,8,9

430 .
¥š
: 
db
 'spin',0

431 .
keybßrd
: 
db
 'keyboard IRQ', 0

432 .
IDE0
: 
db
 'IDE IRQ 2f' , 0

433 
msg
:
db
 'spin',0

435 
outoåroc
:

436 
dd
 1

437 
k”Ãl_e¥
:

438 
dd
 0

439 
ršg0_sm®l¡ack_tİ
:

440 .
”rcode
: 
dd
 0

441 
ršg0_sm®l¡ack_œ‘d
:

442 .
e
 : 
dd
 0

443 .
cs
 : 
dd
 0

444 .
eæags
: 
dd
 0

445 .
e¥
 : 
dd
 0

446 .
ss
 : 
dd
 0

447 
ršg0_sm®l¡ack_bÙtom
:

449 ; 
Ãw
 
gdt


450 
gdt
:

451 .
desc_em±y
: 
DesütÜ
 0,0,0

452 .
desc_¶aš_c0
 :
DesütÜ
 0, 0fffff
h
, 
DA_32
 | 
DA_C
 | 
DA_LIMIT_4K


453 .
desc_¶aš_d0
 :
DesütÜ
 0, 0fffff
h
, 
DA_DRW
 | 
DA_LIMIT_4K
+
DA_32


454 .
desc_¶aš_c1
 :
DesütÜ
 0, 0fffff
h
, 
DA_32
 | 
DA_C
 | 
DA_LIMIT_4K
+
DA_DPL1


455 .
desc_¶aš_d1
 :
DesütÜ
 0, 0fffff
h
, 
DA_32
 | 
DA_DRW
 | 
DA_LIMIT_4K
+
DA_DPL1


456 .
desc_¶aš_c3
 :
DesütÜ
 0, 0fffff
h
, 
DA_C
 | 
DA_LIMIT_4K
 + 
DA_DPL3
 + 
DA_32


457 .
desc_¶aš_d3
 :
DesütÜ
 0, 0fffff
h
, 
DA_DRW
 | 
DA_LIMIT_4K
 + 
DA_DPL3
 + 
DA_32


459 .
desc_video
 :
DesütÜ
 0b8000
h
, 0ffffh, 
DA_DRW
 + 
DA_32
 + 
DA_DPL3


460 .
desc_pgTbl
 :
DesütÜ
 
pgTblBa£
, 1023, 
DA_DRW
 | 
DA_LIMIT_4K
 + 
DA_32


461 .
desc_pgDœ
 :
DesütÜ
 
pgDœBa£
, 4095, 
DA_DRW
 + 
DA_32


462 .
desc_room_¶aš
:
DesütÜ
 0, 0fffff
h
, 
DA_DRW
 | 
DA_LIMIT_4K
 + 
DA_32
 + 
DA_DPL3


463 .
desc_tss
 :
DesütÜ
 
ba£_tss
, 
Ën_tss
 - 1, 
DA_386TSS


464 ; 
’d
 
of
 
Ãw
 
gdt


465 
Ën_gdt
 
equ
 
$
 - 
gdt


467 ;{
£ËùÜ
 
¡¬t


468 
£ËùÜ_¶aš_c0
 
equ
 
gdt
.
desc_¶aš_c0
 - gdt

469 
£ËùÜ_¶aš_d0
 
equ
 
gdt
.
desc_¶aš_d0
 - gdt

470 
£ËùÜ_¶aš_c1
 
equ
 
gdt
.
desc_¶aš_c1
 - gdˆ+ 
SA_RPL1


471 
£ËùÜ_¶aš_d1
 
equ
 
gdt
.
desc_¶aš_d1
 - gdˆ+ 
SA_RPL1


472 
£ËùÜ_¶aš_c3
 
equ
 
gdt
.
desc_¶aš_c3
 - gdˆ+ 
SA_RPL3


473 
£ËùÜ_¶aš_d3
 
equ
 
gdt
.
desc_¶aš_d3
 - gdˆ+ 
SA_RPL3


475 
£ËùÜ_video
 
equ
 
gdt
.
desc_video
 - gdt

476 
£ËùÜ_pgTbl
 
equ
 
gdt
.
desc_pgTbl
 - gdt

477 
£ËùÜ_pgDœ
 
equ
 
gdt
.
desc_pgDœ
 - gdt

478 
£ËùÜ_room_¶aš
 
equ
 
gdt
.
desc_room_¶aš
 - gdt

479 
£ËùÜ_tss
 
equ
 
gdt
.
desc_tss
 - gdt

480 ;
	}

}£ËùÜ
 
’d


482 
	ggdtPŒ
:

483 
dw
 
Ën_gdt
-1

484 
dd
 
gdt


485 
dw
 0 ; 
·dd’
 
to
 
®ign
 
	gÚ
 8-
	gb™


487 ;{
g©e
 
idt


488 
	gidt
:

489 .
g©e_divide_”rÜ
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gdivide_”rÜ
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


490 .
	gg©e_sšgË_¡•
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gsšgË_¡•
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


491 .
	gg©e_nmi
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gnmi
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


492 .
	gg©e_b»akPošt
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gb»akPošt
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


493 .
	gg©e_ov”æow
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gov”æow
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


494 .
	gg©e_bounds_check
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gbounds_check
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


495 .
	gg©e_šv®_İcode
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gšv®_İcode
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


496 .
	gg©e_cİr_nÙ_avŸÏbË
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gcİr_nÙ_avŸÏbË
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


497 .
	gg©e_doubË_çuÉ
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gdoubË_çuÉ
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


498 .
	gg©e_cİr_£g_ov”run
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gcİr_£g_ov”run
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


499 .
	gg©e_šv®_tss
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gšv®_tss
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


500 .
	gg©e_£gm’t_nÙ_´e£Á
: 
G©e
 
£ËùÜ_¶aš_c0
, 
	g£gm’t_nÙ_´e£Á
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


501 .
	gg©e_¡ack_”rÜ
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	g¡ack_”rÜ
 -
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


502 .
	gg©e_g’”®_´ÙeùiÚ
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gg’”®_´ÙeùiÚ
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


503 .
	gg©e_·ge_çuÉ
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	g·ge_çuÉ
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


504 .
	gg©e_cİr_”rÜ
 : 
G©e
 
£ËùÜ_¶aš_c0
, 
	gcİr_”rÜ
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


506 %
»p
 (0x20-16è; 0-15,
	gtÙ®ly
 16 
	gg©es
,0-0x19,tÙ®ly 0x20 g©es,
u£
 (0x20-16)

507 
G©e
 
	g£ËùÜ_¶aš_c0
, 
	gi80
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


508 %
	g’d»p


510 .
	gg©e_i20h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi20h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e
 + 
	gDA_DPL3
 ;
ERR
 
	gd¶3


511 .
	gg©e_i21h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi21h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


512 .
	gg©e_i22h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi22h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


513 .
	gg©e_i23h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi23h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


514 .
	gg©e_i24h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi24h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


515 .
	gg©e_i25h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi25h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


516 .
	gg©e_i26h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi26h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


517 .
	gg©e_i27h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi27h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


518 .
	gg©e_i28h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi28h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


519 .
	gg©e_i29h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi29h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


520 .
	gg©e_i2ah
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi2ah
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


521 .
	gg©e_i2bh
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi2bh
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


522 .
	gg©e_i2ch
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi2ch
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


523 .
	gg©e_i2dh
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi2dh
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


524 .
	gg©e_i2eh
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi2eh
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


525 .
	gg©e_i2fh
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi2fh
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


527 .
	gg©e_i30h
:
G©e
 
£ËùÜ_¶aš_c0
,
	gi30h
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


529 %
»p
 (0x80-0x31è;0-0x2f,
	gtÙ®ly
 0x30 
	gg©es
,0-0x79,tÙ®ly 0x80 g©es,
u£
 (0x80-0x22)

530 
G©e
 
	g£ËùÜ_¶aš_c0
, 
	gi80
 -
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e


531 %
	g’d»p


533 .
	gg©e_i80h
:
G©e
 
£ËùÜ_¶aš_c0
, 
	gi80
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e
 + 
	gDA_DPL3


534 .
	gg©e_i81h
:
G©e
 
£ËùÜ_¶aš_c0
, 
	gi81
 - 
	g_¡¬t
 + 
	gba£_‹xt
, 0, 
	gDA_386IG©e
 + 
DA_DPL0


536 
Ën_idt
 
equ
 
	g$
 - 
idt


538 
	gidtPŒ
:

539 
dw
 
Ën_idt
-1

540 
dd
 
idt


541 
dw
 0

542 ;
	g’d
}

	@kernel.c

1 
	~<´oc.h
>

2 
	~<di¥.h
>

3 
	~<uts.h
>

4 
	~<mm.h
>

5 
	~<ku_uts.h
>

6 
	~<lšux/fs.h
>

7 
	~<lšux/ûÎ.h
>

8 
	~<lšux/mouÁ.h
>

9 
	~<scheduË.h
>

10 
	~<asm_ÏbË.h
>

11 
	~<lšux/blkdev.h
>

12 
	~<lšux/ide.h
>

13 
	~<lšux/¦ab.h
>

14 
	~<lšux/pci.h
>

15 
	~<lšux/skbuff.h
>

16 
	~<lšux/tim”.h
>

17 
	~<lšux/bšfmts.h
>

18 
	~<lšux/´štf.h
>

19 
	~<time.h
>

20 
	~<i8259.h
>

21 
	~<lšux/NR_sysÿÎ.h
>

22 
blkdev_Ïy”_š™
();

24 *
	g‹¡buf
;

25 *
	gbigbuf
;

26 
	gavoid_gcc_com¶aš
;

27 
p1
,
p2
,
£c_d©a
;

28 
‰y
();

29 
‰y1
();

30 
p3
();

31 
p4
();

32 
hs
();

33 
t
();

34 
fs_ext
();

35 
mm
();

36 
	gıu_¡ršg
[16];

37 
sk0_func
();

38 
func1
();

39 
func2
(*
¬g
);

40 
func0
();

41 
func_š™
(*
v
);

42 
u¤_func
();

43 
´obe
();

44 
pcb
 *
	gsk0
;

45 
pcb
 *
	gsk1
;

47 
š™_di¥Ïy
();

48 
	~"../debug/debug.h
"

49 
	$k”Ãl_c
(){

53 
	`as£¹
((
dr_ù¾
) == 4);

54 
dr_ù¾
 
dr7
ğ{
v®ue
:0};

55 
__asm__
 
	`__vŞ©e__
 (

57 :"ô"(
dr7
.
v®ue
)

59 
dr7
.
LEN0
 = 
BRK_ADDR_ALIGN_4
;

60 
dr7
.
RWE0
 = 
RWE_WR
;

61 
dr7
.
G0
 = dr7.
G1
 = 1;

63 
__asm__
 
	`__vŞ©e__
 (

66 :"r"(
dr7
.
v®ue
)

70 
	`š™_di¥Ïy
();

71 
	`wr™e_b¬
(2, 2, "BH ", "see");

73 
couÁ
 = 0;

75 
couÁ
++;

76 
	`md–ay
(20);

77 
	`İrštf
("h–lØwÜld, %x ", 
couÁ
);

81 
	`´obe
();

83 
	`mm_š™
();

84 
	`kmem_ÿche_š™
();

85 
	`mm_š™2
();

87 
	`Ãt_š™
();

88 
	`pci_š™
();

90 
	`´oc_š™
();

91 
	`š™_ISA_œqs
();

92 
	`š™_time
();

93 
	`ide_š™
();

94 
	`š™_blkÏy”
();

114 
bigbuf
 = (*)
	`__®loc_·ges
(
__GFP_DEFAULT
, 8+1);

115 
sk0
=(
pcb
*)
	`__®loc_·ges
(
__GFP_DEFAULT
,1);

116 
	`š™_pcb
(
sk0
,(
u32
)
sk0_func
,10,0xffffffff,"idle");

127 
	`fœe_th»ad
(
sk0
);

128 
	`as£¹
(0);

129 
	}
}

133 
sys_bad
(
±_»gs
 
»gs
);

134 
	$sys_bad
(
±_»gs
 
»gs
){

135 
	`İrštf
("unim¶em’‹d sysÿÎ :NR = %u\n", 
»gs
.
—x
);

136 
	`¥š
("");

137 
	}
}

143 
	$block_bufãr_¡amp
(){

144 
i
 = 0; ;i++){

145 
bufãr_h—d
 *
bh
 = 
	`mm­_disk
(0x300, 
i
);

146 
bufãr_h—d
 *
bh2
 = 
	`mm­_disk
(0x300, 
i
);

147 
	`munm­_disk
(
bh
);

148 
	`munm­_disk
(
bh2
);

149 if(
i
 > 250){

153 
	}
}

156 
	$func_š™
(*
v
){

157 
sk1
 = 
cu¼’t
;

158 
	`İrštf
("func init„un..\n");

160 
func_bË
[255];

161 
i
 = 0; i < 255; i++){

162 if(
func_bË
[
i
] =ğ0èfunc_bË[i] = ()
sys_bad
;

165 
lšux_bšfmt
 
–f_fÜm©
;

166 
	`»gi¡”_bšfmt
(&
–f_fÜm©
);

168 
	`ide_»ad_·¹©iÚ
(0x3, 0);

169 
	`š™_vfs
();

170 
	`»gi¡”_fesy¡em
("ûÎ", 
ûÎ_»ad_su³r
);

171 
vfsmouÁ
 *
mÁ_¡ru
 = 
	`do_mouÁ
(0x301, "/", "cell");

172 if(!
mÁ_¡ru
è
	`¥š
("root device mount failed");

173 
fs_¡ruù
 *
fs_¡ru
 = 
cu¼’t
->
fs
;

174 
fs_¡ru
->
roÙ
 = fs_¡ru->
pwd
 = 
mÁ_¡ru
->
sm®l_roÙ
;

175 
fs_¡ru
->
roÙmÁ
 = fs_¡ru->
pwdmÁ
 = 
mÁ_¡ru
;

178 
š_dœ
 
šdœ
;

180 
mÁ_¡ru
 = 
	`do_mouÁ
(0x305, "/home/mnt/", "cell");

182 
‹¡buf
 = 
	`km®loc
(512 * 200);

183 
fd
 = 
	`sys_İ’
("/home/mnt/5/_dimg.c", 2, 0);

185 
rby‹s
 = 
	`sys_»ad
(
fd
, 
‹¡buf
, 100);

186 
avoid_gcc_com¶aš
 = 
rby‹s
 = ()&
šdœ
;

188 
	`block_bufãr_¡amp
();

191 
x
 = 0;

192 *
¬gv
[] = {"init", "arg1", 0};

193 
__asm__
 
	`__vŞ©e__
(

195 :"÷"(
x
)

196 :"a"(
NR_execve
), "b"("/š™"), "c"(
¬gv
), "d"(0)

198 
	`İrštf
("execvçed,ƒ¼Ü cod%u ", 
x
);

203 1è
	`scheduË_timeout
(1000);

205 
	}
}

207 
	$sk0_func
(){

208 
	`k”Ãl_th»ad
(
func_š™
, (*)123, 0);

211 
	`__asm__
("hlt");

215 if(
li¡_aùive
 || 
li¡_expœe
è
	`scheduË
();

217 
	}
}

219 
	sıuid_çmy
{

220 
u32
 
	m¡•pšg_id
:4;

221 
u32
 
	mmod–
:4;

222 
u32
 
	mçmy
:4;

223 
u32
 
	mty³
:2;

224 
	mu32
 :2;

225 
u32
 
	mmod–_ex‹nd
:4;

226 
u32
 
	mçmy_ex‹nd
:8;

227 
	mu32
 :4;

229 
	$´obe
(){

230 
ıuid_çmy
 cpuid_family;

231 
ıuid_šput_max
=0;

232 
x­ic_suµÜt
=0;

233 
x2­ic_suµÜt
=0;

234 
muÉi_th»ad_suµÜt
=0;

235 
add»s§bË_cÜe_num
=0;

236 
add»s§bË_logic_num
=0;

237 
__asm__
 
	`__vŞ©e__
(

263 :"=m"(
x­ic_suµÜt
),"=m"(
x2­ic_suµÜt
),"=m"(
muÉi_th»ad_suµÜt
),"=m"(
ıuid_šput_max
),"=m"(
add»s§bË_logic_num
),\

264 "=m"(
add»s§bË_cÜe_num
), "=m"(
ıuid_çmy
)

268 
	`İrštf
("ıu famy:%x mod–:%x\n",
ıuid_çmy
.
çmy
+(ıuid_çmy.
çmy_ex‹nd
<<4), cpuid_çmy.
mod–
+(ıuid_çmy.
mod–_ex‹nd
<<4));

270 if(!
x­ic_suµÜt
 ) 
	`¥š
("xapic‚ot support");

271 
	`İrštf
("­ic/x­ic_suµÜˆsuµÜt:%s\n",
x­ic_suµÜt
 ? "yes" : "no");

272 
	`İrštf
("x2­ic_suµÜˆsuµÜt:%s\n",
x2­ic_suµÜt
 ? "yes" : "no");

273 
	`İrštf
("muÉi-th»adšg suµÜt:%s\n",
muÉi_th»ad_suµÜt
 ? "yes" : "no");

274 
	`İrštf
("ıuid iÅuˆmax:%u\n",
ıuid_šput_max
);

275 
	`İrštf
("add»s§bË cÜes:%u\n",
add»s§bË_cÜe_num
);

276 
	`İrštf
("add»s§bË†ogics:%u\n",
add»s§bË_logic_num
);

286 
	}
}

289 
	$sÿn_dœty_machše_wÜds
(
¡¬t
, 
’d
){

290 
couÁ
 = 0;

291 
i
 = 
¡¬t
; i < 
’d
; i += 4){

292 
x
 = *(*)(
i
+
PAGE_OFFSET
);

293 ifĞ
x
 ){

294 
	`İrštf
("%u ", 
x
);

295 
couÁ
++;

298  
couÁ
;

299 
	}
}

	@kernel/bh.c

1 
	~<asm/b™.h
>

2 
	~<lšux/bh.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<uts.h
>

6 
	#NUM_BH
 32

	)

7 
	gaùive
;

8 
	gusšg
;

9 
	sbh
{

10 
bh_â
 
	mroutše
;

11 *
	md©a
;

12 }
	gbh_¡rus
[
NUM_BH
];

14 
	$bh_š™
(){

15 
	`as£¹
(
aùive
 * 
usšg
 == 0);

16 
	}
}

18 
	$do_bh
(){

19 
id
;

20 
shadow
;

22 
	`bh_di§bË
();

23 
	`şi
();

25 
»³©
:

26 
shadow
 = 
aùive
;

27 
aùive
 = 0;

28 
	`¡i
();

29  (
id
 = 
	`__bs
(
shadow
)) != -1 ){

30 
	`__bŒ
(&
shadow
, 
id
);

31 
bh
 *bh = 
bh_¡rus
 + 
id
; 
	`as£¹
Ğbh->
routše
 );

32 
bh
->
	`routše
Ğbh->
d©a
 );

34 
	`şi
();

35 if(
aùive
){

37 
»³©
;

39 
	`bh_’abË
();

40 
	}
}

42 
	$®loc_bh
(
bh_â
 
routše
, *
d©a
){

43 
	`İrštf
(">");

44 
id
 = 
	`__bs0s
(&
usšg
);

45 if(
id
 =ğ-1è
	`¥š
("bh‡llocation failed");

46 
	`as£¹
(!
	`__bt
(&
aùive
, 
id
));

47 
bh_¡rus
[
id
].
routše
 =„outine;

48 
bh_¡rus
[
id
].
d©a
 = data;

49  
id
;

50 
	}
}

52 
	$ä“_bh
(
id
){

53 if(
id
 < 0 || id > 
NUM_BH
è
	`¥š
(" illegal bh ido free");

54 if(!
	`__bt
(&
usšg
, 
id
)è
	`¥š
("attempto free‡‚on-using bh");

55 if(!
	`__bt
(&
aùive
, 
id
)è
	`¥š
("attempto free‡n‡ctive bh");

57 
	`__bŒ
(&
usšg
, 
id
);

58 
	}
}

60 
	$m¬k_bh
(
id
){

61 if(
id
 < 0 || id > 
NUM_BH
è
	`¥š
(" illegal bh ido mark");

62 if(!
	`__bt
(&
usšg
, 
id
)è
	`¥š
("attempto mark‡‚on-using bh");

65 
	`__bts
(&
aùive
, 
id
);

66 
	}
}

	@kernel/exit.c

1 
	~<lšux/»sourû.h
>

2 
	~<lšux/myli¡.h
>

3 
	~<lšux/mm.h
>

4 
	~<´oc.h
>

5 
	~<Şd/scheduË.h
>

6 
	~<lšux/wa™.h
>

8 
do_ex™
(
code
);

10 
	$sys_ex™
(
”rcode
){

11 
	`do_ex™
Ğ(
”rcode
 & 0xff) << 8);

13 
	}
}

18 
	$do_ex™
(
code
){

19 
mm
 *mm;

21 
mm
 = 
cu¼’t
->mm;

22 
	`as£¹
(
mm
);

24 
	`Œy_»Ëa£_u£r_¥aû
(
mm
);

25 
	`Œy_»Ëa£_kºl_»sourû
(
cu¼’t
);

26 
	`LL_DEL
(
li¡_aùive
, 
cu¼’t
);

27 
cu¼’t
->
ex™_¡©us
 = 
code
;

28 
cu¼’t
->
¡©e
 = 
TASK_ZOMBIE
;

30 
	`scheduË
();

31 
	}
}

33 
	$»Ëa£_sk_·ge
(
pcb
 *pcb){

34 
	`__ä“_·ges
((*)
pcb
, 1);

36 
	}
}

39 
	$adİt_his_chd»n
(
pcb
 *
he
){

40 
pcb
 *
chd
;

41 
	`li¡_fÜ_—ch_§ã
(&
he
->
chd»n
, 
chd
, 
siblšg
){

42 
chd
->
mÚ™Ü
 = 
sk1
;

43 
	`li¡_add
(&
chd
->
siblšg
, &
sk1
->
chd»n
);

46 
	}
}

49 
	$pickup_äom_ÃtwÜk
(
pcb
 *
sk
){

50 
	`li¡_d–
(&
sk
->
siblšg
);

52 
	}
}

54 
	$sys_wa™4
(
pid
, *
¡©us
, 
İtiÚs
, 
ru§ge
 *
ru
){

55 
pcb
 *
chd
;

56 
»t
 = -1;

58 
»³©
:

59 
	`li¡_fÜ_—ch_§ã
(&
cu¼’t
->
chd»n
, 
chd
, 
siblšg
){

60 if(
pid
 != -1 ){

61 if(
pid
 !ğ
chd
->pid) ;

67 if(
İtiÚs
 =ğ
WNOHANG
)

68 
»t
 = 0;

71 if(
chd
->
¡©e
 !ğ
TASK_ZOMBIE
) ;

73 
»t
 = 
chd
->
pid
;

74 if(
¡©us
è*¡©u ğ
chd
->
ex™_¡©us
;

76 
	`put_mm
(
chd
->
mm
);

77 
chd
->
mm
 = 0;

78 
	`adİt_his_chd»n
(
chd
);

79 
	`pickup_äom_ÃtwÜk
(
chd
);

80 
	`»Ëa£_sk_·ge
(
chd
);

81 
out
;

83 if(
İtiÚs
 =ğ
WUNTRACED
è
»³©
;

84 if(
İtiÚs
 =ğ
WNOHANG
);

85 
	`¥š
("bad wait options");

87 
out
:

88  
»t
;

89 
	}
}

	@kernel/fork.c

1 
	~<fÜk.h
>

2 
	~<´oc.h
>

3 
	~<mm.h
>

4 
	~<asm_ÏbË.h
>

5 
	~<scheduË.h
>

6 
	~<lšux/sched.h
>

7 
	~<lšux/myli¡.h
>

8 
	~<lšux/´štf.h
>

10 
	$chgpg
(
u32
*
dœ
,
vpg
,
rw
){

13 
u32
 *
dœ’t
 = 
dœ
 + 
	`PG_H10
(
vpg
);

14 
	`as£¹
(*
dœ’t
 & 
PG_P
);

15 
u32
 *
tbl
 = (u32*)
	`KV
((*
dœ’t
)>>12<<12);

16 if(
rw
){

17 
tbl
[
	`PG_L10
(
vpg
)] |ğ
PG_RWW
;

19 
tbl
[
	`PG_L10
(
vpg
)] &ğ~
PG_RWW
;

21 
	`__asm__
("mov %cr3, %eax\n\t"

23 
	}
}

25 
	$cİy_fd
Ğ
pcb
 *
chd
){

26 
fes_¡ruù
 *
my
 = 
cu¼’t
->
fes
;

27 
fes_¡ruù
 *
his
 = 
	`kmem_ÿche_®loc
(
fes_¡ruù_ÿche
, 0);

28 
his
->
max_fds
 = 
my
->max_fds;

29 if(
my
->
f•
 =ğmy->
Üigš_f•
){

30 
his
->
f•
 = his->
Üigš_f•
;

33 
his
->
f•
 = 
	`km®loc2
Ğ(
fe
 *è* 
my
->
max_fds
, 0);

36  
i
 = 0; i < 
my
->
max_fds
; i++ ){

37 
fe
 *fğ
my
->
f•
[
i
];

38 
his
->
f•
[
i
] = 
fe
;

39 if(
fe
){

40 
	`g‘_fe
(
fe
);

44 
chd
->
fes
 = 
his
;

47 
	}
}

49 
	$cİy_fs
(
pcb
 *
chd
){

50 
fs_¡ruù
 *
his
 = 
	`kmem_ÿche_®loc
(
fs_¡ruù_ÿche
, 0);

51 *
his
 = *
cu¼’t
->
fs
;

52 
	`dg‘
(
his
->
roÙ
);

53 
	`dg‘
(
his
->
pwd
);

54 
	`mÁg‘
(
his
->
roÙmÁ
);

55 
	`mÁg‘
(
his
->
pwdmÁ
);

57 
chd
->
fs
 = 
his
;

59 
	}
}

61 
vm_¬—
 * 
	$şÚe_vma
(
vm_¬—
 *
me
, 
mm
 *
hismm
){

62 
±e
 *
mydœ
, *
hisdœ
;

63 
±e
 *
mytbl
, *
hi¡bl
;

64 
vm_æags
 vm_flags;

65 
boŞ
 
cow
;

66 
lš—r_addr
 
vaddr
;

67 
·ge
 *
thi¥age
;

69 
vm_¬—
 *
he
 = 
	`kmem_ÿche_®loc
(
vm_¬—_ÿche
, 0);

70 *
he
 = *
me
;

71 
he
->
mm
 = 
hismm
;

73 
mydœ
 = 
	`PGDIR_OF_MM
(
me
->
mm
);

74 
hisdœ
 = 
	`PGDIR_OF_MM
(
hismm
);

75 
vm_æags
 = 
me
->
æags
;

76 
cow
 = !
vm_æags
.
sh¬ed
 && vm_æags.
maywr™e
;

78 
vaddr
.
v®ue
 = 
me
->
¡¬t
;

79 
Ãxt_4M
;

80 
vaddr
.
v®ue
 < 
me
->
’d
){

81 
i
 = 
vaddr
.
tbl_idx
;

82 
±e
 *
’Œy
 = 
mytbl
 + 
i
;

83 ifĞ
’Œy
->
v®ue
 =ğ0 ) 
_cÚtšue
;

84 ifĞ!
’Œy
->
´e£Á
è
	`¥š
("swapped…age on disk ?");

85 if(
cow
){

86 
mytbl
[
i
].
wr™abË
 = 
çl£
;

87 
	`švÍg
((*)
vaddr
.
v®ue
);

89 if(
vm_æags
.
sh¬ed
);

90 if(
vm_æags
.
maywr™e
);

93 
hi¡bl
[
i
] = 
mytbl
[i];

94 
thi¥age
 = 
	`±e2·ge_t
(
mytbl
[
i
]);

95 
	`g‘_·ge
(
thi¥age
);

97 
_cÚtšue
:

98 
vaddr
.
v®ue
 +ğ
__4K
;

99 if(
vaddr
.
v®ue
 % 
__4M
 == 0){

100 
idx
;

101 
Ãxt_4M
:

102 
idx
 = 
vaddr
.
dœ_idx
;

103 ifĞ
hisdœ
[
idx
].
v®ue
 == 0 )

105 
hisdœ
[
idx
].
v®ue
 = 
	`__·
(
	`__®loc_·ge
(
__GFP_ZERO
))

106 | 
PG_USU
 | 
PG_RWW
 | 
PG_P
;

107 
	`as£¹
(
hisdœ
[
idx
].
´e£Á
);

108 
mytbl
 = 
	`±e2·ge
Ğ
mydœ
[
idx
] );

109 
hi¡bl
 = 
	`±e2·ge
Ğ
hisdœ
[
idx
] );

113 if(
me
->
fe
){

114 
	`g‘_fe
(
me
->
fe
);

117  
he
;

118 
	}
}

120 
	$dup_mm­
(
mm
 *
mymm
, mm *
hismm
)

122 
vm_¬—
 *
şÚe
;

123 
vm_¬—
 *
roÙ
 = 
mymm
->
vma
; 
	`as£¹
(root);

124 
vm_¬—
 *
this
 = 
roÙ
;

126 if(
this
->
æags
.
dÚtcİy
) ;

128 
şÚe
 = 
	`şÚe_vma
(
this
, 
hismm
);

129 
	`O_APPEND_SAFE
(
hismm
->
vma
, 
şÚe
);

130 } (
this
 =his->
Ãxt
è&&hi !ğ
roÙ
 );

133 
	}
}

135 
	$şÚe_mm
(
pcb
 *
chd
){

136 
mm
 *
hismm
 = 
	`kmem_ÿche_®loc
(
mm_ÿche
, 0);

137 
±e
 *
pgdœ
 = 
	`__®loc_·ge
Ğ
__GFP_ZERO
);

138 *
hismm
 = *
cu¼’t
->
mm
;

139 
hismm
->
u£rs
 = 1;

142 
±e
 *
mydœ
 = 
	`PGDIR_OF_MM
(
cu¼’t
->
mm
);

143 
	`memıy
((*)(
pgdœ
 + 256*3), 
mydœ
 + 256*3, 256*4);

145 
hismm
->
ü3
.
v®ue
 = 
	`__·
(
pgdœ
);

146 
hismm
->
vma
 = 0;

148 
	`dup_mm­
(
cu¼’t
->
mm
, 
hismm
);

150 
chd
->
mm
 = 
hismm
;

152 
	}
}

154 
	$do_fÜk
(
şÚe_æags
, 
¡ack_¡¬t
,

155 
±_»gs
 *
»gs
, 
¡ack_size
)

158 
µg
 = 
	`·ge_idx
(
	`®loc_·ges
(
__GFP_ZERO
, 1));

159 
pcb
 * 
chd
 = (*)
	`KV
(
µg
<<12);

161 
	`memıy
((*)
chd
, (*)
cu¼’t
, 0x2000);

164 if(!
cu¼’t
->
mm
è
£t_back_routše
;

166 
chd
->
time_¦iû
 = chd->
time_¦iû_fuÎ
 = 10;

169 if(
şÚe_æags
 & 
CLONE_FD
){

170 
	`cİy_fd
(
chd
);

172 
cu¼’t
->
fes
->
couÁ
++;

176 if(
şÚe_æags
 & 
CLONE_FS
){

177 
	`cİy_fs
(
chd
);

179 
cu¼’t
->
fs
->
couÁ
++;

182 if(
şÚe_æags
 & 
CLONE_VM
){

183 
	`şÚe_mm
(
chd
);

186 
	`g‘_mm
(
cu¼’t
->
mm
);

189 
pcb2pcb
;

190 
¡ack_äame
 *
æßt_»gs
;

191 
£t_back_routše
:

195 
pcb2pcb
 = ()
chd
 - ()
cu¼’t
;

196 
æßt_»gs
 = (*)(()
»gs
 + 
pcb2pcb
);

197 
chd
->
th»ad
.
e¥
 = ()
æßt_»gs
;

198 
æßt_»gs
->
—x
 = 0;

199 if(!(
»gs
->
cs
 & 3)){

200 
æßt_»gs
->
ebp
 +ğ
pcb2pcb
;

202 
chd
->
th»ad
.
e
 = ()
»t_äom_sys_ÿÎ
;

204 
	`¥rštf
(
chd
->
p_Çme
, "mœrÜ:%s", 
cu¼’t
->p_name);

205 
chd
->
pid
 = 
	`®loc_pid
(-1);

206 
chd
->
mÙh”
 = chd->
mÚ™Ü
 = 
cu¼’t
;

207 
	`INIT_LIST_HEAD
(&
chd
->
chd»n
);

208 
	`li¡_add
(&
chd
->
siblšg
, &
cu¼’t
->
chd»n
);

210 
	`LL_I_INCRE
(
li¡_aùive
, 
chd
, 
´io
);

212  
chd
->
pid
;

213 
	}
}

214 
	$sys_fÜk
(
¡ack_äame
 
»gs
){

215  
	`do_fÜk
(

216 
CLONE_FD
 | 
CLONE_FS
 |
CLONE_VM
,

218 &
»gs
,

221 
	}
}

	@kernel/timer.c

1 
	~<lšux/tim”.h
>

2 
	~<li¡.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<uts.h
>

5 
li¡_h—d
 
	gmy_tim”li¡
;

7 
	$Œigg”_mytim”
(
tim”
 *timer){

8 
tim”
->
	`aù
Ñim”->
d©a
);

9 
	`li¡_d–
(&
tim”
->
node
);

10 
tim”
->
¡©e
 = 
TIMER_STOPPED
;

11 
tim”
->
liã
 =im”->
Üigš
;

12 
	}
}

15 
	$my_tim”li¡_dida
(){

16 
li¡_h—d
 *
cu¼
 = 
my_tim”li¡
.
Ãxt
;

17 
cu¼
 !ğ&
my_tim”li¡
){

18 
tim”
 *tim” = 
	`MB2STRU
(tim”, 
cu¼
, 
node
);

20 
li¡_h—d
 *
_Ãxt
 = 
cu¼
->
Ãxt
;

21 
tim”
->
liã
--;

22 if(
tim”
->
liã
 == 0){

23 
	`Œigg”_mytim”
(
tim”
);

25 
cu¼
 = 
_Ãxt
;

27 
	}
}

29 
	$š™_mytim”
(){

30 
	`INIT_LIST_HEAD
(&
my_tim”li¡
);

31 
	}
}

34 
tim”
 *
ü—‹_mytim”
(
u32
 
liã
, (*
aù
)(* 
d©a
), *data){

35 
	`as£¹
(
liã
 && 
aù
);

36 
tim”
 *tim” = 
	`km®loc2
((timer), 0);

37 
tim”
->
aù
 =‡ct;

38 
tim”
->
Üigš
 =im”->
liã
 / 10;

39 
tim”
->
liã
 =im”->
Üigš
;

40 
tim”
->
¡©e
 = 
TIMER_STOPPED
;

41 
tim”
->
d©a
 = data;

42  
tim”
;

43 
	}
}

45 
	$¡¬t_mytim”
(
tim”
 *timer){

46 
boŞ
 
IF
 = 
	`şi_ex
();

47 
	`li¡_add
(&
tim”
->
node
, &
my_tim”li¡
);

48 
tim”
->
¡©e
 = 
TIMER_RUNNING
;

49 if(
IF
){

50 
	`¡i
();

52 
	}
}

54 
	$»£t_mytim”
(
tim”
 *timer){

55 
boŞ
 
IF
 = 
	`şi_ex
();

56 
tim”
->
liã
 =im”->
Üigš
;

57 if(
IF
){

58 
	`¡i
();

60 
	}
}

62 
	$¡İ_mytim”
(
tim”
 *timer){

63 
boŞ
 
IF
 = 
	`şi_ex
();

64 
	`li¡_d–
(&
tim”
->
node
);

65 
tim”
->
¡©e
 = 
TIMER_STOPPED
;

66 if(
IF
){

67 
	`¡i
();

69 
	}
}

	@ku_utils.c

1 
	~<ku_uts.h
>

4 
	#CMP_GOON_WHEN
(
exp
)\

5 
exp
){\

6 if(*
±1
!=*
±2
)  0;\

7 
±1
++;\

8 
±2
++;\

10  1;

	)

12 
	$hex_št
(
x
){

13 if(
x
>='0'&&x<='9')  (x-48);

14 if(
x
>='a'&&x<='f')  (x-87);

16 
	}
}

17 
	$mem£t
(*
de¡
,
v®ue
,
n
){

18 
v®ue32
 = 
v®ue
 + (value<<8) + (value<<16) + (value<<24);

19 
qu¬d
 = 
n
 / 4;

20 
l
 = 
n
 % 4;

21 
i
 = 0; i < 
qu¬d
; i++){

22 ((*)
de¡
)[
i
] = 
v®ue32
;

24 
l
--){

25 ((*)
de¡
)[
n
-
l
] = 
v®ue
;

27 
	}
}

30 *
	$humª_memsize
(
size
,
š™Ÿl_sÿË_couÁ
){

31 
gmkb
[4];

32 
	`humª_memsize_što
(
gmkb
,
size
,
š™Ÿl_sÿË_couÁ
);

33  
gmkb
;

34 
	}
}

35 
	$humª_memsize_što
(*
gmkb
,
size
,
š™Ÿl_sÿË_couÁ
){

36 
	`mem£t
((*)
gmkb
,0,16);

37 
i
=3-
š™Ÿl_sÿË_couÁ
;i>=0;i--){

38 
gmkb
[
i
]=
size
%1024;

39 
size
/=1024;

41 
	}
}

42 
	$pow_št
(
ba£
,
exp
){

43 if(
exp
==0)  1;

44 
»suÉ
=1;

45 
i
=0;i<
exp
;i++){

46 
»suÉ
*=
ba£
;

48  
»suÉ
;

49 
	}
}

50 
	$û_divide
(
a
,
b
){

51 
quÙ
=
a
/
b
;

52 
»mašd”
=
a
%
b
;

53  
»mašd”
==0?
quÙ
:quot+1;

54 
	}
}

55 
	$ch¬s_to_¡r
(*
¡r
,*
ch¬s
){

56 *
ch¬s
!=' '&&*chars!=0){

57 *
¡r
=*
ch¬s
;

58 
¡r
++;

59 
ch¬s
++;

61 *
¡r
=0;

62 
	}
}

64 
	$memı
(*
de¡
,*
¤c
,
by‹
){

65 
by‹
>0){

66 *
de¡
=*
¤c
;

67 
de¡
++;

68 
¤c
++;

69 
by‹
--;

71 
	}
}

73 
	$mem£tw
(
u16
*
de¡
,
wÜd
,u16 
v®ue
){

74 
wÜd
>0){

75 *(
de¡
+
wÜd
-1)=
v®ue
;

76 
wÜd
-=1;

78 
	}
}

80 
	$ch¬scmp
(*
±1
,*
±2
,
’d_æag
){

81 
’d_æag
){

83 
	`CMP_GOON_WHEN
((*
±1
!=0)&&(*
±2
!=0))

86 
	`CMP_GOON_WHEN
((*
±1
!=0)&&(*
±2
!=0)&&(*pt1!=' ')&&(*pt2!=' '))

91 
	}
}

	@lib/printf.c

7 
	~<lšux/´štf.h
>

8 
	~<mm.h
>

9 
	~<video_drv.h
>

12 
¡©wnd_»nd”
();

13 
İ’_wšdow
(
¡¬lše
);

14 
ş—¾še
(
l
);

19 
boŞ
 
	gmm_avaabË
 = 
çl£
;

20 
boŞ
 
	gsk_avaabË
 = 
çl£
;

22 
	gcursÜ
;

24 
	#BUF_PG_ORDER
 2

	)

25 
	#PAGE_W
 80

	)

26 
	#PAGE_H
 25

	)

27 
	#O_PER_PAGE
 (
PAGE_W
 * 
PAGE_H
)

	)

28 #undeà
PAGE_SIZE


29 
	#PAGE_SIZE
 (
O_PER_PAGE
 * 2)

	)

30 
	#NR_PAGES
 8

	)

31 
	#VIDEO_CELL_NUM
 (
O_PER_PAGE
 * 
NR_PAGES
)

	)

32 
	#VIDEO_BUF_SIZE
 (
PAGE_SIZE
 * 
NR_PAGES
)

	)

34 
	#POS_L
(
pos
èÕo / 
PAGE_W
)

	)

35 
	#VIDEO_L_ADDR
(
lšeid
è(
video_ûÎs
 + (lšeid )* 
PAGE_W
)

	)

37 
	#RGB_BLUE
 1

	)

38 
	#RGB_GREEN
 2

	)

39 
	#RGB_RED
 4

	)

40 
	#RGB_WHITE
 7

	)

42 #´agm¨
·ck
(
push
)

43 #´agm¨
·ck
(1)

44 
	scŞÜmod
{

47 
	mfg
: 3;

48 
boŞ
 
	mhighlight
:1;

49 
	mbg
: 3;

50 
boŞ
 
	mblšk
:1;

52 
	mv®ue
;

56 
	sûÎ
{

59 
	mascii
;

60 
cŞÜmod
 
	mmode
;

62 
u16
 
	mv®ue
;

65 #´agm¨
·ck
(
pİ
)

66 
	#video_mem
 ((*)0xc00b8000)

	)

67 
ûÎ
 *
	gvideo_ûÎs
 = (*)
video_mem
;

73 
	#STAT_WND_H
 4

	)

74 
	#STAT_WND_SIZE
 (
STAT_WND_H
 * 
PAGE_W
 * 2)

	)

75 
ûÎ
 
	g¡©_wnd
[
STAT_WND_H
][
PAGE_W
];

78 
	$İrštf
(*
fÜm©
, ...){

79 
Şdlše
;

80 
IF
;

81 
size_t
 
upsize
 = 
mm_avaabË
 ? 0: 1024;

82 
¡kroom
[
upsize
];

84 *
buf
 = 
mm_avaabË
 ? (*)
	`__®loc_·ges
(0, 
BUF_PG_ORDER
è: 
¡kroom
;

85 *
»ad
 = 
buf
;

87 
Ëngth
 = 
	`__¥rštf
(
buf
, 
fÜm©
, (
u32
 *)(&format + 1));

88 if(
Ëngth
 > 80 * 24) 1);

91 
IF
 = 
	`şi_ex
();

93 *
»ad
){

94 
Şdlše
 = 
	`POS_L
(
cursÜ
);

95 if(*
»ad
 == '\n'){

96 
cursÜ
 = (cursÜ / 
PAGE_W
 + 1) * PAGE_W;

98 if(*
»ad
 == '\t'){

99 
cursÜ
 += 4;

102 
video_ûÎs
[
cursÜ
].
ascii
 = *
»ad
;

103 
video_ûÎs
[
cursÜ
].
mode
.
fg
 = 
RGB_WHITE
;

104 
cursÜ
++;

107 if(
cursÜ
 >ğ
VIDEO_CELL_NUM
){

108 
	`memıy
(
video_mem
, video_mem + (
NR_PAGES
 - 1è* 
PAGE_SIZE
, PAGE_SIZE);

109 
cursÜ
 = cursÜ % 
O_PER_PAGE
 + O_PER_PAGE;

111 
cu¼lše
 = 
	`POS_L
(
cursÜ
);

112 if(
cu¼lše
 !ğ
Şdlše
è
	`ş—¾še
(currline);

113 
»ad
++;

116 
	`¡©wnd_»nd”
();

118 
	`İ’_wšdow
(
	`POS_L
(
cursÜ
è- 
PAGE_H
 + 1 + 4);

119 if(
IF
è
	`¡i
();

120 if(
mm_avaabË
){

121 
	`__ä“_·ges
(
buf
, 
BUF_PG_ORDER
);

123  
Ëngth
;

124 
	}
}

126 
	$¡©wnd_»nd”
(){

127 
	`memıy
(
	`VIDEO_L_ADDR
Ğ
	`POS_L
(
cursÜ
è+ 1), 
¡©_wnd
, 
STAT_WND_SIZE
);

128 
	}
}

129 
	$ş—¾še
(
l
){

130 
ûÎ
 *
o
 = &
video_ûÎs
[ 
l
 * 
PAGE_W
 ];

131 
i
 = 0; i < 
PAGE_W
; i++){

132 
o
[
i
].
v®ue
 = 0;

134 
	}
}

136 
	$İ’_wšdow
(
¡¬še
){

137 if(
¡¬še
 < 0) startline = 0;

138 
	`£t_¡¬t
(
¡¬še
 * 
PAGE_W
);

139 
	}
}

148 
	#BAR_V_NR
 3

149 
	#BAR_H_NR
 3

150 
	#BAR_NR
 (
BAR_V_NR
 * 
BAR_H_NR
)

	)

151 
	#SIDE_EDGE_WIDTH
 2

	)

152 
	#BAR_CELLS
 ((
PAGE_W
 - 
SIDE_EDGE_WIDTH
 * 2è/ 
BAR_H_NR
)

	)

153 
	#BAR_SIZE
 (
BAR_CELLS
 * 2)

	)

155 
	#BAR
(
x
, 
y
è(
¡©_wnd
[y + 1] + 
SIDE_EDGE_WIDTH
 + 
BAR_CELLS
 * x)

	)

157 
	sb¬_desc
{

158 
cŞÜmod
 
	mmode
;

159 *
	mt™Ë
;

161 
b¬_desc
 
	gdesc_of_b¬
[
BAR_V_NR
][
BAR_H_NR
];

162 
	$__£t_cŞumn
(
ûÎ
 *
wnd
, 
cŞ
,

163 
begšl
, 
Êum
, 
ûÎ
 cell){

164 
i
 = 
begšl
; i < begšÈ+ 
Êum
; i++) {

165 
	`memıy
(
wnd
 + 
i
 * 
PAGE_W
 + 
cŞ
, &
ûÎ
, (cell));

167 
	}
}

169 
	$¡©wnd_£tcŞ
(
cŞ
, 
ûÎ
 cell){

170 
	`__£t_cŞumn
(
¡©_wnd
[0], 
cŞ
, 0, 4, 
ûÎ
);

171 
	}
}

173 
	$__£t_lše
(
ûÎ
 *
wnd
, 
lše
,

174 
begš
, 
cŞumns
, 
ûÎ
 cell){

175 
i
 = 
begš
; i < begš + 
cŞumns
; i++){

176 
	`memıy
(
wnd
 + 
lše
 * 
PAGE_W
 + 
i
, &
ûÎ
, (cell));

178 
	}
}

180 
	$¡©wnd_£še
(
lše
, 
ûÎ
 cell){

181 
	`__£t_lše
(
¡©_wnd
[0], 
lše
, 0, 
PAGE_W
, 
ûÎ
);

182 
	}
}

185 
	$wr™e_sü“n
(
ûÎ
 *
¡¬t
, *
¡r
, 
cŞÜmod
 
mode
){

186 *
»ad
 = 
¡r
;

187 
ûÎ
 *
wr™e
 = 
¡¬t
;

188 *
»ad
){

189 
wr™e
->
ascii
 = *
»ad
;

190 
wr™e
->
mode
.
v®ue
 = mode.value;

192 
wr™e
++;

193 
»ad
++;

195  
»ad
 - 
¡r
;

196 
	}
}

198 
	$wr™e_b¬
(
x
, 
y
, *
t™Ë
, *
cÚ‹Á
){

199 if(
x
 > 2 || 
y
 > 2) 1);

200 
b¬_desc
 *
desc
 = &
desc_of_b¬
[
x
][
y
];

201 if(
t™Ë
){

202 
desc
->
t™Ë
 =itle;

204 if(!
cÚ‹Á
) content = "nul";

206 
ûÎ
 *
b¬_¡¬t
 = 
	`BAR
(
x
, 
y
);

207 
off£t
 = 0;

208 
off£t
 = 
	`wr™e_sü“n
(
b¬_¡¬t
 + off£t, 
desc
->
t™Ë
, desc->
mode
);

209 
	`wr™e_sü“n
(
b¬_¡¬t
 + 
off£t
, 
cÚ‹Á
, 
desc
->
mode
);

210 
	`¡©wnd_»nd”
();

211 
	}
}

214 
	$š™_¡©us_wšdow
(){

215 
ûÎ
 
blue_ûÎ
 = { 
ascii
:0, 
mode
: {
bg
:
RGB_BLUE
} };

216 
ûÎ
 
tİ_ûÎ
 = {
ascii
:205, 
mode
:{
bg
:
RGB_BLUE
} };

217 
	`¡©wnd_£tcŞ
(0, 
blue_ûÎ
);

218 
	`¡©wnd_£tcŞ
(1, 
blue_ûÎ
);

219 
	`¡©wnd_£tcŞ
(
PAGE_W
 - 1, 
blue_ûÎ
);

220 
	`¡©wnd_£tcŞ
(
PAGE_W
 - 2, 
blue_ûÎ
);

223 
	`¡©wnd_£še
(0, 
tİ_ûÎ
);

225 
i
 = 0; i < 
BAR_V_NR
; i++){

226 
j
 = 0; j < 
BAR_H_NR
; j++){

227 
desc_of_b¬
[
i
][
j
].
mode
.
bg
 = 
RGB_GREEN
;

228 
desc_of_b¬
[
i
][
j
].
mode
.
fg
 = 
RGB_RED
;

229 
desc_of_b¬
[
i
][
j
].
mode
.
blšk
 = 
çl£
;

230 
desc_of_b¬
[
i
][
j
].
mode
.
highlight
 = 
çl£
;

232 
desc_of_b¬
[
i
][
j
].
t™Ë
 = "?:";

235 
	}
}

237 
	$š™_di¥Ïy
(){

238 
	`š™_¡©us_wšdow
();

240 
	}
}

	@lib/string.c

1 
	~<lšux/¡ršg.h
>

4 
	$¡ºËn
(*
¡r
, 
ulÚg
 
n
){

5 
i
 = 0; i < 
n
; i++){

6 if(
¡r
[
i
] == 0)  i;

8  
n
;

9 
	}
}

12 
	$¡¾’
(*
¡r
){

13 
Ën
=0;

14 *
¡r
!=0){

15 
¡r
++;

16 
Ën
++;

18  
Ën
;

19 
	}
}

21 
boŞ
 
	$¡rm©ch
(*
£g
,*
whŞe
){

22 
i
=0;i<
	`¡¾’
(
£g
);i++){

23 if(
£g
[
i
]!=
whŞe
[i]è 
çl£
;

25  
Œue
;

26 
	}
}

28 *
	$¡rıy
(*
de¡
,*
¤c
){

29 *
d
=
de¡
;

30 (*
de¡
++=*
¤c
++));

31  
d
;

32 
	}
}

40 *
	$¡ºıy
(*
de¡
, cÚ¡ *
¤c
, 
n
){

41 
i
;

42 
i
 = 0; i < 
n
 && 
¤c
[i]; i++){

43 
de¡
[
i
] = 
¤c
[i];

45 ; 
i
<
n
; i++è
de¡
[i] = 0;

46  
de¡
;

47 
	}
}

50 
	$¡rcmp
(cÚ¡ *
¡r1
, cÚ¡ *
¡r2
){

51 
i
;

52 
i
 = 0; 
¡r1
[i] =ğ
¡r2
[i]; i++){

53 if(
¡r1
[
i
] == 0)  0;

55  
i
 + 1;

57 
	}
}

59 
	$¡ºcmp
(cÚ¡ *
¡r1
, cÚ¡ *
¡r2
, 
n
){

60 
i
 = 0; i < 
n
; i++){

61 if(
¡r1
[
i
] =ğ
¡r2
[i]) {

62 if(
¡r1
[
i
]) ;

65  
i
 + 1;

68 
	}
}

	@lib/vsprintf.c

1 
	~<v®Ty³.h
>

2 
	~<uts.h
>

3 
	~<lšux/´štf.h
>

5 *
v®ue2¡r
(
u32
 
v®ue
, 
t_æag
, *
ascii_buf
, 
buæ’
 );

6 
u32
 
¡e_decim®
(*
±r
, *
ch¬num
);

7 
wr™e_ch¬s
(*
de¡
, *
¤c
, *
’dæags
, 
width
);

8 
wr™e_v¬ŸbË
(*
buf
, 
u32
 
v®ue
, 
æag
, 
width
);

11 
	$¥rštf
(*
buf
, *
fÜm©
, ...){

12  
	`__¥rštf
(
buf
, 
fÜm©
, (
u32
 *)(&format + 1));

13 
	}
}

15 
	$__¥rštf
(*
buf
, *
fÜm©
, 
u32
 *
¬gs
){

16 
width
;

17 
Ä_wr
;

18 *
æag
 = 
fÜm©
;

19 *
de¡
 = 
buf
;

20 
u32
 *
¬g
 = 
¬gs
;

22 *
æag
){

23 if(*
æag
 == '%'){

24 
æag
++;

25 if(*
æag
 == '*'){

26 
width
 = *(
¬g
++);

27 
æag
++;

29 if(*
æag
 <= '9' && *flag >= '1'){

30 
ch¬num
;

31 
width
 = 
	`¡e_decim®
(
æag
, &
ch¬num
);

32 
æag
 +ğ
ch¬num
;

34 
width
 = 0;

36 
Ä_wr
 = 
	`wr™e_v¬ŸbË
(
de¡
, *
¬g
++, *
æag
, 
width
);

37 
æag
++;

43 
Ä_wr
 = 
	`wr™e_ch¬s
(
de¡
, 
æag
, "%", 0);

44 
æag
 +ğ
Ä_wr
;

46 
de¡
 +ğ
Ä_wr
;

48 
de¡
[0] = 0;

49  
de¡
 - 
buf
;

50 
	}
}

52 
u32
 
	$¡e_decim®
(*
±r
, *
ch¬num
){

53 *
¡¬t
 = 
±r
;

54 
n
 = 0;

55 
u32
 
sum
 = 0;

57 *
±r
 >= '0' && *ptr <= '9')…tr++;

58 
n
 = 
±r
 - 
¡¬t
;

59 
i
 = 1; i <ğ
n
; i++){

60 
s
 = 
±r
[-
i
] - '0';

61 
sum
 +ğ
s
 * 
	`pow_št
(10, 
i
-1);

63 *
ch¬num
 = 
n
;

64  
sum
;

65 
	}
}

68 
šlše
 *
	$¡rch¬
(*
¡r
, 
c
){

69 if(!
¡r
)  0;

70 *
cu¼
 = 
¡r
;

71 *
cu¼
){

72 if(*
cu¼
 =ğ
c
)  curr;

73 
cu¼
++;

76 
	}
}

84 
	$wr™e_ch¬s
(*
de¡
, *
¤c
, *
’dæags
, 
width
){

85 *
wr™e
 = 
de¡
;

86 *
»ad
 = 
¤c
;

88 *
»ad
 && 
	`¡rch¬
(
’dæags
, *read) == 0){

90 *
wr™e
++ = *
»ad
++;

91 if(
wr™e
 - 
de¡
 =ğ
width
) ;

93 if(
width
){

94 
wr™e
 - 
de¡
 < 
width
){

95 *
wr™e
++ = ' ';

99  
wr™e
 - 
de¡
;

100 
	}
}

112 
	$wr™e_v¬ŸbË
(*
buf
, 
u32
 
v®ue
, 
æag
, 
width
){

113 
	#VALUE_LEN
 31

	)

114 
v®ue¡r
[
VALUE_LEN
 + 1];

115 
Ä_wr
;

116 *
»suÉ
;

117 
æag
){

119 
Ä_wr
 = 
	`wr™e_ch¬s
(
buf
, (*)
v®ue
, "%", 
width
);

124 
»suÉ
 = 
	`v®ue2¡r
(
v®ue
, 
æag
, 
v®ue¡r
, 
VALUE_LEN
+1);

125 
Ä_wr
 = 
	`wr™e_ch¬s
(
buf
, 
»suÉ
, 0, 
width
);

131  
Ä_wr
;

132 
	}
}

138 *
	$v®ue2¡r
(
u32
 
v®ue
, 
t_æag
, *
ascii_buf
, 
buæ’
 ){

139 
‹mp
 = 
v®ue
;

140 
off£t
 = 
buæ’
 - 1 - 1;

142 
ascii_buf
[
buæ’
 - 1] = 0;

143 
t_æag
){

145 
ascii_buf
[
off£t
] = 
v®ue
;

150 
‹mp
>9){

151 
ascii_buf
[
off£t
]=
‹mp
%10+48;

152 
‹mp
/=10;

153 
off£t
--;

155 
ascii_buf
[
off£t
]=
‹mp
+48;

158 
‹mp
>0xf){

159 
i
=
‹mp
%16;

160 
ascii_buf
[
off£t
]=
i
<=9?i+48:i+87;

161 
‹mp
/=16;

162 
off£t
--;

165 
ascii_buf
[
off£t
--] = 
‹mp
<=9?temp+48:temp+87;

166 
ascii_buf
[
off£t
--] = 'X';

167 
ascii_buf
[
off£t
] = '0';

172  
ascii_buf
 + 
off£t
;

173 
	}
}

	@mm.c

1 
	~<di¥.h
>

2 
	~<uts.h
>

3 
	~<mm.h
>

4 
	~<v®Ty³.h
>

5 
	~<´oc.h
>

6 
	~<boÙšfo.h
>

7 
	~<–f.h
>

8 
	~<fÜk.h
>

9 
	~<lšux/sched.h
>

10 
¦ab_h—d
 * 
	gmm_ÿche
;

11 
¦ab_h—d
 * 
	gvm_¬—_ÿche
;

12 
¦ab_h—d
 *
	gfs_¡ruù_ÿche
;

13 
¦ab_h—d
 *
	gfes_¡ruù_ÿche
;

14 
u32
 
	ggmemsize
=0;

15 
	g‹¡buf
[1024];

16 
	$š™_memÜy
(){

17 
	`as£¹
((
ü3
è=ğ4 && Ğ
±e
) == 4 &&

18 (
lš—r_addr
) == 4);

19 
	`h—p_š™
();

21 
mem_£gnum
 = 
»®mod_šfo
->mem_segnum;

22 
mem_£gšfo
 *
mem£g
 =
»®mod_šfo
->mem_seginfo;

23 
	`İrštf
("%12s%12s%10s\n","start","len","type");

24 
i
=0; i<
mem_£gnum
; i++){

25 
	`İrštf
("%12x%12x%10s\n",
mem£g
[
i
].
ba£_low
,mem£g[i].
Ën_low
,\

26 
mem£g
[
i
].
ty³
==1?"free":"occupied");

27 if(
mem£g
[
i
].
ty³
 =ğ1 && mem£g[i].
ba£_low
 > 
gmemsize
) \

28 
gmemsize
 = 
mem£g
[
i
].
ba£_low
+mem£g[i].
Ën_low
;

33 
m­size
 = 
G_PGNUM
 * (
·ge
);

34 
mem_m­
 = 
	`km®loc0
(
m­size
);

36 
size_of_zÚe
[0] = 16*0x100000;

37 if(
gmemsize
 > 
ZONE_HIGHMEM_PA
){

38 
size_of_zÚe
[1] = (896-16)*0x100000;

39 
size_of_zÚe
[2] = 
gmemsize
 - 896*0x100000;

42 
size_of_zÚe
[1] = 
gmemsize
 - 16*0x100000;

43 
size_of_zÚe
[2] = 0;

45 
	}
}

48 
	$m­_pg
(
u32
*
dœ
,
vpg
,
µg
,
us
,
rw
){

51 
u32
 *
dœ’t
 = 
dœ
 + 
	`PG_H10
(
vpg
);

52 if((*
dœ’t
 & 
PG_P
) == 0){

55 *
dœ’t
 =
	`__·
(
	`__®loc_·ge
(
__GFP_ZERO
è)| 
PG_USU
 | 
PG_RWW
 | 
PG_P
;

57 
u32
 *
tbl
 = (u32*)
	`KV
((*
dœ’t
)>>12<<12);

59 
tbl
[
	`PG_L10
(
vpg
)] = 
µg
<<12|
us
|
rw
|
PG_P
;

60 
FLUSH_TLB
;

61 
	}
}

68 
	$‹mp_mmio_m­
(){

74 
	`İrštf
("emp mmio map begin >>>>>>>>>\n");

75 *
dœ
 = (*)0xc0100000;

78 
u32
 
¡¬t
 = 0xfba00000;

79 
u32
 
’d
 = 0xfbb00000;

80 
vaddr
 = 
¡¬t
; vadd¸<ğ
’d
; vaddr+=1024*4){

81 
vpg
 = (
vaddr
 - 
PAGE_OFFSET
) >> 12;

82 
µg
 = 
vaddr
 >> 12;

83 
	`m­_pg
(
dœ
, 
vpg
, 
µg
, 0, 
PG_RWW
);

85 if(
vaddr
 =ğ
’d
){

86 
dÚe
 = 
çl£
;

87 if(
dÚe
) ;

88 
dÚe
 = 
Œue
;

90 
’d
 = 0xfec00000;

91 
vaddr
 = 0xfeb80000;

95 
vaddr
 = 0xfdbf0000; vaddr <= 0xfdc00000; vaddr+=1024*4){

96 
vpg
 = (
vaddr
 - 
PAGE_OFFSET
) >> 12;

97 
µg
 = 
vaddr
 >> 12;

98 
	`m­_pg
(
dœ
, 
vpg
, 
µg
, 0, 
PG_RWW
);

100 
	`İrštf
("emp mmio map done -----\n");

101 
	}
}

105 
	$mm_š™
(){

106 
	`š™_memÜy
();

107 
	`š™_zÚe
();

108 
	`‹mp_mmio_m­
();

109 
boŞ
 
mm_avaabË
;

110 
mm_avaabË
 = 
Œue
;

111 
	}
}

113 
	$mm_š™2
(){

114 
mm_ÿche
 = 
	`kmem_ÿche_ü—‹
("mm_ÿche", (
mm
), 0,

115 
SLAB_HWCACHE_ALIGN
, 0, 0);

116 
vm_¬—_ÿche
 = 
	`kmem_ÿche_ü—‹
("vma_ÿche", (
vm_¬—
), 0,

117 
SLAB_HWCACHE_ALIGN
, 0, 0);

118 
fs_¡ruù_ÿche
 = 
	`kmem_ÿche_ü—‹
("fs_struct_cache",

119 (
fs_¡ruù
), 0,

120 
SLAB_HWCACHE_ALIGN
, 0, 0);

121 
fes_¡ruù_ÿche
 = 
	`kmem_ÿche_ü—‹
("files_struct_cache",

122 (
fes_¡ruù
), 0,

123 
SLAB_HWCACHE_ALIGN
, 0, 0);

124 
	}
}

	@mm/memory.c

1 
	~<asm/·ge.h
>

2 
	~<lšux/mm.h
>

6 
	$vm_upd©e_pg´Ù
(
vm_¬—
 *
vma
){

7 
±e
 *±ğ&
vma
->
em±y_±e
;

8 
ulÚg
 
vm_æags
 = 
vma
->
æags
.
v®ue
;

10 
±e
->
v®ue
 = 
PG_P
 | 
PG_USU
;

11 if(
vm_æags
 & 
VM_WRITE
è
±e
->
wr™abË
 = 1;

15 
	}
}

22 
·ge
 *

23 
	$__»sŞve_add»ss
(
±e
 *
pgdœ
, 
u32
 
vaddr
, u32 
pg´Ù
){

24 
·ge
 *
Ãw·ge
;

25 
lš—r_addr
 
Ïddr
 = {
v®ue
:
vaddr
};

26 
±e
 *
dœ’t
 = 
pgdœ
 + 
Ïddr
.
dœ_idx
;

27 if(
dœ’t
->
´e£Á
 == 0){

28 
dœ’t
->
v®ue
 = 
	`__·
(
	`__®loc_·ge
(
__GFP_ZERO
)è| 
PG_USU
 | 
PG_RWW
 | 
PG_P
;

30 
±e
 *
pgtbl
 = (*)
	`__va
(
dœ’t
->
v®ue
 & 
PAGE_MASK
);

31 
Ãw·ge
 = 
	`__®loc_·ge
(0);

32 
pgtbl
[
Ïddr
.
tbl_idx
].
v®ue
 = (
ulÚg
)
	`__·
(
Ãw·ge
è| 
pg´Ù
;

33 
FLUSH_TLB
;

34  
Ãw·ge
;

35 
	}
}

40 
boŞ
 
	$__»Ëa£_add»ss
(
±e
 *
pgdœ
, 
vaddr
){

41 
lš—r_addr
 
Ïddr
 = {
v®ue
: 
vaddr
};

42 
±e
 *
dœ’t
 = 
pgdœ
 + 
Ïddr
.
dœ_idx
;

43 if(
dœ’t
->
´e£Á
){

44 
±e
 *
bË
 = (*)
	`__va
Ğ
dœ’t
->
v®ue
 & 
PAGE_MASK
);

45 
idx
 = 
Ïddr
.
tbl_idx
;

46 if(
bË
[
idx
].
´e£Á
){

47 
µg
 = 
bË
[
idx
].
physiÿl
;

48 
	`ä“_·ge
(
mem_m­
 + 
µg
);

49 
bË
[
idx
].
v®ue
 = 0;

50 
FLUSH_TLB
;

51  
Œue
;;

54  
çl£
;

55 
	}
}

59 
·ge
*

60 
	$commÚ_no_·ge
(
vm_¬—
 *
vma
, 
u32
 
”r_addr
, 
pg”r_code
 
”rcode
){

61 
·ge
 *
Ãw·ge
;

62 if(
”rcode
.
Ú_wr™e
 && 
vma
->
em±y_±e
.
wr™abË
 =ğ
çl£
)

63 
	`¥š
("attempto write‡„ead-only vma");

65 
Ãw·ge
 =

66 
	`__»sŞve_add»ss
((*)
	`__va
(
vma
->
mm
->
ü3
.
v®ue
 & 
PAGE_MASK
),

67 
”r_addr
, 
vma
->
em±y_±e
.
v®ue
);

68  
Ãw·ge
;

69 
	}
}

	@mm/mmap.c

4 
	~<lšux/mm.h
>

5 
	~<lšux/fs.h
>

6 
	~<lšux/myli¡.h
>

8 
do_brk
(
mm
 *mm, 
brk
);

9 
š£¹_vm_¬—
(
vm_¬—
 *
Ãw
);

10 
·ge
 *

11 
	$do_no_·ge
(
vm_¬—
 *
¬—
, 
u32
 
add»ss
, 
pg”r_code
 
”rcode
){

12 
	`¥š
("ddd");

14 
	}
}

16 
boŞ
 
	$__ÿche_fe_·ge
(
fe
* fe, 
u32
 
·ge_addr
, u32 
fe_off
){

17 
off£t
 = 
	`k_£ek
(
fe
, 
fe_off
, 0);

18 
	`as£¹
(
off£t
 =ğ
fe_off
);

19 
rby‹s
 = 
	`k_»ad
(
fe
, (*)
·ge_addr
, 
PAGE_SIZE
);

20 
	`as£¹
(
rby‹s
 > 0);

21  
Œue
;

22 
	}
}

27 
·ge
*

28 
commÚ_no_·ge
(
vm_¬—
 *
vma
, 
u32
 
”r_addr
, 
pg”r_code
 
”rcode
);

33 
·ge
 *

34 
	$ÿche_fe_·ge
(
vm_¬—
 *
vma
, 
u32
 
”r_addr
, 
pg”r_code
 
”rcode
){

35 
·ge
 *
Ãw·ge
;

36 
u32
 
lš—r_addr
 = 
”r_addr
 & 
PAGE_MASK
;

37 
u32
 
pgoff
 = 
vma
->pgofà+ ((
”r_addr
 - vma->
¡¬t
è>> 
PAGE_SHIFT
);

38 
u32
 
off£t
 = 
pgoff
 << 
PAGE_SHIFT
;

39 
Ãw·ge
 =

40 
	`commÚ_no_·ge
(
vma
, 
lš—r_addr
, 
”rcode
);

41 
	`__ÿche_fe_·ge
(
vma
->
fe
, 
lš—r_addr
, 
off£t
);

42  
Ãw·ge
;

44 
	}
}

46 
vm_İ”©iÚs
 
	gmm­_¬—_İs
 =

48 
nİage
:
ÿche_fe_·ge
,

63 * 
	$do_mm­
(
u32
 
addr
, u32 
Ën
, 
vm_æags
, 
m­_æags
, 
fe
 *fe, u32 
pgoff
){

64 if(
Ën
 == 0)  0;

67 
addr
 = 
	`û_®ign
×ddr, 
__4K
);

68 
Ën
 = 
	`û_®ign
Ö’, 
__4K
);

70 
addr
 = 
	`g‘_unm­³d_¬—
×ddr, 
Ën
); 
	`as£¹
(addr);

71 
vm_¬—
 *
vma
 = 
	`kmem_ÿche_®loc
(
vm_¬—_ÿche
, 0);

73 
vma
->
mm
 = 
cu¼’t
->mm;

74 
vma
->
¡¬t
 = 
addr
;

75 
vma
->
’d
 = 
addr
 + 
Ën
;

76 
vma
->
æags
.
v®ue
 = 
vm_æags
;

77 
vma
->
fe
 = file;

78 
vma
->
pgoff
 =…goff;

79 if(
fe
){

80 
vma
->
İs
 = &
mm­_¬—_İs
;

83 
vma
->
İs
 = 0;

85 
	`vm_upd©e_pg´Ù
(
vma
);

87 
	`as£¹
(
vma
->
mm
->vma);

89 
	`š£¹_vm_¬—
(
vma
);

90  (*)
addr
;

91 
	}
}

99 
vm_¬—
 *
	$fšd_vma
(
mm
 *mm, 
addr
){

100 
vm_¬—
 *
right_Úe
 = 
	`O_SCAN_UNTIL_MEET_LARGER
(
mm
->
vma
, 
’d
, 
addr
);

101  
right_Úe
;

102 
	}
}

128 
u32
 
	$g‘_unm­³d_¬—
(
u32
 
addr
, u32 
Ën
){

129 if(!
addr
èadd¸ğ
__1G
;

130 
addr
 = 
	`û_®ign
×ddr, 
PAGE_SIZE
);

131 
Ën
 = 
	`û_®ign
Ö’, 
PAGE_SIZE
);

133 
vm_¬—
 *
b’—th
 = 
	`fšd_vma
(
cu¼’t
->
mm
, 
addr
);

134 
addr
 + 
Ën
 < 
__3G
;

135 
addr
 = 
b’—th
->
’d
, b’—th = b’—th->
Ãxt
)

137 if(!
b’—th
 || 
addr
 + 
Ën
 <ğb’—th->
’d
){

138 
	`as£¹
((
addr
 & ~
PAGE_MASK
) == 0);

139  
addr
;

143 
	}
}

148 * 
	$mm­
(
ulÚg
 
addr
, 
u32
 
Ën
, 
vm_æags
, 
m­_æags
, 
fe
 *fe, u32 
off£t
){

149 
	`as£¹
(
addr
 % 
__4K
 =ğ0 && 
off£t
 % __4K == 0);

150 *
»t
 = 
	`do_mm­
(
addr
, 
Ën
, 
vm_æags
, 
m­_æags
, 
fe
, 
off£t
 >> 12);

151 
	`as£¹
(
»t
 =ğ(*)
addr
);

152  
»t
;

153 
	}
}

155 
	$š£¹_vm_¬—
(
vm_¬—
 *
Ãw
){

156 
	`as£¹
(
Ãw
 &&‚ew->
mm
 &&‚ew->mm->
vma
);

157 
mm
 *mm = 
Ãw
->mm;

158 
vm_¬—
 *
roÙ
 = 
mm
->
vma
;

159 
vm_¬—
 *
node
 = 
mm
->
vma
;

161 if(
node
->
¡¬t
 > 
Ãw
->start){

164 
node
 =‚ode->
Ãxt
;

165 }
node
 !ğ
roÙ
);

166 if(
Ãw
->
¡¬t
 < 
roÙ
->¡¬tè
mm
->
vma
 =‚ew;

167 
Ãw
->
Ãxt
 = 
node
;

168 
Ãw
->
´ev
 = 
node
->prev;

169 
node
->
´ev
 = 
Ãw
;

170 
Ãw
->
´ev
->
Ãxt
 =‚ew;

171 
	}
}

177 
	$sys_brk
(
brk
){

180 
	}
}

183 
	$k_brk
(
brk
){

184  
	`do_brk
(
cu¼’t
->
mm
, 
brk
);

185 
	}
}

190 
	$do_brk
(
mm
 *mm, 
brk
){

191 
Ãwbrk
, 
Şdbrk
;

192 
Ãwby‹s
;

193 
	`as£¹
(
mm
->
¡¬t_brk
 && mm->
brk
);

194 
Ãwbrk
 = 
	`û_®ign
(
brk
, 
__4K
);

195 
Şdbrk
 = 
mm
->
brk
;

196 
Ãwby‹s
 = 
Ãwbrk
 - 
Şdbrk
;

197 if(
Ãwby‹s
 =ğ0è
sucûss
;

199 if(
mm
->
brk
 =ğmm->
¡¬t_brk
){

200 if(
Ãwby‹s
 < 0è
çed
;

201 
	`mm­
(
mm
->
¡¬t_brk
, 
Ãwby‹s
, 
VM_READ
 | 
VM_WRITE
, 0, 0, 0);

202 
sucûss
;

204 
vm_¬—
 *
brk_¬—
 = 
	`fšd_vma
(
mm
, mm->
¡¬t_brk
);

205 
	`as£¹
(
brk_¬—
->
¡¬t
 =ğ
mm
->
¡¬t_brk
);

206 if(
Ãwby‹s
 > 0){

207 
	`vm_¬—_ex·nd
Ğ
brk_¬—
, 
Ãwbrk
);

210 
	`vm_¬—_shršk
Ğ
brk_¬—
, 
Ãwbrk
 );

212 
sucûss
:

213 
mm
->
brk
 = 
Ãwbrk
;

214  
Ãwbrk
;

215 
çed
:

216  
Şdbrk
;

217 
	}
}

219 
boŞ
 
	$vm_¬—_ex·nd
(
vm_¬—
 *
vma
, 
Ãw_’d
){

220 
	`as£¹
(
Ãw_’d
 > 
vma
->
’d


221 && 
Ãw_’d
 % 
__4K
 == 0);

223 ifĞ
	`fšd_vma_š‹r£ùiÚ
(
vma
->
mm
, vma->
’d
, 
Ãw_’d
) )

224  
çl£
;

225 
vma
->
’d
 = 
Ãw_’d
;

226  
Œue
;

227 
	}
}

229 
boŞ
 
	$vm_¬—_shršk
(
vm_¬—
 *
vma
, 
Ãw_’d
){

230 
	`as£¹
(
Ãw_’d
 < 
vma
->
’d


231 && 
Ãw_’d
 > 
vma
->
¡¬t


232 && 
Ãw_’d
 % 
__4K
 == 0);

233 
vaddr
 = 
vma
->
’d
; vadd¸< 
Ãw_’d
; vadd¸+ğ
__4K
){

234 
	`__»Ëa£_add»ss
Ğ
	`PGDIR_OF_MM
(
vma
->
mm
), 
vaddr
 );

236 
vma
->
’d
 = 
Ãw_’d
;

237  
Œue
;

238 
	}
}

	@mm/slab.c

1 
	~<li¡.h
>

2 
	~<mm.h
>

3 
	~<lšux/¦ab.h
>

6 
	s¦ab
{

7 
li¡_h—d
 
	m‹Áaşe
;

8 
	mšu£
;

9 
	mä“
;

10 * 
	mobjs
;

12 
	mä“li¡
[0];

15 
	s¦ab_h—d
{

16 
li¡_h—d
 
	m¦abs_·¹Ÿl
;

17 
li¡_h—d
 
	m¦abs_u£dout
;

18 
li¡_h—d
 
	m¦abs_äesh
;

20 
li¡_h—d
 
	mglob®
;

21 
	mobjsize
;

22 
u16
 
	mobjnum
;

23 
	mä“_objs
;

24 
	mgåÜd”
;

25 
	mgåæags
;

26 cÚ¡ *
	mÇme
;

28 (*
	mùÜ
)(*, 
	m¦ab_h—d
 *, );

29 (*
	mdtÜ
)(*, 
	m¦ab_h—d
 *, );

33 
	#OBJNUM_PER_SLAB
 8

	)

35 
¦ab_h—d
 
	gÿche_ÿche
[1];

39 
šlše
 
__»gi¡”_¦ab_ty³
(*
Çme
, 
objsize
,

40 
off£t
, 
æags
,

41 (*
ùÜ
)(*, 
¦ab_h—d
 *, ),

42 (*
dtÜ
)(*, 
¦ab_h—d
 *, ),

43 
¦ab_h—d
 *
¦abh—d


46 
g¿nuÏr™y
;

47 if(
æags
 & 
SLAB_HWCACHE_ALIGN
){

48 if(
objsize
 >ğ
L1_CACHLINE_SIZE
è
g¿nuÏr™y
 = L1_CACHLINE_SIZE;

49 
g¿nuÏr™y
 = 
	`û2n
(
objsize
);

51 
g¿nuÏr™y
 = 
BYTES_PER_WORD
;

52 
objsize
 = 
	`û_®ign
(objsize, 
g¿nuÏr™y
);

54 
·ges_wegÙ
 = 
	`size2·ges
(
objsize
 * 
OBJNUM_PER_SLAB
);

55 
size_wegÙ
 = 
·ges_wegÙ
 << 12;

56 
right_size
 = (
size_wegÙ
 - (
¦ab
) );

57 
objnum_mo¡
 = 
right_size
 / (
·ge
);

58 
obj_¡¬t
 = 
size_wegÙ
 - 
objsize
 * 
objnum_mo¡
;

60 
·dd’
 = 
obj_¡¬t
 - (
¦ab
);

62 
x
;

63 ifĞ
·dd’
/2 >ğ
objnum_mo¡
è
x
 = 0;

64 
x
 = 
	`û_div
(2 * 
objnum_mo¡
 - 
·dd’
 , 
objsize
 + 2);

65 
objnum
 = 
objnum_mo¡
 - 
x
;

67 
¦abh—d
->
objsize
 = objsize;

68 
¦abh—d
->
objnum
 = objnum;

69 
¦abh—d
->
gåÜd”
 = 
	`__BSR
(
·ges_wegÙ
);

70 
¦abh—d
->
gåæags
 = 0;

71 if(
æags
 & 
SLAB_CACHE_DMA
è
¦abh—d
->
gåæags
 |ğ
__GFP_DMA
;

72 
¦abh—d
->
ùÜ
 = ctor;

73 
¦abh—d
->
dtÜ
 = dtor;

74 
¦abh—d
->
Çme
 =‚ame;

76 
	`INIT_LIST_HEAD
(&
¦abh—d
->
¦abs_u£dout
);

77 
	`INIT_LIST_HEAD
(&
¦abh—d
->
¦abs_·¹Ÿl
);

78 
	`INIT_LIST_HEAD
(&
¦abh—d
->
¦abs_äesh
);

79 
	`INIT_LIST_HEAD
(&
¦abh—d
->
glob®
);

80 
	`li¡_add
(&
¦abh—d
->
glob®
, &
ÿche_ÿche
->global);

83 
	}
}

85 
šlše
 
	$·ge_m¬k_¦ab
(
·ge
 *·ge, 
¦ab
 *slab){

86 
·ge
->
Ìu
.
´ev
 = (
li¡_h—d
 *)
¦ab
;

87 
	}
}

89 
šlše
 
	$·ge_m¬k_ÿche
(
·ge
 *·ge, 
¦ab_h—d
 *
¦abh—d
){

90 
·ge
->
Ìu
.
Ãxt
 = (
li¡_h—d
 *)
¦abh—d
;

91 
	}
}

93 
šlše
 
	$¦ab_queue_grow
(
¦ab_h—d
 *
¦abh—d
, 
æags
){

94 
¦ab
 *slab = (slab *)

95 
	`__®loc_·ges
(
¦abh—d
->
gåæags
, sÏbh—d->
gåÜd”
);

96 
¦ab
->
šu£
 = 0;

97 
¦ab
->
ä“
 = 0;

98 
¦ab
->
objs
 = (*)((
u32
)¦ab + 
PAGE_SIZE
 * (1 << 
¦abh—d
->
gåÜd”
) - \

99 
¦abh—d
->
objnum
 * sÏbh—d->
objsize
);

100 
i
 = 0; i < 
¦abh—d
->
objnum
; i++){

101 *
obj
 = 
¦ab
->
objs
 + 
¦abh—d
->
objsize
 * 
i
;

102 
¦ab
->
ä“li¡
[
i
] = i + 1;

103 if(
¦abh—d
->
ùÜ
è¦abh—d->
	`ùÜ
(
obj
, sÏbh—d, 
æags
);

106 
pgÄ
 = 1 << 
¦abh—d
->
gåÜd”
;

107 
·ge
 *·gğ
	`vœt_to_·ge
(
¦ab
);

108 
i
 = 0; i < 
pgÄ
; i ++){

109 
	`·ge_m¬k_¦ab
(
·ge
 + 
i
, 
¦ab
);

110 
	`·ge_m¬k_ÿche
(
·ge
 +
i
 , 
¦abh—d
);

113 
	`li¡_add
(&
¦ab
->
‹Áaşe
, &
¦abh—d
->
¦abs_äesh
);

114 
¦abh—d
->
ä“_objs
 +ğ¦abh—d->
objnum
;

116 
	}
}

118 
šlše
 *
	$¦ab_®loc_Úe
(
¦ab_h—d
 *
¦abh—d
, 
¦ab
 *slab){

119 
	`as£¹
(
¦ab
->
šu£
 !ğ
¦abh—d
->
objnum
);

120 
ä“id
 = 
¦ab
->
ä“
;

121 * 
obj
 = 
¦ab
->
objs
 + 
¦abh—d
->
objsize
 * 
ä“id
;

122 
¦ab
->
ä“
 = sÏb->
ä“li¡
[
ä“id
];

123 
¦ab
->
šu£
 ++;

124  
obj
;

125 
	}
}

127 * 
	$kmem_ÿche_®loc
(
¦ab_h—d
 *
¦abh—d
, 
æags
){

128 ifĞ
	`li¡_em±y
(&
¦abh—d
->
¦abs_·¹Ÿl
) ){

129 ifĞ
	`li¡_em±y
(&
¦abh—d
->
¦abs_äesh
) ){

130 
	`¦ab_queue_grow
(
¦abh—d
, 
æags
);

132 
li¡_h—d
 *
äesh
 = 
¦abh—d
->
¦abs_äesh
.
Ãxt
;

133 
	`li¡_d–
(
äesh
);

134 
	`li¡_add
(
äesh
, &
¦abh—d
->
¦abs_·¹Ÿl
);

136 
¦ab
 *¦ab = 
	`MB2STRU
(¦ab, 
¦abh—d
->
¦abs_·¹Ÿl
.
Ãxt
, 
‹Áaşe
);

137 *
obj
 = 
	`¦ab_®loc_Úe
(
¦abh—d
, 
¦ab
);

138 
¦abh—d
->
ä“_objs
 --;

139 if(
¦ab
->
šu£
 =ğ
¦abh—d
->
objnum
){

140 
	`li¡_d–
(&
¦ab
->
‹Áaşe
);

141 
	`li¡_add
(&
¦ab
->
‹Áaşe
, &
¦abh—d
->
¦abs_u£dout
);

143  
obj
;

144 
	}
}

145 
¦ab_h—d
 * 
»gi¡”_¦ab_ty³
(*
Çme
, 
objsize
,

146 
off£t
, 
æags
,

147 (*
ùÜ
)(*, 
¦ab_h—d
 *, ),

148 (*
dtÜ
)(*, 
¦ab_h—d
 *, )

151 
¦ab_h—d
 *
¦abh—d
 = 
	`kmem_ÿche_®loc
(
ÿche_ÿche
, 0);

152 
	`__»gi¡”_¦ab_ty³
(
Çme
, 
objsize
, 
off£t
, 
æags
, 
ùÜ
, 
dtÜ
, 
¦abh—d
);

153  
¦abh—d
;

154 
	}
}

156 
šlše
 
	$¦ab_ä“_Úe
(
¦ab_h—d
 *
¦abh—d
, 
¦ab
 *¦ab, 
toä“
){

157 
¦ab
->
ä“li¡
[
toä“
] = sÏb->
ä“
;

158 
¦ab
->
ä“
 = 
toä“
;

159 
¦ab
->
šu£
 --;

160 
	}
}

162 
	$kmem_ÿche_ä“
(
¦ab_h—d
 *
¦abh—d
, *
obj
){

163 
·ge
 *·gğ
	`vœt_to_·ge
(
obj
);

164 
	`as£¹
(
·ge
->
Ìu
.
Ãxt
 =ğ(*)
¦abh—d
);

166 
¦ab
 *¦ab = (*)
·ge
->
Ìu
.
´ev
;

167 
toä“
 = (
obj
 - 
¦ab
->
objs
è/ 
¦abh—d
->
objsize
;

168 
	`¦ab_ä“_Úe
(
¦abh—d
, 
¦ab
, 
toä“
);

169 
¦abh—d
->
ä“_objs
 ++;

171 if(
¦ab
->
šu£
 =ğ
¦abh—d
->
objnum
 - 1){

172 
	`li¡_d–
(&
¦ab
->
‹Áaşe
);

173 
	`li¡_add
(&
¦ab
->
‹Áaşe
, &
¦abh—d
->
¦abs_·¹Ÿl
);

175 if(
¦ab
->
šu£
 == 0){

176 
	`li¡_d–
(&
¦ab
->
‹Áaşe
);

177 
	`li¡_add
(&
¦ab
->
‹Áaşe
, &
¦abh—d
->
¦abs_äesh
);

180 
	}
}

181 
	sÿche_size
{

182 
	msize
;

183 
¦ab_h—d
 *
	m¦abh—d
;

184 
¦ab_h—d
 *
	m¦abh—d_dma
;

187 
	#COMMON_CACHE_NUM
 12

	)

188 
	#COMMON_CACHE_MIN
 32

	)

189 
ÿche_size
 
	gm®loc_sizes
[
COMMON_CACHE_NUM
];

194 *
	$km®loc2
(
size
, 
æags
){

195 
i
 = 0; i <
COMMON_CACHE_NUM
; i++ ){

196 if(
m®loc_sizes
[
i
].
size
 >= size){

197 *
obj
 = 
	`kmem_ÿche_®loc
(
æags
 & 
__GFP_DMA
 ?

198 
m®loc_sizes
[
i
].
¦abh—d_dma
 : m®loc_sizes[i].
¦abh—d
, 
æags
);

199 if(
obj
 && (
æags
 & 
__GFP_ZERO
)è
	`mem£t
(obj, 0, 
size
);

200  
obj
;

203 
	`as£¹
("too big size" && 0);

204  
NULL
;

205 
	}
}

207 
	$kä“2
(*
obj
){

208 
·ge
 *·gğ
	`vœt_to_·ge
(
obj
);

209 
	`kmem_ÿche_ä“
((
¦ab_h—d
 *)
·ge
->
Ìu
.
Ãxt
, 
obj
);

210 
	}
}

213 
	$kmem_ÿche_š™
(){

214 
	`__»gi¡”_¦ab_ty³
("¦ab_h—d", Ğ
¦ab_h—d
), 0, 
SLAB_HWCACHE_ALIGN
,

215 
NULL
, NULL, 
ÿche_ÿche
);

217  
i
 = 0; i < 
COMMON_CACHE_NUM
; i++){

218 
size
 = 
COMMON_CACHE_MIN
 << 
i
;

219 
m®loc_sizes
[
i
].
size
 = size;

220 
m®loc_sizes
[
i
].
¦abh—d
 = 
	`»gi¡”_¦ab_ty³
Ğ"commÚ", 
size
,

221 0, 0, 
NULL
, NULL);

222 
m®loc_sizes
[
i
].
¦abh—d_dma
 = 
	`»gi¡”_¦ab_ty³
Ğ"commÚ_dma", 
size
,

223 0, 
SLAB_CACHE_DMA
, 
NULL
, NULL);

225 
	}
}

227 *
	gadd»ss
[2048];

228 
¦ab_h—d
 *
	g¦abh—ds
[128];

229 
	gcur_idx
;

230 
	$__kmem_ÿche_®loc_ä“
(
¦ab_h—d
 *
¦abh—d
, 
Ä_»³©
){

231 
	`as£¹
(
Ä_»³©
 < 2048);

233 
Ä_»³©
 = (Ä_»³© / 
¦abh—d
->
objnum
 + 1) * slabhead->objnum;

234 
i
;

235 
j
;

236 
i
 = 0; i < 
Ä_»³©
; i++){

237 
add»ss
[
i
] = 
	`kmem_ÿche_®loc
(
¦abh—d
, 0);

239 
i
 = 0; i < 
Ä_»³©
; i++){

240 
	`kmem_ÿche_ä“
(
¦abh—d
, 
add»ss
[
i
]);

242 
i
 = 0; i < 
Ä_»³©
; i++){

243 * 
obj
 = 
	`kmem_ÿche_®loc
(
¦abh—d
, 0);

244 
j
 = 0; j < 
Ä_»³©
; j++){

245 ifĞ
obj
 =ğ
add»ss
[
j
] ){

247 
	`mem£t
(
obj
, 1, 
¦abh—d
->
objsize
);

248 
add»ss
[
j
] = 0;

249 
	`İrštf
(". ");

253 
	`as£¹
(
j
 !ğ
Ä_»³©
);

255 
	}
}

257 
	$kmem_ÿche_®loc_ä“
(*
Çme
, 
size
, 
æags
, 
Ä_»³©
){

258 
	`as£¹
(
Ä_»³©
 < 2048);

259 
¦ab_h—d
 *
¦abh—d
 = 
	`kmem_ÿche_ü—‹
(
Çme
, 
size
, 0, 
æags
, 0, 0);

260 
	`__kmem_ÿche_®loc_ä“
(
¦abh—d
, 
Ä_»³©
);

261 
¦abh—ds
[
cur_idx
++] = 
¦abh—d
;

262 
	}
}

263 
	$kmem_ÿche_‹¡
(){

271 
i
 = 0; i < 
COMMON_CACHE_NUM
; i++){

272 
j
;

273 
j
 =0 ; j < 100; j++){

274 *
obj
 = 
	`km®loc2
Ğ
m®loc_sizes
[
i
].
size
 - 1 , 
__GFP_DMA
);

275 
	`as£¹
(
obj
);

276 
add»ss
[
j
] = 
obj
;

277 
	`mem£t
(
obj
, 0xcc, 
m®loc_sizes
[
i
].
size
);

280 
j
 =0 ; j < 100; j++){

281 
	`kä“2
(
add»ss
[
j
]);

284 
	}
}

287 * 
	$¡©ic_®loc
(
objsize
, 
objnum
){

288 
	`as£¹
(
objsize
 %4 =ğ0 && 
objnum
 > 0 && objnum < 2048);

289  
	`km®loc2
(
objsize
 * 
objnum
, 
__GFP_ZERO
);

290 
	}
}

	@mmzone.c

1 
	~<mmzÚe.h
>

2 
	~<uts.h
>

4 
·ge_is_buddy
(
·ge
 *·ge, 
Üd”
);

5 
š™_ä“_¬—
(
zÚe_id
, 
¡¬t_idx
);

6 
__ä“_·ges_bulk
(
·ge
 *·ge, 
zÚe_t
 *
zÚe
, 
Üd”
);

7 
ş—ve
(
ä“_¬—_t
 *
ä“_¬—
, 
Üd”
);

8 
	$šfo_zÚe
(
zÚe_id
){

9 
	`İrštf
("zÚe%u[¥ªÃd_·ges:%x]\n", 
__zÚes
[
zÚe_id
]->
¥ªÃd_·ges
);

10 
	}
}

12 
zÚe_t
 *
	g__zÚes
[3] = {&
zÚe_dma
, &
zÚe_nÜm®
, &
zÚe_highmem
};

13 
	g·_of_zÚe
[3] = {
ZONE_DMA_PA
, 
ZONE_NORMAL_PA
, 
ZONE_HIGHMEM_PA
};

14 
	$š™_zÚe
(){

15 
	`İrštf
("init buddy \n");

16 
i
 = 0; i <= 2; i++){

17 
__zÚes
[
i
]->
zÚe_mem_m­
 = 
mem_m­
 + 
	`·_idx
(
·_of_zÚe
[i]);

18 
__zÚes
[
i
]->
¥ªÃd_·ges
 = 
size_of_zÚe
[i]>>12;

24 
	`š™_ä“_¬—
(
ZONE_DMA
, 0x300000>>12);

25 
	`š™_ä“_¬—
(
ZONE_NORMAL
, 
HEAP_SIZE
>>12);

26 
	`š™_ä“_¬—
(
ZONE_HIGHMEM
, 0);

27 
	}
}

33 
	$š™_ä“_¬—
(
zÚe_id
, 
¡¬t_idx
){

34 
zÚe_t
 *
zÚe
 = 
__zÚes
[
zÚe_id
];

35 
ä“_¬—_t
 *
ä“_¬—
 = 
zÚe
->free_area;

36 
·ge
 *
zÚe_m­
 = 
zÚe
->
zÚe_mem_m­
;

37 
i
 = 0; i <ğ
MAX_ORDER
; i++){

38 
	`INIT_LIST_HEAD
(&
ä“_¬—
[
i
].
ä“_li¡
);

39 
ä“_¬—
[
i
].
ä“s
 = 0;

40 
ä“_¬—
[
i
].
®locs
 = 0;

43 
lšked
 = 
¡¬t_idx
;

45 
lšked
 < 
zÚe
->
¥ªÃd_·ges
){

46 
zÚe_m­
[
lšked
].
PG_zid
 = 
zÚe_id
;

47 
zÚe_m­
[
lšked
].
_couÁ
 = 1;

48 
zÚe_m­
[
lšked
].
´iv©e
 = 8;

50 
	`ä“_·ges
(
zÚe_m­
 + 
lšked
, 8);

52 
lšked
 += 1 << 8;

54 
zÚe
->
ä“s
 = zÚe->
®locs
 = 0;

56 
	}
}

61 
	$__ä“_·ges_bulk
(
·ge
 *·ge, 
zÚe_t
 *
zÚe
, 
Üd”
){

62 
	`as£¹
(
	`şi_®»ady
());

63 
	`as£¹
(
·ge
->
_couÁ
 == 0 && "only‡llow invoked by free_pages");

64 
	`as£¹
(
Üd”
 =ğ
·ge
->
´iv©e
 && "just commenthis†ine, but be‡ware \
 of what happended");

66 
	`as£¹
(
zÚe
->
ä“_¬—
[
Üd”
].
Ä_ä“
 >= 0);

68 
ä“_¬—_t
 * 
ä“_¬—
 = 
zÚe
->free_area;

69 
·ge
 *
Üphª
 =…age;

70 
·ge
 *
assume_h—d
 = 0;

72 
·ge
 *
phy_ÃighbÜ
 = 0;

73 
cu¼_Üd”
;

74 
Üphª
->
PG_´iv©e
 = 0;

75 
cu¼_Üd”
 = 
Üd”
; cu¼_Üd” < 
MAX_ORDER
; curr_order++){

76 
block_pgs
 = 1<<
cu¼_Üd”
;

80 if(
	`·ge_idx
(
Üphª
è/ 
block_pgs
 % 2 == 0){

81 
phy_ÃighbÜ
 = 
Üphª
 + 
block_pgs
;

82 
assume_h—d
 = 
Üphª
;

85 
phy_ÃighbÜ
 = 
Üphª
 - 
block_pgs
;

86 
assume_h—d
 = 
phy_ÃighbÜ
;

89 if(
phy_ÃighbÜ
 < 
zÚe
->
zÚe_mem_m­
 || \

90 
phy_ÃighbÜ
 >ğ
zÚe
->
zÚe_mem_m­
 + zÚe->
¥ªÃd_·ges
){

91 
	`İrštf
("buddy:boundary outside ");

94 if(!
	`·ge_is_buddy
(
phy_ÃighbÜ
, 
cu¼_Üd”
)) ;

97 
	`li¡_d–
(&
phy_ÃighbÜ
->
Ìu
); 
ä“_¬—
[
cu¼_Üd”
].
Ä_ä“
--;

100 
phy_ÃighbÜ
->
PG_´iv©e
 = 0;

102 
Üphª
 = 
assume_h—d
;

105 
	`INIT_LIST_HEAD
(&
Üphª
->
Ìu
);

106 
	`li¡_add
(&
Üphª
->
Ìu
, &
ä“_¬—
[
cu¼_Üd”
].
ä“_li¡
);

107 
Üphª
->
PG_´iv©e
 = 1;

108 
Üphª
->
´iv©e
 = 
cu¼_Üd”
;

109 
	`as£¹
(
Üphª
->
_couÁ
 == 0);

110 
ä“_¬—
[
cu¼_Üd”
].
Ä_ä“
++;

112 
	}
}

114 
	$·ge_is_buddy
(
·ge
 *·ge, 
Üd”
){

115 if(
·ge
->
PG_´iv©e
 =ğ0 ||…age->
_couÁ
 !ğ0 ||…age->
´iv©e
 !ğ
Üd”
){

120 
	}
}

121 
·ge
 *
	$__rmqu’e
(
zÚe_t
 *
zÚe
 , 
Üd”
){

122 
IF
 = 
	`şi_ex
();

123 
zÚe
->
®locs
++;

124 
zÚe
->
ä“_¬—
[
Üd”
].
®locs
++;

125 
	`as£¹
(
zÚe
->
ä“_¬—
[
Üd”
].
Ä_ä“
 >= 0);

126 
ä“_¬—_t
 *
ä“_¬—
 = 
zÚe
->free_area;

127 
i
 = 
Üd”
;

128 
ä“_¬—
[
i
].
Ä_ä“
 == 0){

129 
i
++;

130 if(
i
 =ğ
MAX_ORDER
 + 1è
	`¥š
("page frame„eclaming„equired");

132 
i
 > 
Üd”
){

133 
	`ş—ve
(
zÚe
->
ä“_¬—
, 
i
);

134 
i
--;

136 
li¡_h—d
 *
Ìu
 = 
ä“_¬—
[
i
].
ä“_li¡
.
Ãxt
;

137 
	`li¡_d–_š™
(
Ìu
); 
ä“_¬—
[
i
].
Ä_ä“
--;

139 
·ge
 *
™
 = (
·ge_t
 *)(()
Ìu
 - 
	`MEMBER_OFFSET
(page_t,†ru));

140 
™
->
_couÁ
 = 1;

141 
™
->
PG_´iv©e
 = 0;

142 
™
->
debug
 = 
zÚe
->
®locs
;

144 if(
IF
è
	`¡i
();

145  
™
;

146 
	}
}

151 
	$ş—ve
(
ä“_¬—_t
 *
ä“_¬—
, 
Üd”
){

152 
li¡_h—d
 *
ä“_li¡
 = &
ä“_¬—
[
Üd”
].free_list;

154 
li¡_h—d
 *
Ìu
 = 
ä“_li¡
->
Ãxt
;

155 
	`li¡_d–_š™
(
Ìu
);

156 
ä“_¬—
[
Üd”
].
Ä_ä“
--;

158 
·ge_t
 *
mÙh”
 = (·ge_ˆ*)(()
Ìu
 - 
	`MEMBER_OFFSET
(page_t,†ru));

159 
·ge_t
 *
chd1
 = 
mÙh”
;

160 
chd1
->
´iv©e
--;

161 
·ge_t
 *
chd2
 = 
chd1
 + (1<<chd1->
´iv©e
);

162 *
chd2
 = *
chd1
;

163 
	`li¡_add
(&
chd1
->
Ìu
, &
ä“_¬—
[
Üd”
 - 1].
ä“_li¡
);

164 
	`li¡_add
(&
chd2
->
Ìu
, &
ä“_¬—
[
Üd”
 - 1].
ä“_li¡
);

165 
ä“_¬—
[
Üd”
 - 1].
Ä_ä“
 += 2;

166 
	}
}

174 
	$ä“_·ges
(
·ge_t
 *
·ge
, 
Üd”
){

175 
	`as£¹
(
·ge
->
_couÁ
 >= 1);

176 
IF
 = 
	`şi_ex
();

178 
zÚe_t
 *
zÚe
 = 
__zÚes
[
·ge
->
PG_zid
];

179 
zÚe
->
ä“s
++;

180 
zÚe
->
ä“_¬—
[
Üd”
].
ä“s
++;

181 
·ge
->
_couÁ
--;

182 if(
·ge
->
_couÁ
 == 0){

183 
	`__ä“_·ges_bulk
(
·ge
, 
zÚe
, 
Üd”
);

186 if(
IF
è
	`¡i
();

187 
	}
}

190 
·ge
 *
	$®loc_·ges
(
u32
 
gå_mask
, 
Üd”
){

192 
·ge
 *page;

193 
avoid_gcc_com¶aš
;

194 if(
gå_mask
 & 
__GFP_DMA
){

195 
·ge
 = (*)
	`__rmqu’e
(&
zÚe_dma
, 
Üd”
);

197 if(
gå_mask
 & 
__GFP_HIGHMEM
){

198 
avoid_gcc_com¶aš
 =

199 Ğ
·ge
 = (*)
	`__rmqu’e
(&
zÚe_highmem
, 
Üd”
) ) ||

200 Ğ
·ge
 = (*)
	`__rmqu’e
(&
zÚe_nÜm®
, 
Üd”
) ) ||

201 Ğ
·ge
 = (*)
	`__rmqu’e
(&
zÚe_dma
, 
Üd”
) ) ;

204 
avoid_gcc_com¶aš
 =

205 Ğ
·ge
 = (*)
	`__rmqu’e
(&
zÚe_nÜm®
, 
Üd”
) ) ||

206 Ğ
·ge
 = (*)
	`__rmqu’e
(&
zÚe_dma
, 
Üd”
) ) ;

208 
	`as£¹
(
·ge
);

209 if(
gå_mask
 & 
__GFP_ZERO
){

210 
µg
 = 
·ge
 - 
mem_m­
;

211 *
vaddr
 = (*)
	`KV
(
µg
 << 12);

212 
	`mem£t
(
vaddr
, 0, 4096<<
Üd”
);

214 
·ge
->
_couÁ
 = 1;

215  
·ge
;

216 
	}
}

	@net/core/dev.c

1 
	~<lšux/Ãtdeviû.h
>

2 
	~<lšux/myli¡.h
>

3 
	~<uts.h
>

4 
	~<lšux/if_‘h”.h
>

5 
	~<lšux/by‹Üd”/g’”ic.h
>

6 
	~<Ãt/¬p.h
>

7 
	~<Ãt/.h
>

8 
	~<Ãt/tı.h
>

9 
	#IN_WAKE_QUEUE
 1

	)

11 
	#YOUR_NIC_CNT
 4

	)

12 
Ãt_deviû
 *
	g__®l_your_nic
[
YOUR_NIC_CNT
];

14 
Ãt_deviû
 * 
	$who_am_i
(
u8
 *
mac
){

15 
Ãt_deviû
 *
this
;

16 
i
 = 0; i < 
YOUR_NIC_CNT
; i++){

17 ifĞ(
this
 = 
__®l_your_nic
[
i
]) &&

18 
	`memcmp
(
this
->
mac
, mac, 6) == 0 )

20  
this
;

24 
	}
}

26 
	$šfo_nic
(
Ãt_deviû
 *
Ãtdev
){

28 
u8
 *
mac
 = 
Ãtdev
->mac;

29 
	s—x
 { 
u8
 
®
; u8 
ah
; u8 
AL
; u8 
AH
;};

30 
—x
 *

 = (*)&
Ãtdev
->ip;

31 
	`İrštf
("mac: %x%x%x%x%x%x << *%x >>:%u.%u.%u.%u \n", 
mac
[0], mac[1], mac[2], mac[3], mac[4], mac[5],

32 &
Ãtdev
->

,

33 

->
AH
, ip->
AL
, ip->
ah
, ip->
®
);

35 
	}
}

36 
	$li¡_nic
(){

37 
Ãt_deviû
 *
this
;

38 
i
 = 0; i < 
YOUR_NIC_CNT
; i++){

39 ifĞ(
this
 = 
__®l_your_nic
[
i
]) ){

40 
	`İrštf
("nic[%u]: ", 
i
);

41 
	`šfo_nic
(
this
);

44 
	}
}

53 
Ãt_deviû
 *
	$pick_nic
(
u32
 
de¡_
, u32 
¤c_
){

54 
	`as£¹
(
de¡_
 || 
¤c_
);

55 
Ãt_deviû
 *
this
;

56 
i
 = 0; i < 
YOUR_NIC_CNT
; i++){

57 if((
this
 = 
__®l_your_nic
[
i
])){

58 if(
this
->

 =ğ
¤c_
) his;

61 if((
de¡_
 & 
this
->
mask
è=ğÑhis->

 &his->ipmask)){

62  
this
;

68 
__—x
 *
—x
 = (*)&
de¡_
;

69 
	`İrštf
("wªˆtØ%u.%u.%u.%u\n", 
—x
->
AH
,ƒax->
AL
,ƒax->
ah
,ƒax->
®
);

70 
—x
 = (*)&
¤c_
;

71 
	`İrštf
("äom %u.%u.%u.%u\n", 
—x
->
AH
,ƒax->
AL
,ƒax->
ah
,ƒax->
®
);

74 
	`as£¹
(0 && "pic‚ic failed");

76 
	}
}

78 
	$»gi¡”_nic
(
Ãt_deviû
 *
Ãtdev
){

79 
i
 = 0; i < 
YOUR_NIC_CNT
; i++){

80 if(!
__®l_your_nic
[
i
]){

81 
__®l_your_nic
[
i
] = 
Ãtdev
;

85 
	`as£¹
(0);

86 
	}
}

88 
	$Ãt_š™
(){

89 
	`skbuff_š™
();

90 
	`¬p_š™
();

91 
	`_Ïy”_š™
();

92 
	`š™_tı
();

93 
	}
}

99 
	$wa™šg_fÜ_Œªsm™
(
sk_buff
 *
skb
){

101 
	`as£¹
Ğ
	`¡i_®»ady
() );

102 
	`şi
();

103 
boŞ
 
tx_queue_em±y
 = !(boŞ)
skb
->
dev
->
tx_queue
.
roÙ
;

104 
	`LL2_A
Ğ&
skb
->
dev
->
tx_queue
, skb);

105 
	`¡i
();

112 if(
tx_queue_em±y
è
	`nic_wake_queue
(
skb
->
dev
);

114 
skb
->
dev
->
debug
.
quick_š£¹
++;

124 
	}
}

139 
	$nic_wake_queue
(
Ãt_deviû
 *
Ãtdev
){

140 
	`as£¹
Ğ
	`¡i_®»ady
() );

146 
	`şi
();

151 ifĞ(
Ãtdev
->
æags
 & 
IN_WAKE_QUEUE
è=ğ1è 
	`¡i
();

153 if(!
Ãtdev
->
tx_queue
.
roÙ
è 
	`¡i
();

154 if(
Ãtdev
->
	`tx_busy
(netdev)) {

158  
	`¡i
();

160 
Ãtdev
->
æags
 |ğ
IN_WAKE_QUEUE
;

161 
	`¡i
();

163 
skb_queue
 *
li¡
 = &
Ãtdev
->
tx_queue
;

164 
sk_buff
 * 
Úe
;

167 
code
 = 0;

169 
Ãtdev
->
tx_couÁ
++;

171 
Úe
 = 
li¡
->
roÙ
;

173 
	`LL2_POP
(
li¡
);

174 
	`şi
();

175 
code
 = 
Ãtdev
->
	`¡¬t_xm™
(
Úe
,‚etdev);

176 if(
code
 =ğ-1 || 
li¡
->
roÙ
 == 0){

177 
Ãtdev
->
æags
 &ğ~
IN_WAKE_QUEUE
;

180 
	`¡i
();

183 
	`¡i
();

187 
	}
}

190 
	$´oûss_rx_queue
Ğ
Ãt_deviû
 *
Ãtdev
){

191 
couÁ
 = 0;

192 
	`as£¹
(
couÁ
 == 0);

193 
couÁ
++;

195 
skb_queue
 *
rx_queue
 = &
Ãtdev
->rx_queue;

196 
	`şi
();

197 
rx_queue
->
roÙ
){

198 
sk_buff
 *
Úe
 = 
rx_queue
->
roÙ
;

199 
	`LL2_POP
(
rx_queue
);

200 
	`¡i
();

201  
	`Áohs
(
Úe
->
‘hhdr
->
´ÙocŞ
) ){

202 
PROTOCOL_ARP
:

203 
	`¬p_Ïy”_»ûive
(
Úe
);

205 
PROTOCOL_IP
:

206 
	`_Ïy”_»ûive
(
Úe
);

209 
	`¥š
("ipv6 message");

211 
	`İrštf
("´ÙocŞ id:%x , IGNORE It\n", 
	`Áohs
(
Úe
->
‘hhdr
->
´ÙocŞ
) );

214 
	`şi
();

216 
	`¡i
();

217 
couÁ
--;

218 
	}
}

	@net/core/skbuff.c

1 
	~<uts.h
>

2 
	~<lšux/skbuff.h
>

3 
	~<lšux/Ãtdeviû.h
>

4 
	~<lšux/if_‘h”.h
>

5 
	~<Ãt/¬p.h
>

6 
	~<lšux/.h
>

7 
	~<lšux/udp.h
>

8 
	~<lšux/icmp.h
>

10 
¦ab_h—d
 *
	gskbuff_ÿche
;

11 
	$skbuff_š™
(){

12 
skbuff_ÿche
 = 
	`kmem_ÿche_ü—‹
("skbuff_ÿche", (
sk_buff
), 0,

13 
SLAB_HWCACHE_ALIGN
, 0, 0);

14 
	}
}

27 
sk_buff
 *
	$dev_®loc_skb2
(
u32
 
msgty³
, 
size_t
 
·ylßd
){

28 
Ën
 = Ğ
‘hhdr
);

29 
msgty³
 & 0xffff){

31 
Ën
 +ğĞ
¬phdr
 );

34 
Ën
 +ğĞ
hdr
);

35 
msgty³
 >> 24){

37 
Ën
 +ğĞ
udphdr
);

40 
msgty³
 << 8 >> 24){

42 
Ën
 +ğĞ
icmpmsg_un
);

46 
Ën
 +ğĞ
icmpmsg_mask
);

50 
Ën
 +ğĞ
icmpmsg_t¡amp
);

53 
	`¥š
("unknown icmpype");

56 
	`¥š
("unknown IPype");

59 
	`¥š
( "unknown main…rotocolype" );

62  
	`dev_®loc_skb
Ğ
Ën
 + 
·ylßd
 );

63 
	}
}

71 
sk_buff
 * 
	$dev_®loc_skb
Ğ
pkgsize
 ){

72 
bufsize
 = 
pkgsize
 + 2;

73 
sk_buff
 *
skb
 = 
	`kmem_ÿche_®loc
(
skbuff_ÿche
, 0);

74 
skb
->
d©a
 = 
	`km®loc2
Ğ
bufsize
, 0 );

76 
skb
->
‘hhdr
 = (*)Ğskb->
d©a
 + 2 );

77 
skb
->
£cÚd_hdr
 = (*)(skb->
‘hhdr
 + 1);

78 
skb
->
thœd_hdr
 = (*)(skb->
hdr
 + 1);

81 
skb
->
bufsize
 = bufsize;

82 
skb
->
pkgsize
 =…kgsize;

83  
skb
;

84 
	}
}

86 
	$dev_ä“_skb
Ğ
sk_buff
 *
skb
){

88 
	`kä“2
(
skb
->
d©a
);

89 
	`kmem_ÿche_ä“
Ğ
skbuff_ÿche
, 
skb
 );

90 
	}
}

92 *
	$g‘_ty³
(
hdr
 *iphdr){

93 
hdr
->
´ÙocŞ
){

94 
PROTOCOL_ICMP
:

96 
PROTOCOL_UDP
:

98 
PROTOCOL_TCP
:

104 
	}
}

108 
	$šfo_skb
(
sk_buff
 *
skb
){

109 
	`İrštf
("@skb ");

110 
	`Áohs
(
skb
->
‘hhdr
->
´ÙocŞ
)){

111 
PROTOCOL_ARP
:

112 
	`İrštf
("ARP %s ==> %s\n",

113 
	`mk_¡r
Ğ
	`Áohl
(
skb
->
¬phdr
->
my
) ),

114 
	`mk_¡r
Ğ
	`Áohl
(
skb
->
¬phdr
->
your
) ) );

116 
PROTOCOL_IP
:{

117 
	`İrštf
("IP(%s) %s ==> %s\n",

118 
	`g‘_ty³
(
skb
->
hdr
),

119 
	`mk_¡r
Ğ
	`Áohl
(
skb
->
hdr
->
my
) ),

120 
	`mk_¡r
Ğ
	`Áohl
(
skb
->
hdr
->
your
) )

125 
	`İrštf
("UNKNOWN…rotocol\n");

128 
	}
}

	@net/core/testnet.c

1 
	~<lšux/skbuff.h
>

2 
	~<lšux/Ãtdeviû.h
>

3 
	~<uts.h
>

5 
	~<Ãt/¬p.h
>

6 
	$£nd_d©a
(*
d©a
){

7 
tÙ®
 = 1;

8 
i
 = 0; i < 
tÙ®
; i++){

12 
u32
 
your
 = 
	`MAKE_IP
(192, 168, 0, 22);

13 
	`¬p_šquœe
(
your
);

16 
	}
}

18 
»gi¡”_¹l8139_driv”
();

19 
	$‹¡Ãt
(){

21 
	`»gi¡”_¹l8139_driv”
();

24 
	`li¡_nic
();

26 
Ãt_deviû
 *
Ãtdev
 = 
	`pick_nic
(0, 
	`MAKE_IP
(192,168,0,9));

27 
Ãt_deviû
 *
Ãtdev2
 = 
	`pick_nic
(0, 
	`MAKE_IP
(192,168,1,9));

28 
Ãtdev
->
	`İ’
(netdev);

29 
Ãtdev2
->
	`İ’
(netdev2);

38 
d©a
[] = "this†ine come from…apaya kernel";

40 
	`£nd_d©a
(
d©a
);

43 
	}
}

	@net/ipv4/arp.c

4 
	~<Ãt/¬p.h
>

5 
	~<lšux/Ãtdeviû.h
>

6 
	~<lšux/¦ab.h
>

7 
	~<lšux/by‹Üd”/g’”ic.h
>

8 
	~<uts.h
>

9 
	~<lšux/skbuff.h
>

10 
	~<lšux/.h
>

12 
wa™šg_fÜ_Œªsm™
(
sk_buff
 *
skb
);

20 
sk_buff
 **
	gÏ‹r_down
;

21 
u8
 
	g__mac_brßdÿ¡
[6] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff};

22 
u32
 
	g__loÿl_
 = 
MAKE_IP
(192, 168, 0, 9);

23 
	s¬p_»cÜd
{

24 
u32
 
	mhis_
;

25 
	mhis_mac
[6];

26 
¬p_»cÜd
 *
	m´ev
, *
	mÃxt
;

28 
	#ARP_TBL_LEN
 256

	)

29 
¬p_»cÜd
 **
	g¬±bl
;

31 
	$¬p_š™
(){

32 
Ï‹r_down
 = 
	`km®loc2
Ğ4 * 
ARP_TBL_LEN
, 
__GFP_ZERO
);

33 
¬±bl
 = 
	`km®loc2
 (4 * 
ARP_TBL_LEN
, 
__GFP_ZERO
);

34 
	}
}

40 
	$š™_¬p_msg
(
sk_buff
 *
¬pmsg
, 
İ”©iÚ
){

41 
¬phdr
 *¬phd¸ğ
¬pmsg
->arphdr;

43 
¬pmsg
->
‘hhdr
->
´ÙocŞ
 = 
	`htÚs
(0x0806);

45 
¬phdr
->
h¬dw¬e
 = 
	`htÚs
(1);

46 
¬phdr
->
´ÙocŞ
 = 
	`htÚs
(0x0800);

47 
¬phdr
->
İ”©iÚ
 = 
	`htÚs
(operation);

48 
¬phdr
->
haddr_Ën
 = 6;

49 
¬phdr
->
·ddr_Ën
 = 4;

50 
	}
}

52 
u8
 *
	$¬p_lookup
(
u32
 

){

53 
šdex
 = 
	`hash
(

è% 
ARP_TBL_LEN
;

54 
¬p_»cÜd
 * 
roÙ
 = 
¬±bl
[
šdex
];

55 
¬p_»cÜd
 *
™
 = 0;

56 
	`LL_SCAN_ON_KEY
(
roÙ
, 
his_
, 

, 
™
);

57 if(
™
){

58  (
u8
*)
™
->
his_mac
;

61 
	}
}

67 
¬p_»cÜd
 * 
	$¬p_Ë¬n
(
u8
 *
com”_mac
, 
u32
 
com”_
){

68 
šdex
 = 
	`hash
(
com”_
 )% 
ARP_TBL_LEN
;

69 
¬p_»cÜd
 *
»cÜd
 = 
¬±bl
[
šdex
];

70 
»cÜd
){

71 ifĞ
»cÜd
->
his_
 =ğ
com”_
) ;

72 
»cÜd
 =„ecÜd->
Ãxt
;

75 if(
»cÜd
){

76 
	`memıy
Ğ
»cÜd
->
his_mac
, 
com”_mac
, 6);

79 
»cÜd
 = 
	`km®loc2
ĞĞ
¬p_»cÜd
), 0 );

80 
»cÜd
->
his_
 = 
com”_
;

81 
	`memıy
Ğ
»cÜd
->
his_mac
, 
com”_mac
, 6);

83 
	`LL_I
Ğ
¬±bl
[
šdex
], 
»cÜd
);

90  
»cÜd
;

91 
	}
}

94 
	$__¬p_šquœe
(
u32
 
your
, 
u8
 *
mymac
, u32 
my
 ){

96 
sk_buff
 *
skb
 = 
	`dev_®loc_skb2
( 0x0806, 0);

97 
	`š™_¬p_msg
(
skb
, 1, 
mymac
, 
my
, 0, 
your
);

98 
	`wa™šg_fÜ_Œªsm™
(
skb
);

99 
	}
}

103 
	$¬p_šquœe
(
u32
 
your
){

104 
Ãt_deviû
 *
Ãtdev
 = 
	`pick_nic
(
your
, 0);

105 
	`as£¹
(
Ãtdev
);

107 
sk_buff
 *
skb
 = 
	`dev_®loc_skb2
( 0x0806, 0);

108 
¬phdr
 *¬phd¸ğ
skb
->arphdr;

109 
	`š™_¬p_msg
(
skb
, 1);

110 
skb
->
dev
 = 
Ãtdev
;

111 
	`memıy
(
skb
->
‘hhdr
->
yourmac
, 
__mac_brßdÿ¡
, 6);

112 
	`memıy
(
skb
->
‘hhdr
->
mymac
, 
Ãtdev
->
mac
, 6);

114 
	`mem£t
(
¬phdr
->
yourmac
, 0, 6);

115 
	`memıy
(
¬phdr
->
mymac
, 
Ãtdev
->
mac
, 6);

116 
¬phdr
->
your
 = 
	`htÚl
(yourip);

117 
¬phdr
->
my
 = 
	`htÚl
(
Ãtdev
->

);

119 
	`wa™šg_fÜ_Œªsm™
(
skb
);

120 
	}
}

123 
	$¬p_»¥Úd
(
sk_buff
 *
msg
){

124 
¬phdr
 *‡½hd¸ğ
msg
->arphdr;

125 
‘hhdr
 *ƒthhd¸ğ
msg
->ethhdr;

126 
Ãt_deviû
 *
Ãtdev
 = 
msg
->
dev
;

128 
	`¬p_Ë¬n
(
msg
->
¬phdr
->
mymac
, msg->¬phdr->
my
);

130 
	`š™_¬p_msg
(
msg
, 2);

132 
	`memıy
(
‘hhdr
->
yourmac
, 
¬phdr
->
mymac
, 6);

133 
	`memıy
(
‘hhdr
->
mymac
, 
Ãtdev
->
mac
, 6);

135 
	`memıy
(
¬phdr
->
yourmac
, 
‘hhdr
->yourmac, 6);

136 
	`memıy
(
¬phdr
->
mymac
, 
Ãtdev
->
mac
, 6);

137 
¬phdr
->
your
 = 
	`htÚl
×½hdr->
my
);

139 
¬phdr
->
my
 = 
	`htÚl
(
Ãtdev
->

);

141 
	`wa™šg_fÜ_Œªsm™
(
msg
);

142 
	}
}

145 
	$¬p_aù
(
sk_buff
 *
skb
){

146 
¬phdr
 *¬phd¸ğ
skb
->arphdr;

147 
	`as£¹
(
¬phdr
->
İ”©iÚ
 == 2 &&

148 
¬phdr
->
yourmac
[3] =ğ
skb
->
dev
->
mac
[3]);

150 
¬p_»cÜd
 * 
»cÜd
 = 
	`¬p_Ë¬n
Ğ
¬phdr
->
mymac
 ,¬phdr->
my
);

152 
šdex
 = 
	`hash
(
»cÜd
->
his_
 )% 
ARP_TBL_LEN
;

153 
sk_buff
 * 
wa™šg
 = 
Ï‹r_down
[
šdex
];

155 
wa™šg
){

156 
	`İrštf
("$");

157 
sk_buff
 *
_Ãxt
 = 
wa™šg
->
Ãxt
;

158 if(
wa™šg
->
hdr
->
your
 =ğ
	`htÚl
(
»cÜd
->
his_
)){

160 
	`memıy
(
wa™šg
->
‘hhdr
->
yourmac
, 
»cÜd
->
his_mac
, 6);

161 
	`şi
();

162 
	`LL_DEL
(
Ï‹r_down
[
šdex
], 
wa™šg
);

163 
	`¡i
();

164 
	`wa™šg_fÜ_Œªsm™
(
wa™šg
);

166 
wa™šg
 = 
_Ãxt
;

168 
	}
}

173 
	$¬p_down
(
sk_buff
 *
skb
){

174 
hdr
 * iphd¸ğ
skb
->iphdr;

175 
your
 = 
	`Áohl
(
hdr
->yourip);

178 
Ãt_deviû
 * 
dev
 = 
skb
->dev;

179 
	`as£¹
(
dev
);

181 
	`memıy
(
skb
->
‘hhdr
->
mymac
, skb->
dev
->
mac
, 6);

182 
skb
->
‘hhdr
->
´ÙocŞ
 = 
	`htÚs
(0x0800);

185 
Ãxthİ
;

186 if((
your
 & 
dev
->
mask
è=ğ(dev->

 & dev->ipmask)){

187 
Ãxthİ
 = 
your
;

189 
Ãxthİ
 = 
dev
->
g©eway_
;

191 
u8
 *
de¡_mac
 = 
	`¬p_lookup
(
Ãxthİ
);

192 if(
de¡_mac
){

193 
	`memıy
(
skb
->
‘hhdr
->
yourmac
, 
de¡_mac
, 6);

194 
	`wa™šg_fÜ_Œªsm™
(
skb
);

197 
	`İrštf
("[!]\n");

198 
	`şi
();

199 
šdex
 = 
	`hash
(
your
 )% 
ARP_TBL_LEN
;

201 
	`LL_I
Ğ
Ï‹r_down
[
šdex
], 
skb
);

202 
	`¡i
();

203 
	`¬p_šquœe
(
your
);

205 
	}
}

209 
	$¬p_Ïy”_»ûive
Ğ
sk_buff
 *
com”_skb
 ){

210 
	`as£¹
(
com”_skb
->
pkgsize
 = 14 + 28);

212 
¬phdr
 *¬phd¸ğ(*)(
com”_skb
->
‘hhdr
 + 1);

213 
com”_skb
->
¬phdr
 =‡rphdr;

216 
	`BYTE_ENDIAN_FLIP2
(
¬phdr
->
h¬dw¬e
);

217 
	`BYTE_ENDIAN_FLIP2
(
¬phdr
->
´ÙocŞ
);

218 
	`BYTE_ENDIAN_FLIP2
(
¬phdr
->
İ”©iÚ
);

219 
	`BYTE_ENDIAN_FLIP4
(
¬phdr
->
my
);

220 
	`BYTE_ENDIAN_FLIP4
(
¬phdr
->
your
);

225 if(
¬phdr
->
İ”©iÚ
 == 1){

226 
	`¬p_»¥Úd
(
com”_skb
);

228 if(
¬phdr
->
İ”©iÚ
 == 2){

229 
	`¬p_aù
(
com”_skb
);

231 
	`¥š
("unknown operation");

234 
	}
}

	@net/ipv4/icmp.c

2 
	~<Ãt/icmp.h
>

3 
	~<uts.h
>

4 
	~<lšux/skbuff.h
>

5 
	~<lšux/by‹Üd”/g’”ic.h
>

7 
sk_buff
 *
	gexam¶e
;

8 
icmp_down
(
sk_buff
 *
skb
, 
u32
 
de¡_
, u32 
¤c_
);

9 
icmp_echo_down
(
sk_buff
 *
skb
);

10 
	$icmp_echo
(
u32
 
de¡_
){

13 
sk_buff
 *
baby
 = 
	`dev_®loc_skb
(70);

15 
icmphdr
 * icmphd¸ğ
baby
->icmphdr;

16 
icmphdr
->
ty³
 = 
ICMP_ECHO
;

17 
icmphdr
->
subty³
 = 0;

18 
icmphdr
->
d©a
.
dwÜd
[0] = 
	`__RDTSC_U
();

19 
	`icmp_down
(
baby
, 
de¡_
, 0);

20 
	}
}

22 
	$icmp_»ûive
(
sk_buff
 *
com”
){

23 
icmphdr
 *
hdr
 = 
com”
->icmphdr;

24 
	`İrštf
("@ICMPy³: %u, subty³: %u\n", 
hdr
->
ty³
, hdr->
subty³
);

25 
icmp_Ën
 = 
	`IP_PAYLOAD_LEN
(
com”
->
hdr
);

26 
u16
 
checksum
 = 
	`üc16_compu‹_be
(
hdr
, 
icmp_Ën
);

27 if((
u16
)~
checksum
è
	`¥š
("ICMP CRC16 check failed");

28 
hdr
->
ty³
){

29 
ICMP_ECHO
:{

30 
hdr
->
ty³
 = 
ICMP_ECHOREPLY
;

31 
exam¶e
 = 
com”
;

32 
	`icmp_echo_down
(
com”
);

33 
	`icmp_echo
(
	`MAKE_IP
(192, 168, 1, 1));

38 
ICMP_ECHOREPLY
:{

39 
u32
 
now
 = 
	`__RDTSC_U
();

40 
__—x
 *
—x
 = (*)&
com”
->
hdr
->
my
;

41 
	`İrštf
("echo„eply from : %u.%u.%u.%u,ime cost :%u\n",

42 
—x
->
AH
,ƒax->
AL
,ƒax->
ah
,ƒax->
®
,

43 
hdr
->
d©a
.
dwÜd
[0] - 
now
);

47 
	`İrštf
("ignore it..");

50 
	}
}

52 
	$icmp_down
(
sk_buff
 *
skb
, 
u32
 
de¡_
, u32 
¤c_
){

53 
	`üc16_wr™e_be
(
skb
->
icmphdr
, skb->
pkgsize
 - 14 - 20, &skb->icmphdr->
checksum
);

54 
	`_down
(
skb
, 
PROTOCOL_ICMP
, 
de¡_
, 
¤c_
, 64);

55 
	}
}

57 
	$icmp_echo_down
(
sk_buff
 *
skb
){

58 
	`üc16_wr™e_be
(
skb
->
icmphdr
, 
	`IP_PAYLOAD_LEN
(skb->
hdr
), &skb->icmphdr->
checksum
);

59 
	`_echo_down
(
skb
, 
PROTOCOL_ICMP
, 64);

61 
	}
}

	@net/ipv4/ip.c

1 
	~<lšux/.h
>

2 
	~<lšux/if_‘h”.h
>

3 
	~<lšux/skbuff.h
>

4 
	~<lšux/Ãtdeviû.h
>

5 
	~<uts.h
>

6 
	~<lšux/myli¡.h
>

7 
	~<lšux/by‹Üd”/g’”ic.h
>

8 
	~<Ãt/¬p.h
>

9 
	~<Ãt/icmp.h
>

10 
	~<Ãt/tı.h
>

11 
	~<Ãt/udp.h
>

13 
	#FRAG_BEGIN
 1

	)

14 
	#FRAG_MID
 2

	)

15 
	#FRAG_END
 3

	)

22 
šlše
 
	$is_äagm’t
(
hdr
 *iphdr){

23 if(!
hdr
->
æag_mf
 && iphdr->
me_off£t
 == 0)  0;

24 if(
hdr
->
me_off£t
 =ğ0 && iphdr->
æag_mf
è 
FRAG_BEGIN
;

25 if(
hdr
->
me_off£t
 && !hdr->
æag_mf
è 
FRAG_END
;

26  
FRAG_MID
;

27 
	}
}

29 
	#FRAG_OFFSET
(
hdr
è((hdr)->
me_off£t
 << 3)

	)

33 
	#IP_ORIGIN_SIZE
(
äag_’d
) \

34 Ğ(
äag_’d
)->
me_off£t
 * 8 + (äag_’d)->
tÙ_Ën
)

	)

37 
	#IPHDR_FLIP
(
hdr
) \

39 
	`BYTE_ENDIAN_FLIP2
((
hdr
)->
tÙ_Ën
); \

40 
	`BYTE_ENDIAN_FLIP2
((
hdr
)->
msgid
); \

41 
	`BYTE_ENDIAN_FLIP2
((
hdr
)->
æag_off
); \

42 
	`BYTE_ENDIAN_FLIP2
(
hdr
->
chksum
); \

43 
	`BYTE_ENDIAN_FLIP4
((
hdr
)->
my
); \

44 
	`BYTE_ENDIAN_FLIP4
((
hdr
)->
your
); \

45 }0)

	)

53 
sk_buff
 **
	gcŞËùÜ
;

54 
	#FRAG_TBL_LEN
 128

	)

56 
_up
(
sk_buff
 *
skb
);

57 
sk_buff
 *
_adİt_Úe
(sk_bufà*
skb
);

58 
sk_buff
 * 
_»as£mbË
(sk_bufà*
group_h—d
);

59 
sk_buff
 *
_äagm’t
(sk_bufà*
Ügš
);

61 
	$_Ïy”_š™
(){

62 
cŞËùÜ
 = 
	`¡©ic_®loc
((*), 
FRAG_TBL_LEN
);

63 
	}
}

68 
	$_Ïy”_»ûive
(
sk_buff
 *
skb
){

69 
hdr
 *hd¸ğ
skb
->iphdr;

70 
	`as£¹
(
hdr
->
v”siÚ
 =ğ4 && iphdr->
Ën
 == 5);

72 
u16
 
checksum
 = 
	`üc16_compu‹_be
(
hdr
, 20);

73 if((
u16
)~
checksum
 !ğ0è
	`¥š
("crc check failed");

75 
	`IPHDR_FLIP
(
hdr
);

78 ifĞ
	`is_äagm’t
(
skb
->
hdr
)){

79 
sk_buff
 *
group_h—d
 = 
	`_adİt_Úe
(
skb
);

80 
	`as£¹
(
group_h—d
);

81 if(
group_h—d
->
hdr
->
æag_mf
 =ğ
çl£
 &&

82 
group_h—d
->
gÙsize
 + 
IPHDR_LEN
 =ğ
	`IP_ORIGIN_SIZE
(group_h—d->
hdr
))

84 
skb
 = 
	`_»as£mbË
(
group_h—d
);

87 
	`İrštf
("+");

92 
	`_up
(
skb
);

94 
	}
}

101 
	$___down
(
sk_buff
 *
skb
, 
u8
 
me_´ÙocŞ
, u8 
‰l
){

103 
hdr
 *hd¸ğ
skb
->iphdr;

104 
Ãt_deviû
 *
nic
 = 
	`pick_nic
(
hdr
->
your
, iphdr->
my
);

105 
skb
->
dev
 = 
nic
;

106 
hdr
->
my
 = 
nic
->

;

108 
hdr
->
´ÙocŞ
 = 
me_´ÙocŞ
;

110 
hdr
->
‰l
 =tl;

112 if(
hdr
->
tÙ_Ën
 < 1486){

113 
	`IPHDR_FLIP
(
hdr
);

114 
	`üc16_wr™e_be
(
hdr
, 
IPHDR_LEN
, &hdr->
chksum
);

115 
	`¬p_down
(
skb
);

118 
	`as£¹
(" > MTU ");

120 
sk_buff
 *
group_h—d
 = 
	`_äagm’t
(
skb
);

122 
li¡_h—d
 *
cu¼
 = &
group_h—d
->
node
;

123 *
begš
 = 
cu¼
;

125 
sk_buff
 *
äag
 = 
	`MB2STRU
(sk_buff, 
cu¼
, 
node
);

126 
Ãt_deviû
 *
nic
 = 
	`pick_nic
(
äag
->
hdr
->
your
, f¿g->hdr->
my
);

127 
äag
->
hdr
->
my
 = 
nic
->

;

128 
	`¬p_down
(
äag
);

129 
cu¼
 = cu¼->
Ãxt
;

130 }
cu¼
 !ğ
begš
);

133 
	}
}

141 
	$_down
(
sk_buff
 *
skb
, 
u8
 
me_´ÙocŞ
,

142 
u32
 
de¡_
, u32 
¤c_
,

143 
u8
 
‰l
){

145 
hdr
 *hd¸ğ
skb
->iphdr;

146 
hdr
->
v”siÚ
 = 4;

147 
hdr
->
Ën
 = 5;

148 
hdr
->
ignÜe
 = 0;

149 
hdr
->
æag_off
 = 0;

150 
hdr
->
tÙ_Ën
 = 
skb
->
pkgsize
 - 
ETHHDR_LEN
;

151 
hdr
->
my
 = 
¤c_
;

152 
hdr
->
your
 = 
de¡_
;

153  
	`___down
(
skb
, 
me_´ÙocŞ
, 
‰l
);

154 
	}
}

156 
	$_echo_down
(
sk_buff
 *
skb
, 
u8
 
me_´ÙocŞ
, u8 
‰l
){

157 
hdr
 *hd¸ğ
skb
->iphdr;

158 
	`EXCHG_U32
(
hdr
->
my
, iphdr->
your
);

159  
	`___down
(
skb
, 
me_´ÙocŞ
, 
‰l
);

160 
	}
}

165 
sk_buff
 *
	$_äagm’t
(
sk_buff
 *
Üigš
){

166 
__—x
 *
—x
 = (*)&
Üigš
->
hdr
->
your
;

167 
	`İrštf
("wªˆtØ%u.%u.%u.%u\n", 
—x
->
AH
,ƒax->
AL
,ƒax->
ah
,ƒax->
®
);

168 
	`as£¹
(0 && "ip fragment spin");

170 
	}
}

174 
sk_buff
 * 
	$_»as£mbË
(
sk_buff
 *
group_h—d
){

175 
	`as£¹
(
	`is_äagm’t
(
group_h—d
->
hdr
è=ğ
FRAG_END
);

177 
hdr
 *hd¸ğ
group_h—d
->iphdr;

178 
tÙ_Ën
 = 
	`IP_ORIGIN_SIZE
(
hdr
);

179 
sk_buff
 *
Üigš_skb
 = 
	`dev_®loc_skb
(
tÙ_Ën
 + 
ETHHDR_LEN
);

180 
šdex
 = 
	`hash
(
hdr
->
my
è% 
FRAG_TBL_LEN
;

182 
	`as£¹
(
	`¡i_®»ady
());

183 
	`şi
();

184 
	`LL_CHECK
(
cŞËùÜ
[
šdex
], 
group_h—d
);

185 
	`LL_DEL
(
cŞËùÜ
[
šdex
], 
group_h—d
);

186 
	`¡i
();

190 
	`memıy
(
Üigš_skb
->
‘hhdr
, 
group_h—d
->‘hhdr, 
ETHHDR_LEN
 + 
IPHDR_LEN
);

192 
li¡_h—d
 *
cu¼
 = &
group_h—d
->
node
;

193 *
¡¬t
 = 
cu¼
;

195 
sk_buff
 *
skb
 = 
	`MB2STRU
(sk_buff, 
cu¼
, 
node
);

196 
	`İrštf
("cİy f¿gm’ˆtØ..,†’:%x\n", 
	`IP_PAYLOAD_LEN
(
skb
->
hdr
));

197 
	`memıy
(

198 (*)
Üigš_skb
->
thœd_hdr
 + 
	`FRAG_OFFSET
(
skb
->
hdr
),

199 
skb
->
thœd_hdr
,

200 
	`IP_PAYLOAD_LEN
(
skb
->
hdr
)

202 
cu¼
 = cu¼->
Ãxt
;

205 }
cu¼
 !ğ
¡¬t
);

207 
Üigš_skb
->
hdr
->
me_off£t
 = 0;

208 
Üigš_skb
->
hdr
->
tÙ_Ën
 =ot_len;

209  
Üigš_skb
;

210 
	}
}

212 
	$_up
(
sk_buff
 *
skb
){

213 
hdr
 *hd¸ğ
skb
->iphdr;

214 
hdr
->
´ÙocŞ
){

216 
	`icmp_»ûive
(
skb
);

219 
	`İrštf
("@IGMP\n");

221 
PROTOCOL_TCP
:{

222 
p£udo_hdr
 *

223 
p£udo_hdr
 = 
	`km®loc2
((pseudo_hdr), 0);

224 
p£udo_hdr
->
my
 = 
	`htÚl
(
hdr
->myip);

225 
p£udo_hdr
->
your
 = 
	`htÚl
(
hdr
->yourip);

226 
p£udo_hdr
->
z”o
 = 0;

227 
p£udo_hdr
->
´ÙocŞ
 = 
hdr
->protocol;

228 
p£udo_hdr
->
·ylßd_Ën
 = 
	`htÚs
(
	`IP_PAYLOAD_LEN
(
hdr
));

229 
skb
->
p£udo_hdr
 =…seudo_hdr;

230 
	`tı_Ïy”_»cv
(
skb
);

234 
	`udp_Ïy”_»ûive
(
skb
);

237 
	`İrštf
("unknowÀ´ÙocŞ: %u\n", 
hdr
->
´ÙocŞ
);

238 
	`¥š
("spin");

241 
	}
}

248 
sk_buff
 *
	$_adİt_Úe
(
sk_buff
 *
skb
){

249 
	`as£¹
(
skb
->
hdr
->
me_off£t
 | skb->hdr->
æag_mf
);

250 
hdr
 *hd¸ğ
skb
->iphdr;

251 
¤c_
 = 
hdr
->
my
;

253 
sk_buff
 *
group_h—d
 = 0;

254 
šdex
 = 
	`hash
(
¤c_
 ) % 
FRAG_TBL_LEN
;

255 
	`LL_SCAN_ON_KEY
(
cŞËùÜ
[
šdex
], 
hdr
->
msgid
, iphdr->msgid, 
group_h—d
);

258 if(!
group_h—d
){

259 
	`LL_I
(
cŞËùÜ
[
šdex
], 
skb
);

260 
	`INIT_LIST_HEAD
(&
skb
->
node
);

261 
skb
->
gÙsize
 = 
	`IP_PAYLOAD_LEN
(skb->
hdr
);

262 
	`İrštf
("no friend found, insert‡s first one. just„eturn\n");

263  
skb
;

265 
	`İrštf
("see? find‡ friend");

267 
	`li¡_add
Ğ&
skb
->
node
, &
group_h—d
->node);

268 if(!
hdr
->
æag_mf
){

269 
	`LL_REPLACE
(
cŞËùÜ
[
šdex
], 
group_h—d
, 
skb
);

270 
	`as£¹
("meethe final one,„eplace done\n");

271 
skb
->
gÙsize
 = 
group_h—d
->gotsize;

272 
group_h—d
 = 
skb
;

274 
group_h—d
->
gÙsize
 +ğ
	`IP_PAYLOAD_LEN
(
skb
->
hdr
);

275  
group_h—d
;

276 
	}
}

	@net/ipv4/tcp.cn

7 
	~<Ãt/tı.h
>

8 
	~<lšux/skbuff.h
>

9 
	~<Ãt/.h
>

10 
	~<lšux/by‹Üd”/g’”ic.h
>

11 
	~<uts.h
>

12 
	~<asm/b™.h
>

13 
	~<lšux/tim”.h
>

14 
	#TCP_PAYLOAD_LEN
(
skb
è(
	`IP_PAYLOAD_LEN
((skb)->
hdr
è- (skb)->
tıhdr
->
Ën
 * 4)

	)

15 
	#ETHHDR_LEN
 14

16 

	)

17 #defšæŒ‡é’ˆæ¨ç§»(
±r
, 
by‹s
)…tr = (*)(()(ptr) + bytes)

18 #defšç‰‡å°¾åºå·(
skb
è((skb)->
tıhdr
->
£q
 + 
TCP_PAYLOAD_LEN
(skb) - 1)

20 
	mTCP_OPT_EOL
,

21 
	mTCP_OPT_NOP
,

22 
	mTCP_OPT_MSS
,

23 
	mTCP_OPT_WNDSCL
,

24 
	mTCP_OPT_SACK_PERMIT
,

25 
	mTCP_OPT_SACK
,

26 
	mTCP_OPT_TSTAMP
 = 8,

27 
	mTCP_OPT_UTO
 = 28,

28 
	mTCP_OPT_AO
 = 29

41 
šlše
 
	$l_š_L
(
l_¡¬t
, 
Ën
, 
L_¡¬t
, 
LEN
){

42 ç‰‡é¦–åç§» = 
l_¡¬t
 - 
L_¡¬t
;

43 ç‰‡å°¾åç§» = ç‰‡é¦–åç§» + 
Ën
 - 1;

45 if(ç‰‡å°¾åç§» < 
LEN
)  0;

53 
	}
}

54 
šlše
 æŒ‡é’ˆé—´è·(*
	g±r1
, *
	g±r2
){

55 
	gdi¡ªû
 = (
u32
)
±r2
 - (u32)
±r1
;

56 
as£¹
(
di¡ªû
 >= 0 && "argument order should be flipped");

57  
	gdi¡ªû
;

60 
u32
 
	gMY_WND_SIZE
 = 0x100000;

61 
u16
 
	gMY_MSS
 = 1460;

64 å‘èµ·è€…
	m_
ç­‰å¾…ç¡®è®¤,

65 åº”ç­”è€…
	m_
ç­‰å¾…ç¡®è®¤,

67 å‘Šé€€è€…
	m_
ç­‰å¾…ç¡®è®¤,

68 åé€€è€…
	m_
ç­‰å¾…ç¡®è®¤,

69 å‘Šé€€è€…
	m_
ä¿ç•™ä¾¦å¬

71 #´agm¨
·ck
(
push
)

72 #´agm¨
·ck
(1)

73 #´agm¨
·ck
(
pİ
)

76 
	s»cv_wnd
{

77 
u16
 
	msize
;

78 
u8
 
	msÿË
;

82 
	m»®size
;

84 
sk_buff
 *
	mfœ¡
;

87 
sk_buff
 *
	mto_ack
;

91 
u32
 
	mËá
;

93 
tim”
 *
	mtim”
;

95 
	s£nd_wnd
{

96 
u16
 
	msize
;

97 
	msÿË
;

98 
	m»®size
;

99 
u32
 
	mËá
;

101 
	scÚÃù
{

102 
u32
 
	mmy
;

103 
u32
 
	mhis
;

104 
u16
 
	mmypÜt
;

105 
u16
 
	mhi¥Üt
;

106 
	m¡©e
;

107 
u32
 
	m£q_gÙ
;

108 
u32
 
	m£q_out
;

109 
u32
 
	mby‹s_gÙ
;

110 
u32
 
	mby‹s_out
;

111 
cÚÃù
 *
	mÃxt
;

112 
cÚÃù
 *
	m´ev
;

113 
»cv_wnd
 
	m»cv_wnd
;

114 
£nd_wnd
 
	m£nd_wnd
;

115 
Ãt_deviû
 *
	mÃtdev
;

116 
u16
 
	mmax_£g_size
;

117 
boŞ
 
	m§ck_³rm™
;

120 
boŞ
 
	mt¡amp_³rm™
;

124 
	gcÚÃù
 **è¿æ¥è¡¨;

127 
	$tı_ack_fš
(
cÚÃù
 *cÚÃù, 
sk_buff
 *
com”
){
	}
}

128 
do_ack
(*
_cÚÃù
);

129 
sk_buff
 *

130 
´•¬e_acksyn
(
cÚÃù
 * cÚÃù, 
sk_buff
 *
com”
);

131 
cÚÃù
 *

132 
__cÚÃùiÚ_lookup
(
u32
 
his
, 
u16
 
hi¥Üt
, u32 
my
, u16 
mypÜt
);

133 
cÚÃù
 *

134 
__cÚÃùiÚ_ü—‹
(
u32
 
his
, 
u16
 
hi¥Üt
, u32 
my
, u16 
mypÜt
);

136 
cÚÃù
 * 
cÚÃùiÚ_lookup
(
sk_buff
 * 
com”
);

137 
cÚÃù
 * 
cÚÃùiÚ_ü—‹
(
sk_buff
 *
com”
);

139 
tı_down
(
sk_buff
 *
skb
, 
u32
 
de¡_
, u32 
¤c_
);

140 
tı_echo_down
(
sk_buff
 *
skb
);

141 
wnd_adİt_Úe
(
cÚÃù
 *cÚÃù, 
sk_buff
 *
Úe
);

142 
tı_dup_ack
(
cÚÃù
 *cÚÃù, 
sk_buff
 *
Œigg”
);

143 
š™_cÚÃù_w™h_syn
(
cÚÃù
 *cÚÃù, 
sk_buff
 *
com”
);

144 
tı_checksum
(
sk_buff
 *
com”
);

147 
šlše
 
boŞ
 
	$šside_wšdow
(
sk_buff
 *
skb
, 
»cv_wnd
 *recv_wnd){

148 
u32
 ç‰‡é¦–åºå· = 
skb
->
tıhdr
->
£q
;

149 ç‰‡é•¿åº¦ = 
	`TCP_PAYLOAD_LEN
(
skb
);

150  
	`l_š_L
(ç‰‡é¦–åºå·, ç‰‡é•¿åº¦, 
»cv_wnd
->
Ëá
,„ecv_wnd->
»®size
);

151 
	}
}

153 
šlše
 
boŞ
 
	$wa™šg_fÜ_™
(
sk_buff
 *
™
, 
cÚÃù
 *connect){

154 if(!
™
è 
çl£
;

155 
sk_buff
 *
to_ack
 = 
cÚÃù
->
»cv_wnd
.to_ack;

156 if(
to_ack
){

157 if(
™
->
tıhdr
->
£q
 =ğ
to_ack
->tıhdr->£q + 
	`TCP_PAYLOAD_LEN
(to_ack)){

158  
Œue
;

162 if(
™
->
tıhdr
->
£q
 =ğ
cÚÃù
->
»cv_wnd
.
Ëá
è 
Œue
;

164  
çl£
;

165 
	}
}

167 
	$tı_fš
(){

169 
	}
}

172 
	#TCPHDR_FLIP
(
tıhdr
) \

174 
	`BYTE_ENDIAN_FLIP2
(
tıhdr
->
mypÜt
); \

175 
	`BYTE_ENDIAN_FLIP2
(
tıhdr
->
you½Üt
); \

176 
	`BYTE_ENDIAN_FLIP4
(
tıhdr
->
£q
); \

177 
	`BYTE_ENDIAN_FLIP4
(
tıhdr
->
ack
); \

178 
	`BYTE_ENDIAN_FLIP2
(
tıhdr
->
wndsize
); \

179 
	`BYTE_ENDIAN_FLIP2
(
tıhdr
->
chksum
); \

180 
	`BYTE_ENDIAN_FLIP2
(
tıhdr
->
urg±r
); \

181 }0)

	)

183 
	$tı_Ïy”_»cv
(
sk_buff
 *
com”
){

184 
tıhdr
 *tıhd¸ğ
com”
->tcphdr;

187 
	`tı_checksum
(
com”
);

189 
	`TCPHDR_FLIP
(
tıhdr
);

192 
cÚÃù
 *cÚÃù = 
	`cÚÃùiÚ_lookup
(
com”
);

193 
	`as£¹
(
tıhdr
->
æag_r¡
 == 0);

194 if(!
cÚÃù
){

195 
cÚÃù
 = 
	`cÚÃùiÚ_ü—‹
(
com”
);

196 if(
tıhdr
->
æags
 =ğ
TCP_FLAG_SYN
){

197 
	`š™_cÚÃù_w™h_syn
(
cÚÃù
, 
com”
);

198 
cÚÃù
->
t¡amp_³rm™
 = 
çl£
;

200 
	`İrštf
("someonery connecting me ");

201 
sk_buff
 *
»¶y
 = 
	`´•¬e_acksyn
(
cÚÃù
, 
com”
);

202 
	`tı_echo_down
(
»¶y
);

204 
cÚÃù
->
¡©e
 = åº”ç­”è€…
_
ç­‰å¾…ç¡®è®¤;

205 
cÚÃù
->
£q_out
 = 
tıhdr
->
£q
;

206 
cÚÃù
->
by‹s_out
 = 1;

210 
ignÜe
;

213 if(
cÚÃù
->
¡©e
 == è¿æ¥ä¸å­˜åœ¨){

214 
ignÜe
;

216 if(
cÚÃù
->
¡©e
 =ğå‘èµ·è€…
_
ç­‰å¾…ç¡®è®¤){

217 if(
tıhdr
->
ack
 =ğ
cÚÃù
->
£q_gÙ
 &&

218 
tıhdr
->
æags
 =ğ(
TCP_FLAG_SYN
 | 
TCP_FLAG_ACK
) ){

226 
cÚÃù
->
¡©e
 = è¿æ¥å·²å»ºç«‹;

228 
ignÜe
;

230 if(
cÚÃù
->
¡©e
 =ğåº”ç­”è€…
_
ç­‰å¾…ç¡®è®¤){

231 if(
tıhdr
->
æags
 =ğ
TCP_FLAG_ACK
 &&

232 
cÚÃù
->
£q_gÙ
 + cÚÃù->
by‹s_gÙ
 =ğ
tıhdr
->
£q
&&

233 
cÚÃù
->
£q_out
 + cÚÃù->
by‹s_out
 =ğ
tıhdr
->
ack
){

235 
	`İrštf
("got‡n‡ck‚ow, i just sent‡n‡ck+syn\n");

236 
cÚÃù
->
£q_gÙ
 = 
tıhdr
->
£q
;

237 
cÚÃù
->
by‹s_gÙ
 = 0;

238 
cÚÃù
->
¡©e
 = è¿æ¥å·²å»ºç«‹;

240 
ignÜe
;

245 if(
cÚÃù
->
¡©e
 == è¿æ¥å·²å»ºç«‹){

246 if(!
tıhdr
->
æag_ack
è
ignÜe
;

247 if(
tıhdr
->
æags
 =ğ
TCP_FLAG_FIN
){

249 
cÚÃù
->
¡©e
 = åé€€è€…
_
ç­‰å¾…ç¡®è®¤;

250 
	`tı_ack_fš
(
cÚÃù
, 
com”
);

253 if(
	`wnd_adİt_Úe
(
cÚÃù
, 
com”
)){

254 ifĞ
	`wa™šg_fÜ_™
(
com”
, 
cÚÃù
) ){

255 
»cv_wnd
 *
wšdow
 = &
cÚÃù
->recv_wnd;

256 
wšdow
->
to_ack
 = 
com”
;

258  
	`wa™šg_fÜ_™
(
wšdow
->
to_ack
->
Ãxt
, 
cÚÃù
)){

259 
wšdow
->
to_ack
 = wšdow->to_ack->
Ãxt
;

262 if(
wšdow
->
tim”
->
¡©e
 =ğ
TIMER_STOPPED
){

263 
	`¡¬t_mytim”
(
wšdow
->
tim”
);

269 
	`Œigg”_mytim”
(
cÚÃù
->
»cv_wnd
.
tim”
);

271 
	`tı_dup_ack
(
cÚÃù
, 
com”
);

275 
ignÜe
;

277 if(
cÚÃù
->
¡©e
 =ğå‘Šé€€è€…
_
ç­‰å¾…ç¡®è®¤){

278 if(
tıhdr
->
æag_ack
){

279 
cÚÃù
->
¡©e
 = å‘Šé€€è€…
_
ä¿ç•™ä¾¦å¬;

280 if(
tıhdr
->
æag_fš
){

282 
cÚÃù
->
¡©e
 = è¿æ¥ä¸å­˜åœ¨;

285 
ignÜe
;

288 if(
cÚÃù
->
¡©e
 =ğå‘Šé€€è€…
_
ä¿ç•™ä¾¦å¬){

289 if(
tıhdr
->
æag_syn
){

291 
cÚÃù
->
¡©e
 = è¿æ¥ä¸å­˜åœ¨;

293 
ignÜe
;

296 if(
cÚÃù
->
¡©e
 =ğåé€€è€…
_
ç­‰å¾…ç¡®è®¤){

297 if(
tıhdr
->
æags
 =ğ
TCP_FLAG_ACK
){

298 
cÚÃù
->
¡©e
 = è¿æ¥ä¸å­˜åœ¨;

300 
ignÜe
;

302 
	`as£¹
(0);

305 
ignÜe
:

306 
	`İrštf
("@tcp-ignore ");

308 
	}
}

312 
	$´št_tımsg
(
tıhdr
 *
hdr
){

313 
	`İrštf
("tı mes§ge, seq:%x,‡ck:%x\n", 
hdr
->
£q
, hdr->
ack
);

314 
	}
}

316 
cÚÃù
 *

317 
	$__cÚÃùiÚ_lookup
(
u32
 
his
, 
u16
 
hi¥Üt
, u32 
my
, u16 
mypÜt
){

318 
šdex
 = 
	`tıhash
(
his
, 
hi¥Üt
, 
mypÜt
) % è¿æ¥è¡¨é•¿;

319 
cÚÃù
 *
cu¼
 = è¿æ¥è¡¨[
šdex
];

320 
cu¼
){

321 if(
cu¼
->
his
 =ğhis && cu¼->
hi¥Üt
 == hisport &&

322 
cu¼
->
my
 =ğmy && cu¼->
mypÜt
 == myport)

323  
cu¼
;

324 
cu¼
 = cu¼->
Ãxt
;

327 
	}
}

330 
cÚÃù
 * 
	$cÚÃùiÚ_lookup
(
sk_buff
 * 
com”
){

331  
	`__cÚÃùiÚ_lookup
(
com”
->
hdr
->
my
, com”->
tıhdr
->
mypÜt
,

332 
com”
->
hdr
->
your
, com”->
tıhdr
->
you½Üt
);

333 
	}
}

335 
cÚÃù
 *

336 
	$__cÚÃùiÚ_ü—‹
(
u32
 
his
, 
u16
 
hi¥Üt
, u32 
my
, u16 
mypÜt
){

337 
šdex
 = 
	`tıhash
(
his
, 
hi¥Üt
, 
mypÜt
) % è¿æ¥è¡¨é•¿;

338 
cÚÃù
 *cÚÃù = 
	`km®loc2
( (connect), 0);

339 
cÚÃù
->
my
 = myip;

340 
cÚÃù
->
his
 = hisip;

341 
cÚÃù
->
hi¥Üt
 = hisport;

342 
cÚÃù
->
mypÜt
 = myport;

344 
cÚÃù
->
¡©e
 = è¿æ¥ä¸å­˜åœ¨;

347 
»cv_wnd
 *»cv_wnd = &
cÚÃù
->recv_wnd;

348 
»cv_wnd
->
size
 = 
MY_WND_SIZE
 && 0Xffff;

349 
msb
 = 
	`__b¤
(
MY_WND_SIZE
);

350 
»cv_wnd
->
sÿË
 = 
msb
 > 15 ? msb - 15 : 0;

351 
»cv_wnd
->
»®size
 = 
MY_WND_SIZE
;

352 
»cv_wnd
->
fœ¡
 =„ecv_wnd->
to_ack
 = 0;

353 
»cv_wnd
->
Ëá
 = 0;

354 
»cv_wnd
->
tim”
 = 
	`ü—‹_mytim”
(200, 
do_ack
, 
cÚÃù
);

357 
cÚÃù
->
£q_out
 = 0;

358 
cÚÃù
->
by‹s_out
 = 0;

360 
	`LL_I
(è¿æ¥è¡¨[
šdex
], 
cÚÃù
);

361  
cÚÃù
;

362 
	}
}

365 
cÚÃù
 *

366 
	$cÚÃùiÚ_ü—‹
(
sk_buff
 *
com”
){

367  
	`__cÚÃùiÚ_ü—‹
(
com”
->
hdr
->
my
, com”->
tıhdr
->
mypÜt
,

368 
com”
->
hdr
->
your
, com”->
tıhdr
->
you½Üt
);

369 
	}
}

371 
	$š™_tı
(){

372 
	`as£¹
Ğ(
tıhdr
) == 20);

373 è¿æ¥è¡¨ = 
	`¡©ic_®loc
( (*), è¿æ¥è¡¨é•¿);

374 
	}
}

377 
	$tı_ack_d©a
(
sk_buff
 *
com”
){

378 
tıhdr
 *tıhd¸ğ
com”
->tcphdr;

379 
tıhdr_Ën
 = 
tıhdr
->
Ën
 * 4;

380 
Ãw_Ën
 = 20 + 
tıhdr_Ën
;

381 
com”
->
hdr
->
tÙ_Ën
 = 
Ãw_Ën
;

382 
	}
}

384 
	$wnd_adİt_Úe
(
cÚÃù
 *cÚÃù, 
sk_buff
 *
Úe
){

385 
»cv_wnd
 *
wšdow
 = &
cÚÃù
->recv_wnd;

386 
tıhdr
 *tıhd¸ğ
Úe
->tcphdr;

387 æ¥ç‰‡é•¿åº¦ = 
	`TCP_PAYLOAD_LEN
(
Úe
);

388 
u32
 æ¥ç‰‡é¦–åºå· = 
tıhdr
->
£q
;

389 ifĞ!
	`šside_wšdow
(
Úe
, 
wšdow
èè 
çl£
;

391 if(!
wšdow
->
fœ¡
){

392 
wšdow
->
fœ¡
 = 
Úe
;

395 
sk_buff
 * 
­³nd_©
 = 
wšdow
->
to_ack
 ? window->to_ack

396 : 
wšdow
->
fœ¡
;

397 
­³nd_©
){

398 
u32
 è¯¥ç‰‡å°¾åºå· = ç‰‡å°¾åºå·(
­³nd_©
);

400 
sk_buff
 *ä¸‹ç‰‡ = 
­³nd_©
->
Ãxt
;

402 
u32
 ä¸‹ç‰‡é¦–åºå· = ä¸‹ç‰‡ ? ä¸‹ç‰‡->
tıhdr
->
£q


403 : 
wšdow
->
Ëá
 + wšdow->
»®size
;

408 
w™hš
 = 
	`l_š_L
(æ¥ç‰‡é¦–åºå·, æ¥ç‰‡é•¿åº¦, é—´éš™èµ·å§‹, ä¸¤ç‰‡é—´éš™);

409 if(
w™hš
 =ğ-1è 
çl£
;

410 if(
w™hš
 == 0) {

411 
Úe
->
Ãxt
 = ä¸‹ç‰‡;

412 
Úe
->
´ev
 = 
­³nd_©
;

413 
­³nd_©
->
Ãxt
 = 
Úe
;

414 if(ä¸‹ç‰‡èä¸‹ç‰‡->
´ev
 = 
Úe
;

415  
Œue
;

418 
­³nd_©
 = ä¸‹ç‰‡;

421 
	`as£¹
(0);

422  
çl£
;

423 
	}
}

425 
	$tı_dup_ack
(
cÚÃù
 *cÚÃù, 
sk_buff
 *
Œigg”
){

426 
»cv_wnd
 *»cv_wnd = &
cÚÃù
->recv_wnd;

428 
tıhdr_Ën
 = 60;

429 
sk_buff
 *
skb
 = 
	`dev_®loc_skb
(
ETHHDR_LEN
 + 
IPHDR_LEN
 + 
tıhdr_Ën
);

430 
tıhdr
 *ıhd¸ğ
skb
->tcphdr;

431 
tıhdr
->
mypÜt
 = 
cÚÃù
->myport;

432 
tıhdr
->
you½Üt
 = 
cÚÃù
->
hi¥Üt
;

433 
tıhdr
->
£q
 = 
cÚÃù
->
£q_out
 + cÚÃù->
by‹s_out
;

435 
tıhdr
->
ack
 = 
cÚÃù
->
£q_gÙ
 + cÚÃù->
by‹s_gÙ
;

436 
tıhdr
->
Ën
 = 
tıhdr_Ën
 / 4;

437 
tıhdr
->
»sv
 = 0;

438 
tıhdr
->
æags
 = 
TCP_FLAG_ACK
;

439 
tıhdr
->
wndsize
 = 
»cv_wnd
->
size
;

440 
tıhdr
->
urg±r
 = 0;

442 
sk_buff
 *
¡¬t
 = 
Œigg”
;

443 
¡¬t
){

444 ifĞç‰‡å°¾åºå·(
¡¬t
->
´ev
è+ 1 =ğ¡¬t->´ev->
tıhdr
->
£q
 ){

445 
¡¬t
 = s¹->
´ev
;

450 
sk_buff
 *
’d
 = 
Œigg”
;

451 
’d
){

452 ifĞç‰‡å°¾åºå·(
’d
è+ 1 =ğ’d->
Ãxt
->
tıhdr
->
£q
 ){

453 
’d
 =ƒnd->
Ãxt
;

458 
	`mem£t
(
skb
->
tıhdr
->
İt_¬—
, 
TCP_OPT_NOP
, 
tıhdr_Ën
 - 20);

459 
tı_İt
 *
İt
 = 
skb
->
tıhdr
->
İt_¬—
;

460 
İt
->
kšd
 = 
TCP_OPT_SACK
;

461 
İt
->
Ën
 = 10;

462 
İt
->
d©a
.
dwÜd
[0] = 
	`Áohl
(
¡¬t
->
tıhdr
->
£q
);

463 
İt
->
d©a
.
dwÜd
[1] = 
	`Áohl
(ç‰‡å°¾åºå·(
’d
));

465 
	`tı_down
(
skb
, 
cÚÃù
->
his
, cÚÃù->
my
);

466 
	}
}

467 
	$do_ack
(*
_cÚÃù
){

468 
cÚÃù
 *cÚÃù = 
_cÚÃù
;

469 
»cv_wnd
 *»cv_wnd = &
cÚÃù
->recv_wnd;

470 
	`as£¹
(
»cv_wnd
->
to_ack
);

472 
sk_buff
 *
skb
 = 
	`dev_®loc_skb
(
ETHHDR_LEN
 + 
IPHDR_LEN
 + 
TCPHDR_LEN
);

473 
tıhdr
 *ıhd¸ğ
skb
->tcphdr;

474 
tıhdr
->
mypÜt
 = 
cÚÃù
->myport;

475 
tıhdr
->
you½Üt
 = 
cÚÃù
->
hi¥Üt
;

476 
tıhdr
->
£q
 = 
cÚÃù
->
£q_out
 + cÚÃù->
by‹s_out
;

478 
tıhdr
->
ack
 = ç‰‡å°¾åºå·(
»cv_wnd
->
to_ack
) + 1;

479 
tıhdr
->
Ën
 = 20 / 4;

480 
tıhdr
->
»sv
 = 0;

481 
tıhdr
->
æags
 = 
TCP_FLAG_ACK
;

482 
tıhdr
->
wndsize
 = 
»cv_wnd
->
size
;

483 
tıhdr
->
urg±r
 = 0;

485 
	`tı_down
(
skb
, 
cÚÃù
->
his
, cÚÃù->
my
);

488 
sk_buff
 *
to_ack
 = 
»cv_wnd
->to_ack;

489 
»cv_wnd
->
Ëá
 = ç‰‡å°¾åºå·(
to_ack
) + 1;

490 
»cv_wnd
->
fœ¡
 = 
to_ack
->
Ãxt
;

491 
»cv_wnd
->
to_ack
 = 0;

492 
	}
}

498 
	gtı
ä¸‹æ²‰å…¥å£(
sk_buff
 *
	gskb
){

499 
as£¹
(
skb
->
p£udo_hdr
);

500 
tıhdr
 *
	gtıhdr
 = 
skb
->tcphdr;

502 
TCPHDR_FLIP
(
tıhdr
);

504 
	gtıhdr
->
	gchksum
 = 0;

505 
u32
 
	gsum1
 = 
üc16_compu‹_be
(
tıhdr
, 
IP_PAYLOAD_LEN
(
skb
->
hdr
));

506 
u32
 
	gsum2
 = 
üc16_compu‹_be
(
skb
->
p£udo_hdr
, (pseudo_hdr));

507 
u32
 
	gchecksum
 = 
sum1
 + 
sum2
;

508 
u16
 
	gÿ¼y
 = 
checksum
 >> 16;

509 if(
	gÿ¼y
è
	gchecksum
 = 
ÿ¼y
 + (
checksum
 & 0xffff);

510 
	gtıhdr
->
	gchksum
 = 
htÚs
(~
checksum
);

513 
	$tı_down
(
sk_buff
 *
skb
, 
u32
 
de¡_
, u32 
¤c_
){

514 
tı
ä¸‹æ²‰å…¥å£(
skb
);

515  
	`_down
(
skb
, 
PROTOCOL_TCP
, 
de¡_
, 
¤c_
, 64);

516 
	}
}

517 
	$tı_echo_down
(
sk_buff
 *
skb
){

519 
	`EXCHG_U16
(
skb
->
tıhdr
->
you½Üt
, skb->tıhdr->
mypÜt
);

520 
tı
ä¸‹æ²‰å…¥å£(
skb
);

521  
	`_echo_down
(
skb
, 
PROTOCOL_TCP
, 64);

522 
	}
}

527 
sk_buff
 *

528 
	$´•¬e_acksyn
(
cÚÃù
 * cÚÃù, 
sk_buff
 *
com”
){

529 
tıhdr
 *tıhd¸ğ
com”
->tcphdr;

530 
	`as£¹
(
tıhdr
->
Ën
 > 
TCPHDR_LEN
 + 12);

533 
tıhdr
->
£q
 = 
cÚÃù
->
£q_out
 + cÚÃù->
by‹s_out
;

534 
tıhdr
->
ack
 = 
cÚÃù
->
£q_out
 + cÚÃù->
by‹s_gÙ
;

535 
tıhdr
->
æags
 = 
TCP_FLAG_ACK
 | 
TCP_FLAG_SYN
 ;

536 
tıhdr
->
wndsize
 = 
cÚÃù
->
»cv_wnd
.
size
;

537 
tıhdr
->
urg±r
 = 0;

541 
tı_İt
 *
İt
 = 
tıhdr
->
İt_¬—
;

542 
İt
->
kšd
 = 
TCP_OPT_MSS
;

543 
İt
->
Ën
 = 4;

544 
İt
->
d©a
.
wÜd
[0] = 
	`htÚs
(
cÚÃù
->
max_£g_size
);

545 æŒ‡é’ˆæ¨ç§»(
İt
, o±->
Ën
);

547 
İt
->
kšd
 = 
TCP_OPT_WNDSCL
;

548 
İt
->
Ën
 = 3;

549 
İt
->
d©a
.
by‹
[0] = 
cÚÃù
->
»cv_wnd
.
sÿË
;

550 æŒ‡é’ˆæ¨ç§»(
İt
, o±->
Ën
);

552 
İt
->
kšd
 = 
TCP_OPT_SACK_PERMIT
;

553 
İt
->
Ën
 = 2;

554 æŒ‡é’ˆæ¨ç§»(
İt
, o±->
Ën
);

556 
’d
 = æŒ‡é’ˆé—´è·(
tıhdr
->
İt_¬—
, 
İt
);

557 
İt_¬—_Ën
 = 
	`û_®ign
(
’d
, 4);

558 
i
 = 
’d
; i < 
İt_¬—_Ën
; i++){

559 ((*)
tıhdr
->
İt_¬—
)[
i
] = 
TCP_OPT_NOP
;

561 
tıhdr
->
Ën
 = (
TCPHDR_LEN
 + 
İt_¬—_Ën
) / 4;

562  
com”
;

563 
	}
}

565 
	$š™_cÚÃù_w™h_syn
(
cÚÃù
 *cÚÃù, 
sk_buff
 *
com”
){

566 
tıhdr
 *ıhd¸ğ
com”
->tcphdr;

568 
cÚÃù
->
£q_gÙ
 = 
tıhdr
->
£q
;

569 
cÚÃù
->
by‹s_gÙ
 = 1;

570 
cÚÃù
->
£nd_wnd
.
size
 = 
tıhdr
->
wndsize
;

575 
cÚÃù
->
§ck_³rm™
 = 
çl£
;

576 
cÚÃù
->
t¡amp_³rm™
 = 
çl£
;

577 
cÚÃù
->
£nd_wnd
.
sÿË
 = 0;

578 
cÚÃù
->
max_£g_size
 = 
MY_MSS
;

580 
tı_İt
 *
İt
 = 
tıhdr
->
İt_¬—
;

581 
İt
->
kšd
 && æŒ‡é’ˆé—´è·(İt, 
tıhdr
->
İt_¬—
è<ıhdr->
Ën
*4 - 
TCPHDR_LEN
){

582 
Ën
 = 
İt
->len;

583 
İt
->
kšd
){

584 
TCP_OPT_NOP
:

585 
Ën
 = 1;

587 
TCP_OPT_MSS
:{

588 
	`as£¹
(
Ën
 == 4);

589 
u16
 
his_mss
 = 
	`Áohs
(*
İt
->
d©a
.
wÜd
);

590 if(
his_mss
 < 
MY_MSS
è
cÚÃù
->
max_£g_size
 = his_mss;

593 
TCP_OPT_WNDSCL
:

594 
	`as£¹
(
Ën
 == 3);

595 
cÚÃù
->
£nd_wnd
.
sÿË
 = *
İt
->
d©a
.
by‹
;

597 
TCP_OPT_SACK_PERMIT
:

598 
	`as£¹
(
Ën
 == 2);

599 
cÚÃù
->
§ck_³rm™
 = 
Œue
;

601 
TCP_OPT_TSTAMP
:

602 
cÚÃù
->
§ck_³rm™
 = 
Œue
;

603 
	`as£¹
(
Ën
 == 10);

605 
TCP_OPT_UTO
:

606 
	`as£¹
(
Ën
 == 4);

608 
TCP_OPT_AO
:

611 
	`¥š
("unknown option‡ppears in SYN segment");

613 
cÚÃù
->
£nd_wnd
.
»®size
 = cÚÃù->£nd_wnd.
size
 <<

614 
cÚÃù
->
£nd_wnd
.
sÿË
;

615 æŒ‡é’ˆæ¨ç§»(
İt
, 
Ën
);

617 
	}
}

619 
	$tı_checksum
(
sk_buff
 *
com”
){

620 
tıËn
 = 
	`IP_PAYLOAD_LEN
(
com”
->
hdr
);

621 
checksum
 = 
	`üc16_compu‹_be
(
com”
->
tıhdr
, 
tıËn
);

622 
checksum2
 = 
	`üc16_compu‹_be
(
com”
->
p£udo_hdr
, (pseudo_hdr));

623 
sum
 = 
checksum
 + 
checksum2
;

624 
sum
 = (sum & 0xffff) + (sum >> 16);

625 
	`as£¹
(~
sum
);

627 
	}
}

	@net/ipv4/udp.c

1 
	~<di¥.h
>

2 
	~<Ãt/udp.h
>

3 
	~<lšux/skbuff.h
>

4 
	~<lšux/by‹Üd”/g’”ic.h
>

6 
šfo_udpmsg
(
udphdr
 *udphdr);

9 
	#UDPHDR_BE_FLIP
(
udphdr
)\

11 
	`BYTE_ENDIAN_FLIP2
Ğ(
udphdr
)->
mypÜt
 ); \

12 
	`BYTE_ENDIAN_FLIP2
Ğ(
udphdr
)->
you½Üt
 ); \

13 
	`BYTE_ENDIAN_FLIP2
Ğ(
udphdr
)->
tÙ_Ën
 ); \

14 
	`BYTE_ENDIAN_FLIP2
Ğ(
udphdr
)->
chksum
 ); \

15 }0)

	)

18 
	$udp_Ïy”_»ûive
(
sk_buff
 *
com”
){

20 
	`UDPHDR_BE_FLIP
(
com”
->
udphdr
);

21 
	`šfo_udpmsg
(
com”
->
udphdr
);

22 
	}
}

24 
	$šfo_udpmsg
(
udphdr
 *udphdr){

25 
	`İrštf
("UDP…Üt(%xè==>…Üt(%xè", 
udphdr
->
mypÜt
, udphdr->
you½Üt
);

29 
	}
}

	@pmm.c

2 
	~<pmm.h
>

3 
	~<boÙšfo.h
>

4 
	~<uts.h
>

8 
EMPTY_BLOCK
*
	gblock0
=(EMPTY_BLOCK*)
KV
(
HEAP_BASE
);

9 
	$h—p_š™
(){

10 
block0
->
size
=
HEAP_SIZE
-(
EMPTY_BLOCK
);

11 
	}
}

12 
	$šfo_h—p
(){

13 
block_id
=0;

14 
EMPTY_BLOCK
*
block
=
block0
;

15 
block
){

16 
	`İrštf
("%u(%x~%x)--->",
block_id
++,()
block
,
	`BLOCK_DATA_END
(block));

17 
block
=block->
Ãxt
;

19 
	}
}

20 *
	$km®loc
(
by‹
){

21 if(
by‹
+4 < (
EMPTY_BLOCK
))  0;

22 
»®_by‹
=
by‹
+4;

23 
EMPTY_BLOCK
*
block
=
block0
;

24 
block
&&block->
size
<
»®_by‹
èblock=block->
Ãxt
;

25 
	`as£¹
(
block
);

26 
»®_®loc
=
	`BLOCK_DATA_END
(
block
)-
»®_by‹
+1;

27 *(*)
»®_®loc
=
by‹
;

28 
block
->
size
-=
»®_by‹
;

29 *
»tuº_®loc
=(*)(
»®_®loc
+4);

32  
»tuº_®loc
;

33 
	}
}

34 
	$kä“
(*
±
){

35 
»®_u£d_addr
=()
±
-4;

36 
»®_u£d_size
=*(*)(
»®_u£d_addr
)+4;

38 
EMPTY_BLOCK
*
block
=
block0
;

39 
block
->
Ãxt
&&()block->Ãxt<
»®_u£d_addr
) block=block->next;

40 if(
	`BLOCK_DATA_END
(
block
)+1==
»®_u£d_addr
){

41 
block
->
size
+=
»®_u£d_size
;

43 if(
	`BLOCK_DATA_END
(
block
)+1==()block->
Ãxt
){

44 
block
->
size
+=block->
Ãxt
->size+(
EMPTY_BLOCK
);

45 
	`d–_node
(
block
->
Ãxt
);

49 
EMPTY_BLOCK
*
Ãw
=(EMPTY_BLOCK*)
»®_u£d_addr
;

50 
Ãw
->
size
=
»®_u£d_size
-(
EMPTY_BLOCK
);

51 if(()
block
->
Ãxt
==
»®_u£d_addr
+
»®_u£d_size
){

52 
Ãw
->
size
+=(
block
->
Ãxt
->size+(
EMPTY_BLOCK
));

53 
	`d–_node
(
block
->
Ãxt
);

55 
EMPTY_BLOCK
*
Ãxt
=
block
->next;

56 
Ãw
->
´ev
=
block
;

57 
block
->
Ãxt
=
Ãw
;

58 
Ãw
->
Ãxt
=next;

59 if(
Ãxt
èÃxt->
´ev
=
Ãw
;

61 
	}
}

62 
	$d–_node
(
EMPTY_BLOCK
*
block
){

63 
EMPTY_BLOCK
*
´ev
=
block
->prev;

64 
	`as£¹
(
´ev
);

65 
´ev
->
Ãxt
=
block
->next;

66 if(
block
->
Ãxt
èblock->Ãxt->
´ev
=prev;

67 
	}
}

68 
	$š£¹_aá”
(
EMPTY_BLOCK
*
mÙh”
,EMPTY_BLOCK*
block
){

69 
EMPTY_BLOCK
*
Ãxt
=
mÙh”
->next;

71 
block
->
´ev
=
mÙh”
;

72 
mÙh”
->
Ãxt
=
block
;

73 if(
Ãxt
){

74 
Ãxt
->
´ev
=
block
;

75 
block
->
Ãxt
=next;

77 
	}
}

79 * 
	$km®loc0
(
by‹s
){

80 *
±r
 = 
	`km®loc
(
by‹s
);

81 if(
±r
è
	`mem£t
ÕŒ, 0, 
by‹s
);

82  
±r
;

83 
	}
}

	@proc.asm

1 ;
ERR
 
assu»
 
®»ady
 
’‹r
 
	g¶aš
-
	gmod


2 %
	gšşude
 "utils.inc"

3 
glob®
 
fœe_asm


4 
£ËùÜ_¶aš_c3


5 
£ËùÜ_¶aš_d3


6 
tss


7 
size_¡ackäame


8 ;
fœe_asm
(
addr_pcb
);

10 [
£ùiÚ
 .
‹xt
]

11 
	gfœe_asm
:

12 
mov
 
e¥
,[e¥+4];
pošt
ƒ¥ 
to
 
	gaddr_pcb
,
ªd
 
»£t
 
k”Ãl
 
¡ack


13 
mov
 
	gebx
,[
size_¡ackäame
]

14 
Ëa
 
	g—x
,[
e¥
+
ebx
]

15 
mov
 
	gdwÜd
 [
tss
+
tss_e¥0_off£t
],
	g—x
;
	gpcb
.
	g¡ackäame
.
bÙtom
 
š
 
	gtss
.
	ge¥0


16 ;
be
 
´•¬ed
 
Ãxt
 
	gşock
-
	gš‹¼u±


18 ;
»ady
 
jump
 
to
 
ršg3
 
ªd
 
go
 
	gah—d
,
£nd
 
ª
 
EOI
 
	gnow
 å‘é€äº†ä¹Ÿæ²¡äº‹å„¿ï¼Œä¸
	gœ‘d
ï¼Œ8259Açš„
	gœq
ä¸Šä¸æ¥

19 
mov
 
	g®
,20
h


20 
	gout
 20
	gh
,
®


22 
pİ
 
gs


23 
pİ
 
fs


24 
pİ
 
es


25 
pİ
 
ds


26 
pİad


27 
add
 
	ge¥
,4

29 
	gœ‘d


	@proc.c

1 
	~<asm_ÏbË.h
>

2 
	~<´oc.h
>

3 
	~<scheduË.h
>

4 
	~<mm.h
>

5 
	~<uts.h
>

6 
	~<scheduË.h
>

7 
	#PCB_MAGIC_NUMBER
 0x¯bbccdd

	)

8 
	g£ËùÜ_¶aš_d
[4]={()&
£ËùÜ_¶aš_d0
,()&
£ËùÜ_¶aš_d1
,0,()&
£ËùÜ_¶aš_d3
};

9 
	g£ËùÜ_¶aš_c
[4]={()&
£ËùÜ_¶aš_c0
,()&
£ËùÜ_¶aš_c1
,0,()&
£ËùÜ_¶aš_c3
};

10 
	g__eæags
=0x1200;

13 
	$š™_pcb
(
pcb
 *
baby
,
u32
 
addr
,
´io
,
time_¦iû
,*
p_Çme
){

14 
u32
 
NEED_RESCHED_OFFSET
;

15 
off1
 = (
u32
)&
NEED_RESCHED_OFFSET
 ;

16 
off2
 = 
	`MEMBER_OFFSET
(
pcb
, 
Ãed_»sched
);

17 
	`as£¹
(
off1
 =ğ
off2
);

19 
baby
->
»gs
.
ss
=(
£ËùÜ_¶aš_d
[0]);

20 
baby
->
»gs
.
e¥
 = (
u32
)&(baby->regs);

22 
baby
->
»gs
.
eæags
=
__eæags
;

23 
baby
->
»gs
.
cs
=(
£ËùÜ_¶aš_c
[0]);

24 
baby
->
»gs
.
e
=
addr
;

25 
baby
->
»gs
.
gs
=baby->»gs.
fs
=baby->»gs.
es
=baby->»gs.
ds
=(
£ËùÜ_¶aš_d
[0]);

27 
baby
->
Ãed_»sched
 = 0;

28 
baby
->
sig³ndšg
 = 0;

29 
baby
->
´io
=prio;

30 
baby
->
pid
 = 
	`®loc_pid
(0);

31 
baby
->
time_¦iû
=baby->
time_¦iû_fuÎ
=time_slice;

32 
	`¡ºıy
(
baby
->
p_Çme
,…_Çme, 
P_NAME_MAX
);

34 
baby
->
th»ad
.
e¥
 = ()&baby->
»gs
;

35 
baby
->
th»ad
.
e
 = ()
»¡Üe_®l
;

36 
baby
->
fs
 = 
	`km®loc0
Ğ(
fs_¡ruù
));

37 
baby
->
fes
 = 
	`km®loc0
ĞĞ
fes_¡ruù
) );

38 
baby
->
fes
->
f•
 = baby->fes->
Üigš_f•
;

39 
baby
->
fes
->
max_fds
 = (baby->fes->
Üigš_f•
) / 4;

40 
baby
->
¾im™s
[
RLIMIT_NOFILE
].
cur
 = 512;

41 
baby
->
¾im™s
[
RLIMIT_NOFILE
].
max
 = 1024;

42 
baby
->
f¡ack
.
e¥
 = -1;

43 
baby
->
magic
 = 
PCB_MAGIC_NUMBER
;

44 
baby
->
mm
 = 0;

45 
	`INIT_LIST_HEAD
(&
baby
->
siblšg
);

46 
	`INIT_LIST_HEAD
(&
baby
->
chd»n
);

47 
baby
->
mÙh”
 = baby->
mÚ™Ü
 = 0;

48 
	}
}

50 
pcb
 * 
	$ü—‹_´oûss
(
u32
 
addr
,
´io
,
time_¦iû
,*
p_Çme
){

52 
pcb
 *
baby
 = (pcb*)
	`__®loc_·ges
(
__GFP_DEFAULT
,1);

53 
	`š™_pcb
(
baby
,
addr
,
´io
,
time_¦iû
,
p_Çme
);

54 
	`İrštf
("Ãw…roûss:baby‡ddr:%x\n",
baby
);

55 
	`LL_I_INCRE
(
li¡_aùive
,
baby
,
´io
);

57  
baby
;

58 
	}
}

60 
pcb
 *
	$g‘_cu¼’t
(){

61 
pcb
 *
p
;

62 
__asm__
 
	`__vŞ©e__
("ªdÈ%%e¥,%0":"ô"(
p
):"0"(~8191));

63 if((*)
p
 < (*)0xc0000000 ||…->
magic
 !ğ
PCB_MAGIC_NUMBER
){

64 
	`İrštf
("\À© %x ", ()
p
);

65 
	`¥š
("get ill current");

67  
p
;

68 
	}
}

70 
	$´oc_š™
(){

72 if((
pcb
)!=
PCB_SIZE
è
	`¥š
("struct…cb size wrong");

73 
	}
}

75 
	$pcb_šfo
(
pcb
 *
p
){

77 
	`İrštf
("p_Çme:% ’Œy:%x…rio:%uime_¦iû:%u\n",
p
->
p_Çme
,p->
»gs
.
e
,p->
´io
,p->
time_¦iû
);

78 
	}
}

79 
	$fœe_th»ad
(
pcb
 *
p
){

80 
	`as£¹
(
p
->
mm
 == 0);

81 
boŞ
 
sk_avaabË
;

82 
sk_avaabË
 = 
Œue
;

84 
__asm__
 
	`__vŞ©e__
(

88 :"r"(&
p
->
»gs
)

90 
	}
}

99 
	$®loc_pid
(
pid
){

100 
pid_äesh
 = 0;

101 if(
pid
 >ğ0 &&…id !ğ
pid_äesh
è
	`¥š
("bad @pid");

102  
pid_äesh
++;

103 
	}
}

105 
	$£t_pid
(
pid
, 
pcb
 *
p
){

106 
p
->
pid
 =…id;

108 
	}
}

110 
	$put_fes
(
fes_¡ruù
 *
fes
){

111 
fes
->
couÁ
--;

112 if(
fes
->
couÁ
 > 0) ;

115 if(
fes
->
f•
 !ğfes->
Üigš_f•
)

116 
	`kä“2
(
fes
->
f•
);

119 
i
 = 0; i < 
fes
->
max_fds
; i++){

120 
fe
 *fğ
fes
->
f•
[
i
];

121 if(
fe
è
	`k_şo£
(file);

124 
	`kmem_ÿche_ä“
(
fes_¡ruù_ÿche
, 
fes
);

125 
	}
}

127 
	$put_fs
(
fs_¡ruù
 *
fs
){

128 
fs
->
couÁ
--;

129 if(
fs
->
couÁ
 > 0) ;

131 
	`mÁput
(
fs
->
pwdmÁ
);

132 
	`mÁput
(
fs
->
roÙmÁ
);

133 
	`dput
(
fs
->
pwd
);

134 
	`dput
(
fs
->
roÙ
);

136 
	`kmem_ÿche_ä“
(
fs_¡ruù_ÿche
, 
fs
);

137 
	}
}

143 
	$»Ëa£_vm_¬—
(
vm_¬—
 *
vma
){

144 
lš—r_addr
 
vaddr
;

145 
mm
 *mm;

146 
±e
 *
pgdœ
, *
pgtbl
;

147 
±e
 *
dœ’t
;

149 
mm
 = 
vma
->mm;

150 
pgdœ
 = 
	`PGDIR_OF_MM
(
mm
);

152 
vaddr
.
v®ue
 = 
vma
->
¡¬t
;

153 
pgtbl
 = 
	`±e2·ge
(
pgdœ
[
vaddr
.
dœ_idx
]);

154 
vaddr
.
v®ue
 < 
vma
->
’d
){

155 
·ge
 *
u£½age
;

156 
i
 = 
vaddr
.
tbl_idx
;

158 if(
pgtbl
[
i
].
v®ue
 =ğ0è
_cÚtšue
;

159 
u£½age
 = 
	`±e2·ge_t
Ğ
pgtbl
[
i
] );

160 
	`put_·ge
(
u£½age
);

162 
_cÚtšue
:

163 
vaddr
.
v®ue
 +ğ
__4K
;

164 if((
vaddr
.
v®ue
 % 
__4M
) == 0){

165 
±e
 
´ev
 = 
pgdœ
[
vaddr
.
dœ_idx
 - 1];

166 
	`put_·ge
Ğ
	`±e2·ge_t
(
´ev
) );

167 
dœ’t
 = 
pgdœ
 + 
vaddr
.
dœ_idx
;

168 
pgtbl
 = 
	`±e2·ge
(*
dœ’t
);

171 
	`kmem_ÿche_ä“
(
vm_¬—_ÿche
, 
vma
);

173 
	}
}

177 
	$Œy_»Ëa£_u£r_¥aû
(
mm
 *mm){

178 
vm_¬—
 *
vma
, *
Ãxt
;

179 
	`as£¹
(
mm
->
vma
);

180 if(
mm
->
u£rs
 > 1)  0;

182 
vma
 = 
mm
->vma;

184 
Ãxt
 = 
vma
->next;

185 
	`»Ëa£_vm_¬—
(
vma
);

186 } 
Ãxt
 !ğ
mm
->
vma
 && (vma =‚ext));

188 
mm
->
vma
 = 0;

190 
	}
}

192 
	$Œy_»Ëa£_kºl_»sourû
(
pcb
 *
p
){

194 
	`put_fes
(
p
->
fes
);

195 
	`put_fs
(
p
->
fs
);

197 
p
->
fes
 = 0;

198 
p
->
fs
 = 0;

200 
	}
}

205 
	$__»Ëa£_mm
(
mm
 *mm){

206 
±e
 * 
pgdœ
; 
	`as£¹
(
mm
 !ğ
cu¼’t
->mm);

208 
pgdœ
 = 
	`PGDIR_OF_MM
(
mm
);

209 
	`__ä“_·ge
(
pgdœ
);

211 
mm
->
ü3
.
v®ue
 = 0;

212 
	`kä“2
(
mm
);

215 
	}
}

	@ramdisk.c

2 
	~"¿mdisk.h
"

3 
	~"fs_ûÎ.h
"

4 
	~"mm.h
"

5 
	$¿mdisk_š™
(
addr
){

6 
ûÎmbr
 = (*)(
RAMDISK_BASE
 + 
PAGE_OFFSET
);

7 
	`İrštf
("¿mdisk in™:mbr:%x\Àu£ c–Èfesy¡em\n", 
ûÎmbr
);

8 
	}
}

10 
	$ûÎ_»ad
(*
fe
, *
buf
){

11 
ûÎid
 = 
	`£¬ch_fe
(
fe
);

12 if(
ûÎid
 == -1)  0;

13 *
¤c
 = 
ûÎmbr
 + (
ûÎid
*
CELL_SECTORS
 + 1) * 512;

14 
	`memıy
(
buf
, 
¤c
, 1024);

16 
	}
}

	@schedule.c

1 
	~<scheduË.h
>

2 
	~<´oc.h
>

3 
	~<uts.h
>

4 
	~<lšux/sched.h
>

5 
	~<lšux/´štf.h
>

7 
	gticks
;

8 
pcb
 *
sk0
;

10 
	gsched_b¬_t™Ë
[] = {'<', '<', 0};

11 
	gsched_b¬_body
[16];

14 
pcb
 *
	gli¡_¦“p
;

15 
pcb
 **
	gpcb_li¡s
[3] = {&
li¡_aùive
, &
li¡_expœe
, &
li¡_¦“p
};

16 
	$aùive_¦“p
(
pcb
 *
p
,
u32
 
msg_ty³
,u32 
msg_bšd
){

17 
IF
 = 
	`şi_ex
();

19 
p
->
msg_ty³
=msg_type;

20 
p
->
msg_bšd
=msg_bind;

21 
	`LL_DEL
(
li¡_aùive
,
p
);

22 
	`LL_I_INCRE
(
li¡_¦“p
,
p
,
´io
);

24 if(
IF
è
	`¡i
();

25 
	}
}

27 
	$aùive_expœe
(
pcb
 *
p
){

28 
IF
 = 
	`şi_ex
();

30 
	`LL_DEL
(
li¡_aùive
,
p
);

31 
	`LL_I_INCRE
(
li¡_expœe
,
p
,
´io
);

33 if(
IF
è
	`¡i
();

34 
	}
}

36 
	$¦“p_aùive
(
pcb
 *
p
){

37 
IF
 = 
	`şi_ex
();

39 
	`LL_DEL
(
li¡_¦“p
,
p
);

40 
	`LL_I_INCRE
(
li¡_aùive
,
p
,
´io
);

42 
p
->
msg_ty³
 = 0;

44 if(
IF
è
	`¡i
();

45 
	}
}

47 
	$¦“p_expœe
(
pcb
 *
p
){

48 
IF
 = 
	`şi_ex
();

50 
	`LL_DEL
(
li¡_¦“p
,
p
);

51 
	`LL_I_INCRE
(
li¡_expœe
,
p
,
´io
);

52 
p
->
msg_ty³
 = 0;

54 if(
IF
è
	`¡i
();

55 
	}
}

56 
	$do_tim”
(
±_»gs
 *
´egs
){

57 
t™Ë
[16] = { 148,' ', 0};

58 
b¬buf
[16];

60 
ticks
++;

61 if(
ticks
 % 100 == 0){

62 
	`¥rštf
(
b¬buf
, "%u", 
ticks
/100);

63 
	`wr™e_b¬
(0, 0, 
t™Ë
, 
b¬buf
);

65 if(
ticks
 % 300 =ğ0è
	`İrštf
("^");

68 
	`¥rštf
(
sched_b¬_body
, " %*x %*s", 4, 
cu¼’t
->
time_¦iû
, 8, cu¼’t->
p_Çme
);

69 
	`wr™e_b¬
(0, 1, 
sched_b¬_t™Ë
, 
sched_b¬_body
);

71 if(
´egs
->
cs
 & 3) {

72 
	`as£¹
(
cu¼’t
->
time_¦iû
 > 0);

73 if(--
cu¼’t
->
time_¦iû
 == 0){

74 
	`aùive_expœe
(
cu¼’t
);

75 
cu¼’t
->
Ãed_»sched
 = 1;

80 
pcb
 *
cu¼
=
li¡_¦“p
;

81 
cu¼
){

83 
pcb
 *
Ãxt
 = 
cu¼
->next;

84 if(
cu¼
->
msg_ty³
==
MSGTYPE_TIMER
){

85 
cu¼
->
msg_bšd
--;

87 if(
cu¼
->
msg_bšd
==0){

92 if(
cu¼
->
time_¦iû
){

93 
	`¦“p_aùive
(
cu¼
);

95 
cu¼’t
->
Ãed_»sched
 = 1;

97 
	`¦“p_expœe
(
cu¼
);

100 
cu¼
 = 
Ãxt
;

103 
	}
}

109 
	$scheduË
(){

110 
IF
;

111 
IF
 = 
	`şi_ex
();

114 
cu¼’t
->
Ãed_»sched
 = 0;

115 
pcb
 *
Ãxt
 = 0;

124 if(!
li¡_aùive
 && 
li¡_expœe
){

125 
pcb
*
p
=
li¡_expœe
;

126 
p
){

127 
p
->
time_¦iû
 =…->
time_¦iû_fuÎ
;

128 
p
õ->
Ãxt
;

130 
	`EXCHG_PTR
(
li¡_aùive
,
li¡_expœe
);

132 
sched_b¬_t™Ë
[1] = sched_bar_title[0] ^= 2;

135 ià(
li¡_aùive
è
Ãxt
 =†ist_active;

136 
Ãxt
 = 
sk0
;

138 if(
Ãxt
 =ğ
cu¼’t
){

151 if(
Ãxt
->
mm
){

161 
g_tss
->
e¥0
 = ()
Ãxt
 + 
THREAD_SIZE
;

164 
__asm__
 
	`__vŞ©e__
("movl %0, %%cr3\n\t"

166 :"r"(
Ãxt
->
mm
->
ü3
.
v®ue
));

176 
__asm__
 
	`__vŞ©e__
(

197 :"=m"(
cu¼’t
->
th»ad
.
e¥
),"=m"(cu¼’t->th»ad.
e
)

198 :"m"(
Ãxt
->
th»ad
.
e¥
), "m"Òext->th»ad.
e
),"b"(
cu¼’t
)

200 if(
IF
è
	`¡i
();

204 
	}
}

207 
	$scheduË_timeout
(
m£c
){

208 
¦iû
 = (
m£c
-1)/10 + 1;

209 
	`aùive_¦“p
(
cu¼’t
, 
MSGTYPE_TIMER
, 
¦iû
);

210 
	`scheduË
();

211  
¦iû
;

212 
	}
}

217 
	$kp_¦“p
(
u32
 
msg_ty³
,u32 
msg_bšd
){

219 
IF
 = 
	`şi_ex
();

220 
	`aùive_¦“p
(
cu¼’t
,
msg_ty³
,
msg_bšd
);

221 
	`scheduË
();

222 if(
IF
è
	`¡i
();

223 
	}
}

225 
	$wake_up
(
li¡_h—d
 *
roÙ
){

226 
pcb
 *
tsk
;

227 
	`li¡_fÜ_—ch_§ã
(
roÙ
, 
tsk
, 
¦“p
){

228 
	`¦“p_aùive
(
tsk
);

230 
	`INIT_LIST_HEAD
(
roÙ
);

231 
	}
}

236 
	$¦“p_Ú
(
li¡_h—d
 *
roÙ
){

237 
	`li¡_add
(&
cu¼’t
->
¦“p
, 
roÙ
);

238 
	`kp_¦“p
(0, 
MSGTYPE_DEEP
);

239 
	}
}

241 
	$kth»ad_¦“p
(
u32
 
msg_ty³
, u32 
msg_bšd
){

242 
	`aùive_¦“p
(
cu¼’t
, 
msg_ty³
, 
msg_bšd
);

243 
__asm__
 
	`__vŞ©e__
 ("int $0x81");

245 
	}
}

	@t.c

1 
	~"../debug/debug.h
"

2 
	~<as£¹.h
>

3 
	~<¡dio.h
>

4 
	sæow”
{

5 
æow”
 *
	m´ev
, *
	mÃxt
;

6 
æow”
 *
	m_´ev
, *
	m_Ãxt
;

7 
	mage
;

10 
	$š£¹
(
æow”
 *
roÙ
, æow”*
Ãw
){

11 
	}
}

14 
	gg_¬¿y
[10] = {1, 2, 3, 4, 5, 6};

15 
	$foob¬
(){

16 
¯a
;

17 
i
 =0; i < 10; i++){

18 
a
 = 0x123;

19 
b
;

20 ià(
a
 > 
b
)

21 
¯a
: 
	`´štf
("h–lÜ :%d\n", 
a
);

23 
	}
}

24 
	$”a£
(
v
[]){

25 
i
 = 0; i < 10; i++){

26 
v
[
i
] = 0;

28 
	}
}

29 
	$maš
(
¬gc
, *
¬gv
[], *
’vp
[]){

31 
x
 = 2;

32 
¯a
;

35 
j
 = 0x11; j < 100; j++){

36 
a
 = 0x456;

37 
	`¦“p
(1);

38 
¯a
:

39 
	`´štf
("h–lÜ :%d\n", 
j
);

43 
	}
}

	@time.c

1 
	~<lšux/tim”.h
>

2 
	~<time.h
>

3 
	~<œq.h
>

4 
	~<lšux/sched.h
>

5 
	~<lšux/bh.h
>

6 
	gtime_bh
;

7 
	$tim”_š‹¼u±
(
œq
, *
dev
, 
±_»gs
 *
´egs
){

9 
	`do_tim”
(
´egs
);

10 
	`m¬k_bh
(
time_bh
);

11 
	}
}

13 
	$time_bÙtomh®f
(*
d©a
){

14 
	`my_tim”li¡_dida
();

16 
	}
}

17 
	$š™_time
(){

19 
	`»que¡_œq
(0, &
tim”_š‹¼u±
, 
SA_INTERRUPT
, 0);

21 
œq_desc
[0].
¡©us
 &ğ~
IRQ_DISABLED
;

22 
time_bh
 = 
	`®loc_bh
(
time_bÙtomh®f
, 0);

23 
	`š™_mytim”
();

24 
	}
}

	@utils.asm

1 ;
the£
 
funùiÚs
 
¬e
 
deş¬ed
 
ªd
 
	$comm’‹d
(
some
 
basic
 
ex¶ª©iÚ
è
š
 
uts
.
h


2 %
šşude
 "include/old/utils.inc"

3 
glob®
 
š_by‹
,
out_by‹
,
pÜt_»ad
,
pÜt_wr™e
,
d‘eù_ıu
,
š_dw
,
out_dw
,
upd©e_eæags
,
­_š™
,
­_š™_’d
, 
»ad_imr_of8259


4 
glob®
 
__bt
, 
__bts
, 
__bŒ
, 
__bsc
, 
__bs0s


5 
ıu_¡ršg


6 
glob®
 
š™8259A


7 
glob®
 
š™8253


8 [
£ùiÚ
 .
‹xt
]

9 
d‘eù_ıu
:;
	`d‘eù_ıu
();

10 
mov
 
—x
,0

11 
ıuid


12 
mov
 [
ıu_¡ršg
],
ebx


13 
mov
 [
ıu_¡ršg
+4],
edx


14 
mov
 [
ıu_¡ršg
+8],
ecx


15 
»t


18 
pÜt_»ad
:;
	`pÜt_»ad
(
pÜt
,*
buf
,
by‹
);

19 
mov
 
edx
,[
e¥
+4]

20 
mov
 
edi
,[
e¥
+8]

21 
mov
 
ecx
,[
e¥
+12]

22 
shr
 
ecx
,1

23 
şd


24 
»p
 
šsw


25 
»t


26 
pÜt_wr™e
:;
	`pÜt_wr™e
(
pÜt
,*
buf
,
by‹
);

27 
mov
 
edx
,[
e¥
+4]

28 
mov
 
esi
,[
e¥
+8]

29 
mov
 
ecx
,[
e¥
+12]

30 
shr
 
ecx
,1

31 
şd


32 
»p
 
outsw


33 
»t


35 
š_by‹
: ;
	$š_by‹
(
pÜt
)

36 
xÜ
 
—x
,eax

37 
mov
 
dx
,[
e¥
+4]

38 
š
 
®
,
dx


39 
iod–ay


40 
»t


41 
š_dw
: ;
u32
 
	$š_dw
(
pÜt
)

42 
mov
 
dx
,[
e¥
+4]

43 
š
 
—x
,
dx


44 
»t


45 
out_by‹
:;
	$out_by‹
(
pÜt
,
v®ue
)

46 
mov
 
dx
,[
e¥
+4]

47 
mov
 
®
,[
e¥
+8]

48 
out
 
dx
,
®


49 
»t


50 
out_dw
: ;
	$out_dw
(
pÜt
,
u32
 
v®ue
)

51 
mov
 
dx
,[
e¥
+4]

52 
mov
 
—x
,[
e¥
+8]

53 
out
 
dx
,
—x


54 
»t


55 ;
	`š™8259A
(
mask
);

56 
š™8259A
:

57 
mov
 
®
,11
h


58 
out
 20
h
,
®
 ;
£nd
 
icw1
 
to
 0x20 
¬g
 
m—nšg
:[
icw4
 
Ãeded
]

59 
iod–ay
;
io_d–ay
 
b–Úg
 
to
 
the
 
§me
 
£gm’t
,
so
 
ju¡
 
ÿÎ
 
	$Ïb–
(
Çm–y
 
jmp
 
Ã¬
 
±r
 
Ïb–
è
is
 
ok
.

60 
out
 0a0
h
,
®
 ;
£nd
 
icw1
 
to
 0xa0

61 
iod–ay


63 
mov
 
®
,20
h


64 
out
 21
h
,
®
 ;
£nd
 
icw2
 
to
 0x21. 
¬g
 
m—nšg
:[
œq0
=0x20]

65 
iod–ay


66 
mov
 
®
,28
h


67 
out
 0a1
h
,
®
 ;
£nd
 
icw2
 
to
 0xa1. 
¬g
 
m—nšg
:[
œq8
=0x28]

68 
iod–ay


70 
mov
 
®
,4

71 
out
 21
h
,
®
 ;
£nd
 
icw3
 
to
 0x21 
¬g
 
m—nšg
:[
lšk
 
¦ave
 
ch
 
©
 
œ2
]

72 
iod–ay


73 
mov
 
®
,2

74 
out
 0a1
h
,
®
 ;
£nd
 
icw3
 
to
 0xa1 
¬g
 
m—nšg
:[
lšk
 
ma¡”
 
ch
 
äom
 
œ2
]

75 
iod–ay


77 
mov
 
®
,1

78 
out
 21
h
,
®
 ;
¬g
 
m—nšg
[80X86 
mod
,
nÜm®
 
EOI
]

79 
iod–ay


80 
out
 0a1
h
,
®


81 
iod–ay


82 ;
š™Ÿl
 
wÜd
 
pÜt
 
fšished
..

84 ;
£nd
 
ocw1
,
£t
 
š‹¼u±
 
mash
 

85 
mov
 
®
,[
e¥
+4];
ERR
 
by
 ,
®l
 
œq
-
pÜt
 
was
 
masked


86 
out
 21
h
,
®


87 
iod–ay


88 
mov
 
®
,10110011b; 
¬g
 
m—šg
:[
AT
 
h¬d
-
disk
 
œq
 
İ’
]

89 
out
 0a1
h
,
®


90 
iod–ay


91 
»t


92 
»ad_imr_of8259
: ;
	`»ad_imr_of8259
();

93 
xÜ
 
—x
,eax

94 
š
 
®
, 0a1
h


95 
mov
 
ah
, 
®


96 
š
 
®
, 21
h


97 
»t


99 
š™8253
:

100 
mov
 
®
,0x34

101 
out
 0x43,
®


103 
mov
 
ax
,[
e¥
+4]

104 
out
 0x40,
®


105 
mov
 
®
,
ah


106 
out
 0x40,
®


107 
»t


110 ;;;;;;;;;;;;;;;;;;;;; 
	`__bt
(*
ba£
, 
m
);

111 
__bt
:

112 
mov
 
edx
, [
e¥
 + 4] ;
—x
 = 
ba£


113 
mov
 
ecx
, [
e¥
 + 8] ;
ebx
 = 
m


114 
xÜ
 
—x
,ƒax

115 
bt
 [
edx
], 
ecx


116 
adc
 
—x
, 0

117 
»t


119 ;;;;;;;;;;;;;;;;;;;; 
	`__bts
(*
ba£
, 
m
);

120 
__bts
:

121 
mov
 
edx
, [
e¥
 + 4] ;
—x
 = 
ba£


122 
mov
 
ecx
, [
e¥
 + 8] ;
ebx
 = 
m


123 
xÜ
 
—x
,ƒax

124 
bts
 [
edx
], 
ecx


125 
adc
 
—x
, 0

126 
»t


128 ;;;;;;;;;;;;;;;;;;;; 
	`__bŒ
(*
ba£
, 
m
); @
DESC
 
b™
 
‹¡
 
ªd
 
»£t


129 
__bŒ
:

130 
mov
 
edx
, [
e¥
 + 4] ;
—x
 = 
ba£


131 
mov
 
ecx
, [
e¥
 + 8] ;
ebx
 = 
m


132 
xÜ
 
—x
,ƒax

133 
bŒ
 [
edx
], 
ecx


134 
adc
 
—x
, 0

135 
»t


137 ;;;;;;;;;;;;;;;;;; 
	`__bsc
(*
addr
); @
DESC
 
b™
 
sÿn
 
ªd
 
»£t


138 
__b¤
:

139 
mov
 
edx
, [
e¥
 + 4] ;edx = 
addr


140 
mov
 
—x
, [
edx
] ;—x = *
addr
, 
Çm–y
 
b™
 
šdex


141 
bsf
 
—x
,ƒax

142 
jz
 .
z”o


143 
bŒ
 [
edx
], 
—x


144 
»t


145 .
z”o
:

146 
mov
 
—x
, -1

147 
»t


148 
__bs0s
:

149 
mov
 
edx
, [
e¥
 + 4] ;edx = 
addr


150 
mov
 
—x
, [
edx
] ;—x = *
addr
, 
Çm–y
 
b™
 
šdex


151 
nÙ
 
—x
 ;eax = ~eax

152 
bsf
 
—x
,ƒax

153 
jz
 .
z”o


154 
bts
 [
edx
], 
—x


155 
»t


156 .
z”o
:

157 
mov
 
—x
, -1

158 
»t


	@utils.c

1 
	~<uts.h
>

2 
	~<´oc.h
>

3 
	~<di¥.h
>

4 
	~<lšux/by‹Üd”/g’”ic.h
>

5 
	~<lšux/´štf.h
>

6 
	$dump_sys
(){

7 
	}
}

9 *
	$MAKE_IP_STR
(
u32
 

){

11 
	}
}

13 
	$¥š
(*
msg
){

14 
__asm__
 
	`__vŞ©e__
 ("cli");

15 
	`İrštf
("%s",
msg
);

17 
	}
}

18 
	$as£¹_func
(*
exp
,*
fe
,*
ba£_fe
,
lše
){

20 
	`şi
();

21 
	`İrštf
("as£¹ fau»>>>exp:%s,fe:%s,ba£_fe:%s,lše:%u\n",
exp
,
fe
,
ba£_fe
,
lše
);

23 
	}
}

26 
	$b™1_couÁ
(*
addr
,
by‹s
){

27 
couÁ
=0;

28 
off£t
=0;off£t<
by‹s
;offset++){

30 
x
=0;x<8;x++){

32 if(((1<<
x
)&
addr
[
off£t
])!=0){

33 
couÁ
++;

37  
couÁ
;

38 
	}
}

41 
	$memıy
(* 
de¡
,*
¤c
,
by‹s
){

42 
i
=0;i<
by‹s
;i++){

43 ((*)
de¡
)[
i
] = ((*)
¤c
)[i];

45 
	}
}

48 
	$memcmp
(*
_s1
, *
_s2
, 
Ën
){

49 *
s1
 = 
_s1
;

50 *
s2
 = 
_s2
;

51 
i
 = 0; i < 
Ën
; i++){

52 if(
s1
[
i
] =ğ
s2
[i]) ;

56 
	}
}

61 
	$mem‹¡
(*
¡¬t
, 
Ën
){

62 
n
 = 
Ën
 / 4;

63 
l
 = 
Ën
 % 4;

64 
i
;

65 
i
 = 0; i < 
n
; i++){

66 if(((*)
¡¬t
)[
i
] !ğ0è
	`¥š
("memtest failed");

68 
i
 = 0; i < 
l
; i++){

69 if(((*)
¡¬t
)[
i
] !ğ0è
	`¥š
("memtest failed");

71 
	}
}

75 
	#LPJ
 0x242000

	)

76 
	#HZ
 100

	)

77 
	gx_ud–ay
;

78 
	$ud–ay
(
u£cs
)

80 
i
 = 0; i < 
u£cs
; i++){

81 
j
 = 0; j < 0x10000; j++){

82 
__asm__
 
	`__vŞ©e__
("add %1, %1\n\t"

84 : "=m"(
x_ud–ay
)

88 
	}
}

92 
u16
 
	$üc16_compu‹_be
(*
¬—
, 
Ën
){

93 
u16
 *
_¬—
 = 
¬—
;

94 
u32
 
sum
 = 0;

95 
i
 = 0; i < 
Ën
/2; i++){

97 
u16
 
f›ld
 = 
	`Áohs
(
_¬—
[
i
]);

98 
sum
 +ğ
f›ld
;

101 ¡ruù{ 
u16
 
ax
, 
ÿ¼y
; } *
—x
 = (*)&
sum
;

102 
—x
->
ÿ¼y
){

103 
sum
 = 
—x
->
ax
 +ƒax->
ÿ¼y
;

106  
sum
;

107 
	}
}

109 
	g__Ëss_go
 = 1;

110 
	$__Ëss
(*
buf
, 
Ën
){

111 *
¡r
 = 
buf
;

112 
´es¢um
 = 80*12;

113 
i
 = 0; i < 
Ën
; i +ğ
´es¢um
){

114 
Ëá
 = 
Ën
 - 
i
;

115 
	`İrštf
(" %* ", 
´es¢um
 < 
Ëá
 ?…»s¢um :†eá, 
¡r
 + 
i
);

116 
__Ëss_go
 = 
çl£
;

117 !
__Ëss_go
);

119 
	}
}

121 
	g¡r_buf
[128];

122 *
	g¡r
 = 
¡r_buf
;

123 * 
	$mk_¡r
(
u32
 

){

124 *
»suÉ
 = 
¡r
;

125 
__—x
 *
—x
 = (*)&

;

126 
Ën
 = 
	`¥rštf
(
¡r
, "%u.%u.%u.%u", 
—x
->
AH
,ƒax->
AL
,ƒax->
ah
,ƒax->
®
);

127 
¡r
[
Ën
] = 0;

128 
¡r
 +ğ
Ën
 + 2;

129 if(
¡r
 - 
¡r_buf
 > 110) ipstr = ipstr_buf;

130  
»suÉ
;

131 
	}
}

	@video_drv.c

5 
	~<video_drv.h
>

6 
	~<uts.h
>

7 
	~<v®Ty³.h
>

10 
	$£t_cursÜ
(
pos
){

11 
	`out_by‹
(
CRTC_ADDR_REG
,
CURSOR_L
);

12 
	`out_by‹
(
CRTC_DATA_REG
,
pos
&0xff);

13 
	`out_by‹
(
CRTC_ADDR_REG
,
CURSOR_H
);

14 
	`out_by‹
(
CRTC_DATA_REG
,
pos
>>8);

15 
	}
}

18 
	$£t_¡¬t
(
u32
 
pos
){

19 
	`out_by‹
(
CRTC_ADDR_REG
,
START_ADDR_L
);

20 
	`out_by‹
(
CRTC_DATA_REG
,
pos
&0xff);

21 
	`out_by‹
(
CRTC_ADDR_REG
,
START_ADDR_H
);

22 
	`out_by‹
(
CRTC_DATA_REG
,
pos
>>8);

23 
	}
}

26 
	$g‘_¡¬t
(){

27 
pos
=0;

28 
	`out_by‹
(
CRTC_ADDR_REG
,
START_ADDR_L
);

29 
pos
+=
	`š_by‹
(
CRTC_DATA_REG
);

30 
	`out_by‹
(
CRTC_ADDR_REG
,
START_ADDR_H
);

31 
pos
+=
	`š_by‹
(
CRTC_DATA_REG
)<<8;

32  
pos
;

33 
	}
}

	@../debug/debug.h

1 #iâdeà
X86_DEBUG_H


2 
	#X86_DEBUG_H


	)

4 #´agm¨
·ck
(
push
)

5 #´agm¨
·ck
(1)

6 
	udr_ù¾
{

7 
	mv®ue
;

9 
	mL0
: 1;

10 
	mG0
: 1;

11 
	mL1
: 1;

12 
	mG1
: 1;

13 
	mL2
: 1;

14 
	mG2
: 1;

15 
	mL3
: 1;

16 
	mG3
: 1;

20 
	mRWE0
: 2;

21 
	mLEN0
: 2;

22 
	mRWE1
: 2;

23 
	mLEN1
: 2;

24 
	mRWE2
: 2;

25 
	mLEN2
: 2;

26 
	mRWE3
: 2;

27 
	mLEN3
: 2;

31 
	#RWE_EXEC
 0

	)

32 
	#RWE_W_ONLY
 1

	)

33 
	#RWE_WR
 3

	)

35 
	#BRK_ADDR_ALIGN_1
 0

	)

36 
	#BRK_ADDR_ALIGN_2
 1

	)

37 
	#BRK_ADDR_ALIGN_4
 3

	)

39 #´agm¨
·ck
(
pİ
)

	@
1
.
0
152
2795
arch/x86/include/asm/bit.h
arch/x86/include/asm/errno.h
arch/x86/include/asm/io.h
arch/x86/include/asm/page.h
arch/x86/kernel/process.c
arch/x86/kernel/sys_i386.c
arch/x86/mm/fault.c
arch/x86/mm/ioremap.c
block/buffer.cn
block/ll_rw_blk.c
boot.asm
bootinfo.asm
drivers/ide/ide.c
drivers/net/8139.c
drivers/net/e1000.c
drivers/pci/pci.c
drivers/pci/pci_vendor.c
elf.c
fs/binfmt_elf.c
fs/cell/cell.c
fs/cell/namei.c
fs/dcache.c
fs/exec.c
fs/inode.c
fs/namei.c
fs/open.c
fs/pipe.cn
fs/read_write.c
fs/super.c
fs_cell.c
func_table.c
garbage.c
i8259.c
include/asm-generic/errno-base.h
include/asm-generic/errno.h
include/asm-generic/fcntl.h
include/asm-generic/io.h
include/asm/resource.h
include/linux/NR_syscall.h
include/linux/arp.h
include/linux/assert.h
include/linux/bh.h
include/linux/binfmts.h
include/linux/blkdev.h
include/linux/buffer_head.h
include/linux/byteorder/generic.h
include/linux/cell.h
include/linux/cell_common.h
include/linux/ctype.h
include/linux/dcache.h
include/linux/errno.h
include/linux/fs.h
include/linux/fs_struct.h
include/linux/icmp.h
include/linux/ide.h
include/linux/if_ether.h
include/linux/ip.h
include/linux/kit.h
include/linux/mm.h
include/linux/mount.h
include/linux/mylist.h
include/linux/netdevice.h
include/linux/pci.h
include/linux/pci_ids.h
include/linux/pci_regs.h
include/linux/pci_vendor.h
include/linux/pci_vendor_full.h
include/linux/pipe.h
include/linux/printf.h
include/linux/resource.h
include/linux/sched.h
include/linux/skbuff.h
include/linux/slab.h
include/linux/string.h
include/linux/timer.h
include/linux/udp.h
include/linux/wait.h
include/net/arp.h
include/net/icmp.h
include/net/ip.h
include/net/tcp.h
include/net/udp.h
include/old/asm_lable.h
include/old/atomic.h
include/old/blk.h
include/old/bootinfo.h
include/old/disp.h
include/old/elf.h
include/old/fork.h
include/old/fs.h
include/old/fs_cell.h
include/old/fs_ext.h
include/old/func_table.h
include/old/hd.h
include/old/hd_drv.h
include/old/heap.h
include/old/hs.h
include/old/i8259.h
include/old/irq.h
include/old/kbd_drv.h
include/old/ku_mm.h
include/old/ku_proc.h
include/old/ku_utils.h
include/old/list.h
include/old/mm.h
include/old/mmzone.h
include/old/ntfs.h
include/old/pmm.h
include/old/proc.h
include/old/ramdisk.h
include/old/schedule.h
include/old/struinfo.h
include/old/time.h
include/old/tty.h
include/old/utils.h
include/old/valType.h
include/old/video_drv.h
irq.c
kernel.asm
kernel.c
kernel/bh.c
kernel/exit.c
kernel/fork.c
kernel/timer.c
ku_utils.c
lib/printf.c
lib/string.c
lib/vsprintf.c
mm.c
mm/memory.c
mm/mmap.c
mm/slab.c
mmzone.c
net/core/dev.c
net/core/skbuff.c
net/core/testnet.c
net/ipv4/arp.c
net/ipv4/icmp.c
net/ipv4/ip.c
net/ipv4/tcp.cn
net/ipv4/udp.c
pmm.c
proc.asm
proc.c
ramdisk.c
schedule.c
t.c
time.c
utils.asm
utils.c
video_drv.c
../debug/debug.h

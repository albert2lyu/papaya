cscope 15 $HOME/lab/yanqi/cmd -q 0000000732 0000044957
	@_dimg.c

9 
	#ENV_NOT_KERNEL


	)

10 
	~<sys/ty≥s.h
>

11 
	~<sys/°©.h
>

12 
	~<f˙é.h
>

13 
	~<°dio.h
>

14 
	~<uni°d.h
>

15 
	~<as£π.h
>

16 
	~<î∫o.h
>

17 
	~"../§c/ö˛ude/ﬁd/boŸöfo.h
"

18 
	gkî√l_img_size
;

20 
	$fdsize
(
fd
){

21 
pos
 = 
	`l£ek
(
fd
, 0, 
SEEK_CUR
);

22 
size
 = 
	`l£ek
(
fd
, 0, 
SEEK_END
);

23 
	`l£ek
(
fd
, 
pos
, 
SEEK_SET
);

24  
size
;

25 
	}
}

27 
	$fûesize
(*
«me
){

28 
fd
 = 
	`›í
(
«me
, 1+1, 0);

29 if(
fd
 == -1)  -1;

30 
size
 = 
	`fdsize
(
fd
);

31 
	`˛o£
(
fd
);

32  
size
;

33 
	}
}

38 
	$magic_cﬁ‹
(){

39 
	`as£π
(
kî√l_img_size
 > 0 && kernel_img_size < 511 * 512 &&

43 
byã
;

44 
fd_kî√l
 = 
	`›í
("../bö/kî√l.ñf", 
O_RDWR
);

45 
	`as£π
(
fd_kî√l
 != -1);

46 
fd_fix
 = 
	`›í
("./fix.img", 
O_RDWR
);

47 
	`as£π
–
fd_fix
 != -1 && "you should create 'fix.img' manually");

48 
	`as£π
–
	`fdsize
(
fd_fix
) == 512 );

50 
i
;

51 
i
 = 0; i < 511; i++){

52 
magic_x
 = 
i
;

53 
cﬁ‹_pos
 = 
i
 * 512;

54 if(
i
 =
kî√l_img_size
 / 512Ë
magic_x
 = 0xcc;

55 if(
cﬁ‹_pos
 > 
kî√l_img_size
){

56 
	`¥ötf
(">>>>>>>>>>>>>>>>>>>>>>>>%d se˘‹†cﬁ‹ed\n", 
i
);

60 
	`l£ek
(
fd_kî√l
, 
cﬁ‹_pos
, 
SEEK_SET
);

61 
	`as£π
–
	`ªad
(
fd_kî√l
, &
byã
, 1) == 1 );

62 if(
byã
 =0 && 
i
 =0Ë
	`as£π
(0 && "kernel.elf seems old,Åry 'make'\n");

63 
	`l£ek
(
fd_kî√l
, 
cﬁ‹_pos
, 
SEEK_SET
);

64 
	`as£π
(

65 
	`wrôe
(
fd_kî√l
, &
magic_x
, 1) == 1 );

66 
	`as£π
–
	`wrôe
(
fd_fix
, &
byã
, 1) == 1 );

68 
	`as£π
–
	`wrôe
(
fd_fix
, (*)&
i
, 2) == 2);

70 
	`fsync
(
fd_kî√l
);

71 
	`fsync
(
fd_fix
);

72 
	`˛o£
(
fd_kî√l
);

73 
	`˛o£
(
fd_fix
);

74 
	}
}

75 
	$maö
(
¨gc
, *
¨gv
[]){

76 
cmd
[100];

77 
	`as£π
(
¨gc
 == 2);

78 *
fûï©h
 = 
¨gv
[1];

79 
kî√l_img_size
 = 
	`fûesize
("../bin/kernel.elf");

80 
	`¥ötf
("sour˚Él‡size:%d\n", 
kî√l_img_size
);

81 
	`¥ötf
("èrgë devi˚ :%s\n", 
fûï©h
);

82 
	`as£π
(
kî√l_img_size
 < 250 * 1024 &&

86 
	`magic_cﬁ‹
();

88 
	`•rötf
(
cmd
,"dd if=../bö/kî√l.ñ‡of=%†bs=512 c⁄vÚŸrun¯£ek=%u", 
fûï©h
, 
kî√l_image_°¨t_£˘‹
-1);

89 
	`¥ötf
("%s\n", 
cmd
);

90 
	`sy°em
(
cmd
);

91 
	`•rötf
(
cmd
,"dd if=./fix.img of=%†bs=512 c⁄vÚŸrun¯£ek=%u", 
fûï©h
, 
fiximg_°¨t_£˘‹
 - 1);

92 
	`¥ötf
("%s\n", 
cmd
);

93 
	`sy°em
(
cmd
);

95 
boŸ_Êag
[]={0x55,0xaa};

96 
fd_sys
=
	`›í
(
fûï©h
,1+1,0);

97 if(
fd_sys
==-1){

98 
	`¥ötf
("›í %†îr‹:%d",
fûï©h
, 
î∫o
);

101 
d±
[48];

102 
	`l£ek
(
fd_sys
,446,0);

103 
	`as£π
(
	`ªad
(
fd_sys
,
d±
,48) == 48);

105 
	`•rötf
(
cmd
, "dd if=../bö/boŸ.bö of=%†bs=512 c⁄vÚŸrun¯£ek=0", 
fûï©h
);

106 
	`sy°em
(
cmd
);

108 
	`l£ek
(
fd_sys
,446,0);

109 
	`as£π
(
	`wrôe
(
fd_sys
,
d±
,48)==48);

112 
	`l£ek
(
fd_sys
,510,0);

113 
	`as£π
(
	`wrôe
(
fd_sys
,
boŸ_Êag
,2)==2);

115 
	`fsync
(
fd_sys
);

116 
	`as£π
(
	`˛o£
(
fd_sys
)!=-1);

117 
	`¥ötf
("dimg done..");

119 
	}
}

	@cat.c

1 
	~"sysˇŒ.h
"

2 
	$ˇt
(
¨gc
, *
¨g0
){

3 **
¨gv
 = &
¨g0
;

4 **
ívp
 = 
¨gv
 + 
¨gc
 + 1;

5 
i
 = 0;

6 
ª≥©
:

7  
i
 = 0; i < 
¨gc
; i++){

8 
	`¥ötf
("%s\n", 
¨gv
[
i
]);

10 
i
 = 0;

11 
ívp
[
i
]){

12 
	`¥ötf
("%s\n", 
ívp
[
i
++]);

14 
	`exô
(3);

15 
ª≥©
;

19 
	}
}

	@cell.c

11 
	~<°dio.h
>

12 
	~<uni°d.h
>

13 
	~<as£π.h
>

14 
	~<°rög.h
>

15 
	~<°dlib.h
>

16 
	~<f˙é.h
>

17 
	~"../§c/ö˛ude/löux/˚Œ_comm⁄.h
"

19 
	#boﬁ
 

	)

21 
	#F_REG
 1

	)

22 
	#F_DIR
 2

	)

23 
	sdp
{

24 
	mboŸ
;

25 
	m°¨t_hód
;

26 
	m°¨t_£˘‹
;

27 
	m°¨t_cyÀndî
;

29 
	msys_id
;

30 
	míd_hód
;

31 
	míd_£˘‹
;

32 
	míd_cyÀndî
;

34 
	m°¨t_lba
;

35 
	mcou¡
;

36 }*
	gg_dps
;

37 
	gg_d≤um
;

38 
	gmbrbuf
[1024];

39 
˚Œ_su≥rblock
 
	gsb
;

40 
	gcmd
[16];

41 
	g¨g1
[64];

42 
	gmaöfd
;

43 
˚Œ
 *
	g_pwd_block
;

44 
˚Œ
 *
	g_tmp_block
;

45 
˚Œ_díåy
 *
	g_íçwd
;

46 
	#pwd_block
 (*
_pwd_block
)

	)

47 
	#tmp_block
 (*
_tmp_block
)

	)

48 
	#íçwd
 (*
_íçwd
)

	)

49 
	gp_°¨t
;

50 
	gp_cou¡
;

51 
	gp_id
;

52 
	gp_ext_id
;

53 
	#go_⁄
(
msg
, 
¨g
) {\

54 
	`¥ötf
(
msg
 , 
¨g
);\

56 }

	)

58 
	#Áû_ßy
(
msg
, 
¨g
){\

59 
	`¥ötf
(
msg
, 
¨g
);\

60 
	`exô
(1);\

61 }

	)

63 
	#ªtu∫_ßy
(
vÆue
, 
msg
){\

64 
	`¥ötf
(
msg
);\

65  
vÆue
;\

66 }

	)

68 
	#SECTOR2BLOCK
(
£˘‹_num
Ë((£˘‹_num * 512 - 
sb
.
roŸ˚Œ
Ë/ sb.
˚Œsize
)

	)

69 
	$loˇã_˚Œ
(
˚Œid
){

70 
	`l£ek
(
maöfd
, 
p_°¨t
 * 512 + + 
sb
.
roŸ˚Œ
 + 
˚Œid
 * sb.
˚Œsize
, 
SEEK_SET
);

71 
	}
}

72 
boﬁ
 
	$maö_ªad_˚Œ
(*
buf
, 
˚Œid
){

73 
	`loˇã_˚Œ
(
˚Œid
);

74 
	`ªad
(
maöfd
, 
buf
, 
sb
.
˚Œsize
);

76 
	}
}

78 
boﬁ
 
	$maö_wrôe_˚Œ
(*
buf
, 
˚Œid
){

79 
	`loˇã_˚Œ
(
˚Œid
);

80 
	`wrôe
(
maöfd
, 
buf
, 
sb
.
˚Œsize
);

82 
	}
}

84 
	$wrôe_sb
(){

85 
	`as£π
–
	`l£ek
(
maöfd
, 
p_°¨t
*512+1024, 
SEEK_SET
) != -1);

86 
	`as£π
–
	`wrôe
(
maöfd
, (*)&
sb
, 1024) == 1024);

87 
	}
}

90 
˚Œ_díåy
 *
	$˚Œ_föd_íåy
(
˚Œ
 *˚Œ, *
«me
){

91 
˚Œ_díåy
 *
˚Œ_ít
 = 
˚Œ
->
íts
;

92 
ªmaö
;

93 
ªmaö
 = 
˚Œ
->
size
;Ñemain > 0;){

94 
ítsize
 = (
˚Œ_díåy
Ë+ 
˚Œ_ít
->
Àn
;

95 
Àn
 = 
˚Œ_ít
->len;

96 if(
Àn
 != 0){

97 if(
	`°æí
(
«me
Ë=
Àn
 && 
	`°∫cmp
“ame, 
˚Œ_ít
->name,Üen) == 0) ;

98 
ªmaö
 -
ítsize
;

100 
˚Œ_ít
 = (*)(()˚Œ_íà+ 
ítsize
);

102 if(
ªmaö
 > 0Ë 
˚Œ_ít
;

104 
	}
}

105 
	$gë_fûesize
(
fd
){

106 
ﬁdpos
 = 
	`l£ek
(
fd
, 0, 
SEEK_CUR
);

107 
	`as£π
(
ﬁdpos
 != -1);

108 
size
 = 
	`l£ek
(
fd
, 0, 
SEEK_END
);

109 
	`l£ek
(
fd
, 
ﬁdpos
, 
SEEK_SET
);

110  
size
;

111 
	}
}

113 
boﬁ
 
	$check_˚Œ_Êags
(
˚Œ_su≥rblock
 *
_sb
){

114 if(
_sb
->
Êags
[0] != 'c' || _sb->flags[1] != 'e' ||\

115 
_sb
->
Êags
[2] != 'l'|| _sb->flags[3] != 'l')

116 
	`ªtu∫_ßy
(0, "cell flags check failed\n")

117 if(
_sb
->
˚Œnum
 !
	`SECTOR2BLOCK
(
p_cou¡
))

118 
	`ªtu∫_ßy
(0, "block count informationÇot sychronised")

121 
	}
}

126 
boﬁ
 
	$choo£_∑π©i⁄
(
pid
){

127 
foo_pid
 = 
pid
 + 1;

128 if(
pid
 =
p_ext_id
Ë
	`ªtu∫_ßy
(0, "failed, 4 isÉxtendedÖartation\n");

129 if(
foo_pid
 <1 || foo_pid > 
g_d≤um
Ë
	`ªtu∫_ßy
(0, "failed, invalidÖartation id\n")

130 
dp
 *d∞
g_dps
 + 
pid
;

131 
p_id
 = 
pid
;

132 
p_°¨t
 = 
dp
->
°¨t_lba
;

133 
p_cou¡
 = 
dp
->
cou¡
;

135 
ªt
 = 
	`l£ek
(
maöfd
, 
p_°¨t
*512+1024, 
SEEK_SET
);

136 if(
ªt
 =-1Ë
	`Áû_ßy
("chooseÖartation:Üseek failed", 0);

137 
ªt
 = 
	`ªad
(
maöfd
, (*)&
sb
, 1024);

138 if(
ªt
 =-1Ë
	`Áû_ßy
("chooseÖartation:Ñead sb failed", 0);

139 
íçwd
.
˚Œid
=0;

140 
	`maö_ªad_˚Œ
((*)&
pwd_block
, 
íçwd
.
˚Œid
);

142 
	}
}

152 
˚Œ_díåy
 *
	$add_íåy
(
˚Œ
 *˚Œ, 
˚Œid
, *
«me
, 
to˚Œ
){

153 
˚Œ_díåy
 *
√w
 = (*)(()
˚Œ
->
íts
 + cñl->
size
);

154 
˚Œ
->
size
 +(
˚Œ_díåy
Ë+ 
	`°æí
(
«me
);

156 
	`°∫˝y
(
√w
->
«me
,Çame, 
	`°æí
(name));

157 
√w
->
Àn
 = 
	`°æí
(
«me
);

158 
√w
->
˚Œid
 = 
to˚Œ
;

159 
	`maö_wrôe_˚Œ
((*)
˚Œ
, 
˚Œid
);

160  
√w
;

161 
	}
}

165 
	$Æloc_‰ì_block
(
˚Œ_su≥rblock
 *
sb
){

166 
i
 = 0; i < 
sb
->
˚Œnum
; i++){

167 if(
sb
->
bôm≠
[
i
] == 0){

168 
sb
->
bôm≠
[
i
] = 1;

169 
	`wrôe_sb
();

170  
i
;

174 
	}
}

176 
	$maö_ªad_£˘‹
(*
buf
, 
lba
){

177 
	`as£π
–
	`l£ek
(
maöfd
, 
lba
*512, 
SEEK_SET
) != -1 );

178 
	`as£π
–
	`ªad
(
maöfd
, 
buf
, 512) == 512 );

179 
	}
}

181 * 
	gsys_°rög
[256];

182 
	$¥öt_dp
(
dp
 *dp, 
p_id
)

184 
	`¥ötf
("%10u%10u%10u%10u%10uM%10x%10s\n",
p_id
,
dp
->
boŸ
,dp->
°¨t_lba
,\

185 
dp
->
cou¡
, dp->cou¡ * 512 / 0x100000, dp->
sys_id
,
sys_°rög
[dp->sys_id]);

186 
	}
}

188 
	$öô_dp
(){

189 
g_dps
 = (*)(
mbrbuf
 + 446);

191 
i
=0;i<256;i++Ë
sys_°rög
[i]="unknown";

192 
sys_°rög
[0]="empty";

193 
sys_°rög
[0x5]="extend";

194 
sys_°rög
[0x83]="linux";

195 
sys_°rög
[0x6]="fat16";

196 
sys_°rög
[0x7]="hpfs/ntfs";

198 
	`¥ötf
("\n%10s%10s%10s%10s%10s%10s%10s\n","device","boot","start","count",\

200 
ebr_lba
 = 0;

201 
i
;

202 
i
=0;i<4;i++){

203 if(
g_dps
[
i
].
°¨t_lba
==0) ;

204 
	`¥öt_dp
(&
g_dps
[
i
], i + 1);

205 if(
g_dps
[
i
].
sys_id
 == 5) {

206 
ebr_lba
 = 
g_dps
[
i
].
°¨t_lba
;

207 
p_ext_id
 = 
i
;

210 
ebr
[512];

211 
dp
 *d∞(*)(
ebr
 + 446);

212 
√xt_ebr
:

213 if(
ebr_lba
 =0Ë
d⁄e
;

214 
	`maö_ªad_£˘‹
(
ebr
, 
ebr_lba
);

215 
	`as£π
(
dp
->
°¨t_£˘‹
 != 0 && "extendedÖartationÅotallyÉmpty? ");

216 
g_dps
[
i
] = *
dp
;

217 
g_dps
[
i
].
°¨t_lba
 +
ebr_lba
;

220 
	`¥öt_dp
(
dp
, 
i
 + 1);

221 if(
dp
[1].
°¨t_lba
Ë
ebr_lba
 += dp[1].start_lba;

222 
ebr_lba
 = 0;

223 
i
++;

224 
√xt_ebr
;

226 
d⁄e
:

227 
g_d≤um
 = 
i
;

228 
	}
}

230 
	$¥öt_˚Œ
(
˚Œ
 *˚Œ, 
dïth
){

231 
dïth
++;

232 if(
˚Œ
->
ty≥
 !
F_DIR
) ;

233 
˚Œ_díåy
 *
ít
 = 
˚Œ
->
íts
;

234 
ªmaö
 = 
˚Œ
->
size
, 
ítsize
;Ñemaö > 0; 
ít
 = (*)(()ent +Éntsize)){

236 
Àn
 = 
ít
->len;

237 
ítsize
 = (
˚Œ_díåy
Ë+ 
Àn
;

238 if(
Àn
 != 0){

239 
ªmaö
 -
ítsize
;

240 
	`¥ötf
("%*s|__%.*s\n",
dïth
, " ", 
Àn
, 
ít
->
«me
);

241 if(
ít
->
Àn
 =1 && 
	`°∫cmp
”¡->
«me
, ".", 1) == 0) ;

242 if(
ít
->
Àn
 =2 && 
	`°∫cmp
”¡->
«me
, "..", 2) == 0) ;

243 
˚Œ
[
sb
.
˚Œsize
];

244 
	`maö_ªad_˚Œ
(
˚Œ
, 
ít
->
˚Œid
);

245 
	`¥öt_˚Œ
((
˚Œ
*)˚Œ, 
dïth
);

248 
	}
}

251 
boﬁ
 
	$lﬂdfûe
(*
«me
, *
buf
){

252 
˚Œ_díåy
 *
ít
 = 
	`˚Œ_föd_íåy
(&
pwd_block
, 
«me
);

253 if–!
ít
 ) 
	`ªtu∫_ßy
(0, "canÇot find file");

254 
	`maö_ªad_˚Œ
(
buf
, 
ít
->
˚Œid
);

256 
	}
}

257 
	$maö
(
¨gc
, *
¨gv
[]){

258 
_tmp_block
 = 
	`mÆloc
(0x100000);

259 
_pwd_block
 = 
	`mÆloc
(0x100000);

260 
_íçwd
 = 
	`mÆloc
(64);

261 
maöfd
 = 
	`›í
(
¨gv
[1], 
O_RDWR
);

262 if(
maöfd
 =-1Ë
	`Áû_ßy
("›í faûed: %s", 
¨gv
[1]);

263 
	`ªad
(
maöfd
, 
mbrbuf
, 1024);

265 
	`öô_dp
();

266 if(!
	`choo£_∑π©i⁄
(0)Ë
	`ªtu∫_ßy
(1, "auto chooseÖartation failed")

269 
	`¥ötf
("$"Ë&& 
	`sˇnf
("%s%s", 
cmd
, 
¨g1
Ë!
EOF
){

271 if(
	`°rcmp
(
cmd
, "exit") == 0)  0;

272 if(
	`°rcmp
(
cmd
, "pwd") == 0 ||

273 
	`°rcmp
(
cmd
, "where") == 0)

274 
	`¥ötf
("now i¿∑π©i⁄: %d\n", 
p_id
 + 1);

275 if(
	`°rcmp
(
cmd
 , "format") == 0){

276 
	`°∫˝y
(
sb
.
Êags
, "cell", 4);

277 
sb
.
˚Œsize
 = 
CELL_SIZE
;

278 
sb
.
roŸ˚Œ
 = 
ROOTCELL_DEFAULT
;

279 
sb
.
˚Œnum
 = 
	`SECTOR2BLOCK
(
p_cou¡
);

281 
	`mem£t
(
sb
.
bôm≠
, 0, sb.
˚Œnum
);

282 
sb
.
bôm≠
[0] = 1;

283 
	`wrôe_sb
();

284 
	`maö_ªad_˚Œ
((*)&
tmp_block
, 0);

285 
tmp_block
.
size
 = 0;

286 
tmp_block
.
ty≥
 = 
F_DIR
;

287 
	`add_íåy
(&
tmp_block
, 0, ".", 0);

288 
	`add_íåy
(&
tmp_block
, 0, "..", 0);

289 
	`choo£_∑π©i⁄
(
p_id
);

290 
	`¥ötf
("done.\n");

292 if(!
	`check_˚Œ_Êags
(&
sb
))

293 
	`go_⁄
("weáreÅrapped iná un-cellÖartation, you haveÅoÑun 'format'\n", 0)

294 if(
cmd
[0] > '0' && cmd[0] < '9'){

295 
ok
 = 
	`choo£_∑π©i⁄
(
cmd
[0] - '0' - 1);

296 if(
ok
Ë
	`¥ötf
("∑π©i⁄ %¯now\n", 
cmd
[0]);

297 
	`¥ötf
("failed\n");

299 if(
	`°rcmp
(
cmd
, "cd") == 0){

300 if(
	`°æí
(
¨g1
Ë<0Ë
	`go_⁄
("secondárg missing", 0)

301 
˚Œ_díåy
 *
ít
 = 
	`˚Œ_föd_íåy
(&
pwd_block
, 
¨g1
);

302 if(!
ít
Ë
	`go_⁄
("ˇ¿nŸ föd %s", 
¨g1
)

303 
	`maö_ªad_˚Œ
((*)&
tmp_block
, 
ít
->
˚Œid
);

304 if(
tmp_block
.
ty≥
 =
F_DIR
){

305 
íçwd
 = *
ít
;

306 
	`°∫˝y
(
íçwd
.
«me
, 
ít
->«me,É¡->
Àn
);

307 
	`mem˝y
((*)
_pwd_block
, (*)
_tmp_block
, 
sb
.
˚Œsize
);

308 
	`¥ötf
("ok\n");

310 
	`go_⁄
("nŸá dúe˘‹y:%s", 
¨g1
)

313 if(
	`°rcmp
(
cmd
, "cat") == 0){

314 if(
	`lﬂdfûe
(
¨g1
, (*)&
tmp_block
)){

315 if(
tmp_block
.
ty≥
 !
F_REG
)

316 
	`go_⁄
("notÑegular file\n", 0)

317 
tmp_block
.
d©a
[tmp_block.
size
] = 0;

318 
	`¥ötf
("%s\n", 
tmp_block
.
d©a
);

321 if(
	`°rcmp
(
cmd
, "cp") == 0){

322 
√w«me
[64];

323 
	`sˇnf
("%s", 
√w«me
);

324 
fd
 = 
	`›í
(
¨g1
, 
O_RDWR
);

325 if(
fd
 =-1Ë
	`go_⁄
("›í faûed: %s\n", 
¨g1
 )

326 
size
 = 
	`ªad
(
fd
, 
tmp_block
.
d©a
, 
CELL_DATA_MAX
);

327 
tmp_block
.
size
 = size;

328 
tmp_block
.
ty≥
 = 
F_REG
;

331 
˚Œ_díåy
 *
ít
 = 
	`˚Œ_föd_íåy
(&
pwd_block
, 
√w«me
);

332 if(
ít
) ;

334 
√w˚Œ
 = 
	`Æloc_‰ì_block
(&
sb
);

335 
ít
 = 
	`add_íåy
(&
pwd_block
, 
íçwd
.
˚Œid
, 
√w«me
, 
√w˚Œ
);

337 
	`maö_wrôe_˚Œ
((*)&
tmp_block
, 
ít
->
˚Œid
);

338 
	`maö_wrôe_˚Œ
((*)&
pwd_block
, 
íçwd
.
˚Œid
);

339 
	`wrôe_sb
();

341 if(
	`°rcmp
(
cmd
, "mkdir") == 0){

342 
bid
 = 
	`Æloc_‰ì_block
(&
sb
);

343 
˚Œ_díåy
 *
√wít
 = 
	`add_íåy
(&
pwd_block
, 
íçwd
.
˚Œid
, 
¨g1
, 
bid
);

344 
	`as£π
(
√wít
);

345 
tmp_block
.
ty≥
 = 
F_DIR
;

346 
tmp_block
.
size
 = 0;

347 
	`add_íåy
(&
tmp_block
, 
bid
, ".", bid);

348 
	`add_íåy
(&
tmp_block
, 
bid
, "..", 
íçwd
.
˚Œid
);

351 if(
	`°rcmp
(
cmd
, "ls") == 0){

353 
	`¥öt_˚Œ
(&
pwd_block
, 1);

355 
	`go_⁄
("un•ecifõd comm™d %s\n", 
cmd
)

357 
	`˛o£
(
maöfd
);

359 
	}
}

	@foobar.c

1 
	ga
;

2 
b
;

3 
ext
();

4 
	$b¨
(){

5 
a
= 1;

6 
b
 = 2;

7 
	}
}

9 
	$foo
(){

10 
	`b¨
();

11 
	`ext
();

12 
	}
}

	@go.c

1 
foob¨1
();

2 
	$nomaö
(){

3 
	`foob¨1
();

4 
	`¥öt
(*
fmt
, ...);

5 
	`¥öt
("\nIám go!!\n");

8 
	}
}

	@init.c

1 
	~"sysˇŒ.h
"

2 
	~"../§c/ö˛ude/löux/waô.h
"

4 *
	g__¨gv
[] = {

11 * 
	g__ívp
[] = {

17 
	#__¨gc
 ((
__¨gv
Ë/ (*))

	)

19 
	gg_¨øy
[10] = {1, 2, 3, 4, 5, 6};

20 
	g°©ic_¨øy
[1024];

21 
	$öô
(
¨gc
, *
¨gv
[], *
ívp
[]){

22 
x
;

23 
i
 = 0; i < 10; i++Ë
	`¥ötf
("%u\n", 
g_¨øy
[i]);

24 
ªt
 = 
	`f‹k
();

25 
	`¥ötf
("Iám back ! %u\n", 
ªt
);

26 if(
ªt
 == 0){

27 
	`execve
("/home/ˇt", 
__¨gv
, 
__ívp
);

29 
exô_code
;

30 
gŸ
;

31  (
gŸ
 = 
	`waô4
(
ªt
, &
exô_code
, 
WNOHANG
, 0)) <= 0){

32 if(
gŸ
 == 0) ;

35 if(
gŸ
 == -1){

36 
	`¥ötf
("pid %u i†nŸ you∏chûd!", 
ªt
);

40 
	`¥ötf
("wait4Ñeturn bad value\n");

44 
	`¥ötf
("èsk %uÉxô! %u\n", 
gŸ
, 
exô_code
);

46 
°©ic_¨øy
[1023] = 3;

47 
c
 = 
ªt
 == 0 ? '+' : '-';

50 
	}
}

	@ld.c

14 
	~"ld.h
"

15 
	~<ﬁd/ñf.h
>

16 
	~"sysˇŒ.h
"

17 
	~"°©ic.h
"

18 
	~<löux/kô.h
>

19 
	#ERRNO_BASE
 0xfffff000

	)

20 
	gLD_BASE
;

21 
	#ERRNO
(
x
Ë(-()x)

	)

23 
	gld_°aic_v¨1
 = 0x123;

24 
	gld_v¨1
 = 0x111;

25 
	gld_v¨2
 = 0x222;

26 
	gld_v¨3
 = 0x333;

28 
globÆ_v¨1
, 
globÆ_v¨2
, 
globÆ_v¨3
;

32 
	$fdsize
(
fd
){

33 
pos
 = 
	`l£ek
(
fd
, 0, 1);

34 
size
 = 
	`l£ek
(
fd
, 0, 2);

35 
	`l£ek
(
fd
, 
pos
, 0);

36  
size
;

37 
	}
}

40 
	ghóp_bŸtom
;

41 
	ggood¨ó
;

42 
	$öô_hóp
(){

43 
hóp_bŸtom
 = 
	`brk
(0);

44 
good¨ó
 = 
hóp_bŸtom
;

45 
	}
}

46 *
	$mÆloc
(
size
){

47 
√w¨ó
 = 
good¨ó
 + 
size
;

48 if(
√w¨ó
 >
hóp_bŸtom
){

49 
brksize
 = 
	`˚û_Æign
(
size
, 
__4K
);

50 
hóp_bŸtom
 = 
	`brk
(hóp_bŸtom + 
brksize
);

51 if(
hóp_bŸtom
 >
ERRNO_BASE
Ë
	`•ö
("brk failed");

53 
¨ó
 = 
good¨ó
;

54 
good¨ó
 = 
√w¨ó
;

55  (*)
¨ó
;

56 
	}
}

58 * 
	$mem£t
(*
°¨t
, 
vÆue
, 
Àn
){

59 
i
 = 0; i < 
Àn
; i++){

60 ((*)
°¨t
)[
i
] = 
vÆue
;

62  
°¨t
;

63 
	}
}

66 
	$gëeù
(
x
) {

67  *(&
x
 - 1);

68 
	}
}

70 
	sñf_mm≠
{

71 *
	mãxt
;

72 *
	mfûíame
;

73 
	mid
;

74 
Elf32_Ehdr
 *
	mehódî
;

75 
u32
 
	mªba£
;

78 
	mshnum
;

79 
Elf32_Phdr
 *
	mphódî
;

80 
	mphnum
;

81 
Elf32_Dyn
 *
	mdy«mic
;

82 
	mdy∆í
;

83 *
	msym°r
;

84 *
	mdyn°r
;

85 
Elf32_Sym
 *
	mdynsym
;

86 
	mdynsym_ƒ
;

87 *
	mv¨_tbl
;

88 *
	mfunc_tbl
;

89 
	mvtbl_Àn
;

90 
	m·bl_Àn
;

91 
Elf32_Rñ
 *
	mvtbl_fix
;

92 
Elf32_Rñ
 *
	m·bl_fix
;

93 
	mvtbl_fix_Àn
;

94 
	m·bl_fix_Àn
;

97 
ñf_mm≠
 
	gldmm≠
;

98 
	#MAX_SO
 1024

	)

99 
ñf_mm≠
 *
	gmm≠_of_so
[
MAX_SO
];

100 
	gright
;

120 
boﬁ


121 
	$∑r£_ñf_mm≠
(
Elf32_Ehdr
 *
ehódî
, 
ñf_mm≠
 *
mm≠
, 
fd
){

123 
Elf32_Ehdr
 *
ehódî2
;

124 
Elf32_Shdr
 *
shódî2
;

125 *
sh°r2
;

126 
•a˚
 = 
	`˚û_Æign
–
	`fdsize
(
fd
), 
__4K
 );

127 
ehódî2
 = 
	`mm≠2
(0, 
•a˚
, 
PROT_READ
, 
MAP_PRIVATE
, 
fd
, 0);

128 if(
ehódî2
 > (
Elf32_Ehdr
*)
ERRNO_BASE
)

129  
Ál£
;

130 
shódî2
 = 
	`±r_off£t
(
ehódî2
,Éhódî2->
e_shoff
);

135 
sh°r2
 = 
	`±r_off£t
(
ehódî2
, 
shódî2
[
ehódî
->
e_sh°∫dx
].
sh_off£t
);

138 
Elf32_Phdr
 *
phódî
 = 
	`±r_off£t
(
ehódî
,Éhódî->
e_phoff
);

139 
u32
 
ªba£
;

140 if(
ehódî
->
e_ty≥
 =
ET_EXEC
){

141 
u32
 
lﬂd_©
 = 
phódî
[2].
p_vaddr
;

143 
lﬂd_©
 = 
	`Êo‹_Æign
÷ﬂd_©, 
__4K
);

144 if(
lﬂd_©
 !(
u32
)
ehódî
)

145 
	`•ö
("executableÜoadedát wrongÜocation");

146 
ªba£
 = 0;

148 if(
ehódî
->
e_ty≥
 =
ET_DYN
){

149 
ªba£
 = (
u32
)
ehódî
;

151 
	`•ö
("badÉ_type");

153 
i
 = 0; i < 
ehódî
->
e_shnum
; i++){

154 **
£c_¨ó
 = 0;

155 *
£c_íäum
 = 0;

156 
Elf32_Shdr
 *
this
 = 
shódî2
 + 
i
;

157 if(
this
->
sh_addr
 == 0) ;

159 *
£c_«me
 = 
sh°r2
 + 
this
->
sh_«me
;

161 if–
	`°rcmp
(".dyn°r", 
£c_«me
) == 0 ){

162 
£c_¨ó
 = (*)&
mm≠
->
dyn°r
;

164 if(
	`°rcmp
(".dynsym", 
£c_«me
) == 0){

165 
£c_¨ó
 = (*)&
mm≠
->
dynsym
;

166 
£c_íäum
 = (*)&
mm≠
->
dynsym_ƒ
;

168 if(
	`°rcmp
(".ãxt", 
£c_«me
) == 0){

169 
£c_¨ó
 = (*)&
mm≠
->
ãxt
;

172 if(
	`°rcmp
(".dy«mic", 
£c_«me
) == 0){

173 
£c_¨ó
 = (*)&
mm≠
->
dy«mic
;

174 
£c_íäum
 = &
mm≠
->
dy∆í
;

176 if(
	`°rcmp
(".gŸ", 
£c_«me
) == 0){

177 
£c_¨ó
 = (*)&
mm≠
->
v¨_tbl
;

178 
£c_íäum
 = &
mm≠
->
vtbl_Àn
;

180 if(
	`°rcmp
(".gŸ.∂t", 
£c_«me
) == 0){

181 
£c_¨ó
 = (*)&
mm≠
->
func_tbl
;

182 
£c_íäum
 = &
mm≠
->
·bl_Àn
;

184 if(
	`°rcmp
(".ªl.dyn", 
£c_«me
) == 0){

185 
£c_¨ó
 = (*)&
mm≠
->
vtbl_fix
;

186 
£c_íäum
 = &
mm≠
->
vtbl_fix_Àn
;

188 if(
	`°rcmp
(".ªl.∂t", 
£c_«me
) == 0){

189 
£c_¨ó
 = (*)&
mm≠
->
·bl_fix
;

190 
£c_íäum
 = &
mm≠
->
·bl_fix_Àn
;

195 if(
£c_¨ó
Ë*£c_¨ó = (*)(
ªba£
 + 
this
->
sh_addr
);

196 if(
£c_íäum
Ë*£c_íäum = 
this
->
sh_size
 /Åhis->
sh_ítsize
;

199 
mm≠
->
ehódî
 =Éheader;

200 
mm≠
->
shnum
 = 
ehódî
->
e_shnum
;

201 
mm≠
->
phnum
 = 
ehódî
->
e_phnum
;

202 
mm≠
->
phódî
 =Öheader;

203 
mm≠
->
ªba£
 =Ñebase;

205 *
ªt
 = 
	`munm≠
(
ehódî2
, 
•a˚
);

206 if(
ªt
 !0Ë 
Ál£
;

207  
åue
;

208 
	}
}

211 
	gc⁄°_symbﬁ_ty≥
[5][8] = {

219 
	$öfo_dynsym
(
Elf32_Sym
 *
sym
, 
ñf_mm≠
 *
mm≠
){

220 
	`¥öt
("symbolÇame:%s, value:%x,Åype:%s\n",

221 
mm≠
->
dyn°r
 + 
sym
->
°_«me
, sym->
°_vÆue
,

223 
c⁄°_symbﬁ_ty≥
[
sym
->
°_ty≥
]);

224 
	}
}

226 
	$öfo_ªl
(
Elf32_Rñ
 *
ªl
, 
ñf_mm≠
 *
mm≠
){

227 
	`¥öt
("I wantÅo fixárea:%x,Ñel-type:%d, symbolÑeference =>\n",

228 
ªl
->
r_off£t
,Ññ->
r_ty≥
);

229 
	`öfo_dynsym
(
mm≠
->
dynsym
 + 
ªl
->
r_symndx
, mmap);

230 
	}
}

235 
	$now_ôs_addªss
(
Elf32_Sym
 *
sym
, 
ñf_mm≠
 *
mm≠
){

236  
mm≠
->
ªba£
 + 
sym
->
°_vÆue
;

237 
	}
}

239 *
	$¨ó_of_ªl
(
Elf32_Rñ
 *
ªl
, 
ñf_mm≠
 *
mm≠
){

240  (*)(
mm≠
->
ªba£
 + 
ªl
->
r_off£t
);

241 
	}
}

242 
	ssymbﬁ_‹igö
{

243 
ñf_mm≠
 *
	mmm≠
;

244 
Elf32_Sym
 *
	msymbﬁ
;

248 *
	$«meof_dynsym
(
Elf32_Sym
 *
sym
, 
ñf_mm≠
 *
mm≠
){

249  
mm≠
->
dyn°r
 + 
sym
->
°_«me
;

250 
	}
}

253 
Elf32_Sym
 *
	$symof_ªl
(
Elf32_Rñ
 *
ªl
, 
ñf_mm≠
 *
mm≠
){

254  
mm≠
->
dynsym
 + 
ªl
->
r_symndx
;

255 
	}
}

259 
Elf32_Sym
 *

260 
	$£¨ch_ö_dynsym
–*
«me
, 
ñf_mm≠
 *
so
){

261 
Elf32_Sym
 *
sym
;

262 
Elf32_Sym
 *
m©ch
 = 0;

263 
i
;

265 
i
 = 0; i < 
so
->
dynsym_ƒ
; i++){

266 
sym
 = 
so
->
dynsym
 + 
i
;

267 if(
sym
->
°_shndx
 =
SHN_UNDEF
) ;

269 if(
	`°rcmp
(
«me
, 
	`«meof_dynsym
(
sym
, 
so
)) == 0) {

270 if(
sym
->
°_shndx
 !
SHN_COMMON


271 && 
sym
->
°_shndx
 >
SHN_LORESERVE
)

272 
	`•ö
("strange capture");

273 
m©ch
 = 
sym
;

278  
m©ch
;

279 
	}
}

284 
symbﬁ_‹igö
 
	$föd_symbﬁ
(*
«me
){

285 
symbﬁ_‹igö
 
‹igö
 = {0};

286 
ñf_mm≠
 *
so
;

287 
Elf32_Sym
 *
m©ch
;

289 
i
 = 0; i < 
MAX_SO
; i++){

290 
so
 = 
mm≠_of_so
[
i
];

291 if(!
so
) ;

293 
m©ch
 = 
	`£¨ch_ö_dynsym
(
«me
, 
so
);

294 if(
m©ch
){

295 
‹igö
.
mm≠
 = 
so
;

296 
‹igö
.
symbﬁ
 = 
m©ch
;

301  
‹igö
;

302 
	}
}

309 
symbﬁ_‹igö


310 
	$≠∂y_ªl
(
Elf32_Rñ
 *
ªl
, 
ñf_mm≠
 *
mm≠
){

311 
symbﬁ_‹igö
 
‹igö
;

315 
Elf32_Sym
 *
ö√r
 = 
	`symof_ªl
(
ªl
, 
mm≠
);

316 *
«me
 = 
	`«meof_dynsym
(
ö√r
, 
mm≠
);

317 *
¨ó
 = 
	`¨ó_of_ªl
(
ªl
, 
mm≠
);

318 
addªss
 = 0;

319 
ªl
->
r_ty≥
){

320 
R_386_RELATIVE
:

321 
‹igö
.
mm≠
 = mmap;

322 
‹igö
.
symbﬁ
 = 0;

323 
addªss
 = (
u32
)
	`±r_off£t
(
mm≠
->
ªba£
, *
¨ó
);

325 
R_386_GLOB_DAT
:

326 
R_386_JMP_SLOT
:

327 
‹igö
 = 
	`föd_symbﬁ
(
«me
);

328 if(
‹igö
.
mm≠
)

329 
addªss
 = 
	`now_ôs_addªss
(
‹igö
.
symbﬁ
, origö.
mm≠
);

332 
‹igö
.
mm≠
 = 0;

334 if(
‹igö
.
mm≠
Ë*
¨ó
 = 
addªss
;

336  
‹igö
;

337 
	}
}

362 
	$_dl_ru¡ime_ªsﬁve
(
¨g
){

363 
symbﬁ_‹igö
 
‹igö
;

365 
Elf32_Rñ
 *
ªl
;

366 
ñf_mm≠
 *
so
;

369 *
ebp
 = &
¨g
 - 2;

371 
moduÀ_id
 = 
ebp
[1];

372 
ª dx
 = 
ebp
[2];

374 
so
 = 
mm≠_of_so
[
moduÀ_id
];

375 
ªl
 = 
	`±r_off£t
(
so
->
·bl_fix
, 
ª dx
);

376 
‹igö
 = 
	`≠∂y_ªl
(
ªl
, 
so
);

378 if(
‹igö
.
mm≠
 == 0) {

379 
	`öfo_dynsym
(
‹igö
.
symbﬁ
, origö.
mm≠
);

380 
	`•ö
("canÇot findÅhe symbolábove");

382 
addªss
 = 
	`now_ôs_addªss
(
‹igö
.
symbﬁ
, origö.
mm≠
);

383 
__asm__
 
	`__vﬁ©ûe__
("mov %%ebp, %%esp\n\t"

389 :"r"(
addªss
)

391 
	}
}

396 
	$ªgi°î_gŸ
(
so_id
){

397 
i
,
j
;

398 
ñf_mm≠
 *
so
;

399 
Elf32_Rñ
 *
ªl
;

401 
symbﬁ_‹igö
 
‹igö
;

403 
so

mm≠_of_so
[
so_id
];

404 if(
so
->
v¨_tbl
 =
NULL
Ë
ign‹e_gŸ
;

405 
j
 = 0; j < 
so
->
vtbl_fix_Àn
; j++){

406 
ªl
 = &
so
->
vtbl_fix
[
j
];

409 
‹igö
 = 
	`≠∂y_ªl
(
ªl
, 
so
);

410 if(
‹igö
.
mm≠
 == 0) {

411 
	`•ö
("find symbol failed");

414 
ign‹e_gŸ
:

416 if(
so
->
func_tbl
 =
NULL
Ë
ign‹e_gŸ_∂t
;

418 
so
->
func_tbl
[1] = so->
id
;

419 
so
->
func_tbl
[2] = ()
_dl_ru¡ime_ªsﬁve
;

422 
i
 = 3; i < 
so
->
·bl_Àn
; i++){

423 
so
->
func_tbl
[
i
] +()so->
ªba£
;

425 
ign‹e_gŸ_∂t
:

428 
	}
}

441 *
	$lﬂdñf
(
fd
){

442 *
ªt
;

443 *
lﬂd_©
 = 0;

444 
Elf32_Ehdr
 *
ehódî
;

445 
Elf32_Phdr
 *
phódî
;

446 
fsize
 = 
	`fdsize
(
fd
);

449 
•a˚
 = 
	`˚û_Æign
–
fsize
 + 
__4K
 + __4K, __4K);

454 
m≠_Êags
 = 
MAP_SHARED
;

455 
do_lﬂd
:

456 
ehódî
 = 
	`mm≠2
(
lﬂd_©
, 
•a˚
,

457 
PROT_READ
 | 
PROT_EXEC
,

458 
m≠_Êags
, 
fd
, 0);

459 if((
u32
)
ehódî
 > 
ERRNO_BASE
)  0;

460 
phódî
 = 
	`±r_off£t
(
ehódî
,Éhódî->
e_phoff
);

462 
x
,
w
;

463 
ªba£
;

464 if(
ehódî
->
e_ty≥
 =
ET_EXEC
){

465 
x
 = 2; 
w
 = 3;

466 if((
u32
)
ehódî
 !
phódî
[
x
].
p_vaddr
){

467 
lﬂd_©
 = (*)
phódî
[
x
].
p_vaddr
;

469 
ªt
 = 
	`munm≠
(
ehódî
, 
•a˚
);

470 if(
ªt
 != 0)  0;

471 
do_lﬂd
;

473 
ªba£
 = 0;

475 if(
ehódî
->
e_ty≥
 =
ET_DYN
){

476 
x
 = 0; 
w
 = 1;

477 
ªba£
 = (
u32
)
ehódî
;

479 
	`•ö
("bad");

480 if(
phódî
[
x
].
p_ty≥
 !
PT_LOAD
||

481 
phódî
[
x
].
p_vaddr
 %
__4K
 != 0)

482 
	`•ö
("hack failed");

486 
u32
 
d©a_°¨t
 = 
ªba£
 + 
phódî
[
w
].
p_vaddr
;

487 
u32
 
d©a_íd
 = 
d©a_°¨t
 + 
phódî
[
w
].
p_fûesz
 - 1;

488 
u32
 
bss_íd
 = 
d©a_°¨t
 + 
phódî
[
w
].
p_memsz
 - 1;

491 
d©a_°¨t
 = 
	`Êo‹_Æign
(d©a_°¨t, 
__4K
);

492 
d©a_íd
 = 
	`Êo‹_Æign
(d©a_íd, 
__4K
);

493 
bss_íd
 = 
	`Êo‹_Æign
(bss_íd, 
__4K
);

495 
code_Àn
 = 
d©a_°¨t
 - (
u32
)
ehódî
;

496 
ªt
 = 
	`munm≠
((*)
d©a_°¨t
, 
•a˚
 - 
code_Àn
);

497 if(
ªt
 != 0)  0;

498 
ªt
 = 
	`mm≠2
((*)
d©a_°¨t
, 
d©a_íd
 - d©a_°¨à+ 
__4K
,

499 
PROT_READ
|
PROT_WRITE
,

501 
MAP_PRIVATE
,

502 
fd
, 
phódî
[
w
].
p_off£t
 / 
__4K
);

503 if((
u32
)
ªt
 !
d©a_°¨t
)  0;

504 
bss_size
 = 
bss_íd
 - 
d©a_íd
;

506 if(
bss_size
 > 0){

507 
u32
 
bss_°¨t
 = 
d©a_íd
 + 
__4K
;

508 
ªt
 = 
	`mm≠2
((*)
bss_°¨t
, 
bss_íd
 - 
d©a_íd
,

509 
PROT_READ
 | 
PROT_WRITE
,

510 
MAP_ANONYMOUS
 | 
MAP_FIXED
,

512 if((
u32
)
ªt
 !
bss_°¨t
)  0;

513 
	`mem£t
((*)
bss_°¨t
, 0, 
bss_size
 );

516  
ehódî
;

517 
	}
}

525 
ñf_mm≠
 *
	$lﬂdso
(*
«me
){

526 
boﬁ
 
ok
;

527 
ñf_mm≠
 *
mm≠
;

528 
Elf32_Ehdr
 *
ehódî
;

531 
fd
 = 
	`›í
(
«me
, 0, 0);

532 if(
fd
 > 
ERRNO_BASE
)  0;

533 
ehódî
 = 
	`lﬂdñf
(
fd
);

534 if(
ehódî
 == 0)  0;

536 
mm≠
 = 
	`mÆloc
((
ñf_mm≠
));

537 
	`mem£t
(
mm≠
, 0, (
ñf_mm≠
));

538 
ok
 = 
	`∑r£_ñf_mm≠
(
ehódî
, 
mm≠
, 
fd
);

539 if(!
ok
)  0;

540 
mm≠
->
fûíame
 = 
«me
;

541  
mm≠
;

542 
	}
}

550 
ñf_mm≠
 *
	$ªsﬁve_√eded
(*
fûíame
){

551 
i
 = 0; i <
right
; i++){

552 
ñf_mm≠
 *
so
 = 
mm≠_of_so
[
i
];

553 if(
	`°rcmp
(
so
->
fûíame
, fûíameË=0){ if(
i
 =0Ë
	`•ö
("youÑely onÜd.so ?");

554  (*)
i
;

557 
ñf_mm≠
 *
mm≠
 = 
	`lﬂdso
(
fûíame
);

558 if(!
mm≠
)  0;

559 
mm≠_of_so
[++
right
] = 
mm≠
;

560 
mm≠
->
id
 = 
right
;

561  
mm≠
;

562 
	}
}

565 
boﬁ
 
	$ªsﬁve_dïídí˚
(
ñf_mm≠
 *
mm≠
){

566 
Elf32_Dyn
 *
dyn
;

567 
ñf_mm≠
 *
√w
;

568 
dyn
 = 
mm≠
->
dy«mic
; dyn->
d_èg
 !
DT_NULL
; dyn++){

569 if(
dyn
->
d_èg
 !
DT_NEEDED
) ;

570 *
s⁄ame
 = 
mm≠
->
dyn°r
 + 
dyn
->
d_vÆ
;

571 if(
	`°rcmp
(
s⁄ame
, "libc.so.6") == 0)

573 
√w
 = 
	`ªsﬁve_√eded
(
s⁄ame
);

574 if(!
√w
Ë 
Ál£
;

576  
åue
;

577 
	}
}

581 
boﬁ
 
	$ªsﬁve_dïídí˚R
(){

582 
boﬁ
 
ok
;

584 
i
 = 0; i <
right
; i++){

585 
ñf_mm≠
 *
so
 = 
mm≠_of_so
[
i
];

586 
ok
 = 
	`ªsﬁve_dïídí˚
(
so
);

587 if(!
ok
Ë 
Ál£
;

589  
åue
;

590 
	}
}

615 
	$__°¨t
(*
¨g0
){

616 
boﬁ
 
ok
;

617 
Elf32_Ehdr
 *
ehódî
 = 0;

618 
u32
 
°¨ãr_phdr
;

619 
Elf32_Ehdr
 *
exec_ehdr
;

620 
u32
 
°¨ãr_íåy
 = 0;

625 *
∑ge
 = (*Ë(
	`gëeù
(0) & ~0xfff) ;

626 !(
∑ge
[0] == 127

627 && 
∑ge
[1] == 'E' &&Öage[2] == 'L' &&Öage[3] == 'F')){

628 
∑ge
 -= 0x1000;

631 
LD_BASE
 = ()
∑ge
;

632 
ehódî
 = (*)
LD_BASE
;

634 **
¨gv
 = &
¨g0
;

635 
¨gc
 = ()
¨gv
[-1];

636 **
ívp
 = 
¨gv
 + 
¨gc
 + 1;

637 
ld_°aic_v¨1
 = 0x4455;

639 
i
;

640 
i
 = 0; 
ívp
[i]; i++){

643 
Elf32_auxv_t
 *
aux
 = (*)(
ívp
 + 
i
 + 1);

644 
aux
->
a_ty≥
){

646 
aux
->
a_ty≥
){

647 
AT_SYSINFO_EHDR
:

650 
AT_ENTRY
:

651 
°¨ãr_íåy
 = 
aux
->
a_vÆ
;

652 
AT_PHDR
:

653 
°¨ãr_phdr
 = 
aux
->
a_vÆ
;

657 
aux
++;

660 
ldfd
 = 
	`›í
("./ld.so", 0, 0);

661 if(
ldfd
 > 
ERRNO_BASE
)

662 
	`•ö
("openÜd.so failed");

663 
ok
 = 
	`∑r£_ñf_mm≠
(
ehódî
, &
ldmm≠
, 
ldfd
);

664 if(!
ok
Ë
	`•ö
("pase mmap ofÜd.so failed");

665 
ldmm≠
.
id
 = 0;

666 
ldmm≠
.
fûíame
 = "ld.so";

667 
mm≠_of_so
[0] = &
ldmm≠
;

668 
	`ªgi°î_gŸ
(0);

669 
	`öô_hóp
();

673 
me_°¨ãr
 = 
°¨ãr_íåy
 =
LD_BASE
 + 
ehódî
->
e_íåy


674 ? 1 : 
Ál£
;

675 *
exec_∑th
 = 
¨gv
[
me_°¨ãr
];

676 
execfd
 = 
	`›í
(
exec_∑th
, 0, 0); if”xecfd > 
ERRNO_BASE
Ë
	`•ö
("openÉxec failed");

677 if(
me_°¨ãr
){

678 
	`¥öt
("IámÅheÖrogram itself !\n");

679 
exec_ehdr
 = 
	`lﬂdñf
(
execfd
); if(!exec_ehdrË
	`•ö
("loadÉxec failed");

682 
	`¥öt
("IámÜd, invoked by kernel..\n");

684 
exec_ehdr
 = (*)
	`Êo‹_Æign
(
°¨ãr_phdr
, 
__4K
);

686 
ñf_mm≠
 *
exec_mm≠
 = 
	`mÆloc
((ñf_mm≠)); if(!exec_mm≠Ë
	`•ö
("bad");

687 
ok
 = 
	`∑r£_ñf_mm≠
(
exec_ehdr
, 
exec_mm≠
, 
execfd
); if(!okË
	`•ö
("parseÉxec mmap failed");

688 
exec_mm≠
->
id
 = 1;

689 
exec_mm≠
->
fûíame
 = 
exec_∑th
;

690 
mm≠_of_so
[++
right
] = 
exec_mm≠
; if‘ighà!1Ë
	`•ö
("exec should beát slot 1");

692 
ok
 = 
	`ªsﬁve_dïídí˚R
();

693 if(!
ok
Ë
	`•ö
("resolve dependenceR failed");

694 
i
 = 1; i <
right
; i++){

695 
	`ªgi°î_gŸ
(
i
);

697 
__asm__
 
	`__vﬁ©ûe__
(

702 : "r"(
exec_mm≠
->
ehódî
->
e_íåy
)

704 
	`•ö
("you should see me");

705 
	}
}

	@ld.h

1 #i‚de‡
LD_H


2 
	#LD_H


	)

4 
	~<ﬁd/vÆTy≥.h
>

5 
ölöe
 
	$wrôe
(*
°r
, 
Àn
){

6 
__asm__
 
	`__vﬁ©ûe__
(

12 :"r"(1), "a"(4), "c"(
°r
), "d"(
Àn
)

14 
	}
}

	@lib1.c

1 
	~"¥ötf.h
"

12 
	gglobÆ_v¨
;

13 
	gglobÆ_v¨1
 = 1;

14 
globÆ_v¨3
, 
globÆ_v¨4
;

16 
foob¨3
();

17 
foob¨4
();

19 
	$foob¨1
(){

20 
	`¥öt
("foobar1 invoked\n");

23 
	`¥öt
("è°êglobÆ_v¨3: %d, globÆ_v¨4: %d\n", 
globÆ_v¨3
, 
globÆ_v¨4
);

24 
	`foob¨3
();

25 
	`foob¨4
();

27 
	}
}

	@lib2.c

1 
	~"¥ötf.h
"

12 
	gglobÆ_v¨
;

13 
	gglobÆ_v¨2
 = 2;

14 
globÆ_v¨5
, 
globÆ_v¨6
;

16 
foob¨5
();

17 
foob¨6
();

19 
	$foob¨2
(){

20 
	`¥öt
("foobar2 invoked\n");

21 
	`¥öt
("è°êglobÆ_v¨3: %d, globÆ_v¨4: %d\n", 
globÆ_v¨5
, 
globÆ_v¨6
);

22 
	`foob¨5
();

23 
	`foob¨6
();

25 
	}
}

	@lib3.c

1 
	~"¥ötf.h
"

12 
	gglobÆ_v¨
;

13 
	gglobÆ_v¨3
 = 3;

15 
	$foob¨3
(){

16 
	`¥öt
("foobar3 invoked\n");

19 
	}
}

	@lib4.c

1 
	~"¥ötf.h
"

12 
	gglobÆ_v¨
;

13 
	gglobÆ_v¨4
 = 4;

15 
	$foob¨4
(){

16 
	`¥öt
("foobar4 invoked\n");

19 
	}
}

	@lib5.c

1 
	~"¥ötf.h
"

12 
	gglobÆ_v¨
;

13 
	gglobÆ_v¨5
 = 5;

15 
	$foob¨5
(){

16 
	`¥öt
("foobar5 invoked\n");

19 
	}
}

	@lib6.c

1 
	~"¥ötf.h
"

12 
	gglobÆ_v¨
;

13 
	gglobÆ_v¨6
 = 6;

15 
	$foob¨6
(){

16 
	`¥öt
("foobar6 invoked");

19 
	}
}

	@malloc.c

1 
	~"mÆloc.h
"

2 
	~"sysˇŒ.h
"

4 
	gbŸtom
;

5 
boﬁ
 
hóp_öôü


6 
	$öô_hóp
(){

8 
	}
}

	@malloc.h

1 #i‚de‡
PAPAYA_MALLOC_H


2 
	#PAPAYA_MALLOC_H


	)

4 *
mÆloc
(
size
);

	@printf.c

1 
	~"°rög.h
"

2 
	~"¥ötf.h
"

4 
	$wrôe
(*
°r
, 
Àn
){

5 
__asm__
 
	`__vﬁ©ûe__
(

11 :"r"(1), "a"(4), "c"(
°r
), "d"(
Àn
)

13 
	}
}

15 
	$putch
(
c
){

16 
°r
[] = {
c
, 0};

17 
	`wrôe
(
°r
, 1);

18 
	}
}

20 
	$puts
(*
°r
){

21 
	`wrôe
(
°r
, 
	`°æí
(str));

22 
	}
}

24 
	$¥öä
(
uöt
 
n
, uöà
b
){

25 *
¡ab
 = "0123456789ABCDEF";

26 
uöt
 
a
, 
m
;

27 i‡((
a
 = 
n
 / 
b
)){

28 
	`¥öä
(
a
, 
b
);

30 
m
 = 
n
 % 
b
;

31 
	`putch
–
¡ab
[
m
]);

32 
	}
}

34 
	$¥öt
(*
fmt
, ...){

35 
c
;

36 
uöt
 *
adx
 = (uöt*)(*)&
fmt
 + 1;

37 
_lo›
:

38 (
c
 = *
fmt
++) != '%'){

39 i‡(
c
 == '\0') ;

40 
	`putch
(
c
);

42 
c
 = *
fmt
++;

43 i‡(
c
 == 'd' || c == 'l'){

44 
	`¥öä
(*
adx
, 10);

46 i‡(
c
 == 'o' || c == 'x'){

47 
	`¥öä
(*
adx
, 
c
=='o'? 8:16 );

49 i‡(
c
 == 's'){

50 
	`puts
((*)*
adx
);

52 
adx
++;

53 
_lo›
;

54 
	}
}

	@printf.h

1 #i‚de‡
PRINTF_H


2 
	#PRINTF_H


	)

4 
	tuöt
;

5 
¥öt
(*
fmt
, ...);

6 
¥öä
(
uöt
 
n
, uöà
b
);

7 
puts
(*
°r
);

8 
putch
(
c
);

	@static.h

2 
	~"sysˇŒ.h
"

3 
	$°æí
(*
°r
){

4 
Àn
=0;

5 *
°r
!=0){

6 
°r
++;

7 
Àn
++;

9  
Àn
;

10 
	}
}

12 
	$°rcmp
(c⁄° *
°r1
, c⁄° *
°r2
){

13 
i
;

14 
i
 = 0; 
°r1
[i] =
°r2
[i]; i++){

15 if(
°r1
[
i
] == 0)  0;

17  
i
 + 1;

19 
	}
}

21 
	$°∫cmp
(c⁄° *
°r1
, c⁄° *
°r2
, 
n
){

22 
i
 = 0; i < 
n
; i++){

23 if(
°r1
[
i
] =
°r2
[i]) {

24 if(
°r1
[
i
]) ;

27  
i
 + 1;

30 
	}
}

32 
	tuöt
;

33 
	$putch
(
c
){

34 
°r
[] = {
c
, 0};

35 
	`wrôe
(
°r
, 1);

36 
	}
}

38 
	$puts
(*
°r
){

39 
	`wrôe
(
°r
, 
	`°æí
(str));

40 
	}
}

42 
	$¥öä
(
uöt
 
n
, uöà
b
){

43 *
¡ab
 = "0123456789ABCDEF";

44 
uöt
 
a
, 
m
;

45 i‡((
a
 = 
n
 / 
b
)){

46 
	`¥öä
(
a
, 
b
);

48 
m
 = 
n
 % 
b
;

49 
	`putch
–
¡ab
[
m
]);

50 
	}
}

52 
	$¥öt
(*
fmt
, ...){

53 
c
;

54 
uöt
 *
adx
 = (uöt*)(*)&
fmt
 + 1;

55 
_lo›
:

56 (
c
 = *
fmt
++) != '%'){

57 i‡(
c
 == '\0') ;

58 
	`putch
(
c
);

60 
c
 = *
fmt
++;

61 i‡(
c
 == 'd' || c == 'l'){

62 
	`¥öä
(*
adx
, 10);

64 i‡(
c
 == 'o' || c == 'x'){

65 
	`¥öä
(*
adx
, 
c
=='o'? 8:16 );

67 i‡(
c
 == 's'){

68 
	`puts
((*)*
adx
);

70 
adx
++;

71 
_lo›
;

72 
	}
}

74 
	$h≠py
(){

75 
	`¥öt
("happy\n");

76 
	}
}

77 
	$•ö
(*
°r
){

78 
	`¥öt
(
°r
);

80 
	}
}

	@string.c

1 
	~"°rög.h
"

2 
	$°æí
(*
°r
){

3 
Àn
=0;

4 *
°r
!=0){

5 
°r
++;

6 
Àn
++;

8  
Àn
;

9 
	}
}

12 
	$°rcmp
(c⁄° *
°r1
, c⁄° *
°r2
){

13 
i
;

14 
i
 = 0; 
°r1
[i] =
°r2
[i]; i++){

15 if(
°r1
[
i
] == 0)  0;

17  
i
 + 1;

19 
	}
}

21 
	$°∫cmp
(c⁄° *
°r1
, c⁄° *
°r2
, 
n
){

22 
i
 = 0; i < 
n
; i++){

23 if(
°r1
[
i
] =
°r2
[i]) {

24 if(
°r1
[
i
]) ;

27  
i
 + 1;

30 
	}
}

	@string.h

1 #i‚de‡
PAPAYA_STRING_H


2 
	#PAPAYA_STRING_H


	)

4 
°æí
(*
°r
);

5 
°rcmp
(c⁄° *
°r1
, c⁄° *
°r2
);

6 
°∫cmp
(c⁄° *
°r1
, c⁄° *
°r2
, 
n
);

	@syscall.h

1 #i‚de‡
PAPAYA_SYSCALL_H


2 
	#PAPAYA_SYSCALL_H


	)

3 
	~"../§c/ö˛ude/löux/NR_sysˇŒ.h
"

4 
	~"../§c/ö˛ude/löux/ªsour˚.h
"

6 
	#PROT_READ
 0x1

	)

7 
	#PROT_WRITE
 0x2

	)

8 
	#PROT_EXEC
 0x4

	)

9 
	#PROT_SEM
 0x8

	)

10 
	#PROT_NONE
 0x0

	)

11 
	#PROT_GROWSDOWN
 0x01000000

	)

12 
	#PROT_GROWSUP
 0x02000000

	)

14 
	#MAP_SHARED
 0x01

	)

15 
	#MAP_PRIVATE
 0x02

	)

16 
	#MAP_TYPE
 0x0‡

	)

17 
	#MAP_FIXED
 0x100

	)

18 
	#MAP_ANONYMOUS
 0x10

	)

44 
	#öt80_ˇºy_°ack_¨gs_6
(
«me
) \

46 
ªt
; \

47 
__asm__
 
	`__vﬁ©ûe__
("push %%ebx\n\t" \

68 :"Ù"(
ªt
) \

69 :"a"(
NR_
##
«me
) \

71 
ªt
; \

72 })

	)

74 
	#öt80_ˇºy_°ack_¨gs_4
(
«me
) \

76 
__asm__
 
	`__vﬁ©ûe__
("push %%ebx\n\t" \

91 :"a"(
NR_
##
«me
) \

93 })

	)

94 
	#öt80_ˇºy_°ack_¨gs_0
(
«me
) \

96 
__asm__
 
	`__vﬁ©ûe__
( \

99 :"a"(
NR_
##
«me
) \

101 })

	)

103 
	#öt80_ˇºy_°ack_¨gs_1
(
«me
) \

105 
ªt
; \

106 
__asm__
 
	`__vﬁ©ûe__
("push %%ebx\n\t" \

113 :"=m"(
ªt
) \

114 :"a"(
NR_
##
«me
) \

116 
ªt
; \

117 })

	)

119 
	#öt80_ˇºy_°ack_¨gs_2
(
«me
) \

121 
ªt
; \

122 
__asm__
 
	`__vﬁ©ûe__
("push %%ebx\n\t" \

130 :"=m"(
ªt
) \

131 :"a"(
NR_
##
«me
) \

133 
ªt
; \

134 })

	)

136 
	#öt80_ˇºy_°ack_¨gs_3
(
«me
) \

138 
ªt
; \

139 
__asm__
 
	`__vﬁ©ûe__
("push %%ebx\n\t" \

150 :"=m"(
ªt
) \

151 :"a"(
NR_
##
«me
) \

153 
ªt
; \

154 })

	)

156 
ölöe
 
	$execve
(*
fûíame
, *
¨gv
[], *
ívp
[]){

157  
	`öt80_ˇºy_°ack_¨gs_3
(
execve
);

158 
	}
}

160 
ölöe
 
	$¥ötf
(*
f‹m©
, ...){

161  
	`öt80_ˇºy_°ack_¨gs_6
(
¥ötf
);

162 
	}
}

165 
ölöe
 
	$f‹k
(){

166 
	`öt80_ˇºy_°ack_¨gs_0
(
f‹k
);

168 
	}
}

170 
ölöe
 
	$exô
(
°©us
){

171 
	`öt80_ˇºy_°ack_¨gs_1
(
exô
);

172 
	}
}

174 
ölöe
 
	$waô4
(
pid
, *
°©us
, 
›ti⁄
, 
rußge
 *
ru
){

175 
	`öt80_ˇºy_°ack_¨gs_4
(
waô4
);

177 
	}
}

179 
ölöe
 * 
	$mm≠2
(*
addr
, 
Àngth
, 
¥Ÿ
,

180 
Êags
, 
fd
, 
pgoff£t
){

181  (*)
	`öt80_ˇºy_°ack_¨gs_6
(
mm≠2
);

182 
	}
}

184 
ölöe
 * 
	$munm≠
(*
addr
, 
Àngth
){

185  (*)
	`öt80_ˇºy_°ack_¨gs_2
(
munm≠
);

186 
	}
}

188 
ölöe
 
	$›í
(*
fûï©h
, 
Êags
, 
mode
){

189  
	`öt80_ˇºy_°ack_¨gs_3
(
›í
);

190 
	}
}

192 
ölöe
 
	$brk
(
brk
){

193  
	`öt80_ˇºy_°ack_¨gs_1
(
brk
);

194 
	}
}

196 
ölöe
 
	$l£ek
(
fd
, 
off£t
, 
‹igö
){

197  
	`öt80_ˇºy_°ack_¨gs_3
(
l£ek
);

198 
	}
}

	@t.c

1 
	~<uni°d.h
>

2 
	gØØa
=1;

3 
	$a
(){

5 
	}
}

6 
	sabc
{

7 
	ma
;

8 
	mb
;

9 }
	gØa
 = {1, 2};

10 
	$maö
(){

12 
ØØa
=2;

13 
	}
}

	@testlist.c

1 
	#__USER
 1

	)

2 
	~<°dio.h
>

3 
	~"../§c/ö˛ude/ﬁd/li°.h
"

4 
	sÊowî
{

5 
	mage
;

6 
li°_hód
 
	mã¡a˛e
;

8 
Êowî
 
	gÊowîs
[10];

9 
	$maö
(){

10 
Êowî
 
⁄e
;

11 
	`INIT_LIST_HEAD
(&
⁄e
.
ã¡a˛e
);

12  
i
 = 0 ; i < 10 ; i++){

13 
Êowîs
[
i
].
age
 = i * 10;

14 
	`li°_add
(&
Êowîs
[
i
].
ã¡a˛e
, &
⁄e
.tentacle);

16 
Êowî
 *
tmp
;

20 
i
 = 0; i < 2; i++){

21 
	`li°_f‹_óch_ß„
((&
⁄e
.
ã¡a˛e
), 
tmp
,Åentacle){

22 if(
tmp
->
age
 > 40){

23 
	`li°_dñ
(&
tmp
->
ã¡a˛e
);

26 
	`¥ötf
("agê:%d\n", 
tmp
->
age
);

32 
a
=2,
b
=3;

33 
	`¥ötf
("hñlÿw‹ld:%d, %d\n", 
a
, 
b
);

35 
	}
}

38 
	$foob¨
(){

39 
œbÀ
;

41 
x
 = 0;

42 
œbÀ
:

43 
	`¥ötf
("%d", 
x
);

45 
	}
}

	@../src/include/linux/NR_syscall.h

1 #i‚de‡
NR_SYSCALL_H


2 
	#NR_SYSCALL_H


	)

3 
	#NR_bad
 0

	)

4 
	#NR_exô
 1

	)

5 
	#NR_f‹k
 2

	)

6 
	#NR_ªad
 3

	)

7 
	#NR_wrôe
 4

	)

8 
	#NR_›í
 5

	)

9 
	#NR_˛o£
 6

	)

10 
	#NR_waôpid
 7

	)

11 
	#NR_¸ót
 8

	)

12 
	#NR_lök
 9

	)

14 
	#NR_¥ötf
 10

	)

15 
	#NR_execve
 11

	)

16 
	#NR_chdú
 12

	)

17 
	#NR_time
 13

	)

18 
	#NR_mknod
 14

	)

19 
	#NR_chmod
 15

	)

20 
	#NR_lchown
 16

	)

21 
	#NR_bªak
 17

	)

22 
	#NR_ﬁd°©
 18

	)

23 
	#NR_l£ek
 19

	)

24 
	#NR_gëpid
 20

	)

25 
	#NR_mou¡
 21

	)

26 
	#NR_umou¡
 22

	)

27 
	#NR_£tuid
 23

	)

28 
	#NR_gëuid
 24

	)

29 
	#NR_°ime
 25

	)

30 
	#NR_±ø˚
 26

	)

31 
	#NR_Æ¨m
 27

	)

32 
	#NR_ﬁdf°©
 28

	)

33 
	#NR_∑u£
 29

	)

34 
	#NR_utime
 30

	)

35 
	#NR_°ty
 31

	)

36 
	#NR_gây
 32

	)

37 
	#NR_ac˚ss
 33

	)

38 
	#NR_ni˚
 34

	)

39 
	#NR_·ime
 35

	)

40 
	#NR_sync
 36

	)

41 
	#NR_kûl
 37

	)

42 
	#NR_ª«me
 38

	)

43 
	#NR_mkdú
 39

	)

44 
	#NR_rmdú
 40

	)

45 
	#NR_dup
 41

	)

46 
	#NR_pùe
 42

	)

47 
	#NR_times
 43

	)

48 
	#NR_¥of
 44

	)

49 
	#NR_brk
 45

	)

50 
	#NR_£tgid
 46

	)

51 
	#NR_gëgid
 47

	)

52 
	#NR_sig«l
 48

	)

53 
	#NR_gëeuid
 49

	)

54 
	#NR_gëegid
 50

	)

55 
	#NR_ac˘
 51

	)

56 
	#NR_umou¡2
 52

	)

57 
	#NR_lock
 53

	)

58 
	#NR_io˘l
 54

	)

59 
	#NR_f˙é
 55

	)

60 
	#NR_mpx
 56

	)

61 
	#NR_£çgid
 57

	)

62 
	#NR_ulimô
 58

	)

63 
	#NR_ﬁdﬁdu«me
 59

	)

64 
	#NR_umask
 60

	)

65 
	#NR_chroŸ
 61

	)

66 
	#NR_u°©
 62

	)

67 
	#NR_dup2
 63

	)

68 
	#NR_gëµid
 64

	)

69 
	#NR_gëpgΩ
 65

	)

70 
	#NR_£tsid
 66

	)

71 
	#NR_siga˘i⁄
 67

	)

72 
	#NR_sgëmask
 68

	)

73 
	#NR_s£tmask
 69

	)

74 
	#NR_£åeuid
 70

	)

75 
	#NR_£åegid
 71

	)

76 
	#NR_sigsu•íd
 72

	)

77 
	#NR_sig≥ndög
 73

	)

78 
	#NR_£tho°«me
 74

	)

79 
	#NR_£ålimô
 75

	)

80 
	#NR_gëæimô
 76

	)

81 
	#NR_gërußge
 77

	)

82 
	#NR_gëtimeofday
 78

	)

83 
	#NR_£âimeofday
 79

	)

84 
	#NR_gëgroups
 80

	)

85 
	#NR_£tgroups
 81

	)

86 
	#NR_£À˘
 82

	)

87 
	#NR_symlök
 83

	)

88 
	#NR_ﬁdl°©
 84

	)

89 
	#NR_ªadlök
 85

	)

90 
	#NR_u£lib
 86

	)

91 
	#NR_sw≠⁄
 87

	)

92 
	#NR_ªboŸ
 88

	)

93 
	#NR_ªaddú
 89

	)

94 
	#NR_mm≠
 90

	)

95 
	#NR_munm≠
 91

	)

96 
	#NR_åunˇã
 92

	)

97 
	#NR_·runˇã
 93

	)

98 
	#NR_fchmod
 94

	)

99 
	#NR_fchown
 95

	)

100 
	#NR_gë¥i‹ôy
 96

	)

101 
	#NR_£çri‹ôy
 97

	)

102 
	#NR_¥ofû
 98

	)

103 
	#NR_°©fs
 99

	)

104 
	#NR_f°©fs
 100

	)

105 
	#NR_i›îm
 101

	)

106 
	#NR_sockëˇŒ
 102

	)

107 
	#NR_sy¶og
 103

	)

108 
	#NR_£tôimî
 104

	)

109 
	#NR_gëôimî
 105

	)

110 
	#NR_°©
 106

	)

111 
	#NR_l°©
 107

	)

112 
	#NR_f°©
 108

	)

113 
	#NR_ﬁdu«me
 109

	)

114 
	#NR_i›l
 110

	)

115 
	#NR_vh™gup
 111

	)

116 
	#NR_idÀ
 112

	)

117 
	#NR_vm86ﬁd
 113

	)

118 
	#NR_waô4
 114

	)

119 
	#NR_sw≠off
 115

	)

120 
	#NR_sysöfo
 116

	)

121 
	#NR_ùc
 117

	)

122 
	#NR_fsync
 118

	)

123 
	#NR_sigªtu∫
 119

	)

124 
	#NR_˛⁄e
 120

	)

125 
	#NR_£tdomaö«me
 121

	)

126 
	#NR_u«me
 122

	)

127 
	#NR_modify_ldt
 123

	)

128 
	#NR_adjtimex
 124

	)

129 
	#NR_m¥Ÿe˘
 125

	)

130 
	#NR_sig¥ocmask
 126

	)

131 
	#NR_¸óã_moduÀ
 127

	)

132 
	#NR_öô_moduÀ
 128

	)

133 
	#NR_dñëe_moduÀ
 129

	)

134 
	#NR_gë_kî√l_syms
 130

	)

135 
	#NR_quŸa˘l
 131

	)

136 
	#NR_gëpgid
 132

	)

137 
	#NR_fchdú
 133

	)

138 
	#NR_bdÊush
 134

	)

139 
	#NR_sysfs
 135

	)

140 
	#NR_≥rs⁄Æôy
 136

	)

141 
	#NR_afs_sysˇŒ
 137

	)

142 
	#NR_£tfsuid
 138

	)

143 
	#NR_£tfsgid
 139

	)

144 
	#NR__Œ£ek
 140

	)

145 
	#NR_gëdíts
 141

	)

146 
	#NR__√w£À˘
 142

	)

147 
	#NR_Êock
 143

	)

148 
	#NR_msync
 144

	)

149 
	#NR_ªadv
 145

	)

150 
	#NR_wrôev
 146

	)

151 
	#NR_gësid
 147

	)

152 
	#NR_fd©async
 148

	)

153 
	#NR__sys˘l
 149

	)

154 
	#NR_mlock
 150

	)

155 
	#NR_mu∆ock
 151

	)

156 
	#NR_mlockÆl
 152

	)

157 
	#NR_mu∆ockÆl
 153

	)

158 
	#NR_sched_£ç¨am
 154

	)

159 
	#NR_sched_gë∑øm
 155

	)

160 
	#NR_sched_£tscheduÀr
 156

	)

161 
	#NR_sched_gëscheduÀr
 157

	)

162 
	#NR_sched_yõld
 158

	)

163 
	#NR_sched_gë_¥i‹ôy_max
 159

	)

164 
	#NR_sched_gë_¥i‹ôy_mö
 160

	)

165 
	#NR_sched_º_gë_öãrvÆ
 161

	)

166 
	#NR_«no¶ìp
 162

	)

167 
	#NR_mªm≠
 163

	)

168 
	#NR_£åesuid
 164

	)

169 
	#NR_gëªsuid
 165

	)

170 
	#NR_vm86
 166

	)

171 
	#NR_quîy_moduÀ
 167

	)

172 
	#NR_pﬁl
 168

	)

173 
	#NR_nfs£rv˘l
 169

	)

174 
	#NR_£åesgid
 170

	)

175 
	#NR_gëªsgid
 171

	)

176 
	#NR_¥˘l
 172

	)

177 
	#NR_π_sigªtu∫
 173

	)

178 
	#NR_π_siga˘i⁄
 174

	)

179 
	#NR_π_sig¥ocmask
 175

	)

180 
	#NR_π_sig≥ndög
 176

	)

181 
	#NR_π_sigtimedwaô
 177

	)

182 
	#NR_π_sigqueueöfo
 178

	)

183 
	#NR_π_sigsu•íd
 179

	)

184 
	#NR_¥ód
 180

	)

185 
	#NR_pwrôe
 181

	)

186 
	#NR_chown
 182

	)

187 
	#NR_gëcwd
 183

	)

188 
	#NR_ˇpgë
 184

	)

189 
	#NR_ˇp£t
 185

	)

190 
	#NR_sigÆt°ack
 186

	)

191 
	#NR_£ndfûe
 187

	)

192 
	#NR_gëpmsg
 188

	)

193 
	#NR_puçmsg
 189

	)

194 
	#NR_vf‹k
 190

	)

195 
	#NR_ugëæimô
 191

	)

196 
	#NR_mm≠2
 192

	)

197 
	#NR_åunˇã64
 193

	)

198 
	#NR_·runˇã64
 194

	)

199 
	#NR_°©64
 195

	)

200 
	#NR_l°©64
 196

	)

201 
	#NR_f°©64
 197

	)

202 
	#NR_lchown32
 198

	)

203 
	#NR_gëuid32
 199

	)

204 
	#NR_gëgid32
 200

	)

205 
	#NR_gëeuid32
 201

	)

206 
	#NR_gëegid32
 202

	)

207 
	#NR_£åeuid32
 203

	)

208 
	#NR_£åegid32
 204

	)

209 
	#NR_gëgroups32
 205

	)

210 
	#NR_£tgroups32
 206

	)

211 
	#NR_fchown32
 207

	)

212 
	#NR_£åesuid32
 208

	)

213 
	#NR_gëªsuid32
 209

	)

214 
	#NR_£åesgid32
 210

	)

215 
	#NR_gëªsgid32
 211

	)

216 
	#NR_chown32
 212

	)

217 
	#NR_£tuid32
 213

	)

218 
	#NR_£tgid32
 214

	)

219 
	#NR_£tfsuid32
 215

	)

220 
	#NR_£tfsgid32
 216

	)

221 
	#NR_pivŸ_roŸ
 217

	)

222 
	#NR_möc‹e
 218

	)

223 
	#NR_madvi£
 219

	)

224 
	#NR_madvi£1
 219

	)

225 
	#NR_gëdíts64
 220

	)

226 
	#NR_f˙é64
 221

	)

	@../src/include/linux/cell_common.h

6 #i‚de‡
CELL_COMMON_H


7 
	#CELL_COMMON_H


	)

9 
	#ROOTCELL_DEFAULT
 4096

	)

10 
	#CELL_SIZE
 (128 * 1024)

	)

11 
	#CELL_HEADER_SIZE
 ()(((
˚Œ
 *)0)->
d©a
)

	)

12 
	#CELL_DATA_MAX
 (
CELL_SIZE
 - 
CELL_HEADER_SIZE
)

	)

13 
	s˚Œ_díåy
{

14 
	mÀn
;

15 
	m˚Œid
;

16 
	m«me
[0];

18 
	s˚Œ
{

19 
	mmktime
;

20 
	mchgtime
;

21 
	msize
;

22 
	mty≥
;

24 
˚Œ_díåy
 
	míts
[0];

25 
	md©a
[0];

28 
	s˚Œ_su≥rblock
{

31 
	mÊags
[4];

32 
	m˚Œsize
;

33 
	m˚Œnum
;

34 
	mroŸ˚Œ
;

35 
	mbôm≠
[0];

38 
	mroom
[1024];

	@../src/include/linux/resource.h

1 #i‚de‡
LINUX_RESOURCE_H


2 
	#LINUX_RESOURCE_H


	)

4 
	srußge
{

5 
	mk∫l_time
;

6 
	mu£r_time
;

	@../src/include/linux/wait.h

1 #i‚de‡
LINUX_WAIT_H


2 
	#LINUX_WAIT_H


	)

4 
	#WNOHANG
 1

	)

5 
	#WUNTRACED
 2

	)

	@../src/include/old/bootinfo.h

1 #i‚de‡
BOOT_INFO_H


2 
	#BOOT_INFO_H


	)

5 #i‚de‡
ENV_NOT_KERNEL


6 
	~<mm.h
>

10 
	sªÆmod_öfo_°ru˘
{

11 
	mmem_£gnum
;

13 
mem_£göfo
 
	mmem_£göfo
[10];

14 
	m∑ddög
[256];

18 
ªÆmod_öfo_°ru˘
 
ªÆmod_öfo
;

19 
	#ªÆmod_öfo
 ((
ªÆmod_öfo_°ru˘
*)
	`KV
(&
ªÆmod_öfo
))

	)

22 
	#KV
(
physiˇl_addr
Ë((
u32
)’hysiˇl_addr)+
KROOM_ADDR
)

	)

25 
_kî√l_image_°¨t_£˘‹
;

26 
	#kî√l_image_°¨t_£˘‹
 (()&
_kî√l_image_°¨t_£˘‹
)

	)

27 
_fiximg_°¨t_£˘‹
;

28 
	#fiximg_°¨t_£˘‹
 (()&
_fiximg_°¨t_£˘‹
)

	)

30 
_mem£g_num
;

31 
	#g_mem£g_num
 (*(*)
	`KV
(&
_mem£g_num
))

	)

33 
_ba£_memöfo
;

34 
	#g_mem£g_öfo
 ( (
mem£g_öfo
 *)
	`KV
(&
_ba£_memöfo
Ë)

	)

	@../src/include/old/list.h

1 #i‚de‡
LIST_H


2 
	#LIST_H


	)

5 #i‚de‡
__USER


6 
	~<löux/as£π.h
>

8 
	~<as£π.h
>

10 
	sli°_hód
{

11 
li°_hód
 *
	m¥ev
;

12 
li°_hód
 *
	m√xt
;

13 }
	tli°_hód_t
;

15 
	#INIT_LIST_HEAD
(
l
)\

17 (
l
)->
¥ev
 = (l)->
√xt
 =Ü;\

18 } 0)

	)

20 
ölöe
 
	$__li°_add
(
li°_hód_t
 *
√w
,Üi°_hód_à*
¥ev
,

21 
li°_hód_t
 *
√xt
){

22 
	`as£π
–
√w
 && 
¥ev
 && 
√xt
\

23 && 
¥ev
->¥ev &&Öªv->
√xt
 &&Çext->prev &&Çext->next);

24 
√w
->
√xt
 =Çext;

25 
√xt
->
¥ev
 = 
√w
;

26 
√w
->
¥ev
 =Örev;

27 
¥ev
->
√xt
 = 
√w
;

28 
	}
}

35 
ölöe
 
	$li°_add
(
li°_hód_t
 *
√w
,Üi°_hód_à*
hód
){

36 
	`__li°_add
(
√w
, 
hód
, hód->
√xt
);

37 
	}
}

39 
ölöe
 
	$li°_add_èû
(
li°_hód_t
 *
√w
,Üi°_hód_à*
hód
){

40 
	`__li°_add
(
√w
, 
hód
->
¥ev
, head);

41 
	}
}

49 
ölöe
 
	$__li°_dñ
(
li°_hód_t
 *
¥ev
,Üi°_hód_à*
√xt
){

50 
	`as£π
(
¥ev
 && 
√xt
 &&Örev->next &&Örev->prev &&Çext->prev &&Çext->next);

51 
¥ev
->
√xt
 =Çext;

52 
√xt
->
¥ev
 =Örev;

53 
	}
}

56 
ölöe
 
	$li°_dñ
(
li°_hód_t
 *
íåy
){

57 
	`__li°_dñ
(
íåy
->
¥ev
,É¡ry->
√xt
);

58 
	}
}

60 
ölöe
 
	$li°_dñ_öô
(
li°_hód_t
 *
íåy
){

61 
	`__li°_dñ
(
íåy
->
¥ev
,É¡ry->
√xt
);

62 
	`INIT_LIST_HEAD
(
íåy
);

63 
	}
}

65 
ölöe
 
	$li°_em±y
(
li°_hód_t
 *
íåy
){

66  
íåy
->
√xt
 ==Éntry;

67 
	}
}

69 
ölöe
 
	$li°_mìt_èû
(
li°_hód_t
 *
fú°
,Üi°_hód_à*
íåy
){

70  
íåy
->
√xt
 =
fú°
;

71 
	}
}

74 
	#LIST_FIND2
(
°ru_t
, 
mb_t
, 
roŸ
, 
key
, 
vÆue
, 
ªsu…
) \

76 
li°_hód
 * 
node
 = 
roŸ
->
√xt
; \

77 
°ru_t
 *
obj
; \

78 
node
 !
roŸ
){ \

79 *
obj
 = 
	`MB2STRU
(
°ru_t
, 
node
, 
mb_t
); \

80 if–(
obj
)->
key
 =
vÆue
 ) ; \

81 
node
 =Çode->
√xt
; \

83 if(
node
 =
roŸ
Ë
ªsu…
 = 0; \

84 
ªsu…
 = 
obj
; \

85 } 0);

	)

87 
ölöe
 
	$hashèbÀ_add
(
li°_hód_t
 *
hashèbÀ
, 
hash
,Üi°_hód_à*
√w
){

88 
	`li°_add
(
√w
, 
hashèbÀ
 + 
hash
) ;

89 
	}
}

93 
	#MB2STRU
(
°ru_ty≥
, 
mb_addr
, 
mb_«me
)\

94 (
°ru_ty≥
 *)–()(
mb_addr
)- ()&((°ru_ty≥ *)0)->
mb_«me
 )

	)

98 
	#c⁄èöî_of
(
hód
, 
°ru
, 
membî
Ë
	`MB2STRU
(°ru, hód, membî)

	)

104 
	#li°_f‹_óch_ß„
(
roŸ
, 
c⁄èöî
, 
mb«me
) \

106 
li°_hód
 *
node
 = (
roŸ
)->
√xt
, *next =Çode->next; \

107 ((
c⁄èöî
 = 
	`c⁄èöî_of
(
node
, 
	`__ty≥of__
(*c⁄èöî), 
mb«me
)) || 1)\

108 && 
node
 !
roŸ
; \

109 
node
 = 
√xt
,Çext =Çext->next \

110 )

	)

	@
1
.
0
30
367
_dimg.c
cat.c
cell.c
foobar.c
go.c
init.c
ld.c
ld.h
lib1.c
lib2.c
lib3.c
lib4.c
lib5.c
lib6.c
malloc.c
malloc.h
printf.c
printf.h
static.h
string.c
string.h
syscall.h
t.c
testlist.c
../src/include/linux/NR_syscall.h
../src/include/linux/cell_common.h
../src/include/linux/resource.h
../src/include/linux/wait.h
../src/include/old/bootinfo.h
../src/include/old/list.h
